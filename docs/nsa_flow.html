<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 16.0.0"/>
    <title>nsa_flow API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note{color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.tip{color:#0a3622;background-color:#d1e7dd;border-color:#a3cfbb;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%230a3622%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%206a6%206%200%201%201%2010.174%204.31c-.203.196-.359.4-.453.619l-.762%201.769A.5.5%200%200%201%2010.5%2013a.5.5%200%200%201%200%201%20.5.5%200%200%201%200%201l-.224.447a1%201%200%200%201-.894.553H6.618a1%201%200%200%201-.894-.553L5.5%2015a.5.5%200%200%201%200-1%20.5.5%200%200%201%200-1%20.5.5%200%200%201-.46-.302l-.761-1.77a2%202%200%200%200-.453-.618A5.98%205.98%200%200%201%202%206m6-5a5%205%200%200%200-3.479%208.592c.263.254.514.564.676.941L5.83%2012h4.342l.632-1.467c.162-.377.413-.687.676-.941A5%205%200%200%200%208%201%22/%3E%3C/svg%3E");}.pdoc .alert.important{color:#055160;background-color:#cff4fc;border-color:#9eeaf9;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23055160%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%200a2%202%200%200%200-2%202v12a2%202%200%200%200%202%202h12a2%202%200%200%200%202-2V2a2%202%200%200%200-2-2zm6%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.caution{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M11.46.146A.5.5%200%200%200%2011.107%200H4.893a.5.5%200%200%200-.353.146L.146%204.54A.5.5%200%200%200%200%204.893v6.214a.5.5%200%200%200%20.146.353l4.394%204.394a.5.5%200%200%200%20.353.146h6.214a.5.5%200%200%200%20.353-.146l4.394-4.394a.5.5%200%200%200%20.146-.353V4.893a.5.5%200%200%200-.146-.353zM8%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:27px;vertical-align:bottom;width:50px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>




            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="function" href="#nsa_flow">nsa_flow</a>
            </li>
            <li>
                    <a class="function" href="#nsa_flow_retract_auto">nsa_flow_retract_auto</a>
            </li>
            <li>
                    <a class="function" href="#inv_sqrt_sym_adaptive">inv_sqrt_sym_adaptive</a>
            </li>
            <li>
                    <a class="function" href="#invariant_orthogonality_defect">invariant_orthogonality_defect</a>
            </li>
            <li>
                    <a class="function" href="#energy_fidelity">energy_fidelity</a>
            </li>
            <li>
                    <a class="function" href="#get_torch_optimizer">get_torch_optimizer</a>
            </li>
            <li>
                    <a class="function" href="#defect_fast">defect_fast</a>
            </li>
            <li>
                    <a class="function" href="#plot_nsa_trace">plot_nsa_trace</a>
            </li>
            <li>
                    <a class="function" href="#estimate_learning_rate_for_nsa_flow">estimate_learning_rate_for_nsa_flow</a>
            </li>
            <li>
                    <a class="function" href="#test_scale_invariance">test_scale_invariance</a>
            </li>
            <li>
                    <a class="function" href="#test_lr_strategies">test_lr_strategies</a>
            </li>
            <li>
                    <a class="function" href="#test_autograd_scale_invariance">test_autograd_scale_invariance</a>
            </li>
            <li>
                    <a class="function" href="#test_estimate_learning_rate_for_nsa_flow">test_estimate_learning_rate_for_nsa_flow</a>
            </li>
            <li>
                    <a class="function" href="#compute_energy">compute_energy</a>
            </li>
            <li>
                    <a class="function" href="#apply_nonnegativity">apply_nonnegativity</a>
            </li>
            <li>
                    <a class="function" href="#test_nsa_flow_orth_modular">test_nsa_flow_orth_modular</a>
            </li>
            <li>
                    <a class="function" href="#test_aggression_effect_with_convergence">test_aggression_effect_with_convergence</a>
            </li>
            <li>
                    <a class="function" href="#get_lr_estimation_strategies">get_lr_estimation_strategies</a>
            </li>
            <li>
                    <a class="function" href="#test_lr_aggression_monotonicity">test_lr_aggression_monotonicity</a>
            </li>
            <li>
                    <a class="function" href="#run_single_experiment">run_single_experiment</a>
            </li>
            <li>
                    <a class="function" href="#evaluate">evaluate</a>
            </li>
            <li>
                    <a class="function" href="#plot_evaluation_summary">plot_evaluation_summary</a>
            </li>
            <li>
                    <a class="class" href="#NSAFlowLayer">NSAFlowLayer</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#NSAFlowLayer.__init__">NSAFlowLayer</a>
                        </li>
                        <li>
                                <a class="variable" href="#NSAFlowLayer.k">k</a>
                        </li>
                        <li>
                                <a class="variable" href="#NSAFlowLayer.hidden">hidden</a>
                        </li>
                        <li>
                                <a class="variable" href="#NSAFlowLayer.retraction_type">retraction_type</a>
                        </li>
                        <li>
                                <a class="variable" href="#NSAFlowLayer.apply_nonneg">apply_nonneg</a>
                        </li>
                        <li>
                                <a class="variable" href="#NSAFlowLayer.residual">residual</a>
                        </li>
                        <li>
                                <a class="variable" href="#NSAFlowLayer.use_transform">use_transform</a>
                        </li>
                        <li>
                                <a class="variable" href="#NSAFlowLayer.w_retract">w_retract</a>
                        </li>
                        <li>
                                <a class="variable" href="#NSAFlowLayer.alpha">alpha</a>
                        </li>
                        <li>
                                <a class="function" href="#NSAFlowLayer.forward">forward</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="function" href="#test_mlp_then_nsa_joint_residual">test_mlp_then_nsa_joint_residual</a>
            </li>
            <li>
                    <a class="function" href="#test_mlp_then_nsa_joint_residual_pca">test_mlp_then_nsa_joint_residual_pca</a>
            </li>
            <li>
                    <a class="function" href="#test_mlp_then_nsa_joint_residual_diagnostics">test_mlp_then_nsa_joint_residual_diagnostics</a>
            </li>
            <li>
                    <a class="function" href="#test_mlp_then_nsa_joint_residual_v2">test_mlp_then_nsa_joint_residual_v2</a>
            </li>
            <li>
                    <a class="function" href="#fidelity_scaled">fidelity_scaled</a>
            </li>
            <li>
                    <a class="function" href="#fidelity_symmetric">fidelity_symmetric</a>
            </li>
            <li>
                    <a class="function" href="#nsa_flow_orth">nsa_flow_orth</a>
            </li>
            <li>
                    <a class="function" href="#demo_nsa_flow_tradeoff">demo_nsa_flow_tradeoff</a>
            </li>
            <li>
                    <a class="function" href="#safe_to_tensor">safe_to_tensor</a>
            </li>
            <li>
                    <a class="function" href="#demo_nsa_flow_optimizer_tradeoff">demo_nsa_flow_optimizer_tradeoff</a>
            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22160%22%20viewBox%3D%220%200%20150%2080%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M132.316%2048.886c.276-4.679%202.342-6.698%204.409-7.982s4.27-1.165%206.751-1.055c1.586.07%203.044.156%204.222-.482%201.142-.619%202.026-1.932%202.162-3.739.268-3.576-1.929-5.368-5.006-5.551s-7.599.524-10.517%201.606c-4.455%201.652-8.588%206.606-9.552%208.992s-2.342%206.193-1.745%2010.873%202.664%209.221%205.878%2011.79%205.878%203.808%2010.103%204.312%203.444.229%206.062.229%205.006-2.202%204.914-4.909-2.296-5.001-4.501-4.863-3.077.505-5.281.229-7.715-2.064-7.899-9.451z%22%20fill%3D%22%23198754%22/%3E%3Ccircle%20cx%3D%22101.504%22%20cy%3D%2248.943%22%20r%3D%2214.208%22%20fill%3D%22none%22%20stroke%3D%22%23198754%22%20stroke-width%3D%229.354%22/%3E%3Cpath%20d%3D%22M87.81.002c-3.637.065-5.001.454-7.014%201.232s-3.443%201.363-6.3%204.282c-1.723%201.76-3.148%205.019-3.776%207.329-.413%201.521-.316%202.63-.316%202.63l-.195%2034.612c.065%205.774-6.755%208.305-9.612%208.37s-9.678-1.038-9.743-9.408%207.128-9.521%208.362-9.521c1.413-.13%202.526-.021%203.718-.016%202.071.009%204.157-.778%204.092-4.671s-4.157-4.736-4.157-4.736c-6.3-.843-11.43%202.206-11.43%202.206S40.917%2038.15%2041.372%2049.634%2051.568%2068.19%2061.311%2068.125s18.316-7.007%2018.445-17.193l.13-22.772c.046-2.291%202.683-3.644%204.476-4.203.745-.232%201.694-.274%201.694-.274l10.457-.13s4.871-.324%207.729-3.114%204.352-6.294%204.352-6.294.974-3.049.13-4.606-.195-1.233-2.792-3.309-8.573-4.477-8.573-4.477S91.447-.063%2087.81.002zM0%2047.169l.065%2028.417S0%2080.127%204.481%2079.997s5.072-3.866%205.049-4.152l-.113-28.482s1.624-7.656%209.937-7.721%2010.002%206.942%2010.002%208.499-.909%2010.51-9.093%2010.51c-.948%200-2.99-.567-4.145-.272-3.919%201-3.194%204.554-3.194%204.554s.065%205.061%207.404%204.996%2018.575-6.034%2018.575-19.074S26.953%2030.04%2019.549%2029.91%201.234%2035.296%200%2047.169z%22%20fill%3D%22%23198754%22/%3E%3Cg%20transform%3D%22matrix%28.325601%200%200%20.325256%20-10.32669%20-45.802786%29%22%3E%3Ccircle%20cx%3D%22297.554%22%20cy%3D%22172.286%22%20r%3D%2216.5%22%20fill%3D%22%23fff%22/%3E%3Cellipse%20cx%3D%22297.709%22%20cy%3D%22172.642%22%20rx%3D%2211.071%22%20ry%3D%2210.871%22%20fill%3D%22%23105a48%22/%3E%3Ccircle%20cx%3D%22304.104%22%20cy%3D%22167.667%22%20r%3D%224.5%22%20fill%3D%22%23fff%22/%3E%3C/g%3E%3Cpath%20d%3D%22M94.661%2017.032l.893-1.476s.99.714%201.916.925%201.575.114%202.955.114l14.565-.162c1.283-.032%203.085-.762%203.02-3.293s-.373-3.503-.373-3.503l1.283-.487s.52.503.877%201.573.309%201.995.292%202.66-.227%201.541-.227%201.541%201.564-.308%202.359-1.038.823-.779%201.489-1.508.812-.86.812-.86.552-.13.877.26.341.957.065%201.46-1.672%202.206-3.247%203.066-2.76%201.427-3.929%201.768-3.848.73-7.063.714l-10.944-.114s-2.143-.081-3.02-.373-2.241-.973-2.598-1.265z%22%20fill%3D%22%23d36d49%22/%3E%3Cg%20fill%3D%22%23105a48%22%3E%3Cellipse%20cx%3D%2293.052%22%20cy%3D%2243.567%22%20rx%3D%22.869%22%20ry%3D%221.014%22%20transform%3D%22rotate%28341.022%29%22/%3E%3Cellipse%20cx%3D%22104.3%22%20cy%3D%22-16.184%22%20rx%3D%22.865%22%20ry%3D%221.009%22%20transform%3D%22rotate%2814.786%29%22/%3E%3C/g%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
nsa_flow    </h1>

                
                        <input id="mod-nsa_flow-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-nsa_flow-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">1</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">nsa_flow</span><span class="p">,</span> <span class="n">nsa_flow_retract_auto</span><span class="p">,</span> <span class="n">inv_sqrt_sym_adaptive</span><span class="p">,</span> <span class="n">invariant_orthogonality_defect</span><span class="p">,</span> <span class="n">energy_fidelity</span><span class="p">,</span> <span class="n">get_torch_optimizer</span><span class="p">,</span> <span class="n">defect_fast</span><span class="p">,</span> <span class="n">plot_nsa_trace</span><span class="p">,</span> <span class="n">estimate_learning_rate_for_nsa_flow</span><span class="p">,</span><span class="n">test_scale_invariance</span><span class="p">,</span><span class="n">test_lr_strategies</span><span class="p">,</span> <span class="n">test_autograd_scale_invariance</span><span class="p">,</span><span class="n">test_estimate_learning_rate_for_nsa_flow</span><span class="p">,</span><span class="n">compute_energy</span><span class="p">,</span><span class="n">apply_nonnegativity</span><span class="p">,</span><span class="n">test_nsa_flow_orth_modular</span><span class="p">,</span><span class="n">test_aggression_effect_with_convergence</span><span class="p">,</span><span class="n">get_lr_estimation_strategies</span><span class="p">,</span><span class="n">test_lr_aggression_monotonicity</span><span class="p">,</span><span class="n">run_single_experiment</span><span class="p">,</span> <span class="n">evaluate</span><span class="p">,</span> <span class="n">plot_evaluation_summary</span><span class="p">,</span><span class="n">NSAFlowLayer</span><span class="p">,</span><span class="n">test_mlp_then_nsa_joint_residual</span><span class="p">,</span><span class="n">test_mlp_then_nsa_joint_residual_pca</span><span class="p">,</span><span class="n">test_mlp_then_nsa_joint_residual_diagnostics</span><span class="p">,</span> <span class="n">test_mlp_then_nsa_joint_residual_v2</span><span class="p">,</span><span class="n">fidelity_scaled</span><span class="p">,</span><span class="n">fidelity_symmetric</span><span class="p">,</span><span class="n">nsa_flow_orth</span><span class="p">,</span><span class="n">demo_nsa_flow_tradeoff</span><span class="p">,</span><span class="n">safe_to_tensor</span><span class="p">,</span><span class="n">demo_nsa_flow_optimizer_tradeoff</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">2</span></a><span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;nsa_flow&quot;</span><span class="p">,</span> <span class="s2">&quot;nsa_flow_retract_auto&quot;</span><span class="p">,</span> <span class="s2">&quot;inv_sqrt_sym_adaptive&quot;</span><span class="p">,</span> <span class="s2">&quot;invariant_orthogonality_defect&quot;</span><span class="p">,</span> <span class="s2">&quot;energy_fidelity&quot;</span><span class="p">,</span><span class="s2">&quot;get_torch_optimizer&quot;</span><span class="p">,</span><span class="s2">&quot;defect_fast&quot;</span><span class="p">,</span><span class="s2">&quot;plot_nsa_trace&quot;</span><span class="p">,</span> <span class="s2">&quot;estimate_learning_rate_for_nsa_flow&quot;</span><span class="p">,</span><span class="s2">&quot;test_scale_invariance&quot;</span><span class="p">,</span><span class="s2">&quot;test_lr_strategies&quot;</span><span class="p">,</span><span class="s2">&quot;test_autograd_scale_invariance&quot;</span><span class="p">,</span><span class="s1">&#39;test_estimate_learning_rate_for_nsa_flow&#39;</span><span class="p">,</span><span class="s1">&#39;compute_energy&#39;</span><span class="p">,</span><span class="s1">&#39;apply_nonnegativity&#39;</span><span class="p">,</span><span class="s2">&quot;test_nsa_flow_orth_modular&quot;</span><span class="p">,</span><span class="s2">&quot;test_aggression_effect_with_convergence&quot;</span><span class="p">,</span><span class="s2">&quot;get_lr_estimation_strategies&quot;</span><span class="p">,</span><span class="s2">&quot;test_lr_aggression_monotonicity&quot;</span><span class="p">,</span><span class="s2">&quot;run_single_experiment&quot;</span><span class="p">,</span><span class="s2">&quot;evaluate&quot;</span><span class="p">,</span><span class="s2">&quot;plot_evaluation_summary&quot;</span><span class="p">,</span><span class="s2">&quot;NSAFlowLayer&quot;</span><span class="p">,</span><span class="s2">&quot;test_mlp_then_nsa_joint_residual&quot;</span><span class="p">,</span><span class="s2">&quot;test_mlp_then_nsa_joint_residual_pca&quot;</span><span class="p">,</span><span class="s2">&quot;test_mlp_then_nsa_joint_residual_diagnostics&quot;</span><span class="p">,</span><span class="s2">&quot;test_mlp_then_nsa_joint_residual_v2&quot;</span><span class="p">,</span><span class="s2">&quot;fidelity_scaled&quot;</span><span class="p">,</span><span class="s2">&quot;fidelity_symmetric&quot;</span><span class="p">,</span><span class="s2">&quot;nsa_flow_orth&quot;</span><span class="p">,</span><span class="s2">&quot;demo_nsa_flow_tradeoff&quot;</span><span class="p">,</span><span class="s2">&quot;safe_to_tensor&quot;</span><span class="p">,</span><span class="s2">&quot;demo_nsa_flow_optimizer_tradeoff&quot;</span><span class="p">]</span>
</span></pre></div>


            </section>
                <section id="nsa_flow">
                            <input id="nsa_flow-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">nsa_flow</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">Y0</span>,</span><span class="param">	<span class="n">X0</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">w</span><span class="o">=</span><span class="mf">0.5</span>,</span><span class="param">	<span class="n">retraction</span><span class="o">=</span><span class="s1">&#39;soft_polar&#39;</span>,</span><span class="param">	<span class="n">max_iter</span><span class="o">=</span><span class="mi">500</span>,</span><span class="param">	<span class="n">tol</span><span class="o">=</span><span class="mf">1e-05</span>,</span><span class="param">	<span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">seed</span><span class="o">=</span><span class="mi">42</span>,</span><span class="param">	<span class="n">apply_nonneg</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;fast&#39;</span>,</span><span class="param">	<span class="n">initial_learning_rate</span><span class="o">=</span><span class="s1">&#39;default&#39;</span>,</span><span class="param">	<span class="n">record_every</span><span class="o">=</span><span class="mi">1</span>,</span><span class="param">	<span class="n">window_size</span><span class="o">=</span><span class="mi">5</span>,</span><span class="param">	<span class="n">c1_armijo</span><span class="o">=</span><span class="mf">1e-06</span>,</span><span class="param">	<span class="n">simplified</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">project_full_gradient</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">device</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">precision</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="nsa_flow-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#nsa_flow"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="nsa_flow-1083"><a href="#nsa_flow-1083"><span class="linenos">1083</span></a><span class="k">def</span><span class="w"> </span><span class="nf">nsa_flow</span><span class="p">(</span><span class="n">Y0</span><span class="p">,</span> <span class="n">X0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
</span><span id="nsa_flow-1084"><a href="#nsa_flow-1084"><span class="linenos">1084</span></a>             <span class="n">retraction</span><span class="o">=</span><span class="s2">&quot;soft_polar&quot;</span><span class="p">,</span>
</span><span id="nsa_flow-1085"><a href="#nsa_flow-1085"><span class="linenos">1085</span></a>             <span class="n">max_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
</span><span id="nsa_flow-1086"><a href="#nsa_flow-1086"><span class="linenos">1086</span></a>             <span class="n">apply_nonneg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;fast&quot;</span><span class="p">,</span>
</span><span id="nsa_flow-1087"><a href="#nsa_flow-1087"><span class="linenos">1087</span></a>             <span class="n">initial_learning_rate</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">,</span>
</span><span id="nsa_flow-1088"><a href="#nsa_flow-1088"><span class="linenos">1088</span></a>             <span class="n">record_every</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">window_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">c1_armijo</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span>
</span><span id="nsa_flow-1089"><a href="#nsa_flow-1089"><span class="linenos">1089</span></a>             <span class="n">simplified</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="nsa_flow-1090"><a href="#nsa_flow-1090"><span class="linenos">1090</span></a>             <span class="n">project_full_gradient</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="nsa_flow-1091"><a href="#nsa_flow-1091"><span class="linenos">1091</span></a>             <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">):</span>
</span><span id="nsa_flow-1092"><a href="#nsa_flow-1092"><span class="linenos">1092</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="nsa_flow-1093"><a href="#nsa_flow-1093"><span class="linenos">1093</span></a><span class="sd">    NSA-Flow optimization (PyTorch version)</span>
</span><span id="nsa_flow-1094"><a href="#nsa_flow-1094"><span class="linenos">1094</span></a>
</span><span id="nsa_flow-1095"><a href="#nsa_flow-1095"><span class="linenos">1095</span></a><span class="sd">    Parameters</span>
</span><span id="nsa_flow-1096"><a href="#nsa_flow-1096"><span class="linenos">1096</span></a><span class="sd">    ----------</span>
</span><span id="nsa_flow-1097"><a href="#nsa_flow-1097"><span class="linenos">1097</span></a><span class="sd">    Y0 : torch.Tensor</span>
</span><span id="nsa_flow-1098"><a href="#nsa_flow-1098"><span class="linenos">1098</span></a><span class="sd">        Initial matrix (p x k).</span>
</span><span id="nsa_flow-1099"><a href="#nsa_flow-1099"><span class="linenos">1099</span></a><span class="sd">    X0 : torch.Tensor or None</span>
</span><span id="nsa_flow-1100"><a href="#nsa_flow-1100"><span class="linenos">1100</span></a><span class="sd">        Target matrix for fidelity.</span>
</span><span id="nsa_flow-1101"><a href="#nsa_flow-1101"><span class="linenos">1101</span></a><span class="sd">    w : float</span>
</span><span id="nsa_flow-1102"><a href="#nsa_flow-1102"><span class="linenos">1102</span></a><span class="sd">        Weight for orthogonality penalty (0..1).</span>
</span><span id="nsa_flow-1103"><a href="#nsa_flow-1103"><span class="linenos">1103</span></a><span class="sd">    retraction : str</span>
</span><span id="nsa_flow-1104"><a href="#nsa_flow-1104"><span class="linenos">1104</span></a><span class="sd">        Retraction method (&#39;soft_polar&#39;, &#39;polar&#39;, &#39;none&#39;).</span>
</span><span id="nsa_flow-1105"><a href="#nsa_flow-1105"><span class="linenos">1105</span></a><span class="sd">    max_iter : int</span>
</span><span id="nsa_flow-1106"><a href="#nsa_flow-1106"><span class="linenos">1106</span></a><span class="sd">        Maximum iterations.</span>
</span><span id="nsa_flow-1107"><a href="#nsa_flow-1107"><span class="linenos">1107</span></a><span class="sd">    tol : float</span>
</span><span id="nsa_flow-1108"><a href="#nsa_flow-1108"><span class="linenos">1108</span></a><span class="sd">        Convergence tolerance.</span>
</span><span id="nsa_flow-1109"><a href="#nsa_flow-1109"><span class="linenos">1109</span></a><span class="sd">    verbose : bool</span>
</span><span id="nsa_flow-1110"><a href="#nsa_flow-1110"><span class="linenos">1110</span></a><span class="sd">        Print progress if True.</span>
</span><span id="nsa_flow-1111"><a href="#nsa_flow-1111"><span class="linenos">1111</span></a><span class="sd">    seed : int</span>
</span><span id="nsa_flow-1112"><a href="#nsa_flow-1112"><span class="linenos">1112</span></a><span class="sd">        Random seed.</span>
</span><span id="nsa_flow-1113"><a href="#nsa_flow-1113"><span class="linenos">1113</span></a><span class="sd">    apply_nonneg : bool</span>
</span><span id="nsa_flow-1114"><a href="#nsa_flow-1114"><span class="linenos">1114</span></a><span class="sd">        Enforce nonnegativity after each retraction if True.</span>
</span><span id="nsa_flow-1115"><a href="#nsa_flow-1115"><span class="linenos">1115</span></a><span class="sd">    optimizer : str</span>
</span><span id="nsa_flow-1116"><a href="#nsa_flow-1116"><span class="linenos">1116</span></a><span class="sd">        Optimizer to use (&#39;fast&#39; for simple gradient step, or PyTorch optimizers like &#39;asgd&#39;).</span>
</span><span id="nsa_flow-1117"><a href="#nsa_flow-1117"><span class="linenos">1117</span></a><span class="sd">    initial_learning_rate : float or str</span>
</span><span id="nsa_flow-1118"><a href="#nsa_flow-1118"><span class="linenos">1118</span></a><span class="sd">        Learning rate or &#39;default&#39; for auto-estimate.</span>
</span><span id="nsa_flow-1119"><a href="#nsa_flow-1119"><span class="linenos">1119</span></a><span class="sd">    record_every : int</span>
</span><span id="nsa_flow-1120"><a href="#nsa_flow-1120"><span class="linenos">1120</span></a><span class="sd">        Iteration interval for recording traces.</span>
</span><span id="nsa_flow-1121"><a href="#nsa_flow-1121"><span class="linenos">1121</span></a><span class="sd">    window_size : int</span>
</span><span id="nsa_flow-1122"><a href="#nsa_flow-1122"><span class="linenos">1122</span></a><span class="sd">        Energy stability window for convergence check.</span>
</span><span id="nsa_flow-1123"><a href="#nsa_flow-1123"><span class="linenos">1123</span></a><span class="sd">    simplified : bool</span>
</span><span id="nsa_flow-1124"><a href="#nsa_flow-1124"><span class="linenos">1124</span></a><span class="sd">        Use simplified orthogonality objective.</span>
</span><span id="nsa_flow-1125"><a href="#nsa_flow-1125"><span class="linenos">1125</span></a><span class="sd">    project_full_gradient : bool</span>
</span><span id="nsa_flow-1126"><a href="#nsa_flow-1126"><span class="linenos">1126</span></a><span class="sd">        If True, project the full gradient (fidelity + orthogonality) onto the tangent space.</span>
</span><span id="nsa_flow-1127"><a href="#nsa_flow-1127"><span class="linenos">1127</span></a><span class="sd">        If False (default), only project the orthogonality gradient, keeping fidelity as Euclidean.</span>
</span><span id="nsa_flow-1128"><a href="#nsa_flow-1128"><span class="linenos">1128</span></a><span class="sd">    device : torch.device or str or None</span>
</span><span id="nsa_flow-1129"><a href="#nsa_flow-1129"><span class="linenos">1129</span></a><span class="sd">        Device to run on.</span>
</span><span id="nsa_flow-1130"><a href="#nsa_flow-1130"><span class="linenos">1130</span></a><span class="sd">    precision : str</span>
</span><span id="nsa_flow-1131"><a href="#nsa_flow-1131"><span class="linenos">1131</span></a><span class="sd">        Floating point precision (&#39;float32&#39;, &#39;float64&#39;). Default: &#39;float64&#39; for stability.</span>
</span><span id="nsa_flow-1132"><a href="#nsa_flow-1132"><span class="linenos">1132</span></a>
</span><span id="nsa_flow-1133"><a href="#nsa_flow-1133"><span class="linenos">1133</span></a><span class="sd">    Returns</span>
</span><span id="nsa_flow-1134"><a href="#nsa_flow-1134"><span class="linenos">1134</span></a><span class="sd">    -------</span>
</span><span id="nsa_flow-1135"><a href="#nsa_flow-1135"><span class="linenos">1135</span></a><span class="sd">    dict with keys:</span>
</span><span id="nsa_flow-1136"><a href="#nsa_flow-1136"><span class="linenos">1136</span></a><span class="sd">        &#39;Y&#39;, &#39;traces&#39;, &#39;final_iter&#39;, &#39;best_total_energy&#39;, &#39;best_Y_iteration&#39;</span>
</span><span id="nsa_flow-1137"><a href="#nsa_flow-1137"><span class="linenos">1137</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="nsa_flow-1138"><a href="#nsa_flow-1138"><span class="linenos">1138</span></a>
</span><span id="nsa_flow-1139"><a href="#nsa_flow-1139"><span class="linenos">1139</span></a>    <span class="k">if</span> <span class="n">precision</span> <span class="o">==</span> <span class="s1">&#39;float32&#39;</span><span class="p">:</span>
</span><span id="nsa_flow-1140"><a href="#nsa_flow-1140"><span class="linenos">1140</span></a>        <span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float32</span>
</span><span id="nsa_flow-1141"><a href="#nsa_flow-1141"><span class="linenos">1141</span></a>    <span class="k">elif</span> <span class="n">precision</span> <span class="o">==</span> <span class="s1">&#39;float64&#39;</span><span class="p">:</span>
</span><span id="nsa_flow-1142"><a href="#nsa_flow-1142"><span class="linenos">1142</span></a>        <span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float64</span>
</span><span id="nsa_flow-1143"><a href="#nsa_flow-1143"><span class="linenos">1143</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="nsa_flow-1144"><a href="#nsa_flow-1144"><span class="linenos">1144</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported precision: </span><span class="si">{</span><span class="n">precision</span><span class="si">}</span><span class="s2">. Use &#39;float32&#39; or &#39;float64&#39;.&quot;</span><span class="p">)</span>
</span><span id="nsa_flow-1145"><a href="#nsa_flow-1145"><span class="linenos">1145</span></a>    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
</span><span id="nsa_flow-1146"><a href="#nsa_flow-1146"><span class="linenos">1146</span></a>    <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="nsa_flow-1147"><a href="#nsa_flow-1147"><span class="linenos">1147</span></a>        <span class="n">device</span> <span class="o">=</span> <span class="n">Y0</span><span class="o">.</span><span class="n">device</span>
</span><span id="nsa_flow-1148"><a href="#nsa_flow-1148"><span class="linenos">1148</span></a>
</span><span id="nsa_flow-1149"><a href="#nsa_flow-1149"><span class="linenos">1149</span></a>    <span class="n">Y</span> <span class="o">=</span> <span class="n">Y0</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="nsa_flow-1150"><a href="#nsa_flow-1150"><span class="linenos">1150</span></a>    <span class="n">p</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span>
</span><span id="nsa_flow-1151"><a href="#nsa_flow-1151"><span class="linenos">1151</span></a>
</span><span id="nsa_flow-1152"><a href="#nsa_flow-1152"><span class="linenos">1152</span></a>    <span class="k">if</span> <span class="n">X0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="nsa_flow-1153"><a href="#nsa_flow-1153"><span class="linenos">1153</span></a>        <span class="k">if</span> <span class="n">apply_nonneg</span><span class="p">:</span>
</span><span id="nsa_flow-1154"><a href="#nsa_flow-1154"><span class="linenos">1154</span></a>            <span class="n">X0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="nsa_flow-1155"><a href="#nsa_flow-1155"><span class="linenos">1155</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="nsa_flow-1156"><a href="#nsa_flow-1156"><span class="linenos">1156</span></a>            <span class="n">X0</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="nsa_flow-1157"><a href="#nsa_flow-1157"><span class="linenos">1157</span></a>        <span class="n">perturb_scale</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.05</span>
</span><span id="nsa_flow-1158"><a href="#nsa_flow-1158"><span class="linenos">1158</span></a>        <span class="n">Y</span> <span class="o">=</span> <span class="n">Y</span> <span class="o">+</span> <span class="n">perturb_scale</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
</span><span id="nsa_flow-1159"><a href="#nsa_flow-1159"><span class="linenos">1159</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="nsa_flow-1160"><a href="#nsa_flow-1160"><span class="linenos">1160</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Added perturbation to Y0.&quot;</span><span class="p">)</span>
</span><span id="nsa_flow-1161"><a href="#nsa_flow-1161"><span class="linenos">1161</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="nsa_flow-1162"><a href="#nsa_flow-1162"><span class="linenos">1162</span></a>        <span class="n">X0</span> <span class="o">=</span> <span class="n">X0</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="nsa_flow-1163"><a href="#nsa_flow-1163"><span class="linenos">1163</span></a>        <span class="k">if</span> <span class="n">apply_nonneg</span><span class="p">:</span>
</span><span id="nsa_flow-1164"><a href="#nsa_flow-1164"><span class="linenos">1164</span></a>            <span class="n">X0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">X0</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="nsa_flow-1165"><a href="#nsa_flow-1165"><span class="linenos">1165</span></a>        <span class="k">assert</span> <span class="n">X0</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s2">&quot;X0 must match Y0 shape.&quot;</span>
</span><span id="nsa_flow-1166"><a href="#nsa_flow-1166"><span class="linenos">1166</span></a>
</span><span id="nsa_flow-1167"><a href="#nsa_flow-1167"><span class="linenos">1167</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_ortho_terms</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">c_orth</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
</span><span id="nsa_flow-1168"><a href="#nsa_flow-1168"><span class="linenos">1168</span></a>        <span class="n">norm2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="nsa_flow-1169"><a href="#nsa_flow-1169"><span class="linenos">1169</span></a>        <span class="k">if</span> <span class="n">norm2</span> <span class="o">&lt;=</span> <span class="mf">1e-12</span> <span class="ow">or</span> <span class="n">c_orth</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="nsa_flow-1170"><a href="#nsa_flow-1170"><span class="linenos">1170</span></a>            <span class="n">grad_orth</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
</span><span id="nsa_flow-1171"><a href="#nsa_flow-1171"><span class="linenos">1171</span></a>            <span class="k">return</span> <span class="n">grad_orth</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">Y</span><span class="o">.</span><span class="n">device</span><span class="p">),</span> <span class="n">norm2</span>
</span><span id="nsa_flow-1172"><a href="#nsa_flow-1172"><span class="linenos">1172</span></a>
</span><span id="nsa_flow-1173"><a href="#nsa_flow-1173"><span class="linenos">1173</span></a>        <span class="n">S</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Y</span>
</span><span id="nsa_flow-1174"><a href="#nsa_flow-1174"><span class="linenos">1174</span></a>        <span class="n">diagS</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
</span><span id="nsa_flow-1175"><a href="#nsa_flow-1175"><span class="linenos">1175</span></a>        <span class="n">off_f2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">S</span> <span class="o">*</span> <span class="n">S</span><span class="p">)</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">diagS</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="nsa_flow-1176"><a href="#nsa_flow-1176"><span class="linenos">1176</span></a>        <span class="n">defect</span> <span class="o">=</span> <span class="n">off_f2</span> <span class="o">/</span> <span class="p">(</span><span class="n">norm2</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="nsa_flow-1177"><a href="#nsa_flow-1177"><span class="linenos">1177</span></a>
</span><span id="nsa_flow-1178"><a href="#nsa_flow-1178"><span class="linenos">1178</span></a>        <span class="k">if</span> <span class="n">simplified</span><span class="p">:</span>
</span><span id="nsa_flow-1179"><a href="#nsa_flow-1179"><span class="linenos">1179</span></a>            <span class="n">grad_orth</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">c_orth</span> <span class="o">*</span> <span class="p">(</span><span class="n">Y</span> <span class="o">@</span> <span class="p">(</span><span class="n">S</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">diagS</span><span class="p">)))</span>
</span><span id="nsa_flow-1180"><a href="#nsa_flow-1180"><span class="linenos">1180</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="nsa_flow-1181"><a href="#nsa_flow-1181"><span class="linenos">1181</span></a>            <span class="n">Y_S</span> <span class="o">=</span> <span class="n">Y</span> <span class="o">@</span> <span class="n">S</span>
</span><span id="nsa_flow-1182"><a href="#nsa_flow-1182"><span class="linenos">1182</span></a>            <span class="n">Y_diag_scale</span> <span class="o">=</span> <span class="n">Y</span> <span class="o">*</span> <span class="n">diagS</span>
</span><span id="nsa_flow-1183"><a href="#nsa_flow-1183"><span class="linenos">1183</span></a>            <span class="n">term1</span> <span class="o">=</span> <span class="p">(</span><span class="n">Y_S</span> <span class="o">-</span> <span class="n">Y_diag_scale</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">norm2</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="nsa_flow-1184"><a href="#nsa_flow-1184"><span class="linenos">1184</span></a>            <span class="n">term2</span> <span class="o">=</span> <span class="p">(</span><span class="n">defect</span> <span class="o">/</span> <span class="n">norm2</span><span class="p">)</span> <span class="o">*</span> <span class="n">Y</span>
</span><span id="nsa_flow-1185"><a href="#nsa_flow-1185"><span class="linenos">1185</span></a>            <span class="n">grad_orth</span> <span class="o">=</span> <span class="n">c_orth</span> <span class="o">*</span> <span class="p">(</span><span class="n">term1</span> <span class="o">-</span> <span class="n">term2</span><span class="p">)</span>
</span><span id="nsa_flow-1186"><a href="#nsa_flow-1186"><span class="linenos">1186</span></a>        <span class="k">return</span> <span class="n">grad_orth</span><span class="p">,</span> <span class="n">defect</span><span class="p">,</span> <span class="n">norm2</span>
</span><span id="nsa_flow-1187"><a href="#nsa_flow-1187"><span class="linenos">1187</span></a>
</span><span id="nsa_flow-1188"><a href="#nsa_flow-1188"><span class="linenos">1188</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">symm</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
</span><span id="nsa_flow-1189"><a href="#nsa_flow-1189"><span class="linenos">1189</span></a>        <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">A</span> <span class="o">+</span> <span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</span><span id="nsa_flow-1190"><a href="#nsa_flow-1190"><span class="linenos">1190</span></a>
</span><span id="nsa_flow-1191"><a href="#nsa_flow-1191"><span class="linenos">1191</span></a>    <span class="c1"># --- Scaling constants ---</span>
</span><span id="nsa_flow-1192"><a href="#nsa_flow-1192"><span class="linenos">1192</span></a>    <span class="n">g0</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">Y</span> <span class="o">-</span> <span class="n">X0</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="n">k</span><span class="p">)</span>
</span><span id="nsa_flow-1193"><a href="#nsa_flow-1193"><span class="linenos">1193</span></a>    <span class="n">g0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">g0</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">)</span>
</span><span id="nsa_flow-1194"><a href="#nsa_flow-1194"><span class="linenos">1194</span></a>    <span class="n">d0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">defect_fast</span><span class="p">(</span><span class="n">Y</span><span class="p">),</span> <span class="nb">min</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">)</span>
</span><span id="nsa_flow-1195"><a href="#nsa_flow-1195"><span class="linenos">1195</span></a>    <span class="n">fid_eta</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">w</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">g0</span> <span class="o">*</span> <span class="n">p</span> <span class="o">*</span> <span class="n">k</span><span class="p">)</span>
</span><span id="nsa_flow-1196"><a href="#nsa_flow-1196"><span class="linenos">1196</span></a>    <span class="n">c_orth</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">w</span> <span class="o">/</span> <span class="n">d0</span>
</span><span id="nsa_flow-1197"><a href="#nsa_flow-1197"><span class="linenos">1197</span></a>
</span><span id="nsa_flow-1198"><a href="#nsa_flow-1198"><span class="linenos">1198</span></a>    <span class="c1"># --- Learning rate ---</span>
</span><span id="nsa_flow-1199"><a href="#nsa_flow-1199"><span class="linenos">1199</span></a>    <span class="k">if</span> <span class="n">initial_learning_rate</span> <span class="o">==</span> <span class="s2">&quot;default&quot;</span><span class="p">:</span>
</span><span id="nsa_flow-1200"><a href="#nsa_flow-1200"><span class="linenos">1200</span></a>        <span class="n">lr</span> <span class="o">=</span> <span class="mf">1e-3</span> <span class="k">if</span> <span class="n">apply_nonneg</span> <span class="k">else</span> <span class="mf">1.0</span>
</span><span id="nsa_flow-1201"><a href="#nsa_flow-1201"><span class="linenos">1201</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="nsa_flow-1202"><a href="#nsa_flow-1202"><span class="linenos">1202</span></a>        <span class="n">lr</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">initial_learning_rate</span><span class="p">)</span>
</span><span id="nsa_flow-1203"><a href="#nsa_flow-1203"><span class="linenos">1203</span></a>
</span><span id="nsa_flow-1204"><a href="#nsa_flow-1204"><span class="linenos">1204</span></a>    <span class="n">traces</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="nsa_flow-1205"><a href="#nsa_flow-1205"><span class="linenos">1205</span></a>    <span class="n">recent_energies</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="nsa_flow-1206"><a href="#nsa_flow-1206"><span class="linenos">1206</span></a>    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="nsa_flow-1207"><a href="#nsa_flow-1207"><span class="linenos">1207</span></a>
</span><span id="nsa_flow-1208"><a href="#nsa_flow-1208"><span class="linenos">1208</span></a>    <span class="n">best_Y</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="nsa_flow-1209"><a href="#nsa_flow-1209"><span class="linenos">1209</span></a>    <span class="n">best_total_energy</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span>
</span><span id="nsa_flow-1210"><a href="#nsa_flow-1210"><span class="linenos">1210</span></a>    <span class="n">best_Y_iteration</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="nsa_flow-1211"><a href="#nsa_flow-1211"><span class="linenos">1211</span></a>
</span><span id="nsa_flow-1212"><a href="#nsa_flow-1212"><span class="linenos">1212</span></a>    <span class="c1"># --- Initial gradient for relative norm ---</span>
</span><span id="nsa_flow-1213"><a href="#nsa_flow-1213"><span class="linenos">1213</span></a>    <span class="n">grad_fid_init</span> <span class="o">=</span> <span class="o">-</span><span class="n">fid_eta</span> <span class="o">*</span> <span class="p">(</span><span class="n">Y</span> <span class="o">-</span> <span class="n">X0</span><span class="p">)</span>
</span><span id="nsa_flow-1214"><a href="#nsa_flow-1214"><span class="linenos">1214</span></a>    <span class="n">grad_orth_init</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">compute_ortho_terms</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">c_orth</span><span class="p">)</span>
</span><span id="nsa_flow-1215"><a href="#nsa_flow-1215"><span class="linenos">1215</span></a>    <span class="k">if</span> <span class="n">project_full_gradient</span><span class="p">:</span>
</span><span id="nsa_flow-1216"><a href="#nsa_flow-1216"><span class="linenos">1216</span></a>        <span class="n">full_grad_init</span> <span class="o">=</span> <span class="n">grad_fid_init</span> <span class="o">+</span> <span class="n">grad_orth_init</span>
</span><span id="nsa_flow-1217"><a href="#nsa_flow-1217"><span class="linenos">1217</span></a>        <span class="n">sym_term_init</span> <span class="o">=</span> <span class="n">symm</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">full_grad_init</span><span class="p">)</span>
</span><span id="nsa_flow-1218"><a href="#nsa_flow-1218"><span class="linenos">1218</span></a>        <span class="n">rgrad_init</span> <span class="o">=</span> <span class="n">full_grad_init</span> <span class="o">-</span> <span class="n">Y</span> <span class="o">@</span> <span class="n">sym_term_init</span>
</span><span id="nsa_flow-1219"><a href="#nsa_flow-1219"><span class="linenos">1219</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="nsa_flow-1220"><a href="#nsa_flow-1220"><span class="linenos">1220</span></a>        <span class="n">rgrad_fid_init</span> <span class="o">=</span> <span class="n">grad_fid_init</span>
</span><span id="nsa_flow-1221"><a href="#nsa_flow-1221"><span class="linenos">1221</span></a>        <span class="k">if</span> <span class="n">c_orth</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="nsa_flow-1222"><a href="#nsa_flow-1222"><span class="linenos">1222</span></a>            <span class="n">sym_term_orth_init</span> <span class="o">=</span> <span class="n">symm</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">grad_orth_init</span><span class="p">)</span>
</span><span id="nsa_flow-1223"><a href="#nsa_flow-1223"><span class="linenos">1223</span></a>            <span class="n">rgrad_orth_init</span> <span class="o">=</span> <span class="n">grad_orth_init</span> <span class="o">-</span> <span class="n">Y</span> <span class="o">@</span> <span class="n">sym_term_orth_init</span>
</span><span id="nsa_flow-1224"><a href="#nsa_flow-1224"><span class="linenos">1224</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="nsa_flow-1225"><a href="#nsa_flow-1225"><span class="linenos">1225</span></a>            <span class="n">rgrad_orth_init</span> <span class="o">=</span> <span class="n">grad_orth_init</span>
</span><span id="nsa_flow-1226"><a href="#nsa_flow-1226"><span class="linenos">1226</span></a>        <span class="n">rgrad_init</span> <span class="o">=</span> <span class="n">rgrad_fid_init</span> <span class="o">+</span> <span class="n">rgrad_orth_init</span>
</span><span id="nsa_flow-1227"><a href="#nsa_flow-1227"><span class="linenos">1227</span></a>    <span class="n">init_grad_norm</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">rgrad_init</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-8</span>
</span><span id="nsa_flow-1228"><a href="#nsa_flow-1228"><span class="linenos">1228</span></a>
</span><span id="nsa_flow-1229"><a href="#nsa_flow-1229"><span class="linenos">1229</span></a>    <span class="c1"># --- Energy ---</span>
</span><span id="nsa_flow-1230"><a href="#nsa_flow-1230"><span class="linenos">1230</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">nsa_energy</span><span class="p">(</span><span class="n">Vp</span><span class="p">):</span>
</span><span id="nsa_flow-1231"><a href="#nsa_flow-1231"><span class="linenos">1231</span></a>        <span class="n">Vp</span> <span class="o">=</span> <span class="n">nsa_flow_retract_auto</span><span class="p">(</span><span class="n">Vp</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">retraction</span><span class="p">)</span>
</span><span id="nsa_flow-1232"><a href="#nsa_flow-1232"><span class="linenos">1232</span></a>        <span class="k">if</span> <span class="n">apply_nonneg</span><span class="p">:</span>
</span><span id="nsa_flow-1233"><a href="#nsa_flow-1233"><span class="linenos">1233</span></a>            <span class="n">Vp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">Vp</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="nsa_flow-1234"><a href="#nsa_flow-1234"><span class="linenos">1234</span></a>        <span class="n">e</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">fid_eta</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">Vp</span> <span class="o">-</span> <span class="n">X0</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="nsa_flow-1235"><a href="#nsa_flow-1235"><span class="linenos">1235</span></a>        <span class="n">norm2_V</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Vp</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="nsa_flow-1236"><a href="#nsa_flow-1236"><span class="linenos">1236</span></a>        <span class="k">if</span> <span class="n">c_orth</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">norm2_V</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="nsa_flow-1237"><a href="#nsa_flow-1237"><span class="linenos">1237</span></a>            <span class="n">defect</span> <span class="o">=</span> <span class="n">defect_fast</span><span class="p">(</span><span class="n">Vp</span><span class="p">)</span>
</span><span id="nsa_flow-1238"><a href="#nsa_flow-1238"><span class="linenos">1238</span></a>            <span class="n">e</span> <span class="o">=</span> <span class="n">e</span> <span class="o">+</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="n">c_orth</span> <span class="o">*</span> <span class="n">defect</span>
</span><span id="nsa_flow-1239"><a href="#nsa_flow-1239"><span class="linenos">1239</span></a>        <span class="k">return</span> <span class="n">e</span>
</span><span id="nsa_flow-1240"><a href="#nsa_flow-1240"><span class="linenos">1240</span></a>
</span><span id="nsa_flow-1241"><a href="#nsa_flow-1241"><span class="linenos">1241</span></a>    <span class="c1"># --- optimizer setup ---</span>
</span><span id="nsa_flow-1242"><a href="#nsa_flow-1242"><span class="linenos">1242</span></a>    <span class="k">if</span> <span class="n">optimizer</span> <span class="o">==</span> <span class="s2">&quot;fast&quot;</span><span class="p">:</span>
</span><span id="nsa_flow-1243"><a href="#nsa_flow-1243"><span class="linenos">1243</span></a>        <span class="n">opt</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># use manual gradient step</span>
</span><span id="nsa_flow-1244"><a href="#nsa_flow-1244"><span class="linenos">1244</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="nsa_flow-1245"><a href="#nsa_flow-1245"><span class="linenos">1245</span></a>        <span class="n">Y</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="nsa_flow-1246"><a href="#nsa_flow-1246"><span class="linenos">1246</span></a>        <span class="n">opt</span> <span class="o">=</span> <span class="n">get_torch_optimizer</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="p">[</span><span class="n">Y</span><span class="p">],</span> <span class="n">lr</span><span class="p">)</span>
</span><span id="nsa_flow-1247"><a href="#nsa_flow-1247"><span class="linenos">1247</span></a>
</span><span id="nsa_flow-1248"><a href="#nsa_flow-1248"><span class="linenos">1248</span></a>    <span class="c1"># --- Main loop ---</span>
</span><span id="nsa_flow-1249"><a href="#nsa_flow-1249"><span class="linenos">1249</span></a>    <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_iter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="nsa_flow-1250"><a href="#nsa_flow-1250"><span class="linenos">1250</span></a>        <span class="n">grad_fid</span> <span class="o">=</span> <span class="o">-</span><span class="n">fid_eta</span> <span class="o">*</span> <span class="p">(</span><span class="n">Y</span> <span class="o">-</span> <span class="n">X0</span><span class="p">)</span>
</span><span id="nsa_flow-1251"><a href="#nsa_flow-1251"><span class="linenos">1251</span></a>        <span class="n">grad_orth</span><span class="p">,</span> <span class="n">defect_val</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">compute_ortho_terms</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">c_orth</span><span class="p">)</span>
</span><span id="nsa_flow-1252"><a href="#nsa_flow-1252"><span class="linenos">1252</span></a>        <span class="k">if</span> <span class="n">project_full_gradient</span><span class="p">:</span>
</span><span id="nsa_flow-1253"><a href="#nsa_flow-1253"><span class="linenos">1253</span></a>            <span class="n">full_grad</span> <span class="o">=</span> <span class="n">grad_fid</span> <span class="o">+</span> <span class="n">grad_orth</span>
</span><span id="nsa_flow-1254"><a href="#nsa_flow-1254"><span class="linenos">1254</span></a>            <span class="n">sym_term</span> <span class="o">=</span> <span class="n">symm</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">full_grad</span><span class="p">)</span>
</span><span id="nsa_flow-1255"><a href="#nsa_flow-1255"><span class="linenos">1255</span></a>            <span class="n">rgrad</span> <span class="o">=</span> <span class="n">full_grad</span> <span class="o">-</span> <span class="n">Y</span> <span class="o">@</span> <span class="n">sym_term</span>
</span><span id="nsa_flow-1256"><a href="#nsa_flow-1256"><span class="linenos">1256</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="nsa_flow-1257"><a href="#nsa_flow-1257"><span class="linenos">1257</span></a>            <span class="n">rgrad_fid</span> <span class="o">=</span> <span class="n">grad_fid</span>
</span><span id="nsa_flow-1258"><a href="#nsa_flow-1258"><span class="linenos">1258</span></a>            <span class="k">if</span> <span class="n">c_orth</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="nsa_flow-1259"><a href="#nsa_flow-1259"><span class="linenos">1259</span></a>                <span class="n">sym_term_orth</span> <span class="o">=</span> <span class="n">symm</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">grad_orth</span><span class="p">)</span>
</span><span id="nsa_flow-1260"><a href="#nsa_flow-1260"><span class="linenos">1260</span></a>                <span class="n">rgrad_orth</span> <span class="o">=</span> <span class="n">grad_orth</span> <span class="o">-</span> <span class="n">Y</span> <span class="o">@</span> <span class="n">sym_term_orth</span>
</span><span id="nsa_flow-1261"><a href="#nsa_flow-1261"><span class="linenos">1261</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="nsa_flow-1262"><a href="#nsa_flow-1262"><span class="linenos">1262</span></a>                <span class="n">rgrad_orth</span> <span class="o">=</span> <span class="n">grad_orth</span>
</span><span id="nsa_flow-1263"><a href="#nsa_flow-1263"><span class="linenos">1263</span></a>            <span class="n">rgrad</span> <span class="o">=</span> <span class="n">rgrad_fid</span> <span class="o">+</span> <span class="n">rgrad_orth</span>
</span><span id="nsa_flow-1264"><a href="#nsa_flow-1264"><span class="linenos">1264</span></a>
</span><span id="nsa_flow-1265"><a href="#nsa_flow-1265"><span class="linenos">1265</span></a>        <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">rgrad</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">torch</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">rgrad</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
</span><span id="nsa_flow-1266"><a href="#nsa_flow-1266"><span class="linenos">1266</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="nsa_flow-1267"><a href="#nsa_flow-1267"><span class="linenos">1267</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NaN or Inf in gradient; stopping.&quot;</span><span class="p">)</span>
</span><span id="nsa_flow-1268"><a href="#nsa_flow-1268"><span class="linenos">1268</span></a>            <span class="k">break</span>
</span><span id="nsa_flow-1269"><a href="#nsa_flow-1269"><span class="linenos">1269</span></a>
</span><span id="nsa_flow-1270"><a href="#nsa_flow-1270"><span class="linenos">1270</span></a>        <span class="c1"># Compute proposed update before retraction</span>
</span><span id="nsa_flow-1271"><a href="#nsa_flow-1271"><span class="linenos">1271</span></a>        <span class="k">if</span> <span class="n">optimizer</span> <span class="o">==</span> <span class="s2">&quot;fast&quot;</span><span class="p">:</span>
</span><span id="nsa_flow-1272"><a href="#nsa_flow-1272"><span class="linenos">1272</span></a>            <span class="n">Y_proposed</span> <span class="o">=</span> <span class="n">Y</span> <span class="o">-</span> <span class="n">lr</span> <span class="o">*</span> <span class="n">rgrad</span>  <span class="c1"># Reverted to original sign convention</span>
</span><span id="nsa_flow-1273"><a href="#nsa_flow-1273"><span class="linenos">1273</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="nsa_flow-1274"><a href="#nsa_flow-1274"><span class="linenos">1274</span></a>            <span class="n">Y_old</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
</span><span id="nsa_flow-1275"><a href="#nsa_flow-1275"><span class="linenos">1275</span></a>            <span class="n">opt</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
</span><span id="nsa_flow-1276"><a href="#nsa_flow-1276"><span class="linenos">1276</span></a>            <span class="n">Y</span><span class="o">.</span><span class="n">grad</span> <span class="o">=</span> <span class="n">rgrad</span>  <span class="c1"># Set to positive gradient for optimizer to subtract</span>
</span><span id="nsa_flow-1277"><a href="#nsa_flow-1277"><span class="linenos">1277</span></a>            <span class="n">opt</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="nsa_flow-1278"><a href="#nsa_flow-1278"><span class="linenos">1278</span></a>            <span class="n">Y_proposed</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
</span><span id="nsa_flow-1279"><a href="#nsa_flow-1279"><span class="linenos">1279</span></a>            <span class="n">Y</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">Y_old</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># Reset Y to old value (optimizer state remains updated)</span>
</span><span id="nsa_flow-1280"><a href="#nsa_flow-1280"><span class="linenos">1280</span></a>
</span><span id="nsa_flow-1281"><a href="#nsa_flow-1281"><span class="linenos">1281</span></a>        <span class="n">Y_new</span> <span class="o">=</span> <span class="n">nsa_flow_retract_auto</span><span class="p">(</span><span class="n">Y_proposed</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">retraction</span><span class="p">)</span>
</span><span id="nsa_flow-1282"><a href="#nsa_flow-1282"><span class="linenos">1282</span></a>
</span><span id="nsa_flow-1283"><a href="#nsa_flow-1283"><span class="linenos">1283</span></a>        <span class="n">current_energy</span> <span class="o">=</span> <span class="n">nsa_energy</span><span class="p">(</span><span class="n">Y_new</span><span class="p">)</span>
</span><span id="nsa_flow-1284"><a href="#nsa_flow-1284"><span class="linenos">1284</span></a>
</span><span id="nsa_flow-1285"><a href="#nsa_flow-1285"><span class="linenos">1285</span></a>        <span class="c1"># --- Backtracking line search ---</span>
</span><span id="nsa_flow-1286"><a href="#nsa_flow-1286"><span class="linenos">1286</span></a>        <span class="n">alpha</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="nsa_flow-1287"><a href="#nsa_flow-1287"><span class="linenos">1287</span></a>        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="nsa_flow-1288"><a href="#nsa_flow-1288"><span class="linenos">1288</span></a>        <span class="n">max_bt</span> <span class="o">=</span> <span class="mi">20</span>
</span><span id="nsa_flow-1289"><a href="#nsa_flow-1289"><span class="linenos">1289</span></a>        <span class="k">while</span> <span class="n">current_energy</span> <span class="o">&gt;</span> <span class="n">best_total_energy</span> <span class="ow">and</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">max_bt</span><span class="p">:</span>
</span><span id="nsa_flow-1290"><a href="#nsa_flow-1290"><span class="linenos">1290</span></a>            <span class="n">alpha</span> <span class="o">*=</span> <span class="mf">0.5</span>
</span><span id="nsa_flow-1291"><a href="#nsa_flow-1291"><span class="linenos">1291</span></a>            <span class="n">Y_try</span> <span class="o">=</span> <span class="n">best_Y</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span><span class="n">Y_new</span> <span class="o">-</span> <span class="n">best_Y</span><span class="p">)</span>
</span><span id="nsa_flow-1292"><a href="#nsa_flow-1292"><span class="linenos">1292</span></a>            <span class="n">current_energy</span> <span class="o">=</span> <span class="n">nsa_energy</span><span class="p">(</span><span class="n">Y_try</span><span class="p">)</span>
</span><span id="nsa_flow-1293"><a href="#nsa_flow-1293"><span class="linenos">1293</span></a>            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="nsa_flow-1294"><a href="#nsa_flow-1294"><span class="linenos">1294</span></a>            <span class="k">if</span> <span class="n">current_energy</span> <span class="o">&lt;</span> <span class="n">best_total_energy</span><span class="p">:</span>
</span><span id="nsa_flow-1295"><a href="#nsa_flow-1295"><span class="linenos">1295</span></a>                <span class="n">Y_new</span> <span class="o">=</span> <span class="n">nsa_flow_retract_auto</span><span class="p">(</span><span class="n">Y_try</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">retraction</span><span class="p">)</span>
</span><span id="nsa_flow-1296"><a href="#nsa_flow-1296"><span class="linenos">1296</span></a>                <span class="k">break</span>
</span><span id="nsa_flow-1297"><a href="#nsa_flow-1297"><span class="linenos">1297</span></a>
</span><span id="nsa_flow-1298"><a href="#nsa_flow-1298"><span class="linenos">1298</span></a>        <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="n">max_bt</span><span class="p">:</span>
</span><span id="nsa_flow-1299"><a href="#nsa_flow-1299"><span class="linenos">1299</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="nsa_flow-1300"><a href="#nsa_flow-1300"><span class="linenos">1300</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Backtracking failed; reverting to best Y.&quot;</span><span class="p">)</span>
</span><span id="nsa_flow-1301"><a href="#nsa_flow-1301"><span class="linenos">1301</span></a>            <span class="n">Y_new</span> <span class="o">=</span> <span class="n">best_Y</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="nsa_flow-1302"><a href="#nsa_flow-1302"><span class="linenos">1302</span></a>
</span><span id="nsa_flow-1303"><a href="#nsa_flow-1303"><span class="linenos">1303</span></a>        <span class="c1"># Apply nonnegativity after backtracking (to ensure consistency)</span>
</span><span id="nsa_flow-1304"><a href="#nsa_flow-1304"><span class="linenos">1304</span></a>        <span class="k">if</span> <span class="n">apply_nonneg</span><span class="p">:</span>
</span><span id="nsa_flow-1305"><a href="#nsa_flow-1305"><span class="linenos">1305</span></a>            <span class="n">Y_new</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">Y_new</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="nsa_flow-1306"><a href="#nsa_flow-1306"><span class="linenos">1306</span></a>
</span><span id="nsa_flow-1307"><a href="#nsa_flow-1307"><span class="linenos">1307</span></a>        <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="nsa_flow-1308"><a href="#nsa_flow-1308"><span class="linenos">1308</span></a>            <span class="k">if</span> <span class="n">optimizer</span> <span class="o">==</span> <span class="s2">&quot;fast&quot;</span><span class="p">:</span>
</span><span id="nsa_flow-1309"><a href="#nsa_flow-1309"><span class="linenos">1309</span></a>                <span class="n">lr</span> <span class="o">*=</span> <span class="mf">0.95</span>
</span><span id="nsa_flow-1310"><a href="#nsa_flow-1310"><span class="linenos">1310</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="nsa_flow-1311"><a href="#nsa_flow-1311"><span class="linenos">1311</span></a>                <span class="n">opt</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;lr&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="mf">0.95</span>
</span><span id="nsa_flow-1312"><a href="#nsa_flow-1312"><span class="linenos">1312</span></a>        <span class="k">elif</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">it</span> <span class="o">%</span> <span class="mi">5</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="nsa_flow-1313"><a href="#nsa_flow-1313"><span class="linenos">1313</span></a>            <span class="k">if</span> <span class="n">optimizer</span> <span class="o">==</span> <span class="s2">&quot;fast&quot;</span><span class="p">:</span>
</span><span id="nsa_flow-1314"><a href="#nsa_flow-1314"><span class="linenos">1314</span></a>                <span class="n">lr</span> <span class="o">*=</span> <span class="mf">1.01</span>
</span><span id="nsa_flow-1315"><a href="#nsa_flow-1315"><span class="linenos">1315</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="nsa_flow-1316"><a href="#nsa_flow-1316"><span class="linenos">1316</span></a>                <span class="n">opt</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;lr&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="mf">1.01</span>
</span><span id="nsa_flow-1317"><a href="#nsa_flow-1317"><span class="linenos">1317</span></a>
</span><span id="nsa_flow-1318"><a href="#nsa_flow-1318"><span class="linenos">1318</span></a>        <span class="n">Y</span> <span class="o">=</span> <span class="n">Y_new</span>
</span><span id="nsa_flow-1319"><a href="#nsa_flow-1319"><span class="linenos">1319</span></a>
</span><span id="nsa_flow-1320"><a href="#nsa_flow-1320"><span class="linenos">1320</span></a>        <span class="n">fidelity</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">fid_eta</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">Y</span> <span class="o">-</span> <span class="n">X0</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="nsa_flow-1321"><a href="#nsa_flow-1321"><span class="linenos">1321</span></a>        <span class="n">orthogonality</span> <span class="o">=</span> <span class="n">defect_fast</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
</span><span id="nsa_flow-1322"><a href="#nsa_flow-1322"><span class="linenos">1322</span></a>        <span class="n">total_energy</span> <span class="o">=</span> <span class="n">fidelity</span> <span class="o">+</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="n">c_orth</span> <span class="o">*</span> <span class="n">orthogonality</span>
</span><span id="nsa_flow-1323"><a href="#nsa_flow-1323"><span class="linenos">1323</span></a>        <span class="n">dt</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
</span><span id="nsa_flow-1324"><a href="#nsa_flow-1324"><span class="linenos">1324</span></a>
</span><span id="nsa_flow-1325"><a href="#nsa_flow-1325"><span class="linenos">1325</span></a>        <span class="k">if</span> <span class="n">total_energy</span> <span class="o">&lt;</span> <span class="n">best_total_energy</span><span class="p">:</span>
</span><span id="nsa_flow-1326"><a href="#nsa_flow-1326"><span class="linenos">1326</span></a>            <span class="n">best_total_energy</span> <span class="o">=</span> <span class="n">total_energy</span>
</span><span id="nsa_flow-1327"><a href="#nsa_flow-1327"><span class="linenos">1327</span></a>            <span class="n">best_Y</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="nsa_flow-1328"><a href="#nsa_flow-1328"><span class="linenos">1328</span></a>            <span class="n">best_Y_iteration</span> <span class="o">=</span> <span class="n">it</span>
</span><span id="nsa_flow-1329"><a href="#nsa_flow-1329"><span class="linenos">1329</span></a>
</span><span id="nsa_flow-1330"><a href="#nsa_flow-1330"><span class="linenos">1330</span></a>        <span class="n">recent_energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">total_energy</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
</span><span id="nsa_flow-1331"><a href="#nsa_flow-1331"><span class="linenos">1331</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">recent_energies</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">window_size</span><span class="p">:</span>
</span><span id="nsa_flow-1332"><a href="#nsa_flow-1332"><span class="linenos">1332</span></a>            <span class="n">recent_energies</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="nsa_flow-1333"><a href="#nsa_flow-1333"><span class="linenos">1333</span></a>
</span><span id="nsa_flow-1334"><a href="#nsa_flow-1334"><span class="linenos">1334</span></a>        <span class="k">if</span> <span class="n">it</span> <span class="o">%</span> <span class="n">record_every</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="nsa_flow-1335"><a href="#nsa_flow-1335"><span class="linenos">1335</span></a>            <span class="n">traces</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="nsa_flow-1336"><a href="#nsa_flow-1336"><span class="linenos">1336</span></a>                <span class="s2">&quot;iter&quot;</span><span class="p">:</span> <span class="n">it</span><span class="p">,</span>
</span><span id="nsa_flow-1337"><a href="#nsa_flow-1337"><span class="linenos">1337</span></a>                <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">dt</span><span class="p">,</span>
</span><span id="nsa_flow-1338"><a href="#nsa_flow-1338"><span class="linenos">1338</span></a>                <span class="s2">&quot;fidelity&quot;</span><span class="p">:</span> <span class="n">fidelity</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
</span><span id="nsa_flow-1339"><a href="#nsa_flow-1339"><span class="linenos">1339</span></a>                <span class="s2">&quot;orthogonality&quot;</span><span class="p">:</span> <span class="n">orthogonality</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
</span><span id="nsa_flow-1340"><a href="#nsa_flow-1340"><span class="linenos">1340</span></a>                <span class="s2">&quot;total_energy&quot;</span><span class="p">:</span> <span class="n">total_energy</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="nsa_flow-1341"><a href="#nsa_flow-1341"><span class="linenos">1341</span></a>            <span class="p">})</span>
</span><span id="nsa_flow-1342"><a href="#nsa_flow-1342"><span class="linenos">1342</span></a>
</span><span id="nsa_flow-1343"><a href="#nsa_flow-1343"><span class="linenos">1343</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="nsa_flow-1344"><a href="#nsa_flow-1344"><span class="linenos">1344</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Iter </span><span class="si">{</span><span class="n">it</span><span class="si">:</span><span class="s2">3d</span><span class="si">}</span><span class="s2">] Total: </span><span class="si">{</span><span class="n">total_energy</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.6e</span><span class="si">}</span><span class="s2"> | &quot;</span>
</span><span id="nsa_flow-1345"><a href="#nsa_flow-1345"><span class="linenos">1345</span></a>                  <span class="sa">f</span><span class="s2">&quot;Fid: </span><span class="si">{</span><span class="n">fidelity</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.6e</span><span class="si">}</span><span class="s2"> | Orth: </span><span class="si">{</span><span class="n">orthogonality</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.6e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="nsa_flow-1346"><a href="#nsa_flow-1346"><span class="linenos">1346</span></a>
</span><span id="nsa_flow-1347"><a href="#nsa_flow-1347"><span class="linenos">1347</span></a>        <span class="c1"># --- Convergence ---</span>
</span><span id="nsa_flow-1348"><a href="#nsa_flow-1348"><span class="linenos">1348</span></a>        <span class="n">grad_norm</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">rgrad</span><span class="p">)</span>
</span><span id="nsa_flow-1349"><a href="#nsa_flow-1349"><span class="linenos">1349</span></a>        <span class="n">rel_grad_norm</span> <span class="o">=</span> <span class="n">grad_norm</span> <span class="o">/</span> <span class="n">init_grad_norm</span>
</span><span id="nsa_flow-1350"><a href="#nsa_flow-1350"><span class="linenos">1350</span></a>        <span class="k">if</span> <span class="n">rel_grad_norm</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
</span><span id="nsa_flow-1351"><a href="#nsa_flow-1351"><span class="linenos">1351</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="nsa_flow-1352"><a href="#nsa_flow-1352"><span class="linenos">1352</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converged at iter </span><span class="si">{</span><span class="n">it</span><span class="si">}</span><span class="s2"> (grad norm &lt; </span><span class="si">{</span><span class="n">tol</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="nsa_flow-1353"><a href="#nsa_flow-1353"><span class="linenos">1353</span></a>            <span class="k">break</span>
</span><span id="nsa_flow-1354"><a href="#nsa_flow-1354"><span class="linenos">1354</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">recent_energies</span><span class="p">)</span> <span class="o">==</span> <span class="n">window_size</span><span class="p">:</span>
</span><span id="nsa_flow-1355"><a href="#nsa_flow-1355"><span class="linenos">1355</span></a>            <span class="n">e_max</span><span class="p">,</span> <span class="n">e_min</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">recent_energies</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">recent_energies</span><span class="p">)</span>
</span><span id="nsa_flow-1356"><a href="#nsa_flow-1356"><span class="linenos">1356</span></a>            <span class="n">e_avg</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">recent_energies</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">recent_energies</span><span class="p">)</span>
</span><span id="nsa_flow-1357"><a href="#nsa_flow-1357"><span class="linenos">1357</span></a>            <span class="n">rel_var</span> <span class="o">=</span> <span class="p">(</span><span class="n">e_max</span> <span class="o">-</span> <span class="n">e_min</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">e_avg</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-12</span><span class="p">)</span>
</span><span id="nsa_flow-1358"><a href="#nsa_flow-1358"><span class="linenos">1358</span></a>            <span class="k">if</span> <span class="n">rel_var</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
</span><span id="nsa_flow-1359"><a href="#nsa_flow-1359"><span class="linenos">1359</span></a>                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="nsa_flow-1360"><a href="#nsa_flow-1360"><span class="linenos">1360</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converged at iter </span><span class="si">{</span><span class="n">it</span><span class="si">}</span><span class="s2"> (energy stable &lt; </span><span class="si">{</span><span class="n">tol</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="nsa_flow-1361"><a href="#nsa_flow-1361"><span class="linenos">1361</span></a>                <span class="k">break</span>
</span><span id="nsa_flow-1362"><a href="#nsa_flow-1362"><span class="linenos">1362</span></a>
</span><span id="nsa_flow-1363"><a href="#nsa_flow-1363"><span class="linenos">1363</span></a>    <span class="n">zz</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">traces</span><span class="p">)</span>
</span><span id="nsa_flow-1364"><a href="#nsa_flow-1364"><span class="linenos">1364</span></a>    <span class="n">traces</span> <span class="o">=</span> <span class="n">traces_to_dataframe</span><span class="p">(</span><span class="n">traces</span><span class="p">)</span>
</span><span id="nsa_flow-1365"><a href="#nsa_flow-1365"><span class="linenos">1365</span></a>    <span class="k">return</span> <span class="p">{</span>
</span><span id="nsa_flow-1366"><a href="#nsa_flow-1366"><span class="linenos">1366</span></a>        <span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="n">best_Y</span><span class="p">,</span>
</span><span id="nsa_flow-1367"><a href="#nsa_flow-1367"><span class="linenos">1367</span></a>        <span class="s2">&quot;traces&quot;</span><span class="p">:</span> <span class="n">traces</span><span class="p">,</span>
</span><span id="nsa_flow-1368"><a href="#nsa_flow-1368"><span class="linenos">1368</span></a>        <span class="s2">&quot;final_iter&quot;</span><span class="p">:</span> <span class="n">zz</span><span class="p">,</span>
</span><span id="nsa_flow-1369"><a href="#nsa_flow-1369"><span class="linenos">1369</span></a>        <span class="s2">&quot;best_total_energy&quot;</span><span class="p">:</span> <span class="n">best_total_energy</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
</span><span id="nsa_flow-1370"><a href="#nsa_flow-1370"><span class="linenos">1370</span></a>        <span class="s2">&quot;best_Y_iteration&quot;</span><span class="p">:</span> <span class="n">best_Y_iteration</span><span class="p">,</span>
</span><span id="nsa_flow-1371"><a href="#nsa_flow-1371"><span class="linenos">1371</span></a>        <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="n">X0</span>
</span><span id="nsa_flow-1372"><a href="#nsa_flow-1372"><span class="linenos">1372</span></a>    <span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>NSA-Flow optimization (PyTorch version)</p>

<h2 id="parameters">Parameters</h2>

<p>Y0 : torch.Tensor
    Initial matrix (p x k).
X0 : torch.Tensor or None
    Target matrix for fidelity.
w : float
    Weight for orthogonality penalty (0..1).
retraction : str
    Retraction method ('soft_polar', 'polar', 'none').
max_iter : int
    Maximum iterations.
tol : float
    Convergence tolerance.
verbose : bool
    Print progress if True.
seed : int
    Random seed.
apply_nonneg : bool
    Enforce nonnegativity after each retraction if True.
optimizer : str
    Optimizer to use ('fast' for simple gradient step, or PyTorch optimizers like 'asgd').
initial_learning_rate : float or str
    Learning rate or 'default' for auto-estimate.
record_every : int
    Iteration interval for recording traces.
window_size : int
    Energy stability window for convergence check.
simplified : bool
    Use simplified orthogonality objective.
project_full_gradient : bool
    If True, project the full gradient (fidelity + orthogonality) onto the tangent space.
    If False (default), only project the orthogonality gradient, keeping fidelity as Euclidean.
device : torch.device or str or None
    Device to run on.
precision : str
    Floating point precision ('float32', 'float64'). Default: 'float64' for stability.</p>

<h2 id="returns">Returns</h2>

<p>dict with keys:
    'Y', 'traces', 'final_iter', 'best_total_energy', 'best_Y_iteration'</p>
</div>


                </section>
                <section id="nsa_flow_retract_auto">
                            <input id="nsa_flow_retract_auto-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">nsa_flow_retract_auto</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">Y</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>,</span><span class="param">	<span class="n">w_retract</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>,</span><span class="param">	<span class="n">retraction_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;soft_polar&#39;</span>,</span><span class="param">	<span class="n">eps_rf</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-06</span>,</span><span class="param">	<span class="n">max_condition</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10000.0</span>,</span><span class="param">	<span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">) -> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>:</span></span>

                <label class="view-source-button" for="nsa_flow_retract_auto-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#nsa_flow_retract_auto"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="nsa_flow_retract_auto-742"><a href="#nsa_flow_retract_auto-742"><span class="linenos">742</span></a><span class="k">def</span><span class="w"> </span><span class="nf">nsa_flow_retract_auto</span><span class="p">(</span>
</span><span id="nsa_flow_retract_auto-743"><a href="#nsa_flow_retract_auto-743"><span class="linenos">743</span></a>    <span class="n">Y</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
</span><span id="nsa_flow_retract_auto-744"><a href="#nsa_flow_retract_auto-744"><span class="linenos">744</span></a>    <span class="n">w_retract</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="nsa_flow_retract_auto-745"><a href="#nsa_flow_retract_auto-745"><span class="linenos">745</span></a>    <span class="n">retraction_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;soft_polar&quot;</span><span class="p">,</span>
</span><span id="nsa_flow_retract_auto-746"><a href="#nsa_flow_retract_auto-746"><span class="linenos">746</span></a>    <span class="n">eps_rf</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-6</span><span class="p">,</span>
</span><span id="nsa_flow_retract_auto-747"><a href="#nsa_flow_retract_auto-747"><span class="linenos">747</span></a>    <span class="n">max_condition</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e4</span><span class="p">,</span>
</span><span id="nsa_flow_retract_auto-748"><a href="#nsa_flow_retract_auto-748"><span class="linenos">748</span></a>    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="nsa_flow_retract_auto-749"><a href="#nsa_flow_retract_auto-749"><span class="linenos">749</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
</span><span id="nsa_flow_retract_auto-750"><a href="#nsa_flow_retract_auto-750"><span class="linenos">750</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="nsa_flow_retract_auto-751"><a href="#nsa_flow_retract_auto-751"><span class="linenos">751</span></a><span class="sd">    Differentiable retraction for NSA-Flow layers.</span>
</span><span id="nsa_flow_retract_auto-752"><a href="#nsa_flow_retract_auto-752"><span class="linenos">752</span></a><span class="sd">    Removes X0 dependency, stabilizes SVD gradients, and preserves centering.</span>
</span><span id="nsa_flow_retract_auto-753"><a href="#nsa_flow_retract_auto-753"><span class="linenos">753</span></a>
</span><span id="nsa_flow_retract_auto-754"><a href="#nsa_flow_retract_auto-754"><span class="linenos">754</span></a><span class="sd">    Parameters</span>
</span><span id="nsa_flow_retract_auto-755"><a href="#nsa_flow_retract_auto-755"><span class="linenos">755</span></a><span class="sd">    ----------</span>
</span><span id="nsa_flow_retract_auto-756"><a href="#nsa_flow_retract_auto-756"><span class="linenos">756</span></a><span class="sd">    Y : torch.Tensor</span>
</span><span id="nsa_flow_retract_auto-757"><a href="#nsa_flow_retract_auto-757"><span class="linenos">757</span></a><span class="sd">        Input tensor of shape (p, k)</span>
</span><span id="nsa_flow_retract_auto-758"><a href="#nsa_flow_retract_auto-758"><span class="linenos">758</span></a><span class="sd">    w_retract : float or torch.Tensor</span>
</span><span id="nsa_flow_retract_auto-759"><a href="#nsa_flow_retract_auto-759"><span class="linenos">759</span></a><span class="sd">        Blending weight (tensor-safe, differentiable)</span>
</span><span id="nsa_flow_retract_auto-760"><a href="#nsa_flow_retract_auto-760"><span class="linenos">760</span></a><span class="sd">    retraction_type : str</span>
</span><span id="nsa_flow_retract_auto-761"><a href="#nsa_flow_retract_auto-761"><span class="linenos">761</span></a><span class="sd">        One of [&quot;soft_polar&quot;, &quot;polar&quot;, &quot;normalize&quot;]</span>
</span><span id="nsa_flow_retract_auto-762"><a href="#nsa_flow_retract_auto-762"><span class="linenos">762</span></a><span class="sd">    eps_rf : float</span>
</span><span id="nsa_flow_retract_auto-763"><a href="#nsa_flow_retract_auto-763"><span class="linenos">763</span></a><span class="sd">        Epsilon for numerical stability (added to singular values)</span>
</span><span id="nsa_flow_retract_auto-764"><a href="#nsa_flow_retract_auto-764"><span class="linenos">764</span></a><span class="sd">    max_condition : float</span>
</span><span id="nsa_flow_retract_auto-765"><a href="#nsa_flow_retract_auto-765"><span class="linenos">765</span></a><span class="sd">        Singular value clipping threshold</span>
</span><span id="nsa_flow_retract_auto-766"><a href="#nsa_flow_retract_auto-766"><span class="linenos">766</span></a><span class="sd">    verbose : bool</span>
</span><span id="nsa_flow_retract_auto-767"><a href="#nsa_flow_retract_auto-767"><span class="linenos">767</span></a><span class="sd">        Print diagnostics</span>
</span><span id="nsa_flow_retract_auto-768"><a href="#nsa_flow_retract_auto-768"><span class="linenos">768</span></a>
</span><span id="nsa_flow_retract_auto-769"><a href="#nsa_flow_retract_auto-769"><span class="linenos">769</span></a><span class="sd">    Returns</span>
</span><span id="nsa_flow_retract_auto-770"><a href="#nsa_flow_retract_auto-770"><span class="linenos">770</span></a><span class="sd">    -------</span>
</span><span id="nsa_flow_retract_auto-771"><a href="#nsa_flow_retract_auto-771"><span class="linenos">771</span></a><span class="sd">    torch.Tensor : Differentiable retraction result, same shape as Y.</span>
</span><span id="nsa_flow_retract_auto-772"><a href="#nsa_flow_retract_auto-772"><span class="linenos">772</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="nsa_flow_retract_auto-773"><a href="#nsa_flow_retract_auto-773"><span class="linenos">773</span></a>
</span><span id="nsa_flow_retract_auto-774"><a href="#nsa_flow_retract_auto-774"><span class="linenos">774</span></a>    <span class="c1"># Ensure type/device consistency</span>
</span><span id="nsa_flow_retract_auto-775"><a href="#nsa_flow_retract_auto-775"><span class="linenos">775</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">w_retract</span><span class="p">):</span>
</span><span id="nsa_flow_retract_auto-776"><a href="#nsa_flow_retract_auto-776"><span class="linenos">776</span></a>        <span class="n">w_retract</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">w_retract</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">Y</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">Y</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="nsa_flow_retract_auto-777"><a href="#nsa_flow_retract_auto-777"><span class="linenos">777</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="nsa_flow_retract_auto-778"><a href="#nsa_flow_retract_auto-778"><span class="linenos">778</span></a>        <span class="n">w_retract</span> <span class="o">=</span> <span class="n">w_retract</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">Y</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">Y</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="nsa_flow_retract_auto-779"><a href="#nsa_flow_retract_auto-779"><span class="linenos">779</span></a>
</span><span id="nsa_flow_retract_auto-780"><a href="#nsa_flow_retract_auto-780"><span class="linenos">780</span></a>    <span class="c1"># Handle degenerate case</span>
</span><span id="nsa_flow_retract_auto-781"><a href="#nsa_flow_retract_auto-781"><span class="linenos">781</span></a>    <span class="n">normY</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
</span><span id="nsa_flow_retract_auto-782"><a href="#nsa_flow_retract_auto-782"><span class="linenos">782</span></a>    <span class="k">if</span> <span class="n">normY</span> <span class="o">&lt;</span> <span class="mf">1e-12</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">normY</span><span class="p">):</span>
</span><span id="nsa_flow_retract_auto-783"><a href="#nsa_flow_retract_auto-783"><span class="linenos">783</span></a>        <span class="k">return</span> <span class="n">Y</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="nsa_flow_retract_auto-784"><a href="#nsa_flow_retract_auto-784"><span class="linenos">784</span></a>
</span><span id="nsa_flow_retract_auto-785"><a href="#nsa_flow_retract_auto-785"><span class="linenos">785</span></a>    <span class="c1"># Center for numerical stability</span>
</span><span id="nsa_flow_retract_auto-786"><a href="#nsa_flow_retract_auto-786"><span class="linenos">786</span></a>    <span class="n">Y_mean</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="nsa_flow_retract_auto-787"><a href="#nsa_flow_retract_auto-787"><span class="linenos">787</span></a>    <span class="n">Y_centered</span> <span class="o">=</span> <span class="n">Y</span> <span class="o">-</span> <span class="n">Y_mean</span>
</span><span id="nsa_flow_retract_auto-788"><a href="#nsa_flow_retract_auto-788"><span class="linenos">788</span></a>
</span><span id="nsa_flow_retract_auto-789"><a href="#nsa_flow_retract_auto-789"><span class="linenos">789</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="nsa_flow_retract_auto-790"><a href="#nsa_flow_retract_auto-790"><span class="linenos">790</span></a>        <span class="k">if</span> <span class="n">retraction_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;soft_polar&quot;</span><span class="p">,</span> <span class="s2">&quot;polar&quot;</span><span class="p">]:</span>
</span><span id="nsa_flow_retract_auto-791"><a href="#nsa_flow_retract_auto-791"><span class="linenos">791</span></a>            <span class="c1"># Differentiable SVD</span>
</span><span id="nsa_flow_retract_auto-792"><a href="#nsa_flow_retract_auto-792"><span class="linenos">792</span></a>            <span class="n">U</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">Vh</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">Y_centered</span><span class="p">,</span> <span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="nsa_flow_retract_auto-793"><a href="#nsa_flow_retract_auto-793"><span class="linenos">793</span></a>
</span><span id="nsa_flow_retract_auto-794"><a href="#nsa_flow_retract_auto-794"><span class="linenos">794</span></a>            <span class="c1"># Clamp singular values</span>
</span><span id="nsa_flow_retract_auto-795"><a href="#nsa_flow_retract_auto-795"><span class="linenos">795</span></a>            <span class="n">S_clamped</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="n">eps_rf</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="n">max_condition</span><span class="p">)</span>
</span><span id="nsa_flow_retract_auto-796"><a href="#nsa_flow_retract_auto-796"><span class="linenos">796</span></a>
</span><span id="nsa_flow_retract_auto-797"><a href="#nsa_flow_retract_auto-797"><span class="linenos">797</span></a>            <span class="c1"># Polar orthogonalization</span>
</span><span id="nsa_flow_retract_auto-798"><a href="#nsa_flow_retract_auto-798"><span class="linenos">798</span></a>            <span class="n">Y_polar</span> <span class="o">=</span> <span class="n">U</span> <span class="o">@</span> <span class="n">Vh</span>
</span><span id="nsa_flow_retract_auto-799"><a href="#nsa_flow_retract_auto-799"><span class="linenos">799</span></a>
</span><span id="nsa_flow_retract_auto-800"><a href="#nsa_flow_retract_auto-800"><span class="linenos">800</span></a>            <span class="k">if</span> <span class="n">retraction_type</span> <span class="o">==</span> <span class="s2">&quot;soft_polar&quot;</span><span class="p">:</span>
</span><span id="nsa_flow_retract_auto-801"><a href="#nsa_flow_retract_auto-801"><span class="linenos">801</span></a>                <span class="n">Y_re_centered</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">w_retract</span><span class="p">)</span> <span class="o">*</span> <span class="n">Y_centered</span> <span class="o">+</span> <span class="n">w_retract</span> <span class="o">*</span> <span class="n">Y_polar</span>
</span><span id="nsa_flow_retract_auto-802"><a href="#nsa_flow_retract_auto-802"><span class="linenos">802</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="nsa_flow_retract_auto-803"><a href="#nsa_flow_retract_auto-803"><span class="linenos">803</span></a>                <span class="n">Y_re_centered</span> <span class="o">=</span> <span class="n">Y_polar</span>
</span><span id="nsa_flow_retract_auto-804"><a href="#nsa_flow_retract_auto-804"><span class="linenos">804</span></a>
</span><span id="nsa_flow_retract_auto-805"><a href="#nsa_flow_retract_auto-805"><span class="linenos">805</span></a>            <span class="c1"># Preserve scale</span>
</span><span id="nsa_flow_retract_auto-806"><a href="#nsa_flow_retract_auto-806"><span class="linenos">806</span></a>            <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">normY</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">Y_re_centered</span><span class="p">)</span><span class="o">.</span><span class="n">clamp_min</span><span class="p">(</span><span class="mf">1e-12</span><span class="p">)</span>
</span><span id="nsa_flow_retract_auto-807"><a href="#nsa_flow_retract_auto-807"><span class="linenos">807</span></a>            <span class="n">Y_re_centered</span> <span class="o">=</span> <span class="n">Y_re_centered</span> <span class="o">*</span> <span class="n">scale_factor</span>
</span><span id="nsa_flow_retract_auto-808"><a href="#nsa_flow_retract_auto-808"><span class="linenos">808</span></a>
</span><span id="nsa_flow_retract_auto-809"><a href="#nsa_flow_retract_auto-809"><span class="linenos">809</span></a>        <span class="k">elif</span> <span class="n">retraction_type</span> <span class="o">==</span> <span class="s2">&quot;normalize&quot;</span><span class="p">:</span>
</span><span id="nsa_flow_retract_auto-810"><a href="#nsa_flow_retract_auto-810"><span class="linenos">810</span></a>            <span class="n">norms</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">Y_centered</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">clamp_min</span><span class="p">(</span><span class="n">eps_rf</span><span class="p">)</span>
</span><span id="nsa_flow_retract_auto-811"><a href="#nsa_flow_retract_auto-811"><span class="linenos">811</span></a>            <span class="n">Y_re_centered</span> <span class="o">=</span> <span class="n">Y_centered</span> <span class="o">/</span> <span class="n">norms</span>
</span><span id="nsa_flow_retract_auto-812"><a href="#nsa_flow_retract_auto-812"><span class="linenos">812</span></a>
</span><span id="nsa_flow_retract_auto-813"><a href="#nsa_flow_retract_auto-813"><span class="linenos">813</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="nsa_flow_retract_auto-814"><a href="#nsa_flow_retract_auto-814"><span class="linenos">814</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown retraction_type: </span><span class="si">{</span><span class="n">retraction_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="nsa_flow_retract_auto-815"><a href="#nsa_flow_retract_auto-815"><span class="linenos">815</span></a>
</span><span id="nsa_flow_retract_auto-816"><a href="#nsa_flow_retract_auto-816"><span class="linenos">816</span></a>        <span class="c1"># De-center to original mean space</span>
</span><span id="nsa_flow_retract_auto-817"><a href="#nsa_flow_retract_auto-817"><span class="linenos">817</span></a>        <span class="n">Y_re</span> <span class="o">=</span> <span class="n">Y_re_centered</span> <span class="o">+</span> <span class="n">Y_mean</span>
</span><span id="nsa_flow_retract_auto-818"><a href="#nsa_flow_retract_auto-818"><span class="linenos">818</span></a>
</span><span id="nsa_flow_retract_auto-819"><a href="#nsa_flow_retract_auto-819"><span class="linenos">819</span></a>        <span class="c1"># Safety check</span>
</span><span id="nsa_flow_retract_auto-820"><a href="#nsa_flow_retract_auto-820"><span class="linenos">820</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">Y_re</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
</span><span id="nsa_flow_retract_auto-821"><a href="#nsa_flow_retract_auto-821"><span class="linenos">821</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="nsa_flow_retract_auto-822"><a href="#nsa_flow_retract_auto-822"><span class="linenos">822</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; nsa_flow_retract_auto: non-finite values detected; reverting to input.&quot;</span><span class="p">)</span>
</span><span id="nsa_flow_retract_auto-823"><a href="#nsa_flow_retract_auto-823"><span class="linenos">823</span></a>            <span class="n">Y_re</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="nsa_flow_retract_auto-824"><a href="#nsa_flow_retract_auto-824"><span class="linenos">824</span></a>
</span><span id="nsa_flow_retract_auto-825"><a href="#nsa_flow_retract_auto-825"><span class="linenos">825</span></a>        <span class="k">return</span> <span class="n">Y_re</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">Y</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">Y</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="nsa_flow_retract_auto-826"><a href="#nsa_flow_retract_auto-826"><span class="linenos">826</span></a>
</span><span id="nsa_flow_retract_auto-827"><a href="#nsa_flow_retract_auto-827"><span class="linenos">827</span></a>    <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="nsa_flow_retract_auto-828"><a href="#nsa_flow_retract_auto-828"><span class="linenos">828</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="nsa_flow_retract_auto-829"><a href="#nsa_flow_retract_auto-829"><span class="linenos">829</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Retraction fallback due to: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="nsa_flow_retract_auto-830"><a href="#nsa_flow_retract_auto-830"><span class="linenos">830</span></a>        <span class="k">return</span> <span class="n">Y</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Differentiable retraction for NSA-Flow layers.
Removes X0 dependency, stabilizes SVD gradients, and preserves centering.</p>

<h2 id="parameters">Parameters</h2>

<p>Y : torch.Tensor
    Input tensor of shape (p, k)
w_retract : float or torch.Tensor
    Blending weight (tensor-safe, differentiable)
retraction_type : str
    One of ["soft_polar", "polar", "normalize"]
eps_rf : float
    Epsilon for numerical stability (added to singular values)
max_condition : float
    Singular value clipping threshold
verbose : bool
    Print diagnostics</p>

<h2 id="returns">Returns</h2>

<p>torch.Tensor : Differentiable retraction result, same shape as Y.</p>
</div>


                </section>
                <section id="inv_sqrt_sym_adaptive">
                            <input id="inv_sqrt_sym_adaptive-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">inv_sqrt_sym_adaptive</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">YtY</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>,</span><span class="param">	<span class="n">epsilon</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-08</span>,</span><span class="param">	<span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;eig&#39;</span>,</span><span class="param">	<span class="n">ns_iter</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span>,</span><span class="param">	<span class="n">eig_thresh</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">128</span>,</span><span class="param">	<span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">) -> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>:</span></span>

                <label class="view-source-button" for="inv_sqrt_sym_adaptive-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#inv_sqrt_sym_adaptive"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="inv_sqrt_sym_adaptive-690"><a href="#inv_sqrt_sym_adaptive-690"><span class="linenos">690</span></a><span class="k">def</span><span class="w"> </span><span class="nf">inv_sqrt_sym_adaptive</span><span class="p">(</span><span class="n">YtY</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
</span><span id="inv_sqrt_sym_adaptive-691"><a href="#inv_sqrt_sym_adaptive-691"><span class="linenos">691</span></a>                          <span class="n">epsilon</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-8</span><span class="p">,</span>
</span><span id="inv_sqrt_sym_adaptive-692"><a href="#inv_sqrt_sym_adaptive-692"><span class="linenos">692</span></a>                          <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;eig&quot;</span><span class="p">,</span>
</span><span id="inv_sqrt_sym_adaptive-693"><a href="#inv_sqrt_sym_adaptive-693"><span class="linenos">693</span></a>                          <span class="n">ns_iter</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
</span><span id="inv_sqrt_sym_adaptive-694"><a href="#inv_sqrt_sym_adaptive-694"><span class="linenos">694</span></a>                          <span class="n">eig_thresh</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
</span><span id="inv_sqrt_sym_adaptive-695"><a href="#inv_sqrt_sym_adaptive-695"><span class="linenos">695</span></a>                          <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
</span><span id="inv_sqrt_sym_adaptive-696"><a href="#inv_sqrt_sym_adaptive-696"><span class="linenos">696</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="inv_sqrt_sym_adaptive-697"><a href="#inv_sqrt_sym_adaptive-697"><span class="linenos">697</span></a><span class="sd">    Adaptive inverse-square-root for symmetric positive-definite matrix YtY.</span>
</span><span id="inv_sqrt_sym_adaptive-698"><a href="#inv_sqrt_sym_adaptive-698"><span class="linenos">698</span></a><span class="sd">    method: &quot;eig&quot; | &quot;ns&quot; | &quot;diag&quot; | &quot;auto&quot;</span>
</span><span id="inv_sqrt_sym_adaptive-699"><a href="#inv_sqrt_sym_adaptive-699"><span class="linenos">699</span></a><span class="sd">     - &quot;eig&quot;: eigendecomposition</span>
</span><span id="inv_sqrt_sym_adaptive-700"><a href="#inv_sqrt_sym_adaptive-700"><span class="linenos">700</span></a><span class="sd">     - &quot;ns&quot;: Newton-Schulz</span>
</span><span id="inv_sqrt_sym_adaptive-701"><a href="#inv_sqrt_sym_adaptive-701"><span class="linenos">701</span></a><span class="sd">     - &quot;diag&quot;: diagonal fallback</span>
</span><span id="inv_sqrt_sym_adaptive-702"><a href="#inv_sqrt_sym_adaptive-702"><span class="linenos">702</span></a><span class="sd">     - &quot;auto&quot;: choose based on dimension heuristics (k &lt;= eig_thresh =&gt; eig, else ns)</span>
</span><span id="inv_sqrt_sym_adaptive-703"><a href="#inv_sqrt_sym_adaptive-703"><span class="linenos">703</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="inv_sqrt_sym_adaptive-704"><a href="#inv_sqrt_sym_adaptive-704"><span class="linenos">704</span></a>    <span class="n">k</span> <span class="o">=</span> <span class="n">YtY</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="inv_sqrt_sym_adaptive-705"><a href="#inv_sqrt_sym_adaptive-705"><span class="linenos">705</span></a>    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
</span><span id="inv_sqrt_sym_adaptive-706"><a href="#inv_sqrt_sym_adaptive-706"><span class="linenos">706</span></a>        <span class="k">if</span> <span class="n">k</span> <span class="o">&lt;=</span> <span class="n">eig_thresh</span><span class="p">:</span>
</span><span id="inv_sqrt_sym_adaptive-707"><a href="#inv_sqrt_sym_adaptive-707"><span class="linenos">707</span></a>            <span class="n">method_use</span> <span class="o">=</span> <span class="s2">&quot;eig&quot;</span>
</span><span id="inv_sqrt_sym_adaptive-708"><a href="#inv_sqrt_sym_adaptive-708"><span class="linenos">708</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="inv_sqrt_sym_adaptive-709"><a href="#inv_sqrt_sym_adaptive-709"><span class="linenos">709</span></a>            <span class="n">method_use</span> <span class="o">=</span> <span class="s2">&quot;ns&quot;</span>
</span><span id="inv_sqrt_sym_adaptive-710"><a href="#inv_sqrt_sym_adaptive-710"><span class="linenos">710</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="inv_sqrt_sym_adaptive-711"><a href="#inv_sqrt_sym_adaptive-711"><span class="linenos">711</span></a>        <span class="n">method_use</span> <span class="o">=</span> <span class="n">method</span>
</span><span id="inv_sqrt_sym_adaptive-712"><a href="#inv_sqrt_sym_adaptive-712"><span class="linenos">712</span></a>
</span><span id="inv_sqrt_sym_adaptive-713"><a href="#inv_sqrt_sym_adaptive-713"><span class="linenos">713</span></a>    <span class="k">if</span> <span class="n">method_use</span> <span class="o">==</span> <span class="s2">&quot;eig&quot;</span><span class="p">:</span>
</span><span id="inv_sqrt_sym_adaptive-714"><a href="#inv_sqrt_sym_adaptive-714"><span class="linenos">714</span></a>        <span class="k">return</span> <span class="n">_inv_sqrt_eig</span><span class="p">(</span><span class="n">YtY</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="n">epsilon</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
</span><span id="inv_sqrt_sym_adaptive-715"><a href="#inv_sqrt_sym_adaptive-715"><span class="linenos">715</span></a>    <span class="k">elif</span> <span class="n">method_use</span> <span class="o">==</span> <span class="s2">&quot;ns&quot;</span><span class="p">:</span>
</span><span id="inv_sqrt_sym_adaptive-716"><a href="#inv_sqrt_sym_adaptive-716"><span class="linenos">716</span></a>        <span class="c1"># try Newton-Schulz; if it fails (e.g. nan/inf), fallback to eig</span>
</span><span id="inv_sqrt_sym_adaptive-717"><a href="#inv_sqrt_sym_adaptive-717"><span class="linenos">717</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="inv_sqrt_sym_adaptive-718"><a href="#inv_sqrt_sym_adaptive-718"><span class="linenos">718</span></a>            <span class="n">T</span> <span class="o">=</span> <span class="n">_inv_sqrt_newton_schulz</span><span class="p">(</span><span class="n">YtY</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="n">epsilon</span><span class="p">,</span> <span class="n">ns_iter</span><span class="o">=</span><span class="n">ns_iter</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
</span><span id="inv_sqrt_sym_adaptive-719"><a href="#inv_sqrt_sym_adaptive-719"><span class="linenos">719</span></a>            <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
</span><span id="inv_sqrt_sym_adaptive-720"><a href="#inv_sqrt_sym_adaptive-720"><span class="linenos">720</span></a>                <span class="k">return</span> <span class="n">T</span>
</span><span id="inv_sqrt_sym_adaptive-721"><a href="#inv_sqrt_sym_adaptive-721"><span class="linenos">721</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="inv_sqrt_sym_adaptive-722"><a href="#inv_sqrt_sym_adaptive-722"><span class="linenos">722</span></a>                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="inv_sqrt_sym_adaptive-723"><a href="#inv_sqrt_sym_adaptive-723"><span class="linenos">723</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Newton-Schulz produced non-finite entries; falling back to eig.&quot;</span><span class="p">)</span>
</span><span id="inv_sqrt_sym_adaptive-724"><a href="#inv_sqrt_sym_adaptive-724"><span class="linenos">724</span></a>                <span class="k">return</span> <span class="n">_inv_sqrt_eig</span><span class="p">(</span><span class="n">YtY</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="n">epsilon</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
</span><span id="inv_sqrt_sym_adaptive-725"><a href="#inv_sqrt_sym_adaptive-725"><span class="linenos">725</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="inv_sqrt_sym_adaptive-726"><a href="#inv_sqrt_sym_adaptive-726"><span class="linenos">726</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="inv_sqrt_sym_adaptive-727"><a href="#inv_sqrt_sym_adaptive-727"><span class="linenos">727</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Newton-Schulz error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">; falling back to eig.&quot;</span><span class="p">)</span>
</span><span id="inv_sqrt_sym_adaptive-728"><a href="#inv_sqrt_sym_adaptive-728"><span class="linenos">728</span></a>            <span class="k">return</span> <span class="n">_inv_sqrt_eig</span><span class="p">(</span><span class="n">YtY</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="n">epsilon</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
</span><span id="inv_sqrt_sym_adaptive-729"><a href="#inv_sqrt_sym_adaptive-729"><span class="linenos">729</span></a>    <span class="k">elif</span> <span class="n">method_use</span> <span class="o">==</span> <span class="s2">&quot;diag&quot;</span><span class="p">:</span>
</span><span id="inv_sqrt_sym_adaptive-730"><a href="#inv_sqrt_sym_adaptive-730"><span class="linenos">730</span></a>        <span class="k">return</span> <span class="n">_inv_sqrt_diag</span><span class="p">(</span><span class="n">YtY</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="n">epsilon</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
</span><span id="inv_sqrt_sym_adaptive-731"><a href="#inv_sqrt_sym_adaptive-731"><span class="linenos">731</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="inv_sqrt_sym_adaptive-732"><a href="#inv_sqrt_sym_adaptive-732"><span class="linenos">732</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown inv sqrt method: </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Adaptive inverse-square-root for symmetric positive-definite matrix YtY.
method: "eig" | "ns" | "diag" | "auto"</p>

<ul>
<li>"eig": eigendecomposition</li>
<li>"ns": Newton-Schulz</li>
<li>"diag": diagonal fallback</li>
<li>"auto": choose based on dimension heuristics (k &lt;= eig_thresh =&gt; eig, else ns)</li>
</ul>
</div>


                </section>
                <section id="invariant_orthogonality_defect">
                            <input id="invariant_orthogonality_defect-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">invariant_orthogonality_defect</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">V</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="invariant_orthogonality_defect-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#invariant_orthogonality_defect"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="invariant_orthogonality_defect-85"><a href="#invariant_orthogonality_defect-85"><span class="linenos">85</span></a><span class="k">def</span><span class="w"> </span><span class="nf">invariant_orthogonality_defect</span><span class="p">(</span><span class="n">V</span><span class="p">):</span>
</span><span id="invariant_orthogonality_defect-86"><a href="#invariant_orthogonality_defect-86"><span class="linenos">86</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Scale-invariant orthogonality defect.&quot;&quot;&quot;</span>
</span><span id="invariant_orthogonality_defect-87"><a href="#invariant_orthogonality_defect-87"><span class="linenos">87</span></a>    <span class="n">norm2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">V</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="invariant_orthogonality_defect-88"><a href="#invariant_orthogonality_defect-88"><span class="linenos">88</span></a>    <span class="k">if</span> <span class="n">norm2</span> <span class="o">&lt;=</span> <span class="mf">1e-12</span><span class="p">:</span>
</span><span id="invariant_orthogonality_defect-89"><a href="#invariant_orthogonality_defect-89"><span class="linenos">89</span></a>        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">V</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">V</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="invariant_orthogonality_defect-90"><a href="#invariant_orthogonality_defect-90"><span class="linenos">90</span></a>    <span class="n">S</span> <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">V</span>
</span><span id="invariant_orthogonality_defect-91"><a href="#invariant_orthogonality_defect-91"><span class="linenos">91</span></a>    <span class="n">diagS</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
</span><span id="invariant_orthogonality_defect-92"><a href="#invariant_orthogonality_defect-92"><span class="linenos">92</span></a>    <span class="n">off_f2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">S</span> <span class="o">*</span> <span class="n">S</span><span class="p">)</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">diagS</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="invariant_orthogonality_defect-93"><a href="#invariant_orthogonality_defect-93"><span class="linenos">93</span></a>    <span class="k">return</span> <span class="n">off_f2</span> <span class="o">/</span> <span class="p">(</span><span class="n">norm2</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Scale-invariant orthogonality defect.</p>
</div>


                </section>
                <section id="energy_fidelity">
                            <input id="energy_fidelity-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">energy_fidelity</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">M</span>, </span><span class="param"><span class="n">Xc</span>, </span><span class="param"><span class="n">w</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="energy_fidelity-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#energy_fidelity"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="energy_fidelity-736"><a href="#energy_fidelity-736"><span class="linenos">736</span></a><span class="k">def</span><span class="w"> </span><span class="nf">energy_fidelity</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">Xc</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
</span><span id="energy_fidelity-737"><a href="#energy_fidelity-737"><span class="linenos">737</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Smooth fidelity energy used for autograd (no prox).&quot;&quot;&quot;</span>
</span><span id="energy_fidelity-738"><a href="#energy_fidelity-738"><span class="linenos">738</span></a>    <span class="n">n</span> <span class="o">=</span> <span class="n">Xc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="energy_fidelity-739"><a href="#energy_fidelity-739"><span class="linenos">739</span></a>    <span class="c1"># negative sign to match original formulation (we minimize energy = -fid + prox)</span>
</span><span id="energy_fidelity-740"><a href="#energy_fidelity-740"><span class="linenos">740</span></a>    <span class="k">return</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">w</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">Xc</span> <span class="o">@</span> <span class="n">M</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span>
</span></pre></div>


            <div class="docstring"><p>Smooth fidelity energy used for autograd (no prox).</p>
</div>


                </section>
                <section id="get_torch_optimizer">
                            <input id="get_torch_optimizer-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_torch_optimizer</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">opt_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">params</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">lr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.001</span>,</span><span class="param">	<span class="n">return_list</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="get_torch_optimizer-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#get_torch_optimizer"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="get_torch_optimizer-261"><a href="#get_torch_optimizer-261"><span class="linenos">261</span></a><span class="k">def</span><span class="w"> </span><span class="nf">get_torch_optimizer</span><span class="p">(</span><span class="n">opt_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="n">return_list</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="get_torch_optimizer-262"><a href="#get_torch_optimizer-262"><span class="linenos">262</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="get_torch_optimizer-263"><a href="#get_torch_optimizer-263"><span class="linenos">263</span></a><span class="sd">    Returns a PyTorch optimizer instance based on the provided name,</span>
</span><span id="get_torch_optimizer-264"><a href="#get_torch_optimizer-264"><span class="linenos">264</span></a><span class="sd">    or lists all available optimizers if return_list=True.</span>
</span><span id="get_torch_optimizer-265"><a href="#get_torch_optimizer-265"><span class="linenos">265</span></a>
</span><span id="get_torch_optimizer-266"><a href="#get_torch_optimizer-266"><span class="linenos">266</span></a><span class="sd">    Supports optimizers from both torch.optim and (optionally) torch_optimizer.</span>
</span><span id="get_torch_optimizer-267"><a href="#get_torch_optimizer-267"><span class="linenos">267</span></a>
</span><span id="get_torch_optimizer-268"><a href="#get_torch_optimizer-268"><span class="linenos">268</span></a><span class="sd">    Args:</span>
</span><span id="get_torch_optimizer-269"><a href="#get_torch_optimizer-269"><span class="linenos">269</span></a><span class="sd">        opt_name (str, optional): Name of the optimizer (case-insensitive).</span>
</span><span id="get_torch_optimizer-270"><a href="#get_torch_optimizer-270"><span class="linenos">270</span></a><span class="sd">        params: Model parameters to optimize.</span>
</span><span id="get_torch_optimizer-271"><a href="#get_torch_optimizer-271"><span class="linenos">271</span></a><span class="sd">        lr (float): Learning rate.</span>
</span><span id="get_torch_optimizer-272"><a href="#get_torch_optimizer-272"><span class="linenos">272</span></a><span class="sd">        return_list (bool): If True, return a list of available optimizer names.</span>
</span><span id="get_torch_optimizer-273"><a href="#get_torch_optimizer-273"><span class="linenos">273</span></a><span class="sd">        **kwargs: Additional arguments to pass to the optimizer.</span>
</span><span id="get_torch_optimizer-274"><a href="#get_torch_optimizer-274"><span class="linenos">274</span></a>
</span><span id="get_torch_optimizer-275"><a href="#get_torch_optimizer-275"><span class="linenos">275</span></a><span class="sd">    Returns:</span>
</span><span id="get_torch_optimizer-276"><a href="#get_torch_optimizer-276"><span class="linenos">276</span></a><span class="sd">        optimizer (torch.optim.Optimizer) or list[str]:</span>
</span><span id="get_torch_optimizer-277"><a href="#get_torch_optimizer-277"><span class="linenos">277</span></a><span class="sd">            - If return_list=False (default): an optimizer instance.</span>
</span><span id="get_torch_optimizer-278"><a href="#get_torch_optimizer-278"><span class="linenos">278</span></a><span class="sd">            - If return_list=True: sorted list of available optimizer names.</span>
</span><span id="get_torch_optimizer-279"><a href="#get_torch_optimizer-279"><span class="linenos">279</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="get_torch_optimizer-280"><a href="#get_torch_optimizer-280"><span class="linenos">280</span></a>    <span class="c1"># --- Base PyTorch optimizers ---</span>
</span><span id="get_torch_optimizer-281"><a href="#get_torch_optimizer-281"><span class="linenos">281</span></a>    <span class="n">optimizers</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="get_torch_optimizer-282"><a href="#get_torch_optimizer-282"><span class="linenos">282</span></a>        <span class="s2">&quot;adam&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">lr</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span>
</span><span id="get_torch_optimizer-283"><a href="#get_torch_optimizer-283"><span class="linenos">283</span></a>        <span class="s2">&quot;adamw&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">lr</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span>
</span><span id="get_torch_optimizer-284"><a href="#get_torch_optimizer-284"><span class="linenos">284</span></a>        <span class="s2">&quot;sgd&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">lr</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span>
</span><span id="get_torch_optimizer-285"><a href="#get_torch_optimizer-285"><span class="linenos">285</span></a>        <span class="s2">&quot;sgd_nesterov&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">lr</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">nesterov</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span>
</span><span id="get_torch_optimizer-286"><a href="#get_torch_optimizer-286"><span class="linenos">286</span></a>        <span class="s2">&quot;rmsprop&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">lr</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">RMSprop</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span>
</span><span id="get_torch_optimizer-287"><a href="#get_torch_optimizer-287"><span class="linenos">287</span></a>        <span class="s2">&quot;adagrad&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">lr</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adagrad</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span>
</span><span id="get_torch_optimizer-288"><a href="#get_torch_optimizer-288"><span class="linenos">288</span></a><span class="c1">#        &quot;lbfgs&quot;: lambda p, lr: torch.optim.LBFGS(p, lr=lr, max_iter=10, **kwargs),</span>
</span><span id="get_torch_optimizer-289"><a href="#get_torch_optimizer-289"><span class="linenos">289</span></a>        <span class="s2">&quot;adamax&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">lr</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adamax</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span>
</span><span id="get_torch_optimizer-290"><a href="#get_torch_optimizer-290"><span class="linenos">290</span></a>        <span class="s2">&quot;asgd&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">lr</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">ASGD</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span>
</span><span id="get_torch_optimizer-291"><a href="#get_torch_optimizer-291"><span class="linenos">291</span></a>        <span class="s2">&quot;nadam&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">lr</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">NAdam</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span>
</span><span id="get_torch_optimizer-292"><a href="#get_torch_optimizer-292"><span class="linenos">292</span></a>        <span class="s2">&quot;radam&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">lr</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">RAdam</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span>
</span><span id="get_torch_optimizer-293"><a href="#get_torch_optimizer-293"><span class="linenos">293</span></a>        <span class="s2">&quot;rprop&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">lr</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Rprop</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span>
</span><span id="get_torch_optimizer-294"><a href="#get_torch_optimizer-294"><span class="linenos">294</span></a>    <span class="p">}</span>
</span><span id="get_torch_optimizer-295"><a href="#get_torch_optimizer-295"><span class="linenos">295</span></a>
</span><span id="get_torch_optimizer-296"><a href="#get_torch_optimizer-296"><span class="linenos">296</span></a>    <span class="c1"># --- Optionally extend with torch_optimizer if available ---</span>
</span><span id="get_torch_optimizer-297"><a href="#get_torch_optimizer-297"><span class="linenos">297</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="get_torch_optimizer-298"><a href="#get_torch_optimizer-298"><span class="linenos">298</span></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">torch_optimizer</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">optimx</span>
</span><span id="get_torch_optimizer-299"><a href="#get_torch_optimizer-299"><span class="linenos">299</span></a>
</span><span id="get_torch_optimizer-300"><a href="#get_torch_optimizer-300"><span class="linenos">300</span></a>        <span class="n">extra_opts</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="get_torch_optimizer-301"><a href="#get_torch_optimizer-301"><span class="linenos">301</span></a>            <span class="s2">&quot;lars&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">lr</span><span class="p">:</span> <span class="n">optimx</span><span class="o">.</span><span class="n">LARS</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span>
</span><span id="get_torch_optimizer-302"><a href="#get_torch_optimizer-302"><span class="linenos">302</span></a>            <span class="s2">&quot;yogi&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">lr</span><span class="p">:</span> <span class="n">optimx</span><span class="o">.</span><span class="n">Yogi</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span>
</span><span id="get_torch_optimizer-303"><a href="#get_torch_optimizer-303"><span class="linenos">303</span></a>            <span class="s2">&quot;adabound&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">lr</span><span class="p">:</span> <span class="n">optimx</span><span class="o">.</span><span class="n">AdaBound</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span>
</span><span id="get_torch_optimizer-304"><a href="#get_torch_optimizer-304"><span class="linenos">304</span></a>            <span class="s2">&quot;qhadam&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">lr</span><span class="p">:</span> <span class="n">optimx</span><span class="o">.</span><span class="n">QHAdam</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span>
</span><span id="get_torch_optimizer-305"><a href="#get_torch_optimizer-305"><span class="linenos">305</span></a>            <span class="s2">&quot;pid&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">lr</span><span class="p">:</span> <span class="n">optimx</span><span class="o">.</span><span class="n">PID</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span>
</span><span id="get_torch_optimizer-306"><a href="#get_torch_optimizer-306"><span class="linenos">306</span></a>            <span class="s2">&quot;qhm&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">lr</span><span class="p">:</span> <span class="n">optimx</span><span class="o">.</span><span class="n">QHM</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span>
</span><span id="get_torch_optimizer-307"><a href="#get_torch_optimizer-307"><span class="linenos">307</span></a>            <span class="s2">&quot;adamp&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">lr</span><span class="p">:</span> <span class="n">optimx</span><span class="o">.</span><span class="n">AdamP</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span>
</span><span id="get_torch_optimizer-308"><a href="#get_torch_optimizer-308"><span class="linenos">308</span></a>            <span class="s2">&quot;sgdp&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">lr</span><span class="p">:</span> <span class="n">optimx</span><span class="o">.</span><span class="n">SGDP</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span>
</span><span id="get_torch_optimizer-309"><a href="#get_torch_optimizer-309"><span class="linenos">309</span></a>            <span class="s2">&quot;lookahead&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">lr</span><span class="p">:</span> <span class="n">optimx</span><span class="o">.</span><span class="n">Lookahead</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)),</span>
</span><span id="get_torch_optimizer-310"><a href="#get_torch_optimizer-310"><span class="linenos">310</span></a>        <span class="p">}</span>
</span><span id="get_torch_optimizer-311"><a href="#get_torch_optimizer-311"><span class="linenos">311</span></a>        <span class="n">optimizers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">extra_opts</span><span class="p">)</span>
</span><span id="get_torch_optimizer-312"><a href="#get_torch_optimizer-312"><span class="linenos">312</span></a>
</span><span id="get_torch_optimizer-313"><a href="#get_torch_optimizer-313"><span class="linenos">313</span></a>    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
</span><span id="get_torch_optimizer-314"><a href="#get_torch_optimizer-314"><span class="linenos">314</span></a>        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;torch_optimizer not installed. Skipping extra optimizers.&quot;</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">)</span>
</span><span id="get_torch_optimizer-315"><a href="#get_torch_optimizer-315"><span class="linenos">315</span></a>
</span><span id="get_torch_optimizer-316"><a href="#get_torch_optimizer-316"><span class="linenos">316</span></a>    <span class="c1"># --- Return the list of available optimizers if requested ---</span>
</span><span id="get_torch_optimizer-317"><a href="#get_torch_optimizer-317"><span class="linenos">317</span></a>    <span class="k">if</span> <span class="n">return_list</span><span class="p">:</span>
</span><span id="get_torch_optimizer-318"><a href="#get_torch_optimizer-318"><span class="linenos">318</span></a>        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">optimizers</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="get_torch_optimizer-319"><a href="#get_torch_optimizer-319"><span class="linenos">319</span></a>
</span><span id="get_torch_optimizer-320"><a href="#get_torch_optimizer-320"><span class="linenos">320</span></a>    <span class="c1"># --- Otherwise, construct the requested optimizer ---</span>
</span><span id="get_torch_optimizer-321"><a href="#get_torch_optimizer-321"><span class="linenos">321</span></a>    <span class="k">if</span> <span class="n">opt_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="get_torch_optimizer-322"><a href="#get_torch_optimizer-322"><span class="linenos">322</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You must specify `opt_name` unless `return_list=True`.&quot;</span><span class="p">)</span>
</span><span id="get_torch_optimizer-323"><a href="#get_torch_optimizer-323"><span class="linenos">323</span></a>
</span><span id="get_torch_optimizer-324"><a href="#get_torch_optimizer-324"><span class="linenos">324</span></a>    <span class="n">name</span> <span class="o">=</span> <span class="n">opt_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="get_torch_optimizer-325"><a href="#get_torch_optimizer-325"><span class="linenos">325</span></a>    <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">optimizers</span><span class="p">:</span>
</span><span id="get_torch_optimizer-326"><a href="#get_torch_optimizer-326"><span class="linenos">326</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="get_torch_optimizer-327"><a href="#get_torch_optimizer-327"><span class="linenos">327</span></a>            <span class="sa">f</span><span class="s2">&quot;Unsupported optimizer: &#39;</span><span class="si">{</span><span class="n">opt_name</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
</span><span id="get_torch_optimizer-328"><a href="#get_torch_optimizer-328"><span class="linenos">328</span></a>            <span class="sa">f</span><span class="s2">&quot;Supported options: </span><span class="si">{</span><span class="nb">sorted</span><span class="p">(</span><span class="n">optimizers</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="get_torch_optimizer-329"><a href="#get_torch_optimizer-329"><span class="linenos">329</span></a>        <span class="p">)</span>
</span><span id="get_torch_optimizer-330"><a href="#get_torch_optimizer-330"><span class="linenos">330</span></a>
</span><span id="get_torch_optimizer-331"><a href="#get_torch_optimizer-331"><span class="linenos">331</span></a>    <span class="k">return</span> <span class="n">optimizers</span><span class="p">[</span><span class="n">name</span><span class="p">](</span><span class="n">params</span><span class="p">,</span> <span class="n">lr</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Returns a PyTorch optimizer instance based on the provided name,
or lists all available optimizers if return_list=True.</p>

<p>Supports optimizers from both torch.optim and (optionally) torch_optimizer.</p>

<p>Args:
    opt_name (str, optional): Name of the optimizer (case-insensitive).
    params: Model parameters to optimize.
    lr (float): Learning rate.
    return_list (bool): If True, return a list of available optimizer names.
    **kwargs: Additional arguments to pass to the optimizer.</p>

<p>Returns:
    optimizer (torch.optim.Optimizer) or list[str]:
        - If return_list=False (default): an optimizer instance.
        - If return_list=True: sorted list of available optimizer names.</p>
</div>


                </section>
                <section id="defect_fast">
                            <input id="defect_fast-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">defect_fast</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">V</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="defect_fast-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#defect_fast"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="defect_fast-96"><a href="#defect_fast-96"><span class="linenos">96</span></a><span class="k">def</span><span class="w"> </span><span class="nf">defect_fast</span><span class="p">(</span><span class="n">V</span><span class="p">):</span>
</span><span id="defect_fast-97"><a href="#defect_fast-97"><span class="linenos">97</span></a>    <span class="k">return</span> <span class="n">invariant_orthogonality_defect</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
</span></pre></div>


    

                </section>
                <section id="plot_nsa_trace">
                            <input id="plot_nsa_trace-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plot_nsa_trace</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">trace_df</span>, </span><span class="param"><span class="n">retraction</span><span class="o">=</span><span class="s1">&#39;soft_polar&#39;</span>, </span><span class="param"><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="plot_nsa_trace-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#plot_nsa_trace"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="plot_nsa_trace-224"><a href="#plot_nsa_trace-224"><span class="linenos">224</span></a><span class="k">def</span><span class="w"> </span><span class="nf">plot_nsa_trace</span><span class="p">(</span><span class="n">trace_df</span><span class="p">,</span> <span class="n">retraction</span><span class="o">=</span><span class="s2">&quot;soft_polar&quot;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">5</span><span class="p">)):</span>
</span><span id="plot_nsa_trace-225"><a href="#plot_nsa_trace-225"><span class="linenos">225</span></a>    <span class="n">fig</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
</span><span id="plot_nsa_trace-226"><a href="#plot_nsa_trace-226"><span class="linenos">226</span></a>
</span><span id="plot_nsa_trace-227"><a href="#plot_nsa_trace-227"><span class="linenos">227</span></a>    <span class="n">color_fid</span> <span class="o">=</span> <span class="s2">&quot;#1f78b4&quot;</span>      <span class="c1"># Fidelity (blue)</span>
</span><span id="plot_nsa_trace-228"><a href="#plot_nsa_trace-228"><span class="linenos">228</span></a>    <span class="n">color_orth</span> <span class="o">=</span> <span class="s2">&quot;#33a02c&quot;</span>     <span class="c1"># Orthogonality (green)</span>
</span><span id="plot_nsa_trace-229"><a href="#plot_nsa_trace-229"><span class="linenos">229</span></a>
</span><span id="plot_nsa_trace-230"><a href="#plot_nsa_trace-230"><span class="linenos">230</span></a>    <span class="c1"># Compute ratio for scaling the secondary y-axis</span>
</span><span id="plot_nsa_trace-231"><a href="#plot_nsa_trace-231"><span class="linenos">231</span></a>    <span class="n">max_fid</span> <span class="o">=</span> <span class="n">trace_df</span><span class="p">[</span><span class="s2">&quot;fidelity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</span><span id="plot_nsa_trace-232"><a href="#plot_nsa_trace-232"><span class="linenos">232</span></a>    <span class="n">max_orth</span> <span class="o">=</span> <span class="n">trace_df</span><span class="p">[</span><span class="s2">&quot;orthogonality&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</span><span id="plot_nsa_trace-233"><a href="#plot_nsa_trace-233"><span class="linenos">233</span></a>    <span class="n">ratio</span> <span class="o">=</span> <span class="n">max_fid</span> <span class="o">/</span> <span class="n">max_orth</span> <span class="k">if</span> <span class="n">max_orth</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">1.0</span>
</span><span id="plot_nsa_trace-234"><a href="#plot_nsa_trace-234"><span class="linenos">234</span></a>
</span><span id="plot_nsa_trace-235"><a href="#plot_nsa_trace-235"><span class="linenos">235</span></a>    <span class="c1"># Left axis: fidelity</span>
</span><span id="plot_nsa_trace-236"><a href="#plot_nsa_trace-236"><span class="linenos">236</span></a>    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">trace_df</span><span class="p">[</span><span class="s2">&quot;iter&quot;</span><span class="p">],</span> <span class="n">trace_df</span><span class="p">[</span><span class="s2">&quot;fidelity&quot;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">color_fid</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Fidelity&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="plot_nsa_trace-237"><a href="#plot_nsa_trace-237"><span class="linenos">237</span></a>    <span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">trace_df</span><span class="p">[</span><span class="s2">&quot;iter&quot;</span><span class="p">],</span> <span class="n">trace_df</span><span class="p">[</span><span class="s2">&quot;fidelity&quot;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">color_fid</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
</span><span id="plot_nsa_trace-238"><a href="#plot_nsa_trace-238"><span class="linenos">238</span></a>    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Iteration&quot;</span><span class="p">)</span>
</span><span id="plot_nsa_trace-239"><a href="#plot_nsa_trace-239"><span class="linenos">239</span></a>    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Fidelity Energy&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color_fid</span><span class="p">)</span>
</span><span id="plot_nsa_trace-240"><a href="#plot_nsa_trace-240"><span class="linenos">240</span></a>    <span class="n">ax1</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">labelcolor</span><span class="o">=</span><span class="n">color_fid</span><span class="p">)</span>
</span><span id="plot_nsa_trace-241"><a href="#plot_nsa_trace-241"><span class="linenos">241</span></a>
</span><span id="plot_nsa_trace-242"><a href="#plot_nsa_trace-242"><span class="linenos">242</span></a>    <span class="c1"># Right axis: orthogonality (scaled)</span>
</span><span id="plot_nsa_trace-243"><a href="#plot_nsa_trace-243"><span class="linenos">243</span></a>    <span class="n">ax2</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
</span><span id="plot_nsa_trace-244"><a href="#plot_nsa_trace-244"><span class="linenos">244</span></a>    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">trace_df</span><span class="p">[</span><span class="s2">&quot;iter&quot;</span><span class="p">],</span> <span class="n">trace_df</span><span class="p">[</span><span class="s2">&quot;orthogonality&quot;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">color_orth</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Orthogonality&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="plot_nsa_trace-245"><a href="#plot_nsa_trace-245"><span class="linenos">245</span></a>    <span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">trace_df</span><span class="p">[</span><span class="s2">&quot;iter&quot;</span><span class="p">],</span> <span class="n">trace_df</span><span class="p">[</span><span class="s2">&quot;orthogonality&quot;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">color_orth</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
</span><span id="plot_nsa_trace-246"><a href="#plot_nsa_trace-246"><span class="linenos">246</span></a>    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Orthogonality Defect&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color_orth</span><span class="p">)</span>
</span><span id="plot_nsa_trace-247"><a href="#plot_nsa_trace-247"><span class="linenos">247</span></a>    <span class="n">ax2</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">labelcolor</span><span class="o">=</span><span class="n">color_orth</span><span class="p">)</span>
</span><span id="plot_nsa_trace-248"><a href="#plot_nsa_trace-248"><span class="linenos">248</span></a>
</span><span id="plot_nsa_trace-249"><a href="#plot_nsa_trace-249"><span class="linenos">249</span></a>    <span class="c1"># Title and grid</span>
</span><span id="plot_nsa_trace-250"><a href="#plot_nsa_trace-250"><span class="linenos">250</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NSA-Flow Optimization Trace: </span><span class="si">{</span><span class="n">retraction</span><span class="si">}</span><span class="se">\n</span><span class="s2">Fidelity and Orthogonality (Dual Scales)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
</span><span id="plot_nsa_trace-251"><a href="#plot_nsa_trace-251"><span class="linenos">251</span></a>    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
</span><span id="plot_nsa_trace-252"><a href="#plot_nsa_trace-252"><span class="linenos">252</span></a>
</span><span id="plot_nsa_trace-253"><a href="#plot_nsa_trace-253"><span class="linenos">253</span></a>    <span class="c1"># Combine legends from both axes</span>
</span><span id="plot_nsa_trace-254"><a href="#plot_nsa_trace-254"><span class="linenos">254</span></a>    <span class="n">lines</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
</span><span id="plot_nsa_trace-255"><a href="#plot_nsa_trace-255"><span class="linenos">255</span></a>    <span class="n">lines2</span><span class="p">,</span> <span class="n">labels2</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
</span><span id="plot_nsa_trace-256"><a href="#plot_nsa_trace-256"><span class="linenos">256</span></a>    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">lines</span> <span class="o">+</span> <span class="n">lines2</span><span class="p">,</span> <span class="n">labels</span> <span class="o">+</span> <span class="n">labels2</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="plot_nsa_trace-257"><a href="#plot_nsa_trace-257"><span class="linenos">257</span></a>
</span><span id="plot_nsa_trace-258"><a href="#plot_nsa_trace-258"><span class="linenos">258</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="plot_nsa_trace-259"><a href="#plot_nsa_trace-259"><span class="linenos">259</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></pre></div>


    

                </section>
                <section id="estimate_learning_rate_for_nsa_flow">
                            <input id="estimate_learning_rate_for_nsa_flow-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">estimate_learning_rate_for_nsa_flow</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">Y0</span>,</span><span class="param">	<span class="n">X0</span>,</span><span class="param">	<span class="n">w</span><span class="o">=</span><span class="mf">0.5</span>,</span><span class="param">	<span class="n">retraction</span><span class="o">=</span><span class="s1">&#39;soft_polar&#39;</span>,</span><span class="param">	<span class="n">fid_eta</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">c_orth</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">apply_nonneg</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;armijo&#39;</span>,</span><span class="param">	<span class="n">aggression</span><span class="o">=</span><span class="mf">0.5</span>,</span><span class="param">	<span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">plot</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">fidelity_type</span><span class="o">=</span><span class="s1">&#39;scale_invariant&#39;</span>,</span><span class="param">	<span class="n">orth_type</span><span class="o">=</span><span class="s1">&#39;scale_invariant&#39;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="estimate_learning_rate_for_nsa_flow-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#estimate_learning_rate_for_nsa_flow"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="estimate_learning_rate_for_nsa_flow-333"><a href="#estimate_learning_rate_for_nsa_flow-333"><span class="linenos">333</span></a><span class="k">def</span><span class="w"> </span><span class="nf">estimate_learning_rate_for_nsa_flow</span><span class="p">(</span>
</span><span id="estimate_learning_rate_for_nsa_flow-334"><a href="#estimate_learning_rate_for_nsa_flow-334"><span class="linenos">334</span></a>    <span class="n">Y0</span><span class="p">,</span>
</span><span id="estimate_learning_rate_for_nsa_flow-335"><a href="#estimate_learning_rate_for_nsa_flow-335"><span class="linenos">335</span></a>    <span class="n">X0</span><span class="p">,</span>
</span><span id="estimate_learning_rate_for_nsa_flow-336"><a href="#estimate_learning_rate_for_nsa_flow-336"><span class="linenos">336</span></a>    <span class="n">w</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
</span><span id="estimate_learning_rate_for_nsa_flow-337"><a href="#estimate_learning_rate_for_nsa_flow-337"><span class="linenos">337</span></a>    <span class="n">retraction</span><span class="o">=</span><span class="s2">&quot;soft_polar&quot;</span><span class="p">,</span>
</span><span id="estimate_learning_rate_for_nsa_flow-338"><a href="#estimate_learning_rate_for_nsa_flow-338"><span class="linenos">338</span></a>    <span class="n">fid_eta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="estimate_learning_rate_for_nsa_flow-339"><a href="#estimate_learning_rate_for_nsa_flow-339"><span class="linenos">339</span></a>    <span class="n">c_orth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="estimate_learning_rate_for_nsa_flow-340"><a href="#estimate_learning_rate_for_nsa_flow-340"><span class="linenos">340</span></a>    <span class="n">apply_nonneg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="estimate_learning_rate_for_nsa_flow-341"><a href="#estimate_learning_rate_for_nsa_flow-341"><span class="linenos">341</span></a>    <span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;armijo&quot;</span><span class="p">,</span>
</span><span id="estimate_learning_rate_for_nsa_flow-342"><a href="#estimate_learning_rate_for_nsa_flow-342"><span class="linenos">342</span></a>    <span class="n">aggression</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
</span><span id="estimate_learning_rate_for_nsa_flow-343"><a href="#estimate_learning_rate_for_nsa_flow-343"><span class="linenos">343</span></a>    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="estimate_learning_rate_for_nsa_flow-344"><a href="#estimate_learning_rate_for_nsa_flow-344"><span class="linenos">344</span></a>    <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="estimate_learning_rate_for_nsa_flow-345"><a href="#estimate_learning_rate_for_nsa_flow-345"><span class="linenos">345</span></a>    <span class="n">fidelity_type</span><span class="o">=</span><span class="s2">&quot;scale_invariant&quot;</span><span class="p">,</span>
</span><span id="estimate_learning_rate_for_nsa_flow-346"><a href="#estimate_learning_rate_for_nsa_flow-346"><span class="linenos">346</span></a>    <span class="n">orth_type</span><span class="o">=</span><span class="s2">&quot;scale_invariant&quot;</span><span class="p">,</span>
</span><span id="estimate_learning_rate_for_nsa_flow-347"><a href="#estimate_learning_rate_for_nsa_flow-347"><span class="linenos">347</span></a><span class="p">):</span>
</span><span id="estimate_learning_rate_for_nsa_flow-348"><a href="#estimate_learning_rate_for_nsa_flow-348"><span class="linenos">348</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="estimate_learning_rate_for_nsa_flow-349"><a href="#estimate_learning_rate_for_nsa_flow-349"><span class="linenos">349</span></a><span class="sd">    Estimate a suitable learning rate for NSA-Flow optimization with 10 strategy modes</span>
</span><span id="estimate_learning_rate_for_nsa_flow-350"><a href="#estimate_learning_rate_for_nsa_flow-350"><span class="linenos">350</span></a><span class="sd">    and aggression-based scaling. Robust to NaN/Inf energies.</span>
</span><span id="estimate_learning_rate_for_nsa_flow-351"><a href="#estimate_learning_rate_for_nsa_flow-351"><span class="linenos">351</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="estimate_learning_rate_for_nsa_flow-352"><a href="#estimate_learning_rate_for_nsa_flow-352"><span class="linenos">352</span></a>
</span><span id="estimate_learning_rate_for_nsa_flow-353"><a href="#estimate_learning_rate_for_nsa_flow-353"><span class="linenos">353</span></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">torch</span><span class="o">,</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span><span class="o">,</span><span class="w"> </span><span class="nn">warnings</span>
</span><span id="estimate_learning_rate_for_nsa_flow-354"><a href="#estimate_learning_rate_for_nsa_flow-354"><span class="linenos">354</span></a>
</span><span id="estimate_learning_rate_for_nsa_flow-355"><a href="#estimate_learning_rate_for_nsa_flow-355"><span class="linenos">355</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_to_float</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span id="estimate_learning_rate_for_nsa_flow-356"><a href="#estimate_learning_rate_for_nsa_flow-356"><span class="linenos">356</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span id="estimate_learning_rate_for_nsa_flow-357"><a href="#estimate_learning_rate_for_nsa_flow-357"><span class="linenos">357</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
</span><span id="estimate_learning_rate_for_nsa_flow-358"><a href="#estimate_learning_rate_for_nsa_flow-358"><span class="linenos">358</span></a>            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="estimate_learning_rate_for_nsa_flow-359"><a href="#estimate_learning_rate_for_nsa_flow-359"><span class="linenos">359</span></a>                <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
</span><span id="estimate_learning_rate_for_nsa_flow-360"><a href="#estimate_learning_rate_for_nsa_flow-360"><span class="linenos">360</span></a>            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
</span><span id="estimate_learning_rate_for_nsa_flow-361"><a href="#estimate_learning_rate_for_nsa_flow-361"><span class="linenos">361</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="estimate_learning_rate_for_nsa_flow-362"><a href="#estimate_learning_rate_for_nsa_flow-362"><span class="linenos">362</span></a>            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-363"><a href="#estimate_learning_rate_for_nsa_flow-363"><span class="linenos">363</span></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="estimate_learning_rate_for_nsa_flow-364"><a href="#estimate_learning_rate_for_nsa_flow-364"><span class="linenos">364</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="estimate_learning_rate_for_nsa_flow-365"><a href="#estimate_learning_rate_for_nsa_flow-365"><span class="linenos">365</span></a>
</span><span id="estimate_learning_rate_for_nsa_flow-366"><a href="#estimate_learning_rate_for_nsa_flow-366"><span class="linenos">366</span></a>    <span class="c1"># ---------------------------------------------------------------------</span>
</span><span id="estimate_learning_rate_for_nsa_flow-367"><a href="#estimate_learning_rate_for_nsa_flow-367"><span class="linenos">367</span></a>    <span class="c1"># Setup</span>
</span><span id="estimate_learning_rate_for_nsa_flow-368"><a href="#estimate_learning_rate_for_nsa_flow-368"><span class="linenos">368</span></a>    <span class="c1"># ---------------------------------------------------------------------</span>
</span><span id="estimate_learning_rate_for_nsa_flow-369"><a href="#estimate_learning_rate_for_nsa_flow-369"><span class="linenos">369</span></a>    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-370"><a href="#estimate_learning_rate_for_nsa_flow-370"><span class="linenos">370</span></a>    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-371"><a href="#estimate_learning_rate_for_nsa_flow-371"><span class="linenos">371</span></a>
</span><span id="estimate_learning_rate_for_nsa_flow-372"><a href="#estimate_learning_rate_for_nsa_flow-372"><span class="linenos">372</span></a>    <span class="n">Y_ref</span> <span class="o">=</span> <span class="n">Y0</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-373"><a href="#estimate_learning_rate_for_nsa_flow-373"><span class="linenos">373</span></a>    <span class="n">X0</span> <span class="o">=</span> <span class="n">X0</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
</span><span id="estimate_learning_rate_for_nsa_flow-374"><a href="#estimate_learning_rate_for_nsa_flow-374"><span class="linenos">374</span></a>
</span><span id="estimate_learning_rate_for_nsa_flow-375"><a href="#estimate_learning_rate_for_nsa_flow-375"><span class="linenos">375</span></a>    <span class="n">fid_eta</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="k">if</span> <span class="n">fid_eta</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">fid_eta</span>
</span><span id="estimate_learning_rate_for_nsa_flow-376"><a href="#estimate_learning_rate_for_nsa_flow-376"><span class="linenos">376</span></a>    <span class="n">c_orth</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="k">if</span> <span class="n">c_orth</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">c_orth</span>
</span><span id="estimate_learning_rate_for_nsa_flow-377"><a href="#estimate_learning_rate_for_nsa_flow-377"><span class="linenos">377</span></a>    <span class="n">aggression</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">aggression</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
</span><span id="estimate_learning_rate_for_nsa_flow-378"><a href="#estimate_learning_rate_for_nsa_flow-378"><span class="linenos">378</span></a>
</span><span id="estimate_learning_rate_for_nsa_flow-379"><a href="#estimate_learning_rate_for_nsa_flow-379"><span class="linenos">379</span></a>    <span class="c1"># --- Define energy function safely ---</span>
</span><span id="estimate_learning_rate_for_nsa_flow-380"><a href="#estimate_learning_rate_for_nsa_flow-380"><span class="linenos">380</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">safe_energy</span><span class="p">(</span><span class="n">Y</span><span class="p">):</span>
</span><span id="estimate_learning_rate_for_nsa_flow-381"><a href="#estimate_learning_rate_for_nsa_flow-381"><span class="linenos">381</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="estimate_learning_rate_for_nsa_flow-382"><a href="#estimate_learning_rate_for_nsa_flow-382"><span class="linenos">382</span></a>            <span class="n">Yr</span> <span class="o">=</span> <span class="n">nsa_flow_retract_auto</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">retraction</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-383"><a href="#estimate_learning_rate_for_nsa_flow-383"><span class="linenos">383</span></a>            <span class="n">Yr</span> <span class="o">=</span> <span class="n">apply_nonnegativity</span><span class="p">(</span><span class="n">Yr</span><span class="p">,</span> <span class="n">apply_nonneg</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-384"><a href="#estimate_learning_rate_for_nsa_flow-384"><span class="linenos">384</span></a>            <span class="n">e</span> <span class="o">=</span> <span class="n">compute_energy</span><span class="p">(</span>
</span><span id="estimate_learning_rate_for_nsa_flow-385"><a href="#estimate_learning_rate_for_nsa_flow-385"><span class="linenos">385</span></a>                <span class="n">Yr</span><span class="p">,</span>
</span><span id="estimate_learning_rate_for_nsa_flow-386"><a href="#estimate_learning_rate_for_nsa_flow-386"><span class="linenos">386</span></a>                <span class="n">X0</span><span class="p">,</span>
</span><span id="estimate_learning_rate_for_nsa_flow-387"><a href="#estimate_learning_rate_for_nsa_flow-387"><span class="linenos">387</span></a>                <span class="n">w</span><span class="o">=</span><span class="n">w</span><span class="p">,</span>
</span><span id="estimate_learning_rate_for_nsa_flow-388"><a href="#estimate_learning_rate_for_nsa_flow-388"><span class="linenos">388</span></a>                <span class="n">fid_eta</span><span class="o">=</span><span class="n">fid_eta</span><span class="p">,</span>
</span><span id="estimate_learning_rate_for_nsa_flow-389"><a href="#estimate_learning_rate_for_nsa_flow-389"><span class="linenos">389</span></a>                <span class="n">c_orth</span><span class="o">=</span><span class="n">c_orth</span><span class="p">,</span>
</span><span id="estimate_learning_rate_for_nsa_flow-390"><a href="#estimate_learning_rate_for_nsa_flow-390"><span class="linenos">390</span></a>                <span class="n">fidelity_type</span><span class="o">=</span><span class="n">fidelity_type</span><span class="p">,</span>
</span><span id="estimate_learning_rate_for_nsa_flow-391"><a href="#estimate_learning_rate_for_nsa_flow-391"><span class="linenos">391</span></a>                <span class="n">orth_type</span><span class="o">=</span><span class="n">orth_type</span><span class="p">,</span>
</span><span id="estimate_learning_rate_for_nsa_flow-392"><a href="#estimate_learning_rate_for_nsa_flow-392"><span class="linenos">392</span></a>                <span class="n">track_grad</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="estimate_learning_rate_for_nsa_flow-393"><a href="#estimate_learning_rate_for_nsa_flow-393"><span class="linenos">393</span></a>            <span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-394"><a href="#estimate_learning_rate_for_nsa_flow-394"><span class="linenos">394</span></a>            <span class="n">e_val</span> <span class="o">=</span> <span class="n">_to_float</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-395"><a href="#estimate_learning_rate_for_nsa_flow-395"><span class="linenos">395</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">e_val</span><span class="p">):</span>
</span><span id="estimate_learning_rate_for_nsa_flow-396"><a href="#estimate_learning_rate_for_nsa_flow-396"><span class="linenos">396</span></a>                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="estimate_learning_rate_for_nsa_flow-397"><a href="#estimate_learning_rate_for_nsa_flow-397"><span class="linenos">397</span></a>            <span class="k">return</span> <span class="n">e_val</span>
</span><span id="estimate_learning_rate_for_nsa_flow-398"><a href="#estimate_learning_rate_for_nsa_flow-398"><span class="linenos">398</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
</span><span id="estimate_learning_rate_for_nsa_flow-399"><a href="#estimate_learning_rate_for_nsa_flow-399"><span class="linenos">399</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="estimate_learning_rate_for_nsa_flow-400"><a href="#estimate_learning_rate_for_nsa_flow-400"><span class="linenos">400</span></a>                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;safe_energy failed: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-401"><a href="#estimate_learning_rate_for_nsa_flow-401"><span class="linenos">401</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="estimate_learning_rate_for_nsa_flow-402"><a href="#estimate_learning_rate_for_nsa_flow-402"><span class="linenos">402</span></a>
</span><span id="estimate_learning_rate_for_nsa_flow-403"><a href="#estimate_learning_rate_for_nsa_flow-403"><span class="linenos">403</span></a>    <span class="c1"># ---------------------------------------------------------------------</span>
</span><span id="estimate_learning_rate_for_nsa_flow-404"><a href="#estimate_learning_rate_for_nsa_flow-404"><span class="linenos">404</span></a>    <span class="c1"># Baseline energy and gradient</span>
</span><span id="estimate_learning_rate_for_nsa_flow-405"><a href="#estimate_learning_rate_for_nsa_flow-405"><span class="linenos">405</span></a>    <span class="c1"># ---------------------------------------------------------------------</span>
</span><span id="estimate_learning_rate_for_nsa_flow-406"><a href="#estimate_learning_rate_for_nsa_flow-406"><span class="linenos">406</span></a>    <span class="n">f_ref</span> <span class="o">=</span> <span class="n">safe_energy</span><span class="p">(</span><span class="n">Y_ref</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-407"><a href="#estimate_learning_rate_for_nsa_flow-407"><span class="linenos">407</span></a>    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">f_ref</span><span class="p">):</span>
</span><span id="estimate_learning_rate_for_nsa_flow-408"><a href="#estimate_learning_rate_for_nsa_flow-408"><span class="linenos">408</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Initial energy computation failed (NaN).&quot;</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-409"><a href="#estimate_learning_rate_for_nsa_flow-409"><span class="linenos">409</span></a>
</span><span id="estimate_learning_rate_for_nsa_flow-410"><a href="#estimate_learning_rate_for_nsa_flow-410"><span class="linenos">410</span></a>    <span class="n">f_ref_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">f_ref</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">Y_ref</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-411"><a href="#estimate_learning_rate_for_nsa_flow-411"><span class="linenos">411</span></a>    <span class="n">f_ref_tensor</span><span class="o">.</span><span class="n">backward</span><span class="p">(</span><span class="n">retain_graph</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-412"><a href="#estimate_learning_rate_for_nsa_flow-412"><span class="linenos">412</span></a>    <span class="n">grad_ref</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="estimate_learning_rate_for_nsa_flow-413"><a href="#estimate_learning_rate_for_nsa_flow-413"><span class="linenos">413</span></a>        <span class="n">Y_ref</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="estimate_learning_rate_for_nsa_flow-414"><a href="#estimate_learning_rate_for_nsa_flow-414"><span class="linenos">414</span></a>        <span class="k">if</span> <span class="n">Y_ref</span><span class="o">.</span><span class="n">grad</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="estimate_learning_rate_for_nsa_flow-415"><a href="#estimate_learning_rate_for_nsa_flow-415"><span class="linenos">415</span></a>        <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">Y_ref</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-416"><a href="#estimate_learning_rate_for_nsa_flow-416"><span class="linenos">416</span></a>    <span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-417"><a href="#estimate_learning_rate_for_nsa_flow-417"><span class="linenos">417</span></a>    <span class="n">grad_norm</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">grad_ref</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">+</span> <span class="mf">1e-12</span>
</span><span id="estimate_learning_rate_for_nsa_flow-418"><a href="#estimate_learning_rate_for_nsa_flow-418"><span class="linenos">418</span></a>
</span><span id="estimate_learning_rate_for_nsa_flow-419"><a href="#estimate_learning_rate_for_nsa_flow-419"><span class="linenos">419</span></a>    <span class="c1"># ---------------------------------------------------------------------</span>
</span><span id="estimate_learning_rate_for_nsa_flow-420"><a href="#estimate_learning_rate_for_nsa_flow-420"><span class="linenos">420</span></a>    <span class="c1"># Candidate LR generation</span>
</span><span id="estimate_learning_rate_for_nsa_flow-421"><a href="#estimate_learning_rate_for_nsa_flow-421"><span class="linenos">421</span></a>    <span class="c1"># ---------------------------------------------------------------------</span>
</span><span id="estimate_learning_rate_for_nsa_flow-422"><a href="#estimate_learning_rate_for_nsa_flow-422"><span class="linenos">422</span></a>    <span class="n">strategies</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="estimate_learning_rate_for_nsa_flow-423"><a href="#estimate_learning_rate_for_nsa_flow-423"><span class="linenos">423</span></a>        <span class="s2">&quot;armijo&quot;</span><span class="p">,</span> <span class="s2">&quot;armijo_aggressive&quot;</span><span class="p">,</span> <span class="s2">&quot;exponential&quot;</span><span class="p">,</span> <span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="s2">&quot;entropy&quot;</span><span class="p">,</span>
</span><span id="estimate_learning_rate_for_nsa_flow-424"><a href="#estimate_learning_rate_for_nsa_flow-424"><span class="linenos">424</span></a>        <span class="s2">&quot;random&quot;</span><span class="p">,</span> <span class="s2">&quot;adaptive&quot;</span><span class="p">,</span> <span class="s2">&quot;momentum_boost&quot;</span><span class="p">,</span> <span class="s2">&quot;poly_decay&quot;</span><span class="p">,</span> <span class="s2">&quot;grid&quot;</span><span class="p">,</span> <span class="s2">&quot;bayes&quot;</span>
</span><span id="estimate_learning_rate_for_nsa_flow-425"><a href="#estimate_learning_rate_for_nsa_flow-425"><span class="linenos">425</span></a>    <span class="p">]</span>
</span><span id="estimate_learning_rate_for_nsa_flow-426"><a href="#estimate_learning_rate_for_nsa_flow-426"><span class="linenos">426</span></a>    <span class="k">if</span> <span class="n">strategy</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">strategies</span><span class="p">:</span>
</span><span id="estimate_learning_rate_for_nsa_flow-427"><a href="#estimate_learning_rate_for_nsa_flow-427"><span class="linenos">427</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown strategy: </span><span class="si">{</span><span class="n">strategy</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-428"><a href="#estimate_learning_rate_for_nsa_flow-428"><span class="linenos">428</span></a>
</span><span id="estimate_learning_rate_for_nsa_flow-429"><a href="#estimate_learning_rate_for_nsa_flow-429"><span class="linenos">429</span></a>    <span class="c1"># Initial LR sets per strategy (base sweep)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-430"><a href="#estimate_learning_rate_for_nsa_flow-430"><span class="linenos">430</span></a>    <span class="k">if</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s2">&quot;grid&quot;</span><span class="p">:</span>
</span><span id="estimate_learning_rate_for_nsa_flow-431"><a href="#estimate_learning_rate_for_nsa_flow-431"><span class="linenos">431</span></a>        <span class="n">lr_candidates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-432"><a href="#estimate_learning_rate_for_nsa_flow-432"><span class="linenos">432</span></a>
</span><span id="estimate_learning_rate_for_nsa_flow-433"><a href="#estimate_learning_rate_for_nsa_flow-433"><span class="linenos">433</span></a>    <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s2">&quot;entropy&quot;</span><span class="p">:</span>
</span><span id="estimate_learning_rate_for_nsa_flow-434"><a href="#estimate_learning_rate_for_nsa_flow-434"><span class="linenos">434</span></a>        <span class="n">base</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-435"><a href="#estimate_learning_rate_for_nsa_flow-435"><span class="linenos">435</span></a>        <span class="n">temp</span> <span class="o">=</span> <span class="mf">1e-3</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">aggression</span>
</span><span id="estimate_learning_rate_for_nsa_flow-436"><a href="#estimate_learning_rate_for_nsa_flow-436"><span class="linenos">436</span></a>        <span class="n">logits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="mf">1e-12</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">temp</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-437"><a href="#estimate_learning_rate_for_nsa_flow-437"><span class="linenos">437</span></a>        <span class="n">probs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logits</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">logits</span><span class="p">))</span>
</span><span id="estimate_learning_rate_for_nsa_flow-438"><a href="#estimate_learning_rate_for_nsa_flow-438"><span class="linenos">438</span></a>        <span class="n">probs</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">probs</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-439"><a href="#estimate_learning_rate_for_nsa_flow-439"><span class="linenos">439</span></a>        <span class="n">lr_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">base</span> <span class="o">*</span> <span class="n">probs</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-440"><a href="#estimate_learning_rate_for_nsa_flow-440"><span class="linenos">440</span></a>        <span class="n">lr_candidates</span> <span class="o">=</span> <span class="n">lr_mean</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-441"><a href="#estimate_learning_rate_for_nsa_flow-441"><span class="linenos">441</span></a>
</span><span id="estimate_learning_rate_for_nsa_flow-442"><a href="#estimate_learning_rate_for_nsa_flow-442"><span class="linenos">442</span></a>    <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s2">&quot;armijo&quot;</span><span class="p">:</span>
</span><span id="estimate_learning_rate_for_nsa_flow-443"><a href="#estimate_learning_rate_for_nsa_flow-443"><span class="linenos">443</span></a>        <span class="n">lr_candidates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">aggression</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-444"><a href="#estimate_learning_rate_for_nsa_flow-444"><span class="linenos">444</span></a>
</span><span id="estimate_learning_rate_for_nsa_flow-445"><a href="#estimate_learning_rate_for_nsa_flow-445"><span class="linenos">445</span></a>    <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s2">&quot;armijo_aggressive&quot;</span><span class="p">:</span>
</span><span id="estimate_learning_rate_for_nsa_flow-446"><a href="#estimate_learning_rate_for_nsa_flow-446"><span class="linenos">446</span></a>        <span class="n">lr_candidates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">aggression</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-447"><a href="#estimate_learning_rate_for_nsa_flow-447"><span class="linenos">447</span></a>
</span><span id="estimate_learning_rate_for_nsa_flow-448"><a href="#estimate_learning_rate_for_nsa_flow-448"><span class="linenos">448</span></a>    <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s2">&quot;exponential&quot;</span><span class="p">:</span>
</span><span id="estimate_learning_rate_for_nsa_flow-449"><a href="#estimate_learning_rate_for_nsa_flow-449"><span class="linenos">449</span></a>        <span class="n">base</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-450"><a href="#estimate_learning_rate_for_nsa_flow-450"><span class="linenos">450</span></a>        <span class="n">lr_candidates</span> <span class="o">=</span> <span class="n">base</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">aggression</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">aggression</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-451"><a href="#estimate_learning_rate_for_nsa_flow-451"><span class="linenos">451</span></a>
</span><span id="estimate_learning_rate_for_nsa_flow-452"><a href="#estimate_learning_rate_for_nsa_flow-452"><span class="linenos">452</span></a>    <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span>
</span><span id="estimate_learning_rate_for_nsa_flow-453"><a href="#estimate_learning_rate_for_nsa_flow-453"><span class="linenos">453</span></a>        <span class="n">start</span> <span class="o">=</span> <span class="mf">1e-5</span>
</span><span id="estimate_learning_rate_for_nsa_flow-454"><a href="#estimate_learning_rate_for_nsa_flow-454"><span class="linenos">454</span></a>        <span class="n">stop</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">aggression</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-455"><a href="#estimate_learning_rate_for_nsa_flow-455"><span class="linenos">455</span></a>        <span class="n">lr_candidates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-456"><a href="#estimate_learning_rate_for_nsa_flow-456"><span class="linenos">456</span></a>
</span><span id="estimate_learning_rate_for_nsa_flow-457"><a href="#estimate_learning_rate_for_nsa_flow-457"><span class="linenos">457</span></a>    <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s2">&quot;adaptive&quot;</span><span class="p">:</span>
</span><span id="estimate_learning_rate_for_nsa_flow-458"><a href="#estimate_learning_rate_for_nsa_flow-458"><span class="linenos">458</span></a>        <span class="n">base</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-459"><a href="#estimate_learning_rate_for_nsa_flow-459"><span class="linenos">459</span></a>        <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">grad_norm</span><span class="p">),</span> <span class="mf">1e-4</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-460"><a href="#estimate_learning_rate_for_nsa_flow-460"><span class="linenos">460</span></a>        <span class="n">lr_candidates</span> <span class="o">=</span> <span class="n">base</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">aggression</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale</span>
</span><span id="estimate_learning_rate_for_nsa_flow-461"><a href="#estimate_learning_rate_for_nsa_flow-461"><span class="linenos">461</span></a>
</span><span id="estimate_learning_rate_for_nsa_flow-462"><a href="#estimate_learning_rate_for_nsa_flow-462"><span class="linenos">462</span></a>    <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s2">&quot;momentum_boost&quot;</span><span class="p">:</span>
</span><span id="estimate_learning_rate_for_nsa_flow-463"><a href="#estimate_learning_rate_for_nsa_flow-463"><span class="linenos">463</span></a>        <span class="n">base</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-464"><a href="#estimate_learning_rate_for_nsa_flow-464"><span class="linenos">464</span></a>        <span class="n">boost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="mf">9.0</span> <span class="o">*</span> <span class="n">aggression</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-465"><a href="#estimate_learning_rate_for_nsa_flow-465"><span class="linenos">465</span></a>        <span class="n">lr_candidates</span> <span class="o">=</span> <span class="n">base</span> <span class="o">*</span> <span class="n">boost</span>
</span><span id="estimate_learning_rate_for_nsa_flow-466"><a href="#estimate_learning_rate_for_nsa_flow-466"><span class="linenos">466</span></a>
</span><span id="estimate_learning_rate_for_nsa_flow-467"><a href="#estimate_learning_rate_for_nsa_flow-467"><span class="linenos">467</span></a>    <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s2">&quot;poly_decay&quot;</span><span class="p">:</span>
</span><span id="estimate_learning_rate_for_nsa_flow-468"><a href="#estimate_learning_rate_for_nsa_flow-468"><span class="linenos">468</span></a>        <span class="n">base</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1e-3</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-469"><a href="#estimate_learning_rate_for_nsa_flow-469"><span class="linenos">469</span></a>        <span class="n">power</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="n">aggression</span>
</span><span id="estimate_learning_rate_for_nsa_flow-470"><a href="#estimate_learning_rate_for_nsa_flow-470"><span class="linenos">470</span></a>        <span class="n">lr_candidates</span> <span class="o">=</span> <span class="p">(</span><span class="n">base</span> <span class="o">**</span> <span class="n">power</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">+</span> <span class="n">aggression</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-471"><a href="#estimate_learning_rate_for_nsa_flow-471"><span class="linenos">471</span></a>        <span class="n">lr_candidates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">lr_candidates</span><span class="p">,</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-472"><a href="#estimate_learning_rate_for_nsa_flow-472"><span class="linenos">472</span></a>
</span><span id="estimate_learning_rate_for_nsa_flow-473"><a href="#estimate_learning_rate_for_nsa_flow-473"><span class="linenos">473</span></a>    <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s2">&quot;random&quot;</span><span class="p">:</span>
</span><span id="estimate_learning_rate_for_nsa_flow-474"><a href="#estimate_learning_rate_for_nsa_flow-474"><span class="linenos">474</span></a>        <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-475"><a href="#estimate_learning_rate_for_nsa_flow-475"><span class="linenos">475</span></a>        <span class="n">lr_candidates</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">1e-5</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">aggression</span><span class="p">),</span> <span class="mi">25</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-476"><a href="#estimate_learning_rate_for_nsa_flow-476"><span class="linenos">476</span></a>
</span><span id="estimate_learning_rate_for_nsa_flow-477"><a href="#estimate_learning_rate_for_nsa_flow-477"><span class="linenos">477</span></a>    <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s2">&quot;bayes&quot;</span><span class="p">:</span>
</span><span id="estimate_learning_rate_for_nsa_flow-478"><a href="#estimate_learning_rate_for_nsa_flow-478"><span class="linenos">478</span></a>        <span class="n">base</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-479"><a href="#estimate_learning_rate_for_nsa_flow-479"><span class="linenos">479</span></a>        <span class="n">prior</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-480"><a href="#estimate_learning_rate_for_nsa_flow-480"><span class="linenos">480</span></a>        <span class="n">lr_candidates</span> <span class="o">=</span> <span class="n">base</span> <span class="o">*</span> <span class="p">(</span><span class="n">prior</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">aggression</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">aggression</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-481"><a href="#estimate_learning_rate_for_nsa_flow-481"><span class="linenos">481</span></a>
</span><span id="estimate_learning_rate_for_nsa_flow-482"><a href="#estimate_learning_rate_for_nsa_flow-482"><span class="linenos">482</span></a>    <span class="c1"># ---------------------------------------------------------------------</span>
</span><span id="estimate_learning_rate_for_nsa_flow-483"><a href="#estimate_learning_rate_for_nsa_flow-483"><span class="linenos">483</span></a>    <span class="c1"># Aggression-based fine tuning of range</span>
</span><span id="estimate_learning_rate_for_nsa_flow-484"><a href="#estimate_learning_rate_for_nsa_flow-484"><span class="linenos">484</span></a>    <span class="c1"># ---------------------------------------------------------------------</span>
</span><span id="estimate_learning_rate_for_nsa_flow-485"><a href="#estimate_learning_rate_for_nsa_flow-485"><span class="linenos">485</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">scale_range</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">lo_exp</span><span class="o">=-</span><span class="mi">6</span><span class="p">,</span> <span class="n">hi_exp</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
</span><span id="estimate_learning_rate_for_nsa_flow-486"><a href="#estimate_learning_rate_for_nsa_flow-486"><span class="linenos">486</span></a>        <span class="n">lo</span> <span class="o">=</span> <span class="n">lo_exp</span> <span class="o">+</span> <span class="n">aggression</span> <span class="o">*</span> <span class="p">(</span><span class="n">hi_exp</span> <span class="o">-</span> <span class="n">lo_exp</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.7</span>
</span><span id="estimate_learning_rate_for_nsa_flow-487"><a href="#estimate_learning_rate_for_nsa_flow-487"><span class="linenos">487</span></a>        <span class="n">hi</span> <span class="o">=</span> <span class="n">hi_exp</span> <span class="o">+</span> <span class="n">aggression</span> <span class="o">*</span> <span class="p">(</span><span class="n">hi_exp</span> <span class="o">-</span> <span class="n">lo_exp</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.3</span>
</span><span id="estimate_learning_rate_for_nsa_flow-488"><a href="#estimate_learning_rate_for_nsa_flow-488"><span class="linenos">488</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">base</span><span class="p">))</span>
</span><span id="estimate_learning_rate_for_nsa_flow-489"><a href="#estimate_learning_rate_for_nsa_flow-489"><span class="linenos">489</span></a>
</span><span id="estimate_learning_rate_for_nsa_flow-490"><a href="#estimate_learning_rate_for_nsa_flow-490"><span class="linenos">490</span></a>    <span class="k">if</span> <span class="n">strategy</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;armijo&quot;</span><span class="p">,</span> <span class="s2">&quot;armijo_aggressive&quot;</span><span class="p">]:</span>
</span><span id="estimate_learning_rate_for_nsa_flow-491"><a href="#estimate_learning_rate_for_nsa_flow-491"><span class="linenos">491</span></a>        <span class="n">lr_candidates</span> <span class="o">=</span> <span class="n">scale_range</span><span class="p">(</span><span class="n">lr_candidates</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s2">&quot;armijo&quot;</span> <span class="k">else</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-492"><a href="#estimate_learning_rate_for_nsa_flow-492"><span class="linenos">492</span></a>    <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s2">&quot;grid&quot;</span><span class="p">:</span>
</span><span id="estimate_learning_rate_for_nsa_flow-493"><a href="#estimate_learning_rate_for_nsa_flow-493"><span class="linenos">493</span></a>        <span class="n">lr_candidates</span> <span class="o">=</span> <span class="n">scale_range</span><span class="p">(</span><span class="n">lr_candidates</span><span class="p">,</span> <span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">aggression</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-494"><a href="#estimate_learning_rate_for_nsa_flow-494"><span class="linenos">494</span></a>    <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s2">&quot;exponential&quot;</span><span class="p">:</span>
</span><span id="estimate_learning_rate_for_nsa_flow-495"><a href="#estimate_learning_rate_for_nsa_flow-495"><span class="linenos">495</span></a>        <span class="n">exp_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">6</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">aggression</span><span class="p">,</span> <span class="n">aggression</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lr_candidates</span><span class="p">))</span>
</span><span id="estimate_learning_rate_for_nsa_flow-496"><a href="#estimate_learning_rate_for_nsa_flow-496"><span class="linenos">496</span></a>        <span class="n">lr_candidates</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">exp_range</span>
</span><span id="estimate_learning_rate_for_nsa_flow-497"><a href="#estimate_learning_rate_for_nsa_flow-497"><span class="linenos">497</span></a>    <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span>
</span><span id="estimate_learning_rate_for_nsa_flow-498"><a href="#estimate_learning_rate_for_nsa_flow-498"><span class="linenos">498</span></a>        <span class="n">max_lr</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">+</span> <span class="n">aggression</span> <span class="o">*</span> <span class="mf">10.0</span>
</span><span id="estimate_learning_rate_for_nsa_flow-499"><a href="#estimate_learning_rate_for_nsa_flow-499"><span class="linenos">499</span></a>        <span class="n">lr_candidates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1e-5</span><span class="p">,</span> <span class="n">max_lr</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lr_candidates</span><span class="p">))</span>
</span><span id="estimate_learning_rate_for_nsa_flow-500"><a href="#estimate_learning_rate_for_nsa_flow-500"><span class="linenos">500</span></a>    <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s2">&quot;random&quot;</span><span class="p">:</span>
</span><span id="estimate_learning_rate_for_nsa_flow-501"><a href="#estimate_learning_rate_for_nsa_flow-501"><span class="linenos">501</span></a>        <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-502"><a href="#estimate_learning_rate_for_nsa_flow-502"><span class="linenos">502</span></a>        <span class="n">lr_candidates</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lr_candidates</span><span class="p">))</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">aggression</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-503"><a href="#estimate_learning_rate_for_nsa_flow-503"><span class="linenos">503</span></a>        <span class="n">lr_candidates</span> <span class="o">*=</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">aggression</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-504"><a href="#estimate_learning_rate_for_nsa_flow-504"><span class="linenos">504</span></a>    <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s2">&quot;adaptive&quot;</span><span class="p">:</span>
</span><span id="estimate_learning_rate_for_nsa_flow-505"><a href="#estimate_learning_rate_for_nsa_flow-505"><span class="linenos">505</span></a>        <span class="n">base_scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">grad_norm</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1e-3</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="n">f_ref</span><span class="p">)),</span> <span class="mf">1e-4</span><span class="p">,</span> <span class="mf">1e4</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-506"><a href="#estimate_learning_rate_for_nsa_flow-506"><span class="linenos">506</span></a>        <span class="n">scale_factor</span> <span class="o">=</span> <span class="p">(</span><span class="n">base_scale</span> <span class="o">**</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">+</span> <span class="n">aggression</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">aggression</span><span class="p">))</span>
</span><span id="estimate_learning_rate_for_nsa_flow-507"><a href="#estimate_learning_rate_for_nsa_flow-507"><span class="linenos">507</span></a>        <span class="n">lr_candidates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lr_candidates</span><span class="p">))</span> <span class="o">*</span> <span class="n">scale_factor</span>
</span><span id="estimate_learning_rate_for_nsa_flow-508"><a href="#estimate_learning_rate_for_nsa_flow-508"><span class="linenos">508</span></a>        <span class="n">lr_candidates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">lr_candidates</span><span class="p">,</span> <span class="mf">1e-8</span><span class="p">,</span> <span class="mf">1e3</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-509"><a href="#estimate_learning_rate_for_nsa_flow-509"><span class="linenos">509</span></a>    <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s2">&quot;momentum_boost&quot;</span><span class="p">:</span>
</span><span id="estimate_learning_rate_for_nsa_flow-510"><a href="#estimate_learning_rate_for_nsa_flow-510"><span class="linenos">510</span></a>        <span class="n">base_lr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1e-5</span><span class="p">,</span> <span class="mf">1e-4</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lr_candidates</span><span class="p">))</span>
</span><span id="estimate_learning_rate_for_nsa_flow-511"><a href="#estimate_learning_rate_for_nsa_flow-511"><span class="linenos">511</span></a>        <span class="n">lr_candidates</span> <span class="o">=</span> <span class="n">base_lr</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">aggression</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lr_candidates</span><span class="p">)))</span>
</span><span id="estimate_learning_rate_for_nsa_flow-512"><a href="#estimate_learning_rate_for_nsa_flow-512"><span class="linenos">512</span></a>    <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s2">&quot;entropy&quot;</span><span class="p">:</span>
</span><span id="estimate_learning_rate_for_nsa_flow-513"><a href="#estimate_learning_rate_for_nsa_flow-513"><span class="linenos">513</span></a>        <span class="n">ent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">grad_norm</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">f_ref</span><span class="p">))</span> <span class="o">+</span> <span class="mf">1e-12</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-514"><a href="#estimate_learning_rate_for_nsa_flow-514"><span class="linenos">514</span></a>        <span class="n">ent_scale</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">ent</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">))</span>
</span><span id="estimate_learning_rate_for_nsa_flow-515"><a href="#estimate_learning_rate_for_nsa_flow-515"><span class="linenos">515</span></a>        <span class="n">base_lrs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lr_candidates</span><span class="p">))</span>
</span><span id="estimate_learning_rate_for_nsa_flow-516"><a href="#estimate_learning_rate_for_nsa_flow-516"><span class="linenos">516</span></a>        <span class="n">scale_factor</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">aggression</span> <span class="o">*</span> <span class="n">ent_scale</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">aggression</span> <span class="o">*</span> <span class="mf">2.0</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-517"><a href="#estimate_learning_rate_for_nsa_flow-517"><span class="linenos">517</span></a>        <span class="n">lr_candidates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="o">.</span><span class="n">accumulate</span><span class="p">(</span><span class="n">base_lrs</span> <span class="o">*</span> <span class="n">scale_factor</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-518"><a href="#estimate_learning_rate_for_nsa_flow-518"><span class="linenos">518</span></a>    <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s2">&quot;poly_decay&quot;</span><span class="p">:</span>
</span><span id="estimate_learning_rate_for_nsa_flow-519"><a href="#estimate_learning_rate_for_nsa_flow-519"><span class="linenos">519</span></a>        <span class="n">lr_candidates</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="estimate_learning_rate_for_nsa_flow-520"><a href="#estimate_learning_rate_for_nsa_flow-520"><span class="linenos">520</span></a>            <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lr_candidates</span><span class="p">))</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">aggression</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-521"><a href="#estimate_learning_rate_for_nsa_flow-521"><span class="linenos">521</span></a>        <span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">aggression</span><span class="p">))</span>
</span><span id="estimate_learning_rate_for_nsa_flow-522"><a href="#estimate_learning_rate_for_nsa_flow-522"><span class="linenos">522</span></a>    <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s2">&quot;bayes&quot;</span><span class="p">:</span>
</span><span id="estimate_learning_rate_for_nsa_flow-523"><a href="#estimate_learning_rate_for_nsa_flow-523"><span class="linenos">523</span></a>        <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-524"><a href="#estimate_learning_rate_for_nsa_flow-524"><span class="linenos">524</span></a>        <span class="n">priors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lr_candidates</span><span class="p">)))</span>
</span><span id="estimate_learning_rate_for_nsa_flow-525"><a href="#estimate_learning_rate_for_nsa_flow-525"><span class="linenos">525</span></a>        <span class="n">weights</span> <span class="o">=</span> <span class="n">priors</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">aggression</span><span class="p">)</span> <span class="o">+</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lr_candidates</span><span class="p">))</span>
</span><span id="estimate_learning_rate_for_nsa_flow-526"><a href="#estimate_learning_rate_for_nsa_flow-526"><span class="linenos">526</span></a>        <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-527"><a href="#estimate_learning_rate_for_nsa_flow-527"><span class="linenos">527</span></a>        <span class="n">weights</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-528"><a href="#estimate_learning_rate_for_nsa_flow-528"><span class="linenos">528</span></a>        <span class="n">lr_candidates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">aggression</span><span class="p">))</span>
</span><span id="estimate_learning_rate_for_nsa_flow-529"><a href="#estimate_learning_rate_for_nsa_flow-529"><span class="linenos">529</span></a>
</span><span id="estimate_learning_rate_for_nsa_flow-530"><a href="#estimate_learning_rate_for_nsa_flow-530"><span class="linenos">530</span></a>    <span class="c1"># --- Final safety clamp ---</span>
</span><span id="estimate_learning_rate_for_nsa_flow-531"><a href="#estimate_learning_rate_for_nsa_flow-531"><span class="linenos">531</span></a>    <span class="n">lr_candidates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">lr_candidates</span><span class="p">,</span> <span class="mf">1e-8</span><span class="p">,</span> <span class="mf">1e3</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-532"><a href="#estimate_learning_rate_for_nsa_flow-532"><span class="linenos">532</span></a>    <span class="n">lr_candidates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">lr_candidates</span><span class="p">))</span>
</span><span id="estimate_learning_rate_for_nsa_flow-533"><a href="#estimate_learning_rate_for_nsa_flow-533"><span class="linenos">533</span></a>
</span><span id="estimate_learning_rate_for_nsa_flow-534"><a href="#estimate_learning_rate_for_nsa_flow-534"><span class="linenos">534</span></a>    <span class="c1"># ---------------------------------------------------------------------</span>
</span><span id="estimate_learning_rate_for_nsa_flow-535"><a href="#estimate_learning_rate_for_nsa_flow-535"><span class="linenos">535</span></a>    <span class="c1"># Evaluate energies</span>
</span><span id="estimate_learning_rate_for_nsa_flow-536"><a href="#estimate_learning_rate_for_nsa_flow-536"><span class="linenos">536</span></a>    <span class="c1"># ---------------------------------------------------------------------</span>
</span><span id="estimate_learning_rate_for_nsa_flow-537"><a href="#estimate_learning_rate_for_nsa_flow-537"><span class="linenos">537</span></a>    <span class="n">losses</span><span class="p">,</span> <span class="n">rel_changes</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="estimate_learning_rate_for_nsa_flow-538"><a href="#estimate_learning_rate_for_nsa_flow-538"><span class="linenos">538</span></a>    <span class="k">for</span> <span class="n">lr</span> <span class="ow">in</span> <span class="n">lr_candidates</span><span class="p">:</span>
</span><span id="estimate_learning_rate_for_nsa_flow-539"><a href="#estimate_learning_rate_for_nsa_flow-539"><span class="linenos">539</span></a>        <span class="n">Y_try</span> <span class="o">=</span> <span class="n">Y_ref</span> <span class="o">-</span> <span class="n">lr</span> <span class="o">*</span> <span class="n">grad_ref</span>
</span><span id="estimate_learning_rate_for_nsa_flow-540"><a href="#estimate_learning_rate_for_nsa_flow-540"><span class="linenos">540</span></a>        <span class="n">f_new</span> <span class="o">=</span> <span class="n">safe_energy</span><span class="p">(</span><span class="n">Y_try</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-541"><a href="#estimate_learning_rate_for_nsa_flow-541"><span class="linenos">541</span></a>        <span class="n">losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">f_new</span><span class="p">)</span> <span class="k">else</span> <span class="n">f_new</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-542"><a href="#estimate_learning_rate_for_nsa_flow-542"><span class="linenos">542</span></a>        <span class="n">rel_changes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">f_ref</span> <span class="o">-</span> <span class="n">f_new</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">f_ref</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-12</span><span class="p">))</span>
</span><span id="estimate_learning_rate_for_nsa_flow-543"><a href="#estimate_learning_rate_for_nsa_flow-543"><span class="linenos">543</span></a>
</span><span id="estimate_learning_rate_for_nsa_flow-544"><a href="#estimate_learning_rate_for_nsa_flow-544"><span class="linenos">544</span></a>    <span class="n">losses</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-545"><a href="#estimate_learning_rate_for_nsa_flow-545"><span class="linenos">545</span></a>    <span class="n">rel_changes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rel_changes</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-546"><a href="#estimate_learning_rate_for_nsa_flow-546"><span class="linenos">546</span></a>    <span class="n">valid_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-547"><a href="#estimate_learning_rate_for_nsa_flow-547"><span class="linenos">547</span></a>
</span><span id="estimate_learning_rate_for_nsa_flow-548"><a href="#estimate_learning_rate_for_nsa_flow-548"><span class="linenos">548</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">valid_mask</span><span class="p">):</span>
</span><span id="estimate_learning_rate_for_nsa_flow-549"><a href="#estimate_learning_rate_for_nsa_flow-549"><span class="linenos">549</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="estimate_learning_rate_for_nsa_flow-550"><a href="#estimate_learning_rate_for_nsa_flow-550"><span class="linenos">550</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; All candidate losses invalid  defaulting to conservative LR.&quot;</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-551"><a href="#estimate_learning_rate_for_nsa_flow-551"><span class="linenos">551</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="estimate_learning_rate_for_nsa_flow-552"><a href="#estimate_learning_rate_for_nsa_flow-552"><span class="linenos">552</span></a>            <span class="s2">&quot;best_lr&quot;</span><span class="p">:</span> <span class="mf">1e-3</span><span class="p">,</span>
</span><span id="estimate_learning_rate_for_nsa_flow-553"><a href="#estimate_learning_rate_for_nsa_flow-553"><span class="linenos">553</span></a>            <span class="s2">&quot;best_energy&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="estimate_learning_rate_for_nsa_flow-554"><a href="#estimate_learning_rate_for_nsa_flow-554"><span class="linenos">554</span></a>            <span class="s2">&quot;strategy&quot;</span><span class="p">:</span> <span class="n">strategy</span><span class="p">,</span>
</span><span id="estimate_learning_rate_for_nsa_flow-555"><a href="#estimate_learning_rate_for_nsa_flow-555"><span class="linenos">555</span></a>            <span class="s2">&quot;aggression&quot;</span><span class="p">:</span> <span class="n">aggression</span><span class="p">,</span>
</span><span id="estimate_learning_rate_for_nsa_flow-556"><a href="#estimate_learning_rate_for_nsa_flow-556"><span class="linenos">556</span></a>        <span class="p">}</span>
</span><span id="estimate_learning_rate_for_nsa_flow-557"><a href="#estimate_learning_rate_for_nsa_flow-557"><span class="linenos">557</span></a>
</span><span id="estimate_learning_rate_for_nsa_flow-558"><a href="#estimate_learning_rate_for_nsa_flow-558"><span class="linenos">558</span></a>    <span class="n">lr_candidates</span><span class="p">,</span> <span class="n">losses</span><span class="p">,</span> <span class="n">rel_changes</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="estimate_learning_rate_for_nsa_flow-559"><a href="#estimate_learning_rate_for_nsa_flow-559"><span class="linenos">559</span></a>        <span class="n">lr_candidates</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">],</span>
</span><span id="estimate_learning_rate_for_nsa_flow-560"><a href="#estimate_learning_rate_for_nsa_flow-560"><span class="linenos">560</span></a>        <span class="n">losses</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">],</span>
</span><span id="estimate_learning_rate_for_nsa_flow-561"><a href="#estimate_learning_rate_for_nsa_flow-561"><span class="linenos">561</span></a>        <span class="n">rel_changes</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">],</span>
</span><span id="estimate_learning_rate_for_nsa_flow-562"><a href="#estimate_learning_rate_for_nsa_flow-562"><span class="linenos">562</span></a>    <span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-563"><a href="#estimate_learning_rate_for_nsa_flow-563"><span class="linenos">563</span></a>
</span><span id="estimate_learning_rate_for_nsa_flow-564"><a href="#estimate_learning_rate_for_nsa_flow-564"><span class="linenos">564</span></a>    <span class="c1"># ---------------------------------------------------------------------</span>
</span><span id="estimate_learning_rate_for_nsa_flow-565"><a href="#estimate_learning_rate_for_nsa_flow-565"><span class="linenos">565</span></a>    <span class="c1"># Strategy-specific best LR selection</span>
</span><span id="estimate_learning_rate_for_nsa_flow-566"><a href="#estimate_learning_rate_for_nsa_flow-566"><span class="linenos">566</span></a>    <span class="c1"># ---------------------------------------------------------------------</span>
</span><span id="estimate_learning_rate_for_nsa_flow-567"><a href="#estimate_learning_rate_for_nsa_flow-567"><span class="linenos">567</span></a>    <span class="n">best_lr</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="estimate_learning_rate_for_nsa_flow-568"><a href="#estimate_learning_rate_for_nsa_flow-568"><span class="linenos">568</span></a>    <span class="k">if</span> <span class="n">strategy</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;armijo&quot;</span><span class="p">,</span> <span class="s2">&quot;armijo_aggressive&quot;</span><span class="p">]:</span>
</span><span id="estimate_learning_rate_for_nsa_flow-569"><a href="#estimate_learning_rate_for_nsa_flow-569"><span class="linenos">569</span></a>        <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1e-4</span> <span class="o">+</span> <span class="mf">5e-3</span> <span class="o">*</span> <span class="n">aggression</span><span class="p">)</span> <span class="k">if</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s2">&quot;armijo_aggressive&quot;</span> <span class="k">else</span> <span class="p">(</span><span class="mf">1e-4</span> <span class="o">+</span> <span class="mf">1e-3</span> <span class="o">*</span> <span class="n">aggression</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-570"><a href="#estimate_learning_rate_for_nsa_flow-570"><span class="linenos">570</span></a>        <span class="n">good</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="estimate_learning_rate_for_nsa_flow-571"><a href="#estimate_learning_rate_for_nsa_flow-571"><span class="linenos">571</span></a>            <span class="n">lr</span> <span class="k">for</span> <span class="n">lr</span><span class="p">,</span> <span class="n">f_new</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lr_candidates</span><span class="p">,</span> <span class="n">losses</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-572"><a href="#estimate_learning_rate_for_nsa_flow-572"><span class="linenos">572</span></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">f_new</span><span class="p">)</span> <span class="ow">and</span> <span class="n">f_new</span> <span class="o">&lt;=</span> <span class="n">f_ref</span> <span class="o">-</span> <span class="n">c</span> <span class="o">*</span> <span class="n">lr</span> <span class="o">*</span> <span class="n">grad_norm</span><span class="o">**</span><span class="mi">2</span>
</span><span id="estimate_learning_rate_for_nsa_flow-573"><a href="#estimate_learning_rate_for_nsa_flow-573"><span class="linenos">573</span></a>        <span class="p">]</span>
</span><span id="estimate_learning_rate_for_nsa_flow-574"><a href="#estimate_learning_rate_for_nsa_flow-574"><span class="linenos">574</span></a>        <span class="n">best_lr</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">good</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">))</span> <span class="k">if</span> <span class="n">good</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="n">lr_candidates</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">losses</span><span class="p">)])</span>
</span><span id="estimate_learning_rate_for_nsa_flow-575"><a href="#estimate_learning_rate_for_nsa_flow-575"><span class="linenos">575</span></a>
</span><span id="estimate_learning_rate_for_nsa_flow-576"><a href="#estimate_learning_rate_for_nsa_flow-576"><span class="linenos">576</span></a>    <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s2">&quot;entropy&quot;</span><span class="p">:</span>
</span><span id="estimate_learning_rate_for_nsa_flow-577"><a href="#estimate_learning_rate_for_nsa_flow-577"><span class="linenos">577</span></a>        <span class="n">safe_losses</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">losses</span><span class="p">),</span> <span class="n">losses</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">losses</span><span class="p">))</span>
</span><span id="estimate_learning_rate_for_nsa_flow-578"><a href="#estimate_learning_rate_for_nsa_flow-578"><span class="linenos">578</span></a>        <span class="n">exp_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">safe_losses</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">safe_losses</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">))</span>
</span><span id="estimate_learning_rate_for_nsa_flow-579"><a href="#estimate_learning_rate_for_nsa_flow-579"><span class="linenos">579</span></a>        <span class="n">exp_vals</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">exp_vals</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="estimate_learning_rate_for_nsa_flow-580"><a href="#estimate_learning_rate_for_nsa_flow-580"><span class="linenos">580</span></a>        <span class="n">probs</span> <span class="o">=</span> <span class="n">exp_vals</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">exp_vals</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-12</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-581"><a href="#estimate_learning_rate_for_nsa_flow-581"><span class="linenos">581</span></a>        <span class="c1"># --- Normalize probabilities safely before sampling ---</span>
</span><span id="estimate_learning_rate_for_nsa_flow-582"><a href="#estimate_learning_rate_for_nsa_flow-582"><span class="linenos">582</span></a>        <span class="n">probs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">probs</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">posinf</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">neginf</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-583"><a href="#estimate_learning_rate_for_nsa_flow-583"><span class="linenos">583</span></a>        <span class="n">probs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">probs</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-584"><a href="#estimate_learning_rate_for_nsa_flow-584"><span class="linenos">584</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="n">probs</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="estimate_learning_rate_for_nsa_flow-585"><a href="#estimate_learning_rate_for_nsa_flow-585"><span class="linenos">585</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">or</span> <span class="n">s</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
</span><span id="estimate_learning_rate_for_nsa_flow-586"><a href="#estimate_learning_rate_for_nsa_flow-586"><span class="linenos">586</span></a>            <span class="n">probs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">probs</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">probs</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-587"><a href="#estimate_learning_rate_for_nsa_flow-587"><span class="linenos">587</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="estimate_learning_rate_for_nsa_flow-588"><a href="#estimate_learning_rate_for_nsa_flow-588"><span class="linenos">588</span></a>            <span class="n">probs</span> <span class="o">=</span> <span class="n">probs</span> <span class="o">/</span> <span class="n">s</span>
</span><span id="estimate_learning_rate_for_nsa_flow-589"><a href="#estimate_learning_rate_for_nsa_flow-589"><span class="linenos">589</span></a>        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lr_candidates</span><span class="p">),</span> <span class="n">p</span><span class="o">=</span><span class="n">probs</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-590"><a href="#estimate_learning_rate_for_nsa_flow-590"><span class="linenos">590</span></a>        <span class="n">best_lr</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">lr_candidates</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
</span><span id="estimate_learning_rate_for_nsa_flow-591"><a href="#estimate_learning_rate_for_nsa_flow-591"><span class="linenos">591</span></a>
</span><span id="estimate_learning_rate_for_nsa_flow-592"><a href="#estimate_learning_rate_for_nsa_flow-592"><span class="linenos">592</span></a>    <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s2">&quot;bayes&quot;</span><span class="p">:</span>
</span><span id="estimate_learning_rate_for_nsa_flow-593"><a href="#estimate_learning_rate_for_nsa_flow-593"><span class="linenos">593</span></a>        <span class="n">exp_improve</span> <span class="o">=</span> <span class="p">(</span><span class="n">f_ref</span> <span class="o">-</span> <span class="n">losses</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">f_ref</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-12</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-594"><a href="#estimate_learning_rate_for_nsa_flow-594"><span class="linenos">594</span></a>        <span class="n">grad_loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-595"><a href="#estimate_learning_rate_for_nsa_flow-595"><span class="linenos">595</span></a>        <span class="n">denom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">grad_loss</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-8</span>
</span><span id="estimate_learning_rate_for_nsa_flow-596"><a href="#estimate_learning_rate_for_nsa_flow-596"><span class="linenos">596</span></a>        <span class="n">scores</span> <span class="o">=</span> <span class="n">exp_improve</span> <span class="o">/</span> <span class="n">denom</span>
</span><span id="estimate_learning_rate_for_nsa_flow-597"><a href="#estimate_learning_rate_for_nsa_flow-597"><span class="linenos">597</span></a>        <span class="n">scores</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">scores</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
</span><span id="estimate_learning_rate_for_nsa_flow-598"><a href="#estimate_learning_rate_for_nsa_flow-598"><span class="linenos">598</span></a>        <span class="n">best_lr</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">lr_candidates</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">scores</span><span class="p">)])</span>
</span><span id="estimate_learning_rate_for_nsa_flow-599"><a href="#estimate_learning_rate_for_nsa_flow-599"><span class="linenos">599</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="estimate_learning_rate_for_nsa_flow-600"><a href="#estimate_learning_rate_for_nsa_flow-600"><span class="linenos">600</span></a>        <span class="n">best_lr</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">lr_candidates</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">losses</span><span class="p">)])</span>
</span><span id="estimate_learning_rate_for_nsa_flow-601"><a href="#estimate_learning_rate_for_nsa_flow-601"><span class="linenos">601</span></a>
</span><span id="estimate_learning_rate_for_nsa_flow-602"><a href="#estimate_learning_rate_for_nsa_flow-602"><span class="linenos">602</span></a>    <span class="c1"># ---------------------------------------------------------------------</span>
</span><span id="estimate_learning_rate_for_nsa_flow-603"><a href="#estimate_learning_rate_for_nsa_flow-603"><span class="linenos">603</span></a>    <span class="c1"># Reporting &amp; plotting</span>
</span><span id="estimate_learning_rate_for_nsa_flow-604"><a href="#estimate_learning_rate_for_nsa_flow-604"><span class="linenos">604</span></a>    <span class="c1"># ---------------------------------------------------------------------</span>
</span><span id="estimate_learning_rate_for_nsa_flow-605"><a href="#estimate_learning_rate_for_nsa_flow-605"><span class="linenos">605</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="estimate_learning_rate_for_nsa_flow-606"><a href="#estimate_learning_rate_for_nsa_flow-606"><span class="linenos">606</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[LR-Est] </span><span class="si">{</span><span class="n">strategy</span><span class="si">:</span><span class="s2">&lt;16</span><span class="si">}</span><span class="s2"> | agg=</span><span class="si">{</span><span class="n">aggression</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> | best_lr=</span><span class="si">{</span><span class="n">best_lr</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2"> | minE=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-607"><a href="#estimate_learning_rate_for_nsa_flow-607"><span class="linenos">607</span></a>
</span><span id="estimate_learning_rate_for_nsa_flow-608"><a href="#estimate_learning_rate_for_nsa_flow-608"><span class="linenos">608</span></a>    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
</span><span id="estimate_learning_rate_for_nsa_flow-609"><a href="#estimate_learning_rate_for_nsa_flow-609"><span class="linenos">609</span></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
</span><span id="estimate_learning_rate_for_nsa_flow-610"><a href="#estimate_learning_rate_for_nsa_flow-610"><span class="linenos">610</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
</span><span id="estimate_learning_rate_for_nsa_flow-611"><a href="#estimate_learning_rate_for_nsa_flow-611"><span class="linenos">611</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lr_candidates</span><span class="p">,</span> <span class="n">losses</span><span class="p">,</span> <span class="s2">&quot;o-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">strategy</span><span class="si">}</span><span class="s2"> (agg=</span><span class="si">{</span><span class="n">aggression</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-612"><a href="#estimate_learning_rate_for_nsa_flow-612"><span class="linenos">612</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">best_lr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-613"><a href="#estimate_learning_rate_for_nsa_flow-613"><span class="linenos">613</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-614"><a href="#estimate_learning_rate_for_nsa_flow-614"><span class="linenos">614</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Learning rate&quot;</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-615"><a href="#estimate_learning_rate_for_nsa_flow-615"><span class="linenos">615</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Energy&quot;</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-616"><a href="#estimate_learning_rate_for_nsa_flow-616"><span class="linenos">616</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="estimate_learning_rate_for_nsa_flow-617"><a href="#estimate_learning_rate_for_nsa_flow-617"><span class="linenos">617</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LR Strategy: </span><span class="si">{</span><span class="n">strategy</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="estimate_learning_rate_for_nsa_flow-618"><a href="#estimate_learning_rate_for_nsa_flow-618"><span class="linenos">618</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="estimate_learning_rate_for_nsa_flow-619"><a href="#estimate_learning_rate_for_nsa_flow-619"><span class="linenos">619</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="estimate_learning_rate_for_nsa_flow-620"><a href="#estimate_learning_rate_for_nsa_flow-620"><span class="linenos">620</span></a>
</span><span id="estimate_learning_rate_for_nsa_flow-621"><a href="#estimate_learning_rate_for_nsa_flow-621"><span class="linenos">621</span></a>    <span class="k">return</span> <span class="p">{</span>
</span><span id="estimate_learning_rate_for_nsa_flow-622"><a href="#estimate_learning_rate_for_nsa_flow-622"><span class="linenos">622</span></a>        <span class="s2">&quot;best_lr&quot;</span><span class="p">:</span> <span class="n">best_lr</span><span class="p">,</span>
</span><span id="estimate_learning_rate_for_nsa_flow-623"><a href="#estimate_learning_rate_for_nsa_flow-623"><span class="linenos">623</span></a>        <span class="s2">&quot;best_energy&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">losses</span><span class="p">)),</span>
</span><span id="estimate_learning_rate_for_nsa_flow-624"><a href="#estimate_learning_rate_for_nsa_flow-624"><span class="linenos">624</span></a>        <span class="s2">&quot;strategy&quot;</span><span class="p">:</span> <span class="n">strategy</span><span class="p">,</span>
</span><span id="estimate_learning_rate_for_nsa_flow-625"><a href="#estimate_learning_rate_for_nsa_flow-625"><span class="linenos">625</span></a>        <span class="s2">&quot;aggression&quot;</span><span class="p">:</span> <span class="n">aggression</span><span class="p">,</span>
</span><span id="estimate_learning_rate_for_nsa_flow-626"><a href="#estimate_learning_rate_for_nsa_flow-626"><span class="linenos">626</span></a>        <span class="s2">&quot;lr_candidates&quot;</span><span class="p">:</span> <span class="n">lr_candidates</span><span class="p">,</span>
</span><span id="estimate_learning_rate_for_nsa_flow-627"><a href="#estimate_learning_rate_for_nsa_flow-627"><span class="linenos">627</span></a>        <span class="s2">&quot;losses&quot;</span><span class="p">:</span> <span class="n">losses</span><span class="p">,</span>
</span><span id="estimate_learning_rate_for_nsa_flow-628"><a href="#estimate_learning_rate_for_nsa_flow-628"><span class="linenos">628</span></a>        <span class="s2">&quot;rel_changes&quot;</span><span class="p">:</span> <span class="n">rel_changes</span><span class="p">,</span>
</span><span id="estimate_learning_rate_for_nsa_flow-629"><a href="#estimate_learning_rate_for_nsa_flow-629"><span class="linenos">629</span></a>    <span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>Estimate a suitable learning rate for NSA-Flow optimization with 10 strategy modes
and aggression-based scaling. Robust to NaN/Inf energies.</p>
</div>


                </section>
                <section id="test_scale_invariance">
                            <input id="test_scale_invariance-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">test_scale_invariance</span><span class="signature pdoc-code condensed">(<span class="return-annotation">):</span></span>

                <label class="view-source-button" for="test_scale_invariance-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#test_scale_invariance"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="test_scale_invariance-1692"><a href="#test_scale_invariance-1692"><span class="linenos">1692</span></a><span class="k">def</span><span class="w"> </span><span class="nf">test_scale_invariance</span><span class="p">():</span>
</span><span id="test_scale_invariance-1693"><a href="#test_scale_invariance-1693"><span class="linenos">1693</span></a>    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="test_scale_invariance-1694"><a href="#test_scale_invariance-1694"><span class="linenos">1694</span></a>    <span class="n">p</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">5</span>
</span><span id="test_scale_invariance-1695"><a href="#test_scale_invariance-1695"><span class="linenos">1695</span></a>    <span class="n">X</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
</span><span id="test_scale_invariance-1696"><a href="#test_scale_invariance-1696"><span class="linenos">1696</span></a>    <span class="n">Y</span> <span class="o">=</span> <span class="n">X</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
</span><span id="test_scale_invariance-1697"><a href="#test_scale_invariance-1697"><span class="linenos">1697</span></a>
</span><span id="test_scale_invariance-1698"><a href="#test_scale_invariance-1698"><span class="linenos">1698</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Testing scale invariance...&quot;</span><span class="p">)</span>
</span><span id="test_scale_invariance-1699"><a href="#test_scale_invariance-1699"><span class="linenos">1699</span></a>    <span class="n">lr1</span> <span class="o">=</span> <span class="n">estimate_learning_rate_for_nsa_flow</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)[</span><span class="s2">&quot;best_lr&quot;</span><span class="p">]</span>
</span><span id="test_scale_invariance-1700"><a href="#test_scale_invariance-1700"><span class="linenos">1700</span></a>    <span class="n">lr2</span> <span class="o">=</span> <span class="n">estimate_learning_rate_for_nsa_flow</span><span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="n">Y</span><span class="p">,</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">X</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)[</span><span class="s2">&quot;best_lr&quot;</span><span class="p">]</span>
</span><span id="test_scale_invariance-1701"><a href="#test_scale_invariance-1701"><span class="linenos">1701</span></a>
</span><span id="test_scale_invariance-1702"><a href="#test_scale_invariance-1702"><span class="linenos">1702</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Learning rate (original): </span><span class="si">{</span><span class="n">lr1</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="test_scale_invariance-1703"><a href="#test_scale_invariance-1703"><span class="linenos">1703</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Learning rate (scaled 10): </span><span class="si">{</span><span class="n">lr2</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="test_scale_invariance-1704"><a href="#test_scale_invariance-1704"><span class="linenos">1704</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;log10(lr) = </span><span class="si">{</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">lr1</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">lr2</span><span class="p">))</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="test_scale_invariance-1705"><a href="#test_scale_invariance-1705"><span class="linenos">1705</span></a>
</span><span id="test_scale_invariance-1706"><a href="#test_scale_invariance-1706"><span class="linenos">1706</span></a>    <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">lr1</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">lr2</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s2">&quot;Learning rate should be approximately scale invariant&quot;</span>
</span><span id="test_scale_invariance-1707"><a href="#test_scale_invariance-1707"><span class="linenos">1707</span></a>
</span><span id="test_scale_invariance-1708"><a href="#test_scale_invariance-1708"><span class="linenos">1708</span></a>    <span class="n">res1</span> <span class="o">=</span> <span class="n">nsa_flow_orth</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="test_scale_invariance-1709"><a href="#test_scale_invariance-1709"><span class="linenos">1709</span></a>    <span class="n">res2</span> <span class="o">=</span> <span class="n">nsa_flow_orth</span><span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="n">Y</span><span class="p">,</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">X</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="test_scale_invariance-1710"><a href="#test_scale_invariance-1710"><span class="linenos">1710</span></a>
</span><span id="test_scale_invariance-1711"><a href="#test_scale_invariance-1711"><span class="linenos">1711</span></a>    <span class="n">diff</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">res1</span><span class="p">[</span><span class="s2">&quot;Y&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">res1</span><span class="p">[</span><span class="s2">&quot;Y&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="n">res2</span><span class="p">[</span><span class="s2">&quot;Y&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">res2</span><span class="p">[</span><span class="s2">&quot;Y&quot;</span><span class="p">]))</span>
</span><span id="test_scale_invariance-1712"><a href="#test_scale_invariance-1712"><span class="linenos">1712</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Normalized output difference: </span><span class="si">{</span><span class="n">diff</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="test_scale_invariance-1713"><a href="#test_scale_invariance-1713"><span class="linenos">1713</span></a>    <span class="k">assert</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">,</span> <span class="s2">&quot;NSA-Flow output should be invariant up to scale&quot;</span>
</span><span id="test_scale_invariance-1714"><a href="#test_scale_invariance-1714"><span class="linenos">1714</span></a>
</span><span id="test_scale_invariance-1715"><a href="#test_scale_invariance-1715"><span class="linenos">1715</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Scale invariance test passed successfully!&quot;</span><span class="p">)</span>
</span></pre></div>


    

                </section>
                <section id="test_lr_strategies">
                            <input id="test_lr_strategies-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">test_lr_strategies</span><span class="signature pdoc-code condensed">(<span class="return-annotation">):</span></span>

                <label class="view-source-button" for="test_lr_strategies-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#test_lr_strategies"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="test_lr_strategies-1733"><a href="#test_lr_strategies-1733"><span class="linenos">1733</span></a><span class="k">def</span><span class="w"> </span><span class="nf">test_lr_strategies</span><span class="p">():</span>
</span><span id="test_lr_strategies-1734"><a href="#test_lr_strategies-1734"><span class="linenos">1734</span></a>    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="test_lr_strategies-1735"><a href="#test_lr_strategies-1735"><span class="linenos">1735</span></a>    <span class="n">X</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</span><span id="test_lr_strategies-1736"><a href="#test_lr_strategies-1736"><span class="linenos">1736</span></a>    <span class="n">Y</span> <span class="o">=</span> <span class="n">X</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</span><span id="test_lr_strategies-1737"><a href="#test_lr_strategies-1737"><span class="linenos">1737</span></a>
</span><span id="test_lr_strategies-1738"><a href="#test_lr_strategies-1738"><span class="linenos">1738</span></a>    <span class="k">for</span> <span class="n">strat</span> <span class="ow">in</span> <span class="n">get_lr_estimation_strategies</span><span class="p">():</span>
</span><span id="test_lr_strategies-1739"><a href="#test_lr_strategies-1739"><span class="linenos">1739</span></a>        <span class="n">res</span> <span class="o">=</span> <span class="n">estimate_learning_rate_for_nsa_flow</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="n">strat</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="test_lr_strategies-1740"><a href="#test_lr_strategies-1740"><span class="linenos">1740</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">strat</span><span class="si">:</span><span class="s2">&gt;18</span><span class="si">}</span><span class="s2">  best_lr=</span><span class="si">{</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;best_lr&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>    
</span></pre></div>


    

                </section>
                <section id="test_autograd_scale_invariance">
                            <input id="test_autograd_scale_invariance-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">test_autograd_scale_invariance</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">lr_strategy</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="test_autograd_scale_invariance-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#test_autograd_scale_invariance"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="test_autograd_scale_invariance-1742"><a href="#test_autograd_scale_invariance-1742"><span class="linenos">1742</span></a><span class="k">def</span><span class="w"> </span><span class="nf">test_autograd_scale_invariance</span><span class="p">(</span> <span class="n">lr_strategy</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span> <span class="p">):</span>
</span><span id="test_autograd_scale_invariance-1743"><a href="#test_autograd_scale_invariance-1743"><span class="linenos">1743</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="test_autograd_scale_invariance-1744"><a href="#test_autograd_scale_invariance-1744"><span class="linenos">1744</span></a><span class="sd">    Test: NSA-Flow autograd version should be invariant to scaling of X and Y.</span>
</span><span id="test_autograd_scale_invariance-1745"><a href="#test_autograd_scale_invariance-1745"><span class="linenos">1745</span></a>
</span><span id="test_autograd_scale_invariance-1746"><a href="#test_autograd_scale_invariance-1746"><span class="linenos">1746</span></a><span class="sd">    This runs NSA-Flow with a scaled input and verifies that the invariant</span>
</span><span id="test_autograd_scale_invariance-1747"><a href="#test_autograd_scale_invariance-1747"><span class="linenos">1747</span></a><span class="sd">    orthogonality defect and energy evolution are stable. Also visualizes</span>
</span><span id="test_autograd_scale_invariance-1748"><a href="#test_autograd_scale_invariance-1748"><span class="linenos">1748</span></a><span class="sd">    the learning trace for manual inspection.</span>
</span><span id="test_autograd_scale_invariance-1749"><a href="#test_autograd_scale_invariance-1749"><span class="linenos">1749</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="test_autograd_scale_invariance-1750"><a href="#test_autograd_scale_invariance-1750"><span class="linenos">1750</span></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
</span><span id="test_autograd_scale_invariance-1751"><a href="#test_autograd_scale_invariance-1751"><span class="linenos">1751</span></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
</span><span id="test_autograd_scale_invariance-1752"><a href="#test_autograd_scale_invariance-1752"><span class="linenos">1752</span></a>
</span><span id="test_autograd_scale_invariance-1753"><a href="#test_autograd_scale_invariance-1753"><span class="linenos">1753</span></a>    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
</span><span id="test_autograd_scale_invariance-1754"><a href="#test_autograd_scale_invariance-1754"><span class="linenos">1754</span></a>    <span class="n">Y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</span><span id="test_autograd_scale_invariance-1755"><a href="#test_autograd_scale_invariance-1755"><span class="linenos">1755</span></a>    <span class="n">X0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
</span><span id="test_autograd_scale_invariance-1756"><a href="#test_autograd_scale_invariance-1756"><span class="linenos">1756</span></a>    <span class="n">retraction</span> <span class="o">=</span> <span class="s2">&quot;soft_polar&quot;</span>
</span><span id="test_autograd_scale_invariance-1757"><a href="#test_autograd_scale_invariance-1757"><span class="linenos">1757</span></a>    <span class="n">optimizer</span> <span class="o">=</span> <span class="s2">&quot;lars&quot;</span>
</span><span id="test_autograd_scale_invariance-1758"><a href="#test_autograd_scale_invariance-1758"><span class="linenos">1758</span></a>
</span><span id="test_autograd_scale_invariance-1759"><a href="#test_autograd_scale_invariance-1759"><span class="linenos">1759</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[TEST] Running NSA-Flow autograd with scaled inputs (1e4)...&quot;</span><span class="p">)</span>
</span><span id="test_autograd_scale_invariance-1760"><a href="#test_autograd_scale_invariance-1760"><span class="linenos">1760</span></a>
</span><span id="test_autograd_scale_invariance-1761"><a href="#test_autograd_scale_invariance-1761"><span class="linenos">1761</span></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">nsa_flow_orth</span><span class="p">(</span>
</span><span id="test_autograd_scale_invariance-1762"><a href="#test_autograd_scale_invariance-1762"><span class="linenos">1762</span></a>        <span class="n">Y</span> <span class="o">*</span> <span class="mf">1e4</span><span class="p">,</span>            <span class="c1"># scaled input</span>
</span><span id="test_autograd_scale_invariance-1763"><a href="#test_autograd_scale_invariance-1763"><span class="linenos">1763</span></a>        <span class="n">X0</span><span class="o">=</span><span class="n">X0</span> <span class="o">*</span> <span class="mf">1e4</span><span class="p">,</span>        <span class="c1"># ensure target matches scale</span>
</span><span id="test_autograd_scale_invariance-1764"><a href="#test_autograd_scale_invariance-1764"><span class="linenos">1764</span></a>        <span class="n">w</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
</span><span id="test_autograd_scale_invariance-1765"><a href="#test_autograd_scale_invariance-1765"><span class="linenos">1765</span></a>        <span class="n">retraction</span><span class="o">=</span><span class="n">retraction</span><span class="p">,</span>
</span><span id="test_autograd_scale_invariance-1766"><a href="#test_autograd_scale_invariance-1766"><span class="linenos">1766</span></a>        <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span>
</span><span id="test_autograd_scale_invariance-1767"><a href="#test_autograd_scale_invariance-1767"><span class="linenos">1767</span></a>        <span class="n">max_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
</span><span id="test_autograd_scale_invariance-1768"><a href="#test_autograd_scale_invariance-1768"><span class="linenos">1768</span></a>        <span class="n">record_every</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="test_autograd_scale_invariance-1769"><a href="#test_autograd_scale_invariance-1769"><span class="linenos">1769</span></a>        <span class="n">tol</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span>
</span><span id="test_autograd_scale_invariance-1770"><a href="#test_autograd_scale_invariance-1770"><span class="linenos">1770</span></a>        <span class="n">initial_learning_rate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="test_autograd_scale_invariance-1771"><a href="#test_autograd_scale_invariance-1771"><span class="linenos">1771</span></a>        <span class="n">lr_strategy</span><span class="o">=</span><span class="n">lr_strategy</span><span class="p">,</span>
</span><span id="test_autograd_scale_invariance-1772"><a href="#test_autograd_scale_invariance-1772"><span class="linenos">1772</span></a>        <span class="n">apply_nonneg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="test_autograd_scale_invariance-1773"><a href="#test_autograd_scale_invariance-1773"><span class="linenos">1773</span></a>        <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="test_autograd_scale_invariance-1774"><a href="#test_autograd_scale_invariance-1774"><span class="linenos">1774</span></a>    <span class="p">)</span>
</span><span id="test_autograd_scale_invariance-1775"><a href="#test_autograd_scale_invariance-1775"><span class="linenos">1775</span></a>
</span><span id="test_autograd_scale_invariance-1776"><a href="#test_autograd_scale_invariance-1776"><span class="linenos">1776</span></a>    <span class="n">Y_final</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;Y&quot;</span><span class="p">]</span>
</span><span id="test_autograd_scale_invariance-1777"><a href="#test_autograd_scale_invariance-1777"><span class="linenos">1777</span></a>    <span class="n">inv_def_init</span> <span class="o">=</span> <span class="n">invariant_orthogonality_defect</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
</span><span id="test_autograd_scale_invariance-1778"><a href="#test_autograd_scale_invariance-1778"><span class="linenos">1778</span></a>    <span class="n">inv_def_final</span> <span class="o">=</span> <span class="n">invariant_orthogonality_defect</span><span class="p">(</span><span class="n">Y_final</span><span class="p">)</span>
</span><span id="test_autograd_scale_invariance-1779"><a href="#test_autograd_scale_invariance-1779"><span class="linenos">1779</span></a>
</span><span id="test_autograd_scale_invariance-1780"><a href="#test_autograd_scale_invariance-1780"><span class="linenos">1780</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[TEST] Invariant orthogonality defect (init):  </span><span class="si">{</span><span class="n">inv_def_init</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="test_autograd_scale_invariance-1781"><a href="#test_autograd_scale_invariance-1781"><span class="linenos">1781</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[TEST] Invariant orthogonality defect (final): </span><span class="si">{</span><span class="n">inv_def_final</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="test_autograd_scale_invariance-1782"><a href="#test_autograd_scale_invariance-1782"><span class="linenos">1782</span></a>
</span><span id="test_autograd_scale_invariance-1783"><a href="#test_autograd_scale_invariance-1783"><span class="linenos">1783</span></a>    <span class="c1"># --- optional sanity check ---</span>
</span><span id="test_autograd_scale_invariance-1784"><a href="#test_autograd_scale_invariance-1784"><span class="linenos">1784</span></a>    <span class="n">ratio</span> <span class="o">=</span> <span class="n">inv_def_final</span> <span class="o">/</span> <span class="p">(</span><span class="n">inv_def_init</span> <span class="o">+</span> <span class="mf">1e-12</span><span class="p">)</span>
</span><span id="test_autograd_scale_invariance-1785"><a href="#test_autograd_scale_invariance-1785"><span class="linenos">1785</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[TEST] Relative change in invariant defect: </span><span class="si">{</span><span class="n">ratio</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="test_autograd_scale_invariance-1786"><a href="#test_autograd_scale_invariance-1786"><span class="linenos">1786</span></a>    <span class="k">assert</span> <span class="n">torch</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">inv_def_final</span><span class="p">)),</span> <span class="s2">&quot;NaNs in result!&quot;</span>
</span><span id="test_autograd_scale_invariance-1787"><a href="#test_autograd_scale_invariance-1787"><span class="linenos">1787</span></a>    <span class="k">assert</span> <span class="n">ratio</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;Invariant defect exploded  possible scale issue!&quot;</span>
</span><span id="test_autograd_scale_invariance-1788"><a href="#test_autograd_scale_invariance-1788"><span class="linenos">1788</span></a>
</span><span id="test_autograd_scale_invariance-1789"><a href="#test_autograd_scale_invariance-1789"><span class="linenos">1789</span></a>    <span class="c1"># --- plot learning trace ---</span>
</span><span id="test_autograd_scale_invariance-1790"><a href="#test_autograd_scale_invariance-1790"><span class="linenos">1790</span></a>    <span class="n">plot_nsa_trace</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;traces&quot;</span><span class="p">])</span>
</span><span id="test_autograd_scale_invariance-1791"><a href="#test_autograd_scale_invariance-1791"><span class="linenos">1791</span></a>
</span><span id="test_autograd_scale_invariance-1792"><a href="#test_autograd_scale_invariance-1792"><span class="linenos">1792</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[TEST]  Scale invariance check complete.&quot;</span><span class="p">)</span>
</span><span id="test_autograd_scale_invariance-1793"><a href="#test_autograd_scale_invariance-1793"><span class="linenos">1793</span></a>    <span class="k">return</span> <span class="n">result</span>
</span></pre></div>


            <div class="docstring"><p>Test: NSA-Flow autograd version should be invariant to scaling of X and Y.</p>

<p>This runs NSA-Flow with a scaled input and verifies that the invariant
orthogonality defect and energy evolution are stable. Also visualizes
the learning trace for manual inspection.</p>
</div>


                </section>
                <section id="test_estimate_learning_rate_for_nsa_flow">
                            <input id="test_estimate_learning_rate_for_nsa_flow-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">test_estimate_learning_rate_for_nsa_flow</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">fidelity_type</span><span class="o">=</span><span class="s1">&#39;scale_invariant&#39;</span>,</span><span class="param">	<span class="n">orth_type</span><span class="o">=</span><span class="s1">&#39;scale_invariant&#39;</span>,</span><span class="param">	<span class="n">plot</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="test_estimate_learning_rate_for_nsa_flow-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#test_estimate_learning_rate_for_nsa_flow"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="test_estimate_learning_rate_for_nsa_flow-1796"><a href="#test_estimate_learning_rate_for_nsa_flow-1796"><span class="linenos">1796</span></a><span class="k">def</span><span class="w"> </span><span class="nf">test_estimate_learning_rate_for_nsa_flow</span><span class="p">(</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1797"><a href="#test_estimate_learning_rate_for_nsa_flow-1797"><span class="linenos">1797</span></a>    <span class="n">fidelity_type</span><span class="o">=</span><span class="s2">&quot;scale_invariant&quot;</span><span class="p">,</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1798"><a href="#test_estimate_learning_rate_for_nsa_flow-1798"><span class="linenos">1798</span></a>    <span class="n">orth_type</span><span class="o">=</span><span class="s2">&quot;scale_invariant&quot;</span><span class="p">,</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1799"><a href="#test_estimate_learning_rate_for_nsa_flow-1799"><span class="linenos">1799</span></a>    <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1800"><a href="#test_estimate_learning_rate_for_nsa_flow-1800"><span class="linenos">1800</span></a><span class="p">):</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1801"><a href="#test_estimate_learning_rate_for_nsa_flow-1801"><span class="linenos">1801</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1802"><a href="#test_estimate_learning_rate_for_nsa_flow-1802"><span class="linenos">1802</span></a><span class="sd">    Test learning rate estimation with differentiable energy computation.</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1803"><a href="#test_estimate_learning_rate_for_nsa_flow-1803"><span class="linenos">1803</span></a><span class="sd">    Ensures autograd compatibility.</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1804"><a href="#test_estimate_learning_rate_for_nsa_flow-1804"><span class="linenos">1804</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1805"><a href="#test_estimate_learning_rate_for_nsa_flow-1805"><span class="linenos">1805</span></a>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1806"><a href="#test_estimate_learning_rate_for_nsa_flow-1806"><span class="linenos">1806</span></a>    <span class="n">torch</span><span class="o">.</span><span class="n">set_default_dtype</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1807"><a href="#test_estimate_learning_rate_for_nsa_flow-1807"><span class="linenos">1807</span></a>    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1808"><a href="#test_estimate_learning_rate_for_nsa_flow-1808"><span class="linenos">1808</span></a>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1809"><a href="#test_estimate_learning_rate_for_nsa_flow-1809"><span class="linenos">1809</span></a>    <span class="c1"># --- Setup ---</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1810"><a href="#test_estimate_learning_rate_for_nsa_flow-1810"><span class="linenos">1810</span></a>    <span class="n">Y_ref</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1811"><a href="#test_estimate_learning_rate_for_nsa_flow-1811"><span class="linenos">1811</span></a>    <span class="n">X0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">Y_ref</span><span class="p">)</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1812"><a href="#test_estimate_learning_rate_for_nsa_flow-1812"><span class="linenos">1812</span></a>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1813"><a href="#test_estimate_learning_rate_for_nsa_flow-1813"><span class="linenos">1813</span></a>    <span class="c1"># --- Energy function (autograd-safe) ---</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1814"><a href="#test_estimate_learning_rate_for_nsa_flow-1814"><span class="linenos">1814</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">energy_fn</span><span class="p">(</span><span class="n">Y</span><span class="p">):</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1815"><a href="#test_estimate_learning_rate_for_nsa_flow-1815"><span class="linenos">1815</span></a>        <span class="n">Yr</span> <span class="o">=</span> <span class="n">nsa_flow_retract_auto</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;soft_polar&quot;</span><span class="p">)</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1816"><a href="#test_estimate_learning_rate_for_nsa_flow-1816"><span class="linenos">1816</span></a>        <span class="n">Yr</span> <span class="o">=</span> <span class="n">apply_nonnegativity</span><span class="p">(</span><span class="n">Yr</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1817"><a href="#test_estimate_learning_rate_for_nsa_flow-1817"><span class="linenos">1817</span></a>        <span class="c1"># compute_energy must not use .item() internally</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1818"><a href="#test_estimate_learning_rate_for_nsa_flow-1818"><span class="linenos">1818</span></a>        <span class="n">total_energy</span> <span class="o">=</span> <span class="n">compute_energy</span><span class="p">(</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1819"><a href="#test_estimate_learning_rate_for_nsa_flow-1819"><span class="linenos">1819</span></a>            <span class="n">Yr</span><span class="p">,</span> <span class="n">X0</span><span class="p">,</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1820"><a href="#test_estimate_learning_rate_for_nsa_flow-1820"><span class="linenos">1820</span></a>            <span class="n">w</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1821"><a href="#test_estimate_learning_rate_for_nsa_flow-1821"><span class="linenos">1821</span></a>            <span class="n">fidelity_type</span><span class="o">=</span><span class="n">fidelity_type</span><span class="p">,</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1822"><a href="#test_estimate_learning_rate_for_nsa_flow-1822"><span class="linenos">1822</span></a>            <span class="n">orth_type</span><span class="o">=</span><span class="n">orth_type</span><span class="p">,</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1823"><a href="#test_estimate_learning_rate_for_nsa_flow-1823"><span class="linenos">1823</span></a>            <span class="n">track_grad</span><span class="o">=</span><span class="kc">True</span>   <span class="c1"># ensure autograd-safe version</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1824"><a href="#test_estimate_learning_rate_for_nsa_flow-1824"><span class="linenos">1824</span></a>        <span class="p">)</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1825"><a href="#test_estimate_learning_rate_for_nsa_flow-1825"><span class="linenos">1825</span></a>        <span class="k">return</span> <span class="n">total_energy</span>  <span class="c1"># return tensor, not .item()</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1826"><a href="#test_estimate_learning_rate_for_nsa_flow-1826"><span class="linenos">1826</span></a>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1827"><a href="#test_estimate_learning_rate_for_nsa_flow-1827"><span class="linenos">1827</span></a>    <span class="c1"># --- Compute base energy and gradient ---</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1828"><a href="#test_estimate_learning_rate_for_nsa_flow-1828"><span class="linenos">1828</span></a>    <span class="n">f0</span> <span class="o">=</span> <span class="n">energy_fn</span><span class="p">(</span><span class="n">Y_ref</span><span class="p">)</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1829"><a href="#test_estimate_learning_rate_for_nsa_flow-1829"><span class="linenos">1829</span></a>    <span class="k">assert</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">f0</span><span class="p">),</span> <span class="s2">&quot;Energy function must return a tensor.&quot;</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1830"><a href="#test_estimate_learning_rate_for_nsa_flow-1830"><span class="linenos">1830</span></a>    <span class="k">assert</span> <span class="n">f0</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">,</span> <span class="s2">&quot;Energy must retain grad tracking.&quot;</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1831"><a href="#test_estimate_learning_rate_for_nsa_flow-1831"><span class="linenos">1831</span></a>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1832"><a href="#test_estimate_learning_rate_for_nsa_flow-1832"><span class="linenos">1832</span></a>    <span class="n">f0</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>  <span class="c1"># Should work fine now</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1833"><a href="#test_estimate_learning_rate_for_nsa_flow-1833"><span class="linenos">1833</span></a>    <span class="n">grad</span> <span class="o">=</span> <span class="n">Y_ref</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1834"><a href="#test_estimate_learning_rate_for_nsa_flow-1834"><span class="linenos">1834</span></a>    <span class="n">grad_norm</span> <span class="o">=</span> <span class="n">grad</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1835"><a href="#test_estimate_learning_rate_for_nsa_flow-1835"><span class="linenos">1835</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initial energy=</span><span class="si">{</span><span class="n">f0</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, grad_norm=</span><span class="si">{</span><span class="n">grad_norm</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1836"><a href="#test_estimate_learning_rate_for_nsa_flow-1836"><span class="linenos">1836</span></a>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1837"><a href="#test_estimate_learning_rate_for_nsa_flow-1837"><span class="linenos">1837</span></a>    <span class="c1"># --- Run LR estimation across strategies ---</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1838"><a href="#test_estimate_learning_rate_for_nsa_flow-1838"><span class="linenos">1838</span></a>    <span class="n">strategies</span> <span class="o">=</span> <span class="n">get_lr_estimation_strategies</span><span class="p">()</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1839"><a href="#test_estimate_learning_rate_for_nsa_flow-1839"><span class="linenos">1839</span></a>    <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1840"><a href="#test_estimate_learning_rate_for_nsa_flow-1840"><span class="linenos">1840</span></a>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1841"><a href="#test_estimate_learning_rate_for_nsa_flow-1841"><span class="linenos">1841</span></a>    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">strategies</span><span class="p">:</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1842"><a href="#test_estimate_learning_rate_for_nsa_flow-1842"><span class="linenos">1842</span></a>        <span class="n">res</span> <span class="o">=</span> <span class="n">estimate_learning_rate_for_nsa_flow</span><span class="p">(</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1843"><a href="#test_estimate_learning_rate_for_nsa_flow-1843"><span class="linenos">1843</span></a>            <span class="n">Y0</span><span class="o">=</span><span class="n">Y_ref</span><span class="o">.</span><span class="n">detach</span><span class="p">(),</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1844"><a href="#test_estimate_learning_rate_for_nsa_flow-1844"><span class="linenos">1844</span></a>            <span class="n">X0</span><span class="o">=</span><span class="n">X0</span><span class="p">,</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1845"><a href="#test_estimate_learning_rate_for_nsa_flow-1845"><span class="linenos">1845</span></a>            <span class="n">strategy</span><span class="o">=</span><span class="n">s</span><span class="p">,</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1846"><a href="#test_estimate_learning_rate_for_nsa_flow-1846"><span class="linenos">1846</span></a>            <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1847"><a href="#test_estimate_learning_rate_for_nsa_flow-1847"><span class="linenos">1847</span></a>            <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1848"><a href="#test_estimate_learning_rate_for_nsa_flow-1848"><span class="linenos">1848</span></a>        <span class="p">)</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1849"><a href="#test_estimate_learning_rate_for_nsa_flow-1849"><span class="linenos">1849</span></a>        <span class="n">results</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;best_lr&quot;</span><span class="p">]</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1850"><a href="#test_estimate_learning_rate_for_nsa_flow-1850"><span class="linenos">1850</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="si">:</span><span class="s2">&lt;20</span><span class="si">}</span><span class="s2">  best_lr=</span><span class="si">{</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;best_lr&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1851"><a href="#test_estimate_learning_rate_for_nsa_flow-1851"><span class="linenos">1851</span></a>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1852"><a href="#test_estimate_learning_rate_for_nsa_flow-1852"><span class="linenos">1852</span></a>    <span class="c1"># --- Optional visualization ---</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1853"><a href="#test_estimate_learning_rate_for_nsa_flow-1853"><span class="linenos">1853</span></a>    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1854"><a href="#test_estimate_learning_rate_for_nsa_flow-1854"><span class="linenos">1854</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1855"><a href="#test_estimate_learning_rate_for_nsa_flow-1855"><span class="linenos">1855</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">results</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1856"><a href="#test_estimate_learning_rate_for_nsa_flow-1856"><span class="linenos">1856</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1857"><a href="#test_estimate_learning_rate_for_nsa_flow-1857"><span class="linenos">1857</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Estimated best learning rate&quot;</span><span class="p">)</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1858"><a href="#test_estimate_learning_rate_for_nsa_flow-1858"><span class="linenos">1858</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Learning Rate Strategies Comparison&quot;</span><span class="p">)</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1859"><a href="#test_estimate_learning_rate_for_nsa_flow-1859"><span class="linenos">1859</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1860"><a href="#test_estimate_learning_rate_for_nsa_flow-1860"><span class="linenos">1860</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1861"><a href="#test_estimate_learning_rate_for_nsa_flow-1861"><span class="linenos">1861</span></a>
</span><span id="test_estimate_learning_rate_for_nsa_flow-1862"><a href="#test_estimate_learning_rate_for_nsa_flow-1862"><span class="linenos">1862</span></a>    <span class="k">return</span> <span class="n">results</span>
</span></pre></div>


            <div class="docstring"><p>Test learning rate estimation with differentiable energy computation.
Ensures autograd compatibility.</p>
</div>


                </section>
                <section id="compute_energy">
                            <input id="compute_energy-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">compute_energy</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">Y</span>,</span><span class="param">	<span class="n">X0</span>,</span><span class="param">	<span class="n">w</span><span class="o">=</span><span class="mf">0.5</span>,</span><span class="param">	<span class="n">fidelity_type</span><span class="o">=</span><span class="s1">&#39;scale_invariant&#39;</span>,</span><span class="param">	<span class="n">orth_type</span><span class="o">=</span><span class="s1">&#39;scale_invariant&#39;</span>,</span><span class="param">	<span class="n">fid_eta</span><span class="o">=</span><span class="mf">1.0</span>,</span><span class="param">	<span class="n">c_orth</span><span class="o">=</span><span class="mf">1.0</span>,</span><span class="param">	<span class="n">track_grad</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">return_dict</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="compute_energy-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#compute_energy"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="compute_energy-149"><a href="#compute_energy-149"><span class="linenos">149</span></a><span class="k">def</span><span class="w"> </span><span class="nf">compute_energy</span><span class="p">(</span>
</span><span id="compute_energy-150"><a href="#compute_energy-150"><span class="linenos">150</span></a>    <span class="n">Y</span><span class="p">,</span> <span class="n">X0</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
</span><span id="compute_energy-151"><a href="#compute_energy-151"><span class="linenos">151</span></a>    <span class="n">fidelity_type</span><span class="o">=</span><span class="s2">&quot;scale_invariant&quot;</span><span class="p">,</span>
</span><span id="compute_energy-152"><a href="#compute_energy-152"><span class="linenos">152</span></a>    <span class="n">orth_type</span><span class="o">=</span><span class="s2">&quot;scale_invariant&quot;</span><span class="p">,</span>
</span><span id="compute_energy-153"><a href="#compute_energy-153"><span class="linenos">153</span></a>    <span class="n">fid_eta</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
</span><span id="compute_energy-154"><a href="#compute_energy-154"><span class="linenos">154</span></a>    <span class="n">c_orth</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
</span><span id="compute_energy-155"><a href="#compute_energy-155"><span class="linenos">155</span></a>    <span class="n">track_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="compute_energy-156"><a href="#compute_energy-156"><span class="linenos">156</span></a>    <span class="n">return_dict</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="compute_energy-157"><a href="#compute_energy-157"><span class="linenos">157</span></a><span class="p">):</span>
</span><span id="compute_energy-158"><a href="#compute_energy-158"><span class="linenos">158</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="compute_energy-159"><a href="#compute_energy-159"><span class="linenos">159</span></a><span class="sd">    Centralized energy computation for NSA-Flow.</span>
</span><span id="compute_energy-160"><a href="#compute_energy-160"><span class="linenos">160</span></a><span class="sd">    Combines fidelity and orthogonality losses into a total energy value.</span>
</span><span id="compute_energy-161"><a href="#compute_energy-161"><span class="linenos">161</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="compute_energy-162"><a href="#compute_energy-162"><span class="linenos">162</span></a>
</span><span id="compute_energy-163"><a href="#compute_energy-163"><span class="linenos">163</span></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
</span><span id="compute_energy-164"><a href="#compute_energy-164"><span class="linenos">164</span></a>
</span><span id="compute_energy-165"><a href="#compute_energy-165"><span class="linenos">165</span></a>    <span class="c1"># --- Ensure safe numeric inputs ---</span>
</span><span id="compute_energy-166"><a href="#compute_energy-166"><span class="linenos">166</span></a>    <span class="n">w</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
</span><span id="compute_energy-167"><a href="#compute_energy-167"><span class="linenos">167</span></a>    <span class="n">fid_eta</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">fid_eta</span><span class="p">)</span>
</span><span id="compute_energy-168"><a href="#compute_energy-168"><span class="linenos">168</span></a>    <span class="n">c_orth</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">c_orth</span><span class="p">)</span>
</span><span id="compute_energy-169"><a href="#compute_energy-169"><span class="linenos">169</span></a>
</span><span id="compute_energy-170"><a href="#compute_energy-170"><span class="linenos">170</span></a>    <span class="c1"># --- Fidelity term ---</span>
</span><span id="compute_energy-171"><a href="#compute_energy-171"><span class="linenos">171</span></a>    <span class="k">if</span> <span class="n">fidelity_type</span> <span class="o">==</span> <span class="s2">&quot;basic&quot;</span><span class="p">:</span>
</span><span id="compute_energy-172"><a href="#compute_energy-172"><span class="linenos">172</span></a>        <span class="n">fidelity</span> <span class="o">=</span> <span class="n">fidelity_basic</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">X0</span><span class="p">)</span> <span class="o">*</span> <span class="n">fid_eta</span>
</span><span id="compute_energy-173"><a href="#compute_energy-173"><span class="linenos">173</span></a>    <span class="k">elif</span> <span class="n">fidelity_type</span> <span class="o">==</span> <span class="s2">&quot;scale_invariant&quot;</span><span class="p">:</span>
</span><span id="compute_energy-174"><a href="#compute_energy-174"><span class="linenos">174</span></a>        <span class="n">fidelity</span> <span class="o">=</span> <span class="n">fidelity_scaled</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">X0</span><span class="p">)</span> <span class="o">*</span> <span class="n">fid_eta</span>
</span><span id="compute_energy-175"><a href="#compute_energy-175"><span class="linenos">175</span></a>    <span class="k">elif</span> <span class="n">fidelity_type</span> <span class="o">==</span> <span class="s2">&quot;symmetric&quot;</span><span class="p">:</span>
</span><span id="compute_energy-176"><a href="#compute_energy-176"><span class="linenos">176</span></a>        <span class="n">fidelity</span> <span class="o">=</span> <span class="n">fidelity_symmetric</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">X0</span><span class="p">)</span> <span class="o">*</span> <span class="n">fid_eta</span>
</span><span id="compute_energy-177"><a href="#compute_energy-177"><span class="linenos">177</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="compute_energy-178"><a href="#compute_energy-178"><span class="linenos">178</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown fidelity_type: </span><span class="si">{</span><span class="n">fidelity_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="compute_energy-179"><a href="#compute_energy-179"><span class="linenos">179</span></a>
</span><span id="compute_energy-180"><a href="#compute_energy-180"><span class="linenos">180</span></a>    <span class="c1"># --- Orthogonality term ---</span>
</span><span id="compute_energy-181"><a href="#compute_energy-181"><span class="linenos">181</span></a>    <span class="k">if</span> <span class="n">orth_type</span> <span class="o">==</span> <span class="s2">&quot;basic&quot;</span><span class="p">:</span>
</span><span id="compute_energy-182"><a href="#compute_energy-182"><span class="linenos">182</span></a>        <span class="n">I</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">Y</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">Y</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="compute_energy-183"><a href="#compute_energy-183"><span class="linenos">183</span></a>        <span class="n">orth</span> <span class="o">=</span> <span class="n">c_orth</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">Y</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Y</span> <span class="o">-</span> <span class="n">I</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="compute_energy-184"><a href="#compute_energy-184"><span class="linenos">184</span></a>    <span class="k">elif</span> <span class="n">orth_type</span> <span class="o">==</span> <span class="s2">&quot;scale_invariant&quot;</span><span class="p">:</span>
</span><span id="compute_energy-185"><a href="#compute_energy-185"><span class="linenos">185</span></a>        <span class="n">orth</span> <span class="o">=</span> <span class="n">c_orth</span> <span class="o">*</span> <span class="n">defect_fast</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
</span><span id="compute_energy-186"><a href="#compute_energy-186"><span class="linenos">186</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="compute_energy-187"><a href="#compute_energy-187"><span class="linenos">187</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown orth_type: </span><span class="si">{</span><span class="n">orth_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="compute_energy-188"><a href="#compute_energy-188"><span class="linenos">188</span></a>
</span><span id="compute_energy-189"><a href="#compute_energy-189"><span class="linenos">189</span></a>    <span class="c1"># --- Total energy ---</span>
</span><span id="compute_energy-190"><a href="#compute_energy-190"><span class="linenos">190</span></a>    <span class="n">total</span> <span class="o">=</span> <span class="n">fidelity</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">w</span><span class="p">)</span> <span class="o">+</span> <span class="n">orth</span> <span class="o">*</span> <span class="n">w</span>
</span><span id="compute_energy-191"><a href="#compute_energy-191"><span class="linenos">191</span></a>
</span><span id="compute_energy-192"><a href="#compute_energy-192"><span class="linenos">192</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">track_grad</span><span class="p">:</span>
</span><span id="compute_energy-193"><a href="#compute_energy-193"><span class="linenos">193</span></a>        <span class="n">fidelity</span> <span class="o">=</span> <span class="n">fidelity</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
</span><span id="compute_energy-194"><a href="#compute_energy-194"><span class="linenos">194</span></a>        <span class="n">orth</span> <span class="o">=</span> <span class="n">orth</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
</span><span id="compute_energy-195"><a href="#compute_energy-195"><span class="linenos">195</span></a>        <span class="n">total</span> <span class="o">=</span> <span class="n">total</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
</span><span id="compute_energy-196"><a href="#compute_energy-196"><span class="linenos">196</span></a>
</span><span id="compute_energy-197"><a href="#compute_energy-197"><span class="linenos">197</span></a>    <span class="k">if</span> <span class="n">return_dict</span><span class="p">:</span>
</span><span id="compute_energy-198"><a href="#compute_energy-198"><span class="linenos">198</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="compute_energy-199"><a href="#compute_energy-199"><span class="linenos">199</span></a>            <span class="s2">&quot;fidelity&quot;</span><span class="p">:</span> <span class="n">fidelity</span><span class="p">,</span>
</span><span id="compute_energy-200"><a href="#compute_energy-200"><span class="linenos">200</span></a>            <span class="s2">&quot;orthogonality&quot;</span><span class="p">:</span> <span class="n">orth</span><span class="p">,</span>
</span><span id="compute_energy-201"><a href="#compute_energy-201"><span class="linenos">201</span></a>            <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="n">total</span><span class="p">,</span>
</span><span id="compute_energy-202"><a href="#compute_energy-202"><span class="linenos">202</span></a>        <span class="p">}</span>
</span><span id="compute_energy-203"><a href="#compute_energy-203"><span class="linenos">203</span></a>
</span><span id="compute_energy-204"><a href="#compute_energy-204"><span class="linenos">204</span></a>    <span class="k">return</span> <span class="n">total</span>
</span></pre></div>


            <div class="docstring"><p>Centralized energy computation for NSA-Flow.
Combines fidelity and orthogonality losses into a total energy value.</p>
</div>


                </section>
                <section id="apply_nonnegativity">
                            <input id="apply_nonnegativity-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">apply_nonnegativity</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">Y</span>, </span><span class="param"><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;softplus&#39;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="apply_nonnegativity-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#apply_nonnegativity"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="apply_nonnegativity-117"><a href="#apply_nonnegativity-117"><span class="linenos">117</span></a><span class="k">def</span><span class="w"> </span><span class="nf">apply_nonnegativity</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;softplus&quot;</span><span class="p">):</span>
</span><span id="apply_nonnegativity-118"><a href="#apply_nonnegativity-118"><span class="linenos">118</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="apply_nonnegativity-119"><a href="#apply_nonnegativity-119"><span class="linenos">119</span></a><span class="sd">    Apply nonnegativity transformation to a tensor.</span>
</span><span id="apply_nonnegativity-120"><a href="#apply_nonnegativity-120"><span class="linenos">120</span></a>
</span><span id="apply_nonnegativity-121"><a href="#apply_nonnegativity-121"><span class="linenos">121</span></a><span class="sd">    Parameters</span>
</span><span id="apply_nonnegativity-122"><a href="#apply_nonnegativity-122"><span class="linenos">122</span></a><span class="sd">    ----------</span>
</span><span id="apply_nonnegativity-123"><a href="#apply_nonnegativity-123"><span class="linenos">123</span></a><span class="sd">    Y : torch.Tensor</span>
</span><span id="apply_nonnegativity-124"><a href="#apply_nonnegativity-124"><span class="linenos">124</span></a><span class="sd">        Input tensor.</span>
</span><span id="apply_nonnegativity-125"><a href="#apply_nonnegativity-125"><span class="linenos">125</span></a><span class="sd">    mode : str or bool</span>
</span><span id="apply_nonnegativity-126"><a href="#apply_nonnegativity-126"><span class="linenos">126</span></a><span class="sd">        Nonnegativity mode:</span>
</span><span id="apply_nonnegativity-127"><a href="#apply_nonnegativity-127"><span class="linenos">127</span></a><span class="sd">        - &#39;none&#39; or False : no constraint</span>
</span><span id="apply_nonnegativity-128"><a href="#apply_nonnegativity-128"><span class="linenos">128</span></a><span class="sd">        - &#39;softplus&#39;      : smooth differentiable mapping (soft nonnegativity)</span>
</span><span id="apply_nonnegativity-129"><a href="#apply_nonnegativity-129"><span class="linenos">129</span></a><span class="sd">        - True or &#39;hard&#39;  : hard projection via clamping</span>
</span><span id="apply_nonnegativity-130"><a href="#apply_nonnegativity-130"><span class="linenos">130</span></a>
</span><span id="apply_nonnegativity-131"><a href="#apply_nonnegativity-131"><span class="linenos">131</span></a><span class="sd">    Returns</span>
</span><span id="apply_nonnegativity-132"><a href="#apply_nonnegativity-132"><span class="linenos">132</span></a><span class="sd">    -------</span>
</span><span id="apply_nonnegativity-133"><a href="#apply_nonnegativity-133"><span class="linenos">133</span></a><span class="sd">    torch.Tensor</span>
</span><span id="apply_nonnegativity-134"><a href="#apply_nonnegativity-134"><span class="linenos">134</span></a><span class="sd">        Transformed tensor according to the specified mode.</span>
</span><span id="apply_nonnegativity-135"><a href="#apply_nonnegativity-135"><span class="linenos">135</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="apply_nonnegativity-136"><a href="#apply_nonnegativity-136"><span class="linenos">136</span></a>    <span class="k">if</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
</span><span id="apply_nonnegativity-137"><a href="#apply_nonnegativity-137"><span class="linenos">137</span></a>        <span class="k">return</span> <span class="n">Y</span>
</span><span id="apply_nonnegativity-138"><a href="#apply_nonnegativity-138"><span class="linenos">138</span></a>    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;softplus&quot;</span><span class="p">:</span>
</span><span id="apply_nonnegativity-139"><a href="#apply_nonnegativity-139"><span class="linenos">139</span></a>        <span class="k">return</span> <span class="n">F</span><span class="o">.</span><span class="n">softplus</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
</span><span id="apply_nonnegativity-140"><a href="#apply_nonnegativity-140"><span class="linenos">140</span></a>    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;relu&quot;</span><span class="p">:</span>
</span><span id="apply_nonnegativity-141"><a href="#apply_nonnegativity-141"><span class="linenos">141</span></a>        <span class="k">return</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
</span><span id="apply_nonnegativity-142"><a href="#apply_nonnegativity-142"><span class="linenos">142</span></a>    <span class="k">elif</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;hard&quot;</span><span class="p">,</span> <span class="s2">&quot;Hard&quot;</span><span class="p">]:</span>
</span><span id="apply_nonnegativity-143"><a href="#apply_nonnegativity-143"><span class="linenos">143</span></a>        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
</span><span id="apply_nonnegativity-144"><a href="#apply_nonnegativity-144"><span class="linenos">144</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="apply_nonnegativity-145"><a href="#apply_nonnegativity-145"><span class="linenos">145</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid apply_nonneg mode: </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">. &quot;</span>
</span><span id="apply_nonnegativity-146"><a href="#apply_nonnegativity-146"><span class="linenos">146</span></a>                         <span class="s2">&quot;Use &#39;none&#39;, &#39;softplus&#39;, or True/&#39;hard&#39;.&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Apply nonnegativity transformation to a tensor.</p>

<h2 id="parameters">Parameters</h2>

<p>Y : torch.Tensor
    Input tensor.
mode : str or bool
    Nonnegativity mode:
    - 'none' or False : no constraint
    - 'softplus'      : smooth differentiable mapping (soft nonnegativity)
    - True or 'hard'  : hard projection via clamping</p>

<h2 id="returns">Returns</h2>

<p>torch.Tensor
    Transformed tensor according to the specified mode.</p>
</div>


                </section>
                <section id="test_nsa_flow_orth_modular">
                            <input id="test_nsa_flow_orth_modular-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">test_nsa_flow_orth_modular</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">plot</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="test_nsa_flow_orth_modular-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#test_nsa_flow_orth_modular"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="test_nsa_flow_orth_modular-1958"><a href="#test_nsa_flow_orth_modular-1958"><span class="linenos">1958</span></a><span class="k">def</span><span class="w"> </span><span class="nf">test_nsa_flow_orth_modular</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="test_nsa_flow_orth_modular-1959"><a href="#test_nsa_flow_orth_modular-1959"><span class="linenos">1959</span></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
</span><span id="test_nsa_flow_orth_modular-1960"><a href="#test_nsa_flow_orth_modular-1960"><span class="linenos">1960</span></a>    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="test_nsa_flow_orth_modular-1961"><a href="#test_nsa_flow_orth_modular-1961"><span class="linenos">1961</span></a>    <span class="n">Y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</span><span id="test_nsa_flow_orth_modular-1962"><a href="#test_nsa_flow_orth_modular-1962"><span class="linenos">1962</span></a>    <span class="n">X</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
</span><span id="test_nsa_flow_orth_modular-1963"><a href="#test_nsa_flow_orth_modular-1963"><span class="linenos">1963</span></a>
</span><span id="test_nsa_flow_orth_modular-1964"><a href="#test_nsa_flow_orth_modular-1964"><span class="linenos">1964</span></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">nsa_flow_orth</span><span class="p">(</span>
</span><span id="test_nsa_flow_orth_modular-1965"><a href="#test_nsa_flow_orth_modular-1965"><span class="linenos">1965</span></a>        <span class="n">Y0</span><span class="o">=</span><span class="n">Y</span><span class="p">,</span>
</span><span id="test_nsa_flow_orth_modular-1966"><a href="#test_nsa_flow_orth_modular-1966"><span class="linenos">1966</span></a>        <span class="n">X0</span><span class="o">=</span><span class="n">X</span><span class="p">,</span>
</span><span id="test_nsa_flow_orth_modular-1967"><a href="#test_nsa_flow_orth_modular-1967"><span class="linenos">1967</span></a>        <span class="n">w</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
</span><span id="test_nsa_flow_orth_modular-1968"><a href="#test_nsa_flow_orth_modular-1968"><span class="linenos">1968</span></a>        <span class="n">retraction</span><span class="o">=</span><span class="s2">&quot;soft_polar&quot;</span><span class="p">,</span>
</span><span id="test_nsa_flow_orth_modular-1969"><a href="#test_nsa_flow_orth_modular-1969"><span class="linenos">1969</span></a>        <span class="n">fidelity_type</span><span class="o">=</span><span class="s2">&quot;scale_invariant&quot;</span><span class="p">,</span>
</span><span id="test_nsa_flow_orth_modular-1970"><a href="#test_nsa_flow_orth_modular-1970"><span class="linenos">1970</span></a>        <span class="n">orth_type</span><span class="o">=</span><span class="s2">&quot;scale_invariant&quot;</span><span class="p">,</span>
</span><span id="test_nsa_flow_orth_modular-1971"><a href="#test_nsa_flow_orth_modular-1971"><span class="linenos">1971</span></a>        <span class="n">max_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
</span><span id="test_nsa_flow_orth_modular-1972"><a href="#test_nsa_flow_orth_modular-1972"><span class="linenos">1972</span></a>        <span class="n">lr_strategy</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="test_nsa_flow_orth_modular-1973"><a href="#test_nsa_flow_orth_modular-1973"><span class="linenos">1973</span></a>        <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="test_nsa_flow_orth_modular-1974"><a href="#test_nsa_flow_orth_modular-1974"><span class="linenos">1974</span></a>    <span class="p">)</span>
</span><span id="test_nsa_flow_orth_modular-1975"><a href="#test_nsa_flow_orth_modular-1975"><span class="linenos">1975</span></a>    <span class="n">nrgratio</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;traces&#39;</span><span class="p">][</span><span class="s1">&#39;total_energy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;best_Y_iteration&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;traces&#39;</span><span class="p">][</span><span class="s1">&#39;total_energy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="test_nsa_flow_orth_modular-1976"><a href="#test_nsa_flow_orth_modular-1976"><span class="linenos">1976</span></a>    <span class="n">Y_final</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;Y&quot;</span><span class="p">]</span>
</span><span id="test_nsa_flow_orth_modular-1977"><a href="#test_nsa_flow_orth_modular-1977"><span class="linenos">1977</span></a>    <span class="k">assert</span> <span class="n">torch</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">Y_final</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="s2">&quot;Non-finite values detected in Y.&quot;</span>
</span><span id="test_nsa_flow_orth_modular-1978"><a href="#test_nsa_flow_orth_modular-1978"><span class="linenos">1978</span></a>    <span class="k">assert</span> <span class="n">nrgratio</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;Energy did not decrease sufficiently.&quot;</span>
</span><span id="test_nsa_flow_orth_modular-1979"><a href="#test_nsa_flow_orth_modular-1979"><span class="linenos">1979</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Passed NSA-Flow autograd modular test at iter </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;final_iter&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="test_nsa_flow_orth_modular-1980"><a href="#test_nsa_flow_orth_modular-1980"><span class="linenos">1980</span></a>
</span><span id="test_nsa_flow_orth_modular-1981"><a href="#test_nsa_flow_orth_modular-1981"><span class="linenos">1981</span></a>    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
</span><span id="test_nsa_flow_orth_modular-1982"><a href="#test_nsa_flow_orth_modular-1982"><span class="linenos">1982</span></a>        <span class="n">plot_nsa_trace</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;traces&quot;</span><span class="p">])</span>
</span><span id="test_nsa_flow_orth_modular-1983"><a href="#test_nsa_flow_orth_modular-1983"><span class="linenos">1983</span></a>    <span class="k">return</span> <span class="n">result</span>
</span></pre></div>


    

                </section>
                <section id="test_aggression_effect_with_convergence">
                            <input id="test_aggression_effect_with_convergence-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">test_aggression_effect_with_convergence</span><span class="signature pdoc-code condensed">(<span class="return-annotation">):</span></span>

                <label class="view-source-button" for="test_aggression_effect_with_convergence-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#test_aggression_effect_with_convergence"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="test_aggression_effect_with_convergence-1987"><a href="#test_aggression_effect_with_convergence-1987"><span class="linenos">1987</span></a><span class="k">def</span><span class="w"> </span><span class="nf">test_aggression_effect_with_convergence</span><span class="p">():</span>
</span><span id="test_aggression_effect_with_convergence-1988"><a href="#test_aggression_effect_with_convergence-1988"><span class="linenos">1988</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="test_aggression_effect_with_convergence-1989"><a href="#test_aggression_effect_with_convergence-1989"><span class="linenos">1989</span></a><span class="sd">    Demonstrate that increasing aggression raises the learning rate</span>
</span><span id="test_aggression_effect_with_convergence-1990"><a href="#test_aggression_effect_with_convergence-1990"><span class="linenos">1990</span></a><span class="sd">    and accelerates (but destabilizes) convergence.</span>
</span><span id="test_aggression_effect_with_convergence-1991"><a href="#test_aggression_effect_with_convergence-1991"><span class="linenos">1991</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="test_aggression_effect_with_convergence-1992"><a href="#test_aggression_effect_with_convergence-1992"><span class="linenos">1992</span></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">torch</span><span class="o">,</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span><span class="o">,</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
</span><span id="test_aggression_effect_with_convergence-1993"><a href="#test_aggression_effect_with_convergence-1993"><span class="linenos">1993</span></a>
</span><span id="test_aggression_effect_with_convergence-1994"><a href="#test_aggression_effect_with_convergence-1994"><span class="linenos">1994</span></a>    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="test_aggression_effect_with_convergence-1995"><a href="#test_aggression_effect_with_convergence-1995"><span class="linenos">1995</span></a>    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="test_aggression_effect_with_convergence-1996"><a href="#test_aggression_effect_with_convergence-1996"><span class="linenos">1996</span></a>    <span class="n">Y0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
</span><span id="test_aggression_effect_with_convergence-1997"><a href="#test_aggression_effect_with_convergence-1997"><span class="linenos">1997</span></a>    <span class="n">X0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
</span><span id="test_aggression_effect_with_convergence-1998"><a href="#test_aggression_effect_with_convergence-1998"><span class="linenos">1998</span></a>
</span><span id="test_aggression_effect_with_convergence-1999"><a href="#test_aggression_effect_with_convergence-1999"><span class="linenos">1999</span></a>    <span class="n">aggression_levels</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
</span><span id="test_aggression_effect_with_convergence-2000"><a href="#test_aggression_effect_with_convergence-2000"><span class="linenos">2000</span></a>    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="test_aggression_effect_with_convergence-2001"><a href="#test_aggression_effect_with_convergence-2001"><span class="linenos">2001</span></a>
</span><span id="test_aggression_effect_with_convergence-2002"><a href="#test_aggression_effect_with_convergence-2002"><span class="linenos">2002</span></a>    <span class="k">for</span> <span class="n">agg</span> <span class="ow">in</span> <span class="n">aggression_levels</span><span class="p">:</span>
</span><span id="test_aggression_effect_with_convergence-2003"><a href="#test_aggression_effect_with_convergence-2003"><span class="linenos">2003</span></a>        <span class="n">res</span> <span class="o">=</span> <span class="n">estimate_learning_rate_for_nsa_flow</span><span class="p">(</span>
</span><span id="test_aggression_effect_with_convergence-2004"><a href="#test_aggression_effect_with_convergence-2004"><span class="linenos">2004</span></a>            <span class="n">Y0</span><span class="p">,</span> <span class="n">X0</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">retraction</span><span class="o">=</span><span class="s2">&quot;soft_polar&quot;</span><span class="p">,</span>
</span><span id="test_aggression_effect_with_convergence-2005"><a href="#test_aggression_effect_with_convergence-2005"><span class="linenos">2005</span></a>            <span class="n">aggression</span><span class="o">=</span><span class="n">agg</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span>
</span><span id="test_aggression_effect_with_convergence-2006"><a href="#test_aggression_effect_with_convergence-2006"><span class="linenos">2006</span></a>        <span class="p">)</span>
</span><span id="test_aggression_effect_with_convergence-2007"><a href="#test_aggression_effect_with_convergence-2007"><span class="linenos">2007</span></a>        <span class="c1"># One gradient descent step</span>
</span><span id="test_aggression_effect_with_convergence-2008"><a href="#test_aggression_effect_with_convergence-2008"><span class="linenos">2008</span></a>        <span class="n">Y_try</span> <span class="o">=</span> <span class="n">Y0</span> <span class="o">-</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;best_lr&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">Y0</span><span class="p">)</span>
</span><span id="test_aggression_effect_with_convergence-2009"><a href="#test_aggression_effect_with_convergence-2009"><span class="linenos">2009</span></a>        <span class="n">f_new</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">Y_try</span> <span class="o">-</span> <span class="n">X0</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="test_aggression_effect_with_convergence-2010"><a href="#test_aggression_effect_with_convergence-2010"><span class="linenos">2010</span></a>        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">agg</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;best_lr&quot;</span><span class="p">],</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;best_energy&quot;</span><span class="p">],</span> <span class="n">f_new</span><span class="p">))</span>
</span><span id="test_aggression_effect_with_convergence-2011"><a href="#test_aggression_effect_with_convergence-2011"><span class="linenos">2011</span></a>
</span><span id="test_aggression_effect_with_convergence-2012"><a href="#test_aggression_effect_with_convergence-2012"><span class="linenos">2012</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Aggression Effect ===&quot;</span><span class="p">)</span>
</span><span id="test_aggression_effect_with_convergence-2013"><a href="#test_aggression_effect_with_convergence-2013"><span class="linenos">2013</span></a>    <span class="k">for</span> <span class="n">agg</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="n">f1</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
</span><span id="test_aggression_effect_with_convergence-2014"><a href="#test_aggression_effect_with_convergence-2014"><span class="linenos">2014</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;agg=</span><span class="si">{</span><span class="n">agg</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">  best_lr=</span><span class="si">{</span><span class="n">lr</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">, energy=</span><span class="si">{</span><span class="n">e0</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">, after-step=</span><span class="si">{</span><span class="n">f1</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="test_aggression_effect_with_convergence-2015"><a href="#test_aggression_effect_with_convergence-2015"><span class="linenos">2015</span></a>
</span><span id="test_aggression_effect_with_convergence-2016"><a href="#test_aggression_effect_with_convergence-2016"><span class="linenos">2016</span></a>    <span class="c1"># Visualization</span>
</span><span id="test_aggression_effect_with_convergence-2017"><a href="#test_aggression_effect_with_convergence-2017"><span class="linenos">2017</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
</span><span id="test_aggression_effect_with_convergence-2018"><a href="#test_aggression_effect_with_convergence-2018"><span class="linenos">2018</span></a>    <span class="k">for</span> <span class="n">agg</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="n">f1</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
</span><span id="test_aggression_effect_with_convergence-2019"><a href="#test_aggression_effect_with_convergence-2019"><span class="linenos">2019</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">agg</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;agg=</span><span class="si">{</span><span class="n">agg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
</span><span id="test_aggression_effect_with_convergence-2020"><a href="#test_aggression_effect_with_convergence-2020"><span class="linenos">2020</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Aggression&quot;</span><span class="p">)</span>
</span><span id="test_aggression_effect_with_convergence-2021"><a href="#test_aggression_effect_with_convergence-2021"><span class="linenos">2021</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Selected Learning Rate (log10)&quot;</span><span class="p">)</span>
</span><span id="test_aggression_effect_with_convergence-2022"><a href="#test_aggression_effect_with_convergence-2022"><span class="linenos">2022</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
</span><span id="test_aggression_effect_with_convergence-2023"><a href="#test_aggression_effect_with_convergence-2023"><span class="linenos">2023</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Aggression vs Selected Learning Rate&quot;</span><span class="p">)</span>
</span><span id="test_aggression_effect_with_convergence-2024"><a href="#test_aggression_effect_with_convergence-2024"><span class="linenos">2024</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="test_aggression_effect_with_convergence-2025"><a href="#test_aggression_effect_with_convergence-2025"><span class="linenos">2025</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="test_aggression_effect_with_convergence-2026"><a href="#test_aggression_effect_with_convergence-2026"><span class="linenos">2026</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Demonstrate that increasing aggression raises the learning rate
and accelerates (but destabilizes) convergence.</p>
</div>


                </section>
                <section id="get_lr_estimation_strategies">
                            <input id="get_lr_estimation_strategies-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_lr_estimation_strategies</span><span class="signature pdoc-code condensed">(<span class="return-annotation">):</span></span>

                <label class="view-source-button" for="get_lr_estimation_strategies-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#get_lr_estimation_strategies"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="get_lr_estimation_strategies-1718"><a href="#get_lr_estimation_strategies-1718"><span class="linenos">1718</span></a><span class="k">def</span><span class="w"> </span><span class="nf">get_lr_estimation_strategies</span><span class="p">():</span>
</span><span id="get_lr_estimation_strategies-1719"><a href="#get_lr_estimation_strategies-1719"><span class="linenos">1719</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="get_lr_estimation_strategies-1720"><a href="#get_lr_estimation_strategies-1720"><span class="linenos">1720</span></a><span class="sd">    Return a list of supported learning rate estimation strategies</span>
</span><span id="get_lr_estimation_strategies-1721"><a href="#get_lr_estimation_strategies-1721"><span class="linenos">1721</span></a><span class="sd">    for NSA-Flow&#39;s estimate_learning_rate_for_nsa_flow function.</span>
</span><span id="get_lr_estimation_strategies-1722"><a href="#get_lr_estimation_strategies-1722"><span class="linenos">1722</span></a>
</span><span id="get_lr_estimation_strategies-1723"><a href="#get_lr_estimation_strategies-1723"><span class="linenos">1723</span></a><span class="sd">    Returns:</span>
</span><span id="get_lr_estimation_strategies-1724"><a href="#get_lr_estimation_strategies-1724"><span class="linenos">1724</span></a><span class="sd">        List[str]: Supported strategies.</span>
</span><span id="get_lr_estimation_strategies-1725"><a href="#get_lr_estimation_strategies-1725"><span class="linenos">1725</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="get_lr_estimation_strategies-1726"><a href="#get_lr_estimation_strategies-1726"><span class="linenos">1726</span></a>    <span class="n">strategies</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="get_lr_estimation_strategies-1727"><a href="#get_lr_estimation_strategies-1727"><span class="linenos">1727</span></a>        <span class="s1">&#39;armijo&#39;</span><span class="p">,</span> <span class="s1">&#39;armijo_aggressive&#39;</span><span class="p">,</span> <span class="s1">&#39;exponential&#39;</span><span class="p">,</span> 
</span><span id="get_lr_estimation_strategies-1728"><a href="#get_lr_estimation_strategies-1728"><span class="linenos">1728</span></a>         <span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="s1">&#39;adaptive&#39;</span><span class="p">,</span> <span class="s1">&#39;poly_decay&#39;</span><span class="p">,</span> <span class="s1">&#39;momentum_boost&#39;</span><span class="p">,</span> <span class="c1"># needs fixing</span>
</span><span id="get_lr_estimation_strategies-1729"><a href="#get_lr_estimation_strategies-1729"><span class="linenos">1729</span></a>        <span class="s1">&#39;random&#39;</span><span class="p">,</span> <span class="s1">&#39;entropy&#39;</span><span class="p">,</span> <span class="s1">&#39;bayes&#39;</span>
</span><span id="get_lr_estimation_strategies-1730"><a href="#get_lr_estimation_strategies-1730"><span class="linenos">1730</span></a>    <span class="p">]</span>    
</span><span id="get_lr_estimation_strategies-1731"><a href="#get_lr_estimation_strategies-1731"><span class="linenos">1731</span></a>    <span class="k">return</span> <span class="n">strategies</span>
</span></pre></div>


            <div class="docstring"><p>Return a list of supported learning rate estimation strategies
for NSA-Flow's estimate_learning_rate_for_nsa_flow function.</p>

<p>Returns:
    List[str]: Supported strategies.</p>
</div>


                </section>
                <section id="test_lr_aggression_monotonicity">
                            <input id="test_lr_aggression_monotonicity-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">test_lr_aggression_monotonicity</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span>, </span><span class="param"><span class="n">plot</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="test_lr_aggression_monotonicity-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#test_lr_aggression_monotonicity"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="test_lr_aggression_monotonicity-2030"><a href="#test_lr_aggression_monotonicity-2030"><span class="linenos">2030</span></a><span class="k">def</span><span class="w"> </span><span class="nf">test_lr_aggression_monotonicity</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="test_lr_aggression_monotonicity-2031"><a href="#test_lr_aggression_monotonicity-2031"><span class="linenos">2031</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="test_lr_aggression_monotonicity-2032"><a href="#test_lr_aggression_monotonicity-2032"><span class="linenos">2032</span></a><span class="sd">    Test that learning rate estimates increase monotonically with aggression level</span>
</span><span id="test_lr_aggression_monotonicity-2033"><a href="#test_lr_aggression_monotonicity-2033"><span class="linenos">2033</span></a><span class="sd">    for each available strategy in NSA-Flow.</span>
</span><span id="test_lr_aggression_monotonicity-2034"><a href="#test_lr_aggression_monotonicity-2034"><span class="linenos">2034</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="test_lr_aggression_monotonicity-2035"><a href="#test_lr_aggression_monotonicity-2035"><span class="linenos">2035</span></a>
</span><span id="test_lr_aggression_monotonicity-2036"><a href="#test_lr_aggression_monotonicity-2036"><span class="linenos">2036</span></a>    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="test_lr_aggression_monotonicity-2037"><a href="#test_lr_aggression_monotonicity-2037"><span class="linenos">2037</span></a>    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="test_lr_aggression_monotonicity-2038"><a href="#test_lr_aggression_monotonicity-2038"><span class="linenos">2038</span></a>
</span><span id="test_lr_aggression_monotonicity-2039"><a href="#test_lr_aggression_monotonicity-2039"><span class="linenos">2039</span></a>    <span class="c1"># Minimal example data</span>
</span><span id="test_lr_aggression_monotonicity-2040"><a href="#test_lr_aggression_monotonicity-2040"><span class="linenos">2040</span></a>    <span class="n">Y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</span><span id="test_lr_aggression_monotonicity-2041"><a href="#test_lr_aggression_monotonicity-2041"><span class="linenos">2041</span></a>    <span class="n">X</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</span><span id="test_lr_aggression_monotonicity-2042"><a href="#test_lr_aggression_monotonicity-2042"><span class="linenos">2042</span></a>
</span><span id="test_lr_aggression_monotonicity-2043"><a href="#test_lr_aggression_monotonicity-2043"><span class="linenos">2043</span></a>    <span class="n">strategies</span> <span class="o">=</span> <span class="n">get_lr_estimation_strategies</span><span class="p">(</span>  <span class="p">)</span>
</span><span id="test_lr_aggression_monotonicity-2044"><a href="#test_lr_aggression_monotonicity-2044"><span class="linenos">2044</span></a>    <span class="n">strategies</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;entropy&quot;</span><span class="p">)</span>  <span class="c1"># temporarily exclude due to instability</span>
</span><span id="test_lr_aggression_monotonicity-2045"><a href="#test_lr_aggression_monotonicity-2045"><span class="linenos">2045</span></a>    <span class="n">aggressions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
</span><span id="test_lr_aggression_monotonicity-2046"><a href="#test_lr_aggression_monotonicity-2046"><span class="linenos">2046</span></a>    <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="test_lr_aggression_monotonicity-2047"><a href="#test_lr_aggression_monotonicity-2047"><span class="linenos">2047</span></a>
</span><span id="test_lr_aggression_monotonicity-2048"><a href="#test_lr_aggression_monotonicity-2048"><span class="linenos">2048</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
</span><span id="test_lr_aggression_monotonicity-2049"><a href="#test_lr_aggression_monotonicity-2049"><span class="linenos">2049</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Testing learning rate monotonicity vs. aggression&quot;</span><span class="p">)</span>
</span><span id="test_lr_aggression_monotonicity-2050"><a href="#test_lr_aggression_monotonicity-2050"><span class="linenos">2050</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
</span><span id="test_lr_aggression_monotonicity-2051"><a href="#test_lr_aggression_monotonicity-2051"><span class="linenos">2051</span></a>
</span><span id="test_lr_aggression_monotonicity-2052"><a href="#test_lr_aggression_monotonicity-2052"><span class="linenos">2052</span></a>    <span class="k">for</span> <span class="n">strategy</span> <span class="ow">in</span> <span class="n">strategies</span><span class="p">:</span>
</span><span id="test_lr_aggression_monotonicity-2053"><a href="#test_lr_aggression_monotonicity-2053"><span class="linenos">2053</span></a>        <span class="n">lr_vals</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="test_lr_aggression_monotonicity-2054"><a href="#test_lr_aggression_monotonicity-2054"><span class="linenos">2054</span></a>        <span class="k">for</span> <span class="n">agg</span> <span class="ow">in</span> <span class="n">aggressions</span><span class="p">:</span>
</span><span id="test_lr_aggression_monotonicity-2055"><a href="#test_lr_aggression_monotonicity-2055"><span class="linenos">2055</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="test_lr_aggression_monotonicity-2056"><a href="#test_lr_aggression_monotonicity-2056"><span class="linenos">2056</span></a>                <span class="n">res</span> <span class="o">=</span> <span class="n">estimate_learning_rate_for_nsa_flow</span><span class="p">(</span>
</span><span id="test_lr_aggression_monotonicity-2057"><a href="#test_lr_aggression_monotonicity-2057"><span class="linenos">2057</span></a>                    <span class="n">Y</span><span class="p">,</span>
</span><span id="test_lr_aggression_monotonicity-2058"><a href="#test_lr_aggression_monotonicity-2058"><span class="linenos">2058</span></a>                    <span class="n">X</span><span class="p">,</span>
</span><span id="test_lr_aggression_monotonicity-2059"><a href="#test_lr_aggression_monotonicity-2059"><span class="linenos">2059</span></a>                    <span class="n">w</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
</span><span id="test_lr_aggression_monotonicity-2060"><a href="#test_lr_aggression_monotonicity-2060"><span class="linenos">2060</span></a>                    <span class="n">retraction</span><span class="o">=</span><span class="s2">&quot;soft_polar&quot;</span><span class="p">,</span>
</span><span id="test_lr_aggression_monotonicity-2061"><a href="#test_lr_aggression_monotonicity-2061"><span class="linenos">2061</span></a>                    <span class="n">strategy</span><span class="o">=</span><span class="n">strategy</span><span class="p">,</span>
</span><span id="test_lr_aggression_monotonicity-2062"><a href="#test_lr_aggression_monotonicity-2062"><span class="linenos">2062</span></a>                    <span class="n">aggression</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">agg</span><span class="p">),</span>
</span><span id="test_lr_aggression_monotonicity-2063"><a href="#test_lr_aggression_monotonicity-2063"><span class="linenos">2063</span></a>                    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="test_lr_aggression_monotonicity-2064"><a href="#test_lr_aggression_monotonicity-2064"><span class="linenos">2064</span></a>                    <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="test_lr_aggression_monotonicity-2065"><a href="#test_lr_aggression_monotonicity-2065"><span class="linenos">2065</span></a>                <span class="p">)</span>
</span><span id="test_lr_aggression_monotonicity-2066"><a href="#test_lr_aggression_monotonicity-2066"><span class="linenos">2066</span></a>                <span class="n">lr_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;best_lr&quot;</span><span class="p">])</span>
</span><span id="test_lr_aggression_monotonicity-2067"><a href="#test_lr_aggression_monotonicity-2067"><span class="linenos">2067</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="test_lr_aggression_monotonicity-2068"><a href="#test_lr_aggression_monotonicity-2068"><span class="linenos">2068</span></a>                <span class="n">lr_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
</span><span id="test_lr_aggression_monotonicity-2069"><a href="#test_lr_aggression_monotonicity-2069"><span class="linenos">2069</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">strategy</span><span class="si">:</span><span class="s2">&lt;18</span><span class="si">}</span><span class="s2"> agg=</span><span class="si">{</span><span class="n">agg</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="test_lr_aggression_monotonicity-2070"><a href="#test_lr_aggression_monotonicity-2070"><span class="linenos">2070</span></a>
</span><span id="test_lr_aggression_monotonicity-2071"><a href="#test_lr_aggression_monotonicity-2071"><span class="linenos">2071</span></a>        <span class="n">lr_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lr_vals</span><span class="p">)</span>
</span><span id="test_lr_aggression_monotonicity-2072"><a href="#test_lr_aggression_monotonicity-2072"><span class="linenos">2072</span></a>        <span class="n">results</span><span class="p">[</span><span class="n">strategy</span><span class="p">]</span> <span class="o">=</span> <span class="n">lr_vals</span>
</span><span id="test_lr_aggression_monotonicity-2073"><a href="#test_lr_aggression_monotonicity-2073"><span class="linenos">2073</span></a>
</span><span id="test_lr_aggression_monotonicity-2074"><a href="#test_lr_aggression_monotonicity-2074"><span class="linenos">2074</span></a>        <span class="c1"># --- Monotonicity test ---</span>
</span><span id="test_lr_aggression_monotonicity-2075"><a href="#test_lr_aggression_monotonicity-2075"><span class="linenos">2075</span></a>        <span class="n">diffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">lr_vals</span> <span class="o">+</span> <span class="mf">1e-12</span><span class="p">))</span>  <span class="c1"># check log-scale differences</span>
</span><span id="test_lr_aggression_monotonicity-2076"><a href="#test_lr_aggression_monotonicity-2076"><span class="linenos">2076</span></a>        <span class="n">monotonic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">diffs</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mf">1e-3</span><span class="p">)</span>  <span class="c1"># small tolerance</span>
</span><span id="test_lr_aggression_monotonicity-2077"><a href="#test_lr_aggression_monotonicity-2077"><span class="linenos">2077</span></a>
</span><span id="test_lr_aggression_monotonicity-2078"><a href="#test_lr_aggression_monotonicity-2078"><span class="linenos">2078</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="test_lr_aggression_monotonicity-2079"><a href="#test_lr_aggression_monotonicity-2079"><span class="linenos">2079</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">strategy</span><span class="si">:</span><span class="s2">&lt;18</span><span class="si">}</span><span class="s2"> LRs: </span><span class="si">{</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">lr_vals</span><span class="p">]</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">monotonic</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39; Non-monotonic&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="test_lr_aggression_monotonicity-2080"><a href="#test_lr_aggression_monotonicity-2080"><span class="linenos">2080</span></a>
</span><span id="test_lr_aggression_monotonicity-2081"><a href="#test_lr_aggression_monotonicity-2081"><span class="linenos">2081</span></a>        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">lr_vals</span><span class="p">)),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">strategy</span><span class="si">}</span><span class="s2">: all NaN learning rates&quot;</span>
</span><span id="test_lr_aggression_monotonicity-2082"><a href="#test_lr_aggression_monotonicity-2082"><span class="linenos">2082</span></a>        <span class="k">assert</span> <span class="n">monotonic</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">strategy</span><span class="si">}</span><span class="s2">: learning rate did not increase monotonically with aggression&quot;</span>
</span><span id="test_lr_aggression_monotonicity-2083"><a href="#test_lr_aggression_monotonicity-2083"><span class="linenos">2083</span></a>
</span><span id="test_lr_aggression_monotonicity-2084"><a href="#test_lr_aggression_monotonicity-2084"><span class="linenos">2084</span></a>    <span class="c1"># --- Optional visualization ---</span>
</span><span id="test_lr_aggression_monotonicity-2085"><a href="#test_lr_aggression_monotonicity-2085"><span class="linenos">2085</span></a>    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
</span><span id="test_lr_aggression_monotonicity-2086"><a href="#test_lr_aggression_monotonicity-2086"><span class="linenos">2086</span></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
</span><span id="test_lr_aggression_monotonicity-2087"><a href="#test_lr_aggression_monotonicity-2087"><span class="linenos">2087</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
</span><span id="test_lr_aggression_monotonicity-2088"><a href="#test_lr_aggression_monotonicity-2088"><span class="linenos">2088</span></a>        <span class="k">for</span> <span class="n">strat</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="test_lr_aggression_monotonicity-2089"><a href="#test_lr_aggression_monotonicity-2089"><span class="linenos">2089</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">vals</span><span class="p">)):</span>
</span><span id="test_lr_aggression_monotonicity-2090"><a href="#test_lr_aggression_monotonicity-2090"><span class="linenos">2090</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">aggressions</span><span class="p">,</span> <span class="n">vals</span><span class="p">,</span> <span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">strat</span><span class="p">)</span>
</span><span id="test_lr_aggression_monotonicity-2091"><a href="#test_lr_aggression_monotonicity-2091"><span class="linenos">2091</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Aggression Level&quot;</span><span class="p">)</span>
</span><span id="test_lr_aggression_monotonicity-2092"><a href="#test_lr_aggression_monotonicity-2092"><span class="linenos">2092</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Estimated Learning Rate&quot;</span><span class="p">)</span>
</span><span id="test_lr_aggression_monotonicity-2093"><a href="#test_lr_aggression_monotonicity-2093"><span class="linenos">2093</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Monotonicity of LR vs. Aggression Across Strategies&quot;</span><span class="p">)</span>
</span><span id="test_lr_aggression_monotonicity-2094"><a href="#test_lr_aggression_monotonicity-2094"><span class="linenos">2094</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
</span><span id="test_lr_aggression_monotonicity-2095"><a href="#test_lr_aggression_monotonicity-2095"><span class="linenos">2095</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
</span><span id="test_lr_aggression_monotonicity-2096"><a href="#test_lr_aggression_monotonicity-2096"><span class="linenos">2096</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
</span><span id="test_lr_aggression_monotonicity-2097"><a href="#test_lr_aggression_monotonicity-2097"><span class="linenos">2097</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="test_lr_aggression_monotonicity-2098"><a href="#test_lr_aggression_monotonicity-2098"><span class="linenos">2098</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="test_lr_aggression_monotonicity-2099"><a href="#test_lr_aggression_monotonicity-2099"><span class="linenos">2099</span></a>
</span><span id="test_lr_aggression_monotonicity-2100"><a href="#test_lr_aggression_monotonicity-2100"><span class="linenos">2100</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; All strategies tested for monotonicity.&quot;</span><span class="p">)</span>
</span><span id="test_lr_aggression_monotonicity-2101"><a href="#test_lr_aggression_monotonicity-2101"><span class="linenos">2101</span></a>    <span class="k">return</span> <span class="n">results</span>
</span></pre></div>


            <div class="docstring"><p>Test that learning rate estimates increase monotonically with aggression level
for each available strategy in NSA-Flow.</p>
</div>


                </section>
                <section id="run_single_experiment">
                            <input id="run_single_experiment-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">run_single_experiment</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>,</span><span class="param">	<span class="n">w</span><span class="o">=</span><span class="mf">0.5</span>,</span><span class="param">	<span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span>,</span><span class="param">	<span class="n">optimizer_name</span><span class="o">=</span><span class="s1">&#39;lars&#39;</span>,</span><span class="param">	<span class="n">aggression</span><span class="o">=</span><span class="mf">0.5</span>,</span><span class="param">	<span class="n">fidelity_type</span><span class="o">=</span><span class="s1">&#39;scale_invariant&#39;</span>,</span><span class="param">	<span class="n">orth_type</span><span class="o">=</span><span class="s1">&#39;scale_invariant&#39;</span>,</span><span class="param">	<span class="n">device</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span>,</span><span class="param">	<span class="n">seed</span><span class="o">=</span><span class="mi">42</span>,</span><span class="param">	<span class="n">verbose</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="run_single_experiment-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#run_single_experiment"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="run_single_experiment-2105"><a href="#run_single_experiment-2105"><span class="linenos">2105</span></a><span class="k">def</span><span class="w"> </span><span class="nf">run_single_experiment</span><span class="p">(</span>
</span><span id="run_single_experiment-2106"><a href="#run_single_experiment-2106"><span class="linenos">2106</span></a>    <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="mi">50</span><span class="p">,</span><span class="mi">10</span><span class="p">],</span>
</span><span id="run_single_experiment-2107"><a href="#run_single_experiment-2107"><span class="linenos">2107</span></a>    <span class="n">w</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
</span><span id="run_single_experiment-2108"><a href="#run_single_experiment-2108"><span class="linenos">2108</span></a>    <span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
</span><span id="run_single_experiment-2109"><a href="#run_single_experiment-2109"><span class="linenos">2109</span></a>    <span class="n">optimizer_name</span><span class="o">=</span><span class="s1">&#39;lars&#39;</span><span class="p">,</span>
</span><span id="run_single_experiment-2110"><a href="#run_single_experiment-2110"><span class="linenos">2110</span></a>    <span class="n">aggression</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
</span><span id="run_single_experiment-2111"><a href="#run_single_experiment-2111"><span class="linenos">2111</span></a>    <span class="n">fidelity_type</span><span class="o">=</span><span class="s2">&quot;scale_invariant&quot;</span><span class="p">,</span>
</span><span id="run_single_experiment-2112"><a href="#run_single_experiment-2112"><span class="linenos">2112</span></a>    <span class="n">orth_type</span><span class="o">=</span><span class="s2">&quot;scale_invariant&quot;</span><span class="p">,</span>
</span><span id="run_single_experiment-2113"><a href="#run_single_experiment-2113"><span class="linenos">2113</span></a>    <span class="n">device</span><span class="o">=</span><span class="s2">&quot;cpu&quot;</span><span class="p">,</span>
</span><span id="run_single_experiment-2114"><a href="#run_single_experiment-2114"><span class="linenos">2114</span></a>    <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
</span><span id="run_single_experiment-2115"><a href="#run_single_experiment-2115"><span class="linenos">2115</span></a>    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="run_single_experiment-2116"><a href="#run_single_experiment-2116"><span class="linenos">2116</span></a><span class="p">):</span>
</span><span id="run_single_experiment-2117"><a href="#run_single_experiment-2117"><span class="linenos">2117</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="run_single_experiment-2118"><a href="#run_single_experiment-2118"><span class="linenos">2118</span></a><span class="sd">    Run a single NSA-Flow optimization with given configuration and aggression level.</span>
</span><span id="run_single_experiment-2119"><a href="#run_single_experiment-2119"><span class="linenos">2119</span></a><span class="sd">    Returns summary dict of results including fidelity and orth energies.</span>
</span><span id="run_single_experiment-2120"><a href="#run_single_experiment-2120"><span class="linenos">2120</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="run_single_experiment-2121"><a href="#run_single_experiment-2121"><span class="linenos">2121</span></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">torch</span><span class="o">,</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span><span class="o">,</span><span class="w"> </span><span class="nn">time</span>
</span><span id="run_single_experiment-2122"><a href="#run_single_experiment-2122"><span class="linenos">2122</span></a>    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seed</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">aggression</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">))</span>
</span><span id="run_single_experiment-2123"><a href="#run_single_experiment-2123"><span class="linenos">2123</span></a>    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">aggression</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">))</span>
</span><span id="run_single_experiment-2124"><a href="#run_single_experiment-2124"><span class="linenos">2124</span></a>
</span><span id="run_single_experiment-2125"><a href="#run_single_experiment-2125"><span class="linenos">2125</span></a>    <span class="n">p</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">size</span>
</span><span id="run_single_experiment-2126"><a href="#run_single_experiment-2126"><span class="linenos">2126</span></a>    <span class="n">X0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="run_single_experiment-2127"><a href="#run_single_experiment-2127"><span class="linenos">2127</span></a>    <span class="n">Y0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">X0</span><span class="p">)</span>
</span><span id="run_single_experiment-2128"><a href="#run_single_experiment-2128"><span class="linenos">2128</span></a>
</span><span id="run_single_experiment-2129"><a href="#run_single_experiment-2129"><span class="linenos">2129</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="run_single_experiment-2130"><a href="#run_single_experiment-2130"><span class="linenos">2130</span></a>        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="run_single_experiment-2131"><a href="#run_single_experiment-2131"><span class="linenos">2131</span></a>        <span class="n">res</span> <span class="o">=</span> <span class="n">nsa_flow_orth</span><span class="p">(</span>
</span><span id="run_single_experiment-2132"><a href="#run_single_experiment-2132"><span class="linenos">2132</span></a>            <span class="n">Y0</span><span class="p">,</span>
</span><span id="run_single_experiment-2133"><a href="#run_single_experiment-2133"><span class="linenos">2133</span></a>            <span class="n">X0</span><span class="o">=</span><span class="n">X0</span><span class="p">,</span>
</span><span id="run_single_experiment-2134"><a href="#run_single_experiment-2134"><span class="linenos">2134</span></a>            <span class="n">w</span><span class="o">=</span><span class="n">w</span><span class="p">,</span>
</span><span id="run_single_experiment-2135"><a href="#run_single_experiment-2135"><span class="linenos">2135</span></a>            <span class="n">retraction</span><span class="o">=</span><span class="s2">&quot;soft_polar&quot;</span><span class="p">,</span>
</span><span id="run_single_experiment-2136"><a href="#run_single_experiment-2136"><span class="linenos">2136</span></a>            <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer_name</span><span class="p">,</span>
</span><span id="run_single_experiment-2137"><a href="#run_single_experiment-2137"><span class="linenos">2137</span></a>            <span class="n">lr_strategy</span><span class="o">=</span><span class="n">strategy</span><span class="p">,</span>
</span><span id="run_single_experiment-2138"><a href="#run_single_experiment-2138"><span class="linenos">2138</span></a>            <span class="n">aggression</span><span class="o">=</span><span class="n">aggression</span><span class="p">,</span>
</span><span id="run_single_experiment-2139"><a href="#run_single_experiment-2139"><span class="linenos">2139</span></a>            <span class="n">max_iter</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
</span><span id="run_single_experiment-2140"><a href="#run_single_experiment-2140"><span class="linenos">2140</span></a>            <span class="n">tol</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">,</span>
</span><span id="run_single_experiment-2141"><a href="#run_single_experiment-2141"><span class="linenos">2141</span></a>            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
</span><span id="run_single_experiment-2142"><a href="#run_single_experiment-2142"><span class="linenos">2142</span></a>            <span class="n">apply_nonneg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="run_single_experiment-2143"><a href="#run_single_experiment-2143"><span class="linenos">2143</span></a>            <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span>
</span><span id="run_single_experiment-2144"><a href="#run_single_experiment-2144"><span class="linenos">2144</span></a>            <span class="n">record_every</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span><span id="run_single_experiment-2145"><a href="#run_single_experiment-2145"><span class="linenos">2145</span></a>            <span class="n">precision</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">,</span>
</span><span id="run_single_experiment-2146"><a href="#run_single_experiment-2146"><span class="linenos">2146</span></a>        <span class="p">)</span>
</span><span id="run_single_experiment-2147"><a href="#run_single_experiment-2147"><span class="linenos">2147</span></a>        <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
</span><span id="run_single_experiment-2148"><a href="#run_single_experiment-2148"><span class="linenos">2148</span></a>
</span><span id="run_single_experiment-2149"><a href="#run_single_experiment-2149"><span class="linenos">2149</span></a>        <span class="n">Y_final</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="run_single_experiment-2150"><a href="#run_single_experiment-2150"><span class="linenos">2150</span></a>        <span class="k">if</span> <span class="n">Y_final</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;Y_final&quot;</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
</span><span id="run_single_experiment-2151"><a href="#run_single_experiment-2151"><span class="linenos">2151</span></a>            <span class="n">Y_final</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;Y_final&quot;</span><span class="p">]</span>
</span><span id="run_single_experiment-2152"><a href="#run_single_experiment-2152"><span class="linenos">2152</span></a>        <span class="k">if</span> <span class="n">Y_final</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="run_single_experiment-2153"><a href="#run_single_experiment-2153"><span class="linenos">2153</span></a>            <span class="n">energy_dict</span> <span class="o">=</span> <span class="n">compute_energy</span><span class="p">(</span>
</span><span id="run_single_experiment-2154"><a href="#run_single_experiment-2154"><span class="linenos">2154</span></a>                <span class="n">Y_final</span><span class="p">,</span>
</span><span id="run_single_experiment-2155"><a href="#run_single_experiment-2155"><span class="linenos">2155</span></a>                <span class="n">X0</span><span class="p">,</span>
</span><span id="run_single_experiment-2156"><a href="#run_single_experiment-2156"><span class="linenos">2156</span></a>                <span class="n">w</span><span class="o">=</span><span class="n">w</span><span class="p">,</span>
</span><span id="run_single_experiment-2157"><a href="#run_single_experiment-2157"><span class="linenos">2157</span></a>                <span class="n">fidelity_type</span><span class="o">=</span><span class="n">fidelity_type</span><span class="p">,</span>
</span><span id="run_single_experiment-2158"><a href="#run_single_experiment-2158"><span class="linenos">2158</span></a>                <span class="n">orth_type</span><span class="o">=</span><span class="n">orth_type</span><span class="p">,</span>
</span><span id="run_single_experiment-2159"><a href="#run_single_experiment-2159"><span class="linenos">2159</span></a>                <span class="n">fid_eta</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
</span><span id="run_single_experiment-2160"><a href="#run_single_experiment-2160"><span class="linenos">2160</span></a>                <span class="n">c_orth</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
</span><span id="run_single_experiment-2161"><a href="#run_single_experiment-2161"><span class="linenos">2161</span></a>                <span class="n">track_grad</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="run_single_experiment-2162"><a href="#run_single_experiment-2162"><span class="linenos">2162</span></a>                <span class="n">return_dict</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="run_single_experiment-2163"><a href="#run_single_experiment-2163"><span class="linenos">2163</span></a>            <span class="p">)</span>
</span><span id="run_single_experiment-2164"><a href="#run_single_experiment-2164"><span class="linenos">2164</span></a>            <span class="n">total_energy</span> <span class="o">=</span> <span class="n">energy_dict</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">]</span>
</span><span id="run_single_experiment-2165"><a href="#run_single_experiment-2165"><span class="linenos">2165</span></a>            <span class="n">fid_energy</span> <span class="o">=</span> <span class="n">energy_dict</span><span class="p">[</span><span class="s2">&quot;fidelity&quot;</span><span class="p">]</span>
</span><span id="run_single_experiment-2166"><a href="#run_single_experiment-2166"><span class="linenos">2166</span></a>            <span class="n">orth_energy</span> <span class="o">=</span> <span class="n">energy_dict</span><span class="p">[</span><span class="s2">&quot;orthogonality&quot;</span><span class="p">]</span>
</span><span id="run_single_experiment-2167"><a href="#run_single_experiment-2167"><span class="linenos">2167</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="run_single_experiment-2168"><a href="#run_single_experiment-2168"><span class="linenos">2168</span></a>            <span class="n">total_energy</span> <span class="o">=</span> <span class="n">fid_energy</span> <span class="o">=</span> <span class="n">orth_energy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="run_single_experiment-2169"><a href="#run_single_experiment-2169"><span class="linenos">2169</span></a>
</span><span id="run_single_experiment-2170"><a href="#run_single_experiment-2170"><span class="linenos">2170</span></a>        <span class="n">best_iter</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;best_Y_iteration&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">))</span>
</span><span id="run_single_experiment-2171"><a href="#run_single_experiment-2171"><span class="linenos">2171</span></a>        <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="run_single_experiment-2172"><a href="#run_single_experiment-2172"><span class="linenos">2172</span></a>
</span><span id="run_single_experiment-2173"><a href="#run_single_experiment-2173"><span class="linenos">2173</span></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="run_single_experiment-2174"><a href="#run_single_experiment-2174"><span class="linenos">2174</span></a>        <span class="n">total_energy</span> <span class="o">=</span> <span class="n">fid_energy</span> <span class="o">=</span> <span class="n">orth_energy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="run_single_experiment-2175"><a href="#run_single_experiment-2175"><span class="linenos">2175</span></a>        <span class="n">best_iter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="run_single_experiment-2176"><a href="#run_single_experiment-2176"><span class="linenos">2176</span></a>        <span class="n">elapsed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="run_single_experiment-2177"><a href="#run_single_experiment-2177"><span class="linenos">2177</span></a>        <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="run_single_experiment-2178"><a href="#run_single_experiment-2178"><span class="linenos">2178</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Failure: </span><span class="si">{</span><span class="n">strategy</span><span class="si">}</span><span class="s2"> / </span><span class="si">{</span><span class="n">optimizer_name</span><span class="si">}</span><span class="s2"> (agg=</span><span class="si">{</span><span class="n">aggression</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)  </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="run_single_experiment-2179"><a href="#run_single_experiment-2179"><span class="linenos">2179</span></a>
</span><span id="run_single_experiment-2180"><a href="#run_single_experiment-2180"><span class="linenos">2180</span></a>    <span class="k">return</span> <span class="p">{</span>
</span><span id="run_single_experiment-2181"><a href="#run_single_experiment-2181"><span class="linenos">2181</span></a>        <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="run_single_experiment-2182"><a href="#run_single_experiment-2182"><span class="linenos">2182</span></a>        <span class="s2">&quot;w&quot;</span><span class="p">:</span> <span class="n">w</span><span class="p">,</span>
</span><span id="run_single_experiment-2183"><a href="#run_single_experiment-2183"><span class="linenos">2183</span></a>        <span class="s2">&quot;strategy&quot;</span><span class="p">:</span> <span class="n">strategy</span><span class="p">,</span>
</span><span id="run_single_experiment-2184"><a href="#run_single_experiment-2184"><span class="linenos">2184</span></a>        <span class="s2">&quot;optimizer&quot;</span><span class="p">:</span> <span class="n">optimizer_name</span><span class="p">,</span>
</span><span id="run_single_experiment-2185"><a href="#run_single_experiment-2185"><span class="linenos">2185</span></a>        <span class="s2">&quot;aggression&quot;</span><span class="p">:</span> <span class="n">aggression</span><span class="p">,</span>
</span><span id="run_single_experiment-2186"><a href="#run_single_experiment-2186"><span class="linenos">2186</span></a>        <span class="s2">&quot;fidelity_type&quot;</span><span class="p">:</span> <span class="n">fidelity_type</span><span class="p">,</span>
</span><span id="run_single_experiment-2187"><a href="#run_single_experiment-2187"><span class="linenos">2187</span></a>        <span class="s2">&quot;orth_type&quot;</span><span class="p">:</span> <span class="n">orth_type</span><span class="p">,</span>
</span><span id="run_single_experiment-2188"><a href="#run_single_experiment-2188"><span class="linenos">2188</span></a>        <span class="s2">&quot;final_energy&quot;</span><span class="p">:</span> <span class="n">total_energy</span><span class="p">,</span>
</span><span id="run_single_experiment-2189"><a href="#run_single_experiment-2189"><span class="linenos">2189</span></a>        <span class="s2">&quot;total_energy&quot;</span><span class="p">:</span> <span class="n">total_energy</span><span class="p">,</span>
</span><span id="run_single_experiment-2190"><a href="#run_single_experiment-2190"><span class="linenos">2190</span></a>        <span class="s2">&quot;fidelity_energy&quot;</span><span class="p">:</span> <span class="n">fid_energy</span><span class="p">,</span>
</span><span id="run_single_experiment-2191"><a href="#run_single_experiment-2191"><span class="linenos">2191</span></a>        <span class="s2">&quot;orth_energy&quot;</span><span class="p">:</span> <span class="n">orth_energy</span><span class="p">,</span>
</span><span id="run_single_experiment-2192"><a href="#run_single_experiment-2192"><span class="linenos">2192</span></a>        <span class="s2">&quot;best_iter&quot;</span><span class="p">:</span> <span class="n">best_iter</span><span class="p">,</span>
</span><span id="run_single_experiment-2193"><a href="#run_single_experiment-2193"><span class="linenos">2193</span></a>        <span class="s2">&quot;elapsed_sec&quot;</span><span class="p">:</span> <span class="n">elapsed</span><span class="p">,</span>
</span><span id="run_single_experiment-2194"><a href="#run_single_experiment-2194"><span class="linenos">2194</span></a>        <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="n">success</span><span class="p">,</span>
</span><span id="run_single_experiment-2195"><a href="#run_single_experiment-2195"><span class="linenos">2195</span></a>    <span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>Run a single NSA-Flow optimization with given configuration and aggression level.
Returns summary dict of results including fidelity and orth energies.</p>
</div>


                </section>
                <section id="evaluate">
                            <input id="evaluate-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">evaluate</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span>, </span><span class="param"><span class="n">fast</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>, </span><span class="param"><span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="evaluate-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#evaluate"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="evaluate-2197"><a href="#evaluate-2197"><span class="linenos">2197</span></a><span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span><span class="p">,</span> <span class="n">fast</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
</span><span id="evaluate-2198"><a href="#evaluate-2198"><span class="linenos">2198</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="evaluate-2199"><a href="#evaluate-2199"><span class="linenos">2199</span></a><span class="sd">    Comprehensive benchmark of NSA-Flow configurations.</span>
</span><span id="evaluate-2200"><a href="#evaluate-2200"><span class="linenos">2200</span></a>
</span><span id="evaluate-2201"><a href="#evaluate-2201"><span class="linenos">2201</span></a><span class="sd">    Tests combinations of:</span>
</span><span id="evaluate-2202"><a href="#evaluate-2202"><span class="linenos">2202</span></a><span class="sd">    - learning rate estimation strategies</span>
</span><span id="evaluate-2203"><a href="#evaluate-2203"><span class="linenos">2203</span></a><span class="sd">    - optimizers</span>
</span><span id="evaluate-2204"><a href="#evaluate-2204"><span class="linenos">2204</span></a><span class="sd">    - aggression levels</span>
</span><span id="evaluate-2205"><a href="#evaluate-2205"><span class="linenos">2205</span></a><span class="sd">    - weighting parameter w</span>
</span><span id="evaluate-2206"><a href="#evaluate-2206"><span class="linenos">2206</span></a><span class="sd">    - matrix sizes</span>
</span><span id="evaluate-2207"><a href="#evaluate-2207"><span class="linenos">2207</span></a><span class="sd">    - fidelity and orthogonality energy types</span>
</span><span id="evaluate-2208"><a href="#evaluate-2208"><span class="linenos">2208</span></a>
</span><span id="evaluate-2209"><a href="#evaluate-2209"><span class="linenos">2209</span></a><span class="sd">    Returns</span>
</span><span id="evaluate-2210"><a href="#evaluate-2210"><span class="linenos">2210</span></a><span class="sd">    -------</span>
</span><span id="evaluate-2211"><a href="#evaluate-2211"><span class="linenos">2211</span></a><span class="sd">    pd.DataFrame</span>
</span><span id="evaluate-2212"><a href="#evaluate-2212"><span class="linenos">2212</span></a><span class="sd">        Results of all experiments with metrics and rankings.</span>
</span><span id="evaluate-2213"><a href="#evaluate-2213"><span class="linenos">2213</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="evaluate-2214"><a href="#evaluate-2214"><span class="linenos">2214</span></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
</span><span id="evaluate-2215"><a href="#evaluate-2215"><span class="linenos">2215</span></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
</span><span id="evaluate-2216"><a href="#evaluate-2216"><span class="linenos">2216</span></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="evaluate-2217"><a href="#evaluate-2217"><span class="linenos">2217</span></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
</span><span id="evaluate-2218"><a href="#evaluate-2218"><span class="linenos">2218</span></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">nsa_flow</span>
</span><span id="evaluate-2219"><a href="#evaluate-2219"><span class="linenos">2219</span></a>
</span><span id="evaluate-2220"><a href="#evaluate-2220"><span class="linenos">2220</span></a>    <span class="c1"># ------------------------------------------------------------------</span>
</span><span id="evaluate-2221"><a href="#evaluate-2221"><span class="linenos">2221</span></a>    <span class="c1"># Setup reproducibility</span>
</span><span id="evaluate-2222"><a href="#evaluate-2222"><span class="linenos">2222</span></a>    <span class="c1"># ------------------------------------------------------------------</span>
</span><span id="evaluate-2223"><a href="#evaluate-2223"><span class="linenos">2223</span></a>    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
</span><span id="evaluate-2224"><a href="#evaluate-2224"><span class="linenos">2224</span></a>    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
</span><span id="evaluate-2225"><a href="#evaluate-2225"><span class="linenos">2225</span></a>
</span><span id="evaluate-2226"><a href="#evaluate-2226"><span class="linenos">2226</span></a>    <span class="c1"># ------------------------------------------------------------------</span>
</span><span id="evaluate-2227"><a href="#evaluate-2227"><span class="linenos">2227</span></a>    <span class="c1"># Experimental configuration</span>
</span><span id="evaluate-2228"><a href="#evaluate-2228"><span class="linenos">2228</span></a>    <span class="c1"># ------------------------------------------------------------------</span>
</span><span id="evaluate-2229"><a href="#evaluate-2229"><span class="linenos">2229</span></a>    <span class="n">strategies</span> <span class="o">=</span> <span class="n">nsa_flow</span><span class="o">.</span><span class="n">get_lr_estimation_strategies</span><span class="p">()</span>
</span><span id="evaluate-2230"><a href="#evaluate-2230"><span class="linenos">2230</span></a>    <span class="n">optimizers</span> <span class="o">=</span> <span class="n">nsa_flow</span><span class="o">.</span><span class="n">get_torch_optimizer</span><span class="p">(</span><span class="n">return_list</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="evaluate-2231"><a href="#evaluate-2231"><span class="linenos">2231</span></a>    <span class="n">optimizers</span> <span class="o">=</span> <span class="p">[</span><span class="n">opt</span> <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">optimizers</span> <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">]]</span>
</span><span id="evaluate-2232"><a href="#evaluate-2232"><span class="linenos">2232</span></a>    <span class="n">aggressions</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
</span><span id="evaluate-2233"><a href="#evaluate-2233"><span class="linenos">2233</span></a>    <span class="n">ws</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">]</span>
</span><span id="evaluate-2234"><a href="#evaluate-2234"><span class="linenos">2234</span></a>    <span class="n">matrix_sizes</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">40</span><span class="p">),</span> <span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">200</span><span class="p">)]</span>
</span><span id="evaluate-2235"><a href="#evaluate-2235"><span class="linenos">2235</span></a>
</span><span id="evaluate-2236"><a href="#evaluate-2236"><span class="linenos">2236</span></a>    <span class="k">if</span> <span class="n">fast</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="evaluate-2237"><a href="#evaluate-2237"><span class="linenos">2237</span></a>        <span class="n">optimizers</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;lars&quot;</span><span class="p">,</span>  <span class="s2">&quot;asgd&quot;</span> <span class="p">]</span>
</span><span id="evaluate-2238"><a href="#evaluate-2238"><span class="linenos">2238</span></a>        <span class="n">matrix_sizes</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">)]</span><span class="c1"># , (100,400)]</span>
</span><span id="evaluate-2239"><a href="#evaluate-2239"><span class="linenos">2239</span></a>        <span class="n">ws</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">]</span>
</span><span id="evaluate-2240"><a href="#evaluate-2240"><span class="linenos">2240</span></a>        <span class="n">aggressions</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">]</span>
</span><span id="evaluate-2241"><a href="#evaluate-2241"><span class="linenos">2241</span></a>        <span class="n">strategies</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;random&quot;</span><span class="p">,</span> <span class="s2">&quot;armijo_aggressive&quot;</span><span class="p">,</span> <span class="s2">&quot;armijo&quot;</span><span class="p">,</span> <span class="s2">&quot;bayes&quot;</span><span class="p">]</span>
</span><span id="evaluate-2242"><a href="#evaluate-2242"><span class="linenos">2242</span></a>    <span class="k">elif</span> <span class="n">fast</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="evaluate-2243"><a href="#evaluate-2243"><span class="linenos">2243</span></a>        <span class="n">optimizers</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;lars&quot;</span> <span class="p">]</span>
</span><span id="evaluate-2244"><a href="#evaluate-2244"><span class="linenos">2244</span></a>        <span class="n">matrix_sizes</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">10</span><span class="p">)]</span>
</span><span id="evaluate-2245"><a href="#evaluate-2245"><span class="linenos">2245</span></a>        <span class="n">ws</span> <span class="o">=</span> <span class="p">[</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">]</span>
</span><span id="evaluate-2246"><a href="#evaluate-2246"><span class="linenos">2246</span></a>        <span class="n">aggressions</span> <span class="o">=</span> <span class="p">[</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span> <span class="p">]</span>
</span><span id="evaluate-2247"><a href="#evaluate-2247"><span class="linenos">2247</span></a>        <span class="n">strategies</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;armijo&quot;</span><span class="p">,</span> <span class="s2">&quot;bayes&quot;</span><span class="p">]</span>
</span><span id="evaluate-2248"><a href="#evaluate-2248"><span class="linenos">2248</span></a>
</span><span id="evaluate-2249"><a href="#evaluate-2249"><span class="linenos">2249</span></a>
</span><span id="evaluate-2250"><a href="#evaluate-2250"><span class="linenos">2250</span></a>    <span class="n">fidelity_types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;basic&quot;</span><span class="p">,</span> <span class="s2">&quot;scale_invariant&quot;</span><span class="p">,</span> <span class="s2">&quot;symmetric&quot;</span><span class="p">]</span>
</span><span id="evaluate-2251"><a href="#evaluate-2251"><span class="linenos">2251</span></a>    <span class="n">orth_types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;basic&quot;</span><span class="p">,</span> <span class="s2">&quot;scale_invariant&quot;</span><span class="p">]</span>
</span><span id="evaluate-2252"><a href="#evaluate-2252"><span class="linenos">2252</span></a>
</span><span id="evaluate-2253"><a href="#evaluate-2253"><span class="linenos">2253</span></a>    <span class="n">all_results</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="evaluate-2254"><a href="#evaluate-2254"><span class="linenos">2254</span></a>
</span><span id="evaluate-2255"><a href="#evaluate-2255"><span class="linenos">2255</span></a>    <span class="c1">#  include w in total job count</span>
</span><span id="evaluate-2256"><a href="#evaluate-2256"><span class="linenos">2256</span></a>    <span class="n">total_jobs</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="evaluate-2257"><a href="#evaluate-2257"><span class="linenos">2257</span></a>        <span class="nb">len</span><span class="p">(</span><span class="n">strategies</span><span class="p">)</span>
</span><span id="evaluate-2258"><a href="#evaluate-2258"><span class="linenos">2258</span></a>        <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">optimizers</span><span class="p">)</span>
</span><span id="evaluate-2259"><a href="#evaluate-2259"><span class="linenos">2259</span></a>        <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">aggressions</span><span class="p">)</span>
</span><span id="evaluate-2260"><a href="#evaluate-2260"><span class="linenos">2260</span></a>        <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span>
</span><span id="evaluate-2261"><a href="#evaluate-2261"><span class="linenos">2261</span></a>        <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">matrix_sizes</span><span class="p">)</span>
</span><span id="evaluate-2262"><a href="#evaluate-2262"><span class="linenos">2262</span></a>        <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">fidelity_types</span><span class="p">)</span>
</span><span id="evaluate-2263"><a href="#evaluate-2263"><span class="linenos">2263</span></a>        <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">orth_types</span><span class="p">)</span>
</span><span id="evaluate-2264"><a href="#evaluate-2264"><span class="linenos">2264</span></a>    <span class="p">)</span>
</span><span id="evaluate-2265"><a href="#evaluate-2265"><span class="linenos">2265</span></a>
</span><span id="evaluate-2266"><a href="#evaluate-2266"><span class="linenos">2266</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Evaluating </span><span class="si">{</span><span class="n">total_jobs</span><span class="si">}</span><span class="s2"> configurations...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="evaluate-2267"><a href="#evaluate-2267"><span class="linenos">2267</span></a>
</span><span id="evaluate-2268"><a href="#evaluate-2268"><span class="linenos">2268</span></a>    <span class="n">job</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="evaluate-2269"><a href="#evaluate-2269"><span class="linenos">2269</span></a>    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="evaluate-2270"><a href="#evaluate-2270"><span class="linenos">2270</span></a>
</span><span id="evaluate-2271"><a href="#evaluate-2271"><span class="linenos">2271</span></a>    <span class="c1"># ------------------------------------------------------------------</span>
</span><span id="evaluate-2272"><a href="#evaluate-2272"><span class="linenos">2272</span></a>    <span class="c1"># Main experiment loop</span>
</span><span id="evaluate-2273"><a href="#evaluate-2273"><span class="linenos">2273</span></a>    <span class="c1"># ------------------------------------------------------------------</span>
</span><span id="evaluate-2274"><a href="#evaluate-2274"><span class="linenos">2274</span></a>    <span class="k">for</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">matrix_sizes</span><span class="p">:</span>
</span><span id="evaluate-2275"><a href="#evaluate-2275"><span class="linenos">2275</span></a>        <span class="k">for</span> <span class="n">strategy</span> <span class="ow">in</span> <span class="n">strategies</span><span class="p">:</span>
</span><span id="evaluate-2276"><a href="#evaluate-2276"><span class="linenos">2276</span></a>            <span class="k">for</span> <span class="n">optimizer_name</span> <span class="ow">in</span> <span class="n">optimizers</span><span class="p">:</span>
</span><span id="evaluate-2277"><a href="#evaluate-2277"><span class="linenos">2277</span></a>                <span class="k">for</span> <span class="n">agg</span> <span class="ow">in</span> <span class="n">aggressions</span><span class="p">:</span>
</span><span id="evaluate-2278"><a href="#evaluate-2278"><span class="linenos">2278</span></a>                    <span class="k">for</span> <span class="n">fid_type</span> <span class="ow">in</span> <span class="n">fidelity_types</span><span class="p">:</span>
</span><span id="evaluate-2279"><a href="#evaluate-2279"><span class="linenos">2279</span></a>                        <span class="k">for</span> <span class="n">orth_type</span> <span class="ow">in</span> <span class="n">orth_types</span><span class="p">:</span>
</span><span id="evaluate-2280"><a href="#evaluate-2280"><span class="linenos">2280</span></a>                            <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">ws</span><span class="p">:</span>
</span><span id="evaluate-2281"><a href="#evaluate-2281"><span class="linenos">2281</span></a>                                <span class="n">job</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="evaluate-2282"><a href="#evaluate-2282"><span class="linenos">2282</span></a>                                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="evaluate-2283"><a href="#evaluate-2283"><span class="linenos">2283</span></a>                                    <span class="nb">print</span><span class="p">(</span>
</span><span id="evaluate-2284"><a href="#evaluate-2284"><span class="linenos">2284</span></a>                                        <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">job</span><span class="si">:</span><span class="s2">5d</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total_jobs</span><span class="si">}</span><span class="s2">] size=</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2">, strat=</span><span class="si">{</span><span class="n">strategy</span><span class="si">}</span><span class="s2">, &quot;</span>
</span><span id="evaluate-2285"><a href="#evaluate-2285"><span class="linenos">2285</span></a>                                        <span class="sa">f</span><span class="s2">&quot;opt=</span><span class="si">{</span><span class="n">optimizer_name</span><span class="si">}</span><span class="s2">, agg=</span><span class="si">{</span><span class="n">agg</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, &quot;</span>
</span><span id="evaluate-2286"><a href="#evaluate-2286"><span class="linenos">2286</span></a>                                        <span class="sa">f</span><span class="s2">&quot;fid=</span><span class="si">{</span><span class="n">fid_type</span><span class="si">}</span><span class="s2">, orth=</span><span class="si">{</span><span class="n">orth_type</span><span class="si">}</span><span class="s2">, w=</span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="evaluate-2287"><a href="#evaluate-2287"><span class="linenos">2287</span></a>                                    <span class="p">)</span>
</span><span id="evaluate-2288"><a href="#evaluate-2288"><span class="linenos">2288</span></a>
</span><span id="evaluate-2289"><a href="#evaluate-2289"><span class="linenos">2289</span></a>                                <span class="k">try</span><span class="p">:</span>
</span><span id="evaluate-2290"><a href="#evaluate-2290"><span class="linenos">2290</span></a>                                    <span class="c1">#  Pass w into run_single_experiment</span>
</span><span id="evaluate-2291"><a href="#evaluate-2291"><span class="linenos">2291</span></a>                                    <span class="n">res</span> <span class="o">=</span> <span class="n">run_single_experiment</span><span class="p">(</span>
</span><span id="evaluate-2292"><a href="#evaluate-2292"><span class="linenos">2292</span></a>                                        <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span>
</span><span id="evaluate-2293"><a href="#evaluate-2293"><span class="linenos">2293</span></a>                                        <span class="n">w</span><span class="o">=</span><span class="n">w</span><span class="p">,</span>
</span><span id="evaluate-2294"><a href="#evaluate-2294"><span class="linenos">2294</span></a>                                        <span class="n">strategy</span><span class="o">=</span><span class="n">strategy</span><span class="p">,</span>
</span><span id="evaluate-2295"><a href="#evaluate-2295"><span class="linenos">2295</span></a>                                        <span class="n">optimizer_name</span><span class="o">=</span><span class="n">optimizer_name</span><span class="p">,</span>
</span><span id="evaluate-2296"><a href="#evaluate-2296"><span class="linenos">2296</span></a>                                        <span class="n">aggression</span><span class="o">=</span><span class="n">agg</span><span class="p">,</span>
</span><span id="evaluate-2297"><a href="#evaluate-2297"><span class="linenos">2297</span></a>                                        <span class="n">fidelity_type</span><span class="o">=</span><span class="n">fid_type</span><span class="p">,</span>
</span><span id="evaluate-2298"><a href="#evaluate-2298"><span class="linenos">2298</span></a>                                        <span class="n">orth_type</span><span class="o">=</span><span class="n">orth_type</span><span class="p">,</span>
</span><span id="evaluate-2299"><a href="#evaluate-2299"><span class="linenos">2299</span></a>                                        <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span>
</span><span id="evaluate-2300"><a href="#evaluate-2300"><span class="linenos">2300</span></a>                                    <span class="p">)</span>
</span><span id="evaluate-2301"><a href="#evaluate-2301"><span class="linenos">2301</span></a>
</span><span id="evaluate-2302"><a href="#evaluate-2302"><span class="linenos">2302</span></a>                                    <span class="c1">#  Ensure energies are computed if missing</span>
</span><span id="evaluate-2303"><a href="#evaluate-2303"><span class="linenos">2303</span></a>                                    <span class="k">if</span> <span class="s2">&quot;fidelity_energy&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">res</span> <span class="ow">or</span> <span class="s2">&quot;orth_energy&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
</span><span id="evaluate-2304"><a href="#evaluate-2304"><span class="linenos">2304</span></a>                                        <span class="n">Y_final</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Y_final&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="evaluate-2305"><a href="#evaluate-2305"><span class="linenos">2305</span></a>                                        <span class="n">X0</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;X0&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="evaluate-2306"><a href="#evaluate-2306"><span class="linenos">2306</span></a>                                        <span class="k">if</span> <span class="n">Y_final</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">X0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="evaluate-2307"><a href="#evaluate-2307"><span class="linenos">2307</span></a>                                            <span class="n">e_total</span><span class="p">,</span> <span class="n">e_fid</span><span class="p">,</span> <span class="n">e_orth</span> <span class="o">=</span> <span class="n">nsa_flow</span><span class="o">.</span><span class="n">compute_energy_components</span><span class="p">(</span>
</span><span id="evaluate-2308"><a href="#evaluate-2308"><span class="linenos">2308</span></a>                                                <span class="n">Y_final</span><span class="p">,</span>
</span><span id="evaluate-2309"><a href="#evaluate-2309"><span class="linenos">2309</span></a>                                                <span class="n">X0</span><span class="p">,</span>
</span><span id="evaluate-2310"><a href="#evaluate-2310"><span class="linenos">2310</span></a>                                                <span class="n">w</span><span class="o">=</span><span class="n">w</span><span class="p">,</span>
</span><span id="evaluate-2311"><a href="#evaluate-2311"><span class="linenos">2311</span></a>                                                <span class="n">fid_eta</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fid_eta&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
</span><span id="evaluate-2312"><a href="#evaluate-2312"><span class="linenos">2312</span></a>                                                <span class="n">c_orth</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;c_orth&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
</span><span id="evaluate-2313"><a href="#evaluate-2313"><span class="linenos">2313</span></a>                                                <span class="n">fidelity_type</span><span class="o">=</span><span class="n">fid_type</span><span class="p">,</span>
</span><span id="evaluate-2314"><a href="#evaluate-2314"><span class="linenos">2314</span></a>                                                <span class="n">orth_type</span><span class="o">=</span><span class="n">orth_type</span><span class="p">,</span>
</span><span id="evaluate-2315"><a href="#evaluate-2315"><span class="linenos">2315</span></a>                                            <span class="p">)</span>
</span><span id="evaluate-2316"><a href="#evaluate-2316"><span class="linenos">2316</span></a>                                            <span class="n">res</span><span class="p">[</span><span class="s2">&quot;fidelity_energy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">e_fid</span>
</span><span id="evaluate-2317"><a href="#evaluate-2317"><span class="linenos">2317</span></a>                                            <span class="n">res</span><span class="p">[</span><span class="s2">&quot;orth_energy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">e_orth</span>
</span><span id="evaluate-2318"><a href="#evaluate-2318"><span class="linenos">2318</span></a>                                            <span class="n">res</span><span class="p">[</span><span class="s2">&quot;total_energy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">e_total</span>
</span><span id="evaluate-2319"><a href="#evaluate-2319"><span class="linenos">2319</span></a>
</span><span id="evaluate-2320"><a href="#evaluate-2320"><span class="linenos">2320</span></a>                                    <span class="c1">#  Record metadata cleanly</span>
</span><span id="evaluate-2321"><a href="#evaluate-2321"><span class="linenos">2321</span></a>                                    <span class="n">res</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
</span><span id="evaluate-2322"><a href="#evaluate-2322"><span class="linenos">2322</span></a>                                        <span class="nb">dict</span><span class="p">(</span>
</span><span id="evaluate-2323"><a href="#evaluate-2323"><span class="linenos">2323</span></a>                                            <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span>
</span><span id="evaluate-2324"><a href="#evaluate-2324"><span class="linenos">2324</span></a>                                            <span class="n">w</span><span class="o">=</span><span class="n">w</span><span class="p">,</span>
</span><span id="evaluate-2325"><a href="#evaluate-2325"><span class="linenos">2325</span></a>                                            <span class="n">strategy</span><span class="o">=</span><span class="n">strategy</span><span class="p">,</span>
</span><span id="evaluate-2326"><a href="#evaluate-2326"><span class="linenos">2326</span></a>                                            <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer_name</span><span class="p">,</span>
</span><span id="evaluate-2327"><a href="#evaluate-2327"><span class="linenos">2327</span></a>                                            <span class="n">aggression</span><span class="o">=</span><span class="n">agg</span><span class="p">,</span>
</span><span id="evaluate-2328"><a href="#evaluate-2328"><span class="linenos">2328</span></a>                                            <span class="n">fidelity_type</span><span class="o">=</span><span class="n">fid_type</span><span class="p">,</span>
</span><span id="evaluate-2329"><a href="#evaluate-2329"><span class="linenos">2329</span></a>                                            <span class="n">orth_type</span><span class="o">=</span><span class="n">orth_type</span><span class="p">,</span>
</span><span id="evaluate-2330"><a href="#evaluate-2330"><span class="linenos">2330</span></a>                                            <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span>
</span><span id="evaluate-2331"><a href="#evaluate-2331"><span class="linenos">2331</span></a>                                        <span class="p">)</span>
</span><span id="evaluate-2332"><a href="#evaluate-2332"><span class="linenos">2332</span></a>                                    <span class="p">)</span>
</span><span id="evaluate-2333"><a href="#evaluate-2333"><span class="linenos">2333</span></a>                                    <span class="n">all_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</span><span id="evaluate-2334"><a href="#evaluate-2334"><span class="linenos">2334</span></a>
</span><span id="evaluate-2335"><a href="#evaluate-2335"><span class="linenos">2335</span></a>                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="evaluate-2336"><a href="#evaluate-2336"><span class="linenos">2336</span></a>                                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="evaluate-2337"><a href="#evaluate-2337"><span class="linenos">2337</span></a>                                        <span class="nb">print</span><span class="p">(</span>
</span><span id="evaluate-2338"><a href="#evaluate-2338"><span class="linenos">2338</span></a>                                            <span class="sa">f</span><span class="s2">&quot; Failure: </span><span class="si">{</span><span class="n">strategy</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">optimizer_name</span><span class="si">}</span><span class="s2"> &quot;</span>
</span><span id="evaluate-2339"><a href="#evaluate-2339"><span class="linenos">2339</span></a>                                            <span class="sa">f</span><span class="s2">&quot;(agg=</span><span class="si">{</span><span class="n">agg</span><span class="si">}</span><span class="s2">, w=</span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s2">)  </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="evaluate-2340"><a href="#evaluate-2340"><span class="linenos">2340</span></a>                                        <span class="p">)</span>
</span><span id="evaluate-2341"><a href="#evaluate-2341"><span class="linenos">2341</span></a>                                    <span class="n">all_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="evaluate-2342"><a href="#evaluate-2342"><span class="linenos">2342</span></a>                                        <span class="nb">dict</span><span class="p">(</span>
</span><span id="evaluate-2343"><a href="#evaluate-2343"><span class="linenos">2343</span></a>                                            <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span>
</span><span id="evaluate-2344"><a href="#evaluate-2344"><span class="linenos">2344</span></a>                                            <span class="n">w</span><span class="o">=</span><span class="n">w</span><span class="p">,</span>
</span><span id="evaluate-2345"><a href="#evaluate-2345"><span class="linenos">2345</span></a>                                            <span class="n">strategy</span><span class="o">=</span><span class="n">strategy</span><span class="p">,</span>
</span><span id="evaluate-2346"><a href="#evaluate-2346"><span class="linenos">2346</span></a>                                            <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer_name</span><span class="p">,</span>
</span><span id="evaluate-2347"><a href="#evaluate-2347"><span class="linenos">2347</span></a>                                            <span class="n">aggression</span><span class="o">=</span><span class="n">agg</span><span class="p">,</span>
</span><span id="evaluate-2348"><a href="#evaluate-2348"><span class="linenos">2348</span></a>                                            <span class="n">fidelity_type</span><span class="o">=</span><span class="n">fid_type</span><span class="p">,</span>
</span><span id="evaluate-2349"><a href="#evaluate-2349"><span class="linenos">2349</span></a>                                            <span class="n">orth_type</span><span class="o">=</span><span class="n">orth_type</span><span class="p">,</span>
</span><span id="evaluate-2350"><a href="#evaluate-2350"><span class="linenos">2350</span></a>                                            <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
</span><span id="evaluate-2351"><a href="#evaluate-2351"><span class="linenos">2351</span></a>                                        <span class="p">)</span>
</span><span id="evaluate-2352"><a href="#evaluate-2352"><span class="linenos">2352</span></a>                                    <span class="p">)</span>
</span><span id="evaluate-2353"><a href="#evaluate-2353"><span class="linenos">2353</span></a>
</span><span id="evaluate-2354"><a href="#evaluate-2354"><span class="linenos">2354</span></a>    <span class="c1"># ------------------------------------------------------------------</span>
</span><span id="evaluate-2355"><a href="#evaluate-2355"><span class="linenos">2355</span></a>    <span class="c1"># Aggregate results</span>
</span><span id="evaluate-2356"><a href="#evaluate-2356"><span class="linenos">2356</span></a>    <span class="c1"># ------------------------------------------------------------------</span>
</span><span id="evaluate-2357"><a href="#evaluate-2357"><span class="linenos">2357</span></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">all_results</span><span class="p">)</span>
</span><span id="evaluate-2358"><a href="#evaluate-2358"><span class="linenos">2358</span></a>
</span><span id="evaluate-2359"><a href="#evaluate-2359"><span class="linenos">2359</span></a>    <span class="c1">#  Compute ranking metrics safely</span>
</span><span id="evaluate-2360"><a href="#evaluate-2360"><span class="linenos">2360</span></a>    <span class="k">if</span> <span class="s2">&quot;total_energy&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="evaluate-2361"><a href="#evaluate-2361"><span class="linenos">2361</span></a>        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;rank_total&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;total_energy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;dense&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="evaluate-2362"><a href="#evaluate-2362"><span class="linenos">2362</span></a>    <span class="k">if</span> <span class="s2">&quot;fidelity_energy&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="evaluate-2363"><a href="#evaluate-2363"><span class="linenos">2363</span></a>        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;rank_fid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;fidelity_energy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;dense&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="evaluate-2364"><a href="#evaluate-2364"><span class="linenos">2364</span></a>    <span class="k">if</span> <span class="s2">&quot;orth_energy&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="evaluate-2365"><a href="#evaluate-2365"><span class="linenos">2365</span></a>        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;rank_orth&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;orth_energy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;dense&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="evaluate-2366"><a href="#evaluate-2366"><span class="linenos">2366</span></a>
</span><span id="evaluate-2367"><a href="#evaluate-2367"><span class="linenos">2367</span></a>    <span class="n">elapsed_total</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
</span><span id="evaluate-2368"><a href="#evaluate-2368"><span class="linenos">2368</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Completed all </span><span class="si">{</span><span class="n">job</span><span class="si">}</span><span class="s2"> experiments in </span><span class="si">{</span><span class="n">elapsed_total</span><span class="o">/</span><span class="mi">60</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> minutes.&quot;</span><span class="p">)</span>
</span><span id="evaluate-2369"><a href="#evaluate-2369"><span class="linenos">2369</span></a>
</span><span id="evaluate-2370"><a href="#evaluate-2370"><span class="linenos">2370</span></a>    <span class="c1"># ------------------------------------------------------------------</span>
</span><span id="evaluate-2371"><a href="#evaluate-2371"><span class="linenos">2371</span></a>    <span class="c1"># Summary ranking</span>
</span><span id="evaluate-2372"><a href="#evaluate-2372"><span class="linenos">2372</span></a>    <span class="c1"># ------------------------------------------------------------------</span>
</span><span id="evaluate-2373"><a href="#evaluate-2373"><span class="linenos">2373</span></a>    <span class="k">if</span> <span class="s2">&quot;rank_total&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="evaluate-2374"><a href="#evaluate-2374"><span class="linenos">2374</span></a>        <span class="n">summary</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="evaluate-2375"><a href="#evaluate-2375"><span class="linenos">2375</span></a>            <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;optimizer&quot;</span><span class="p">,</span> <span class="s2">&quot;fidelity_type&quot;</span><span class="p">,</span> <span class="s2">&quot;orth_type&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">])</span>
</span><span id="evaluate-2376"><a href="#evaluate-2376"><span class="linenos">2376</span></a>            <span class="o">.</span><span class="n">agg</span><span class="p">(</span>
</span><span id="evaluate-2377"><a href="#evaluate-2377"><span class="linenos">2377</span></a>                <span class="n">mean_total_energy</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;total_energy&quot;</span><span class="p">,</span> <span class="s2">&quot;mean&quot;</span><span class="p">),</span>
</span><span id="evaluate-2378"><a href="#evaluate-2378"><span class="linenos">2378</span></a>                <span class="n">mean_rank</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;rank_total&quot;</span><span class="p">,</span> <span class="s2">&quot;mean&quot;</span><span class="p">),</span>
</span><span id="evaluate-2379"><a href="#evaluate-2379"><span class="linenos">2379</span></a>                <span class="n">std_total_energy</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;total_energy&quot;</span><span class="p">,</span> <span class="s2">&quot;std&quot;</span><span class="p">),</span>
</span><span id="evaluate-2380"><a href="#evaluate-2380"><span class="linenos">2380</span></a>                <span class="n">n</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;total_energy&quot;</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span><span class="p">),</span>
</span><span id="evaluate-2381"><a href="#evaluate-2381"><span class="linenos">2381</span></a>            <span class="p">)</span>
</span><span id="evaluate-2382"><a href="#evaluate-2382"><span class="linenos">2382</span></a>            <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;mean_rank&quot;</span><span class="p">)</span>
</span><span id="evaluate-2383"><a href="#evaluate-2383"><span class="linenos">2383</span></a>        <span class="p">)</span>
</span><span id="evaluate-2384"><a href="#evaluate-2384"><span class="linenos">2384</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Top Performing Configurations:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="evaluate-2385"><a href="#evaluate-2385"><span class="linenos">2385</span></a>        <span class="nb">print</span><span class="p">(</span><span class="n">summary</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
</span><span id="evaluate-2386"><a href="#evaluate-2386"><span class="linenos">2386</span></a>
</span><span id="evaluate-2387"><a href="#evaluate-2387"><span class="linenos">2387</span></a>    <span class="k">return</span> <span class="n">df</span>
</span></pre></div>


            <div class="docstring"><p>Comprehensive benchmark of NSA-Flow configurations.</p>

<p>Tests combinations of:</p>

<ul>
<li>learning rate estimation strategies</li>
<li>optimizers</li>
<li>aggression levels</li>
<li>weighting parameter w</li>
<li>matrix sizes</li>
<li>fidelity and orthogonality energy types</li>
</ul>

<h2 id="returns">Returns</h2>

<p>pd.DataFrame
    Results of all experiments with metrics and rankings.</p>
</div>


                </section>
                <section id="plot_evaluation_summary">
                            <input id="plot_evaluation_summary-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plot_evaluation_summary</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">df</span>, </span><span class="param"><span class="n">save_dir</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">timestamp</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">show_plots</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="plot_evaluation_summary-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#plot_evaluation_summary"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="plot_evaluation_summary-2390"><a href="#plot_evaluation_summary-2390"><span class="linenos">2390</span></a><span class="k">def</span><span class="w"> </span><span class="nf">plot_evaluation_summary</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">save_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show_plots</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="plot_evaluation_summary-2391"><a href="#plot_evaluation_summary-2391"><span class="linenos">2391</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="plot_evaluation_summary-2392"><a href="#plot_evaluation_summary-2392"><span class="linenos">2392</span></a><span class="sd">    Generate and optionally save detailed summary visualizations for NSA-Flow evaluation results.</span>
</span><span id="plot_evaluation_summary-2393"><a href="#plot_evaluation_summary-2393"><span class="linenos">2393</span></a>
</span><span id="plot_evaluation_summary-2394"><a href="#plot_evaluation_summary-2394"><span class="linenos">2394</span></a><span class="sd">    Parameters</span>
</span><span id="plot_evaluation_summary-2395"><a href="#plot_evaluation_summary-2395"><span class="linenos">2395</span></a><span class="sd">    ----------</span>
</span><span id="plot_evaluation_summary-2396"><a href="#plot_evaluation_summary-2396"><span class="linenos">2396</span></a><span class="sd">    df : pd.DataFrame</span>
</span><span id="plot_evaluation_summary-2397"><a href="#plot_evaluation_summary-2397"><span class="linenos">2397</span></a><span class="sd">        DataFrame output from `evaluate()`, expected to include:</span>
</span><span id="plot_evaluation_summary-2398"><a href="#plot_evaluation_summary-2398"><span class="linenos">2398</span></a><span class="sd">        [&#39;strategy&#39;, &#39;optimizer&#39;, &#39;aggression&#39;, &#39;total_energy&#39;, &#39;w&#39;, &#39;error&#39;]</span>
</span><span id="plot_evaluation_summary-2399"><a href="#plot_evaluation_summary-2399"><span class="linenos">2399</span></a><span class="sd">    save_dir : str, optional</span>
</span><span id="plot_evaluation_summary-2400"><a href="#plot_evaluation_summary-2400"><span class="linenos">2400</span></a><span class="sd">        Directory where plots and summary CSVs will be saved.</span>
</span><span id="plot_evaluation_summary-2401"><a href="#plot_evaluation_summary-2401"><span class="linenos">2401</span></a><span class="sd">    timestamp : str, optional</span>
</span><span id="plot_evaluation_summary-2402"><a href="#plot_evaluation_summary-2402"><span class="linenos">2402</span></a><span class="sd">        Timestamp to append to saved filenames.</span>
</span><span id="plot_evaluation_summary-2403"><a href="#plot_evaluation_summary-2403"><span class="linenos">2403</span></a><span class="sd">    show_plots : bool, default=True</span>
</span><span id="plot_evaluation_summary-2404"><a href="#plot_evaluation_summary-2404"><span class="linenos">2404</span></a><span class="sd">        Whether to display plots interactively.</span>
</span><span id="plot_evaluation_summary-2405"><a href="#plot_evaluation_summary-2405"><span class="linenos">2405</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="plot_evaluation_summary-2406"><a href="#plot_evaluation_summary-2406"><span class="linenos">2406</span></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="plot_evaluation_summary-2407"><a href="#plot_evaluation_summary-2407"><span class="linenos">2407</span></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="plot_evaluation_summary-2408"><a href="#plot_evaluation_summary-2408"><span class="linenos">2408</span></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
</span><span id="plot_evaluation_summary-2409"><a href="#plot_evaluation_summary-2409"><span class="linenos">2409</span></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
</span><span id="plot_evaluation_summary-2410"><a href="#plot_evaluation_summary-2410"><span class="linenos">2410</span></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
</span><span id="plot_evaluation_summary-2411"><a href="#plot_evaluation_summary-2411"><span class="linenos">2411</span></a>
</span><span id="plot_evaluation_summary-2412"><a href="#plot_evaluation_summary-2412"><span class="linenos">2412</span></a>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">if</span> <span class="n">save_dir</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="plot_evaluation_summary-2413"><a href="#plot_evaluation_summary-2413"><span class="linenos">2413</span></a>
</span><span id="plot_evaluation_summary-2414"><a href="#plot_evaluation_summary-2414"><span class="linenos">2414</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_robust_clip</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mi">99</span><span class="p">):</span>
</span><span id="plot_evaluation_summary-2415"><a href="#plot_evaluation_summary-2415"><span class="linenos">2415</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Clip dataframe numeric columns to percentile range to reduce outlier influence.&quot;&quot;&quot;</span>
</span><span id="plot_evaluation_summary-2416"><a href="#plot_evaluation_summary-2416"><span class="linenos">2416</span></a>        <span class="n">df_clipped</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="plot_evaluation_summary-2417"><a href="#plot_evaluation_summary-2417"><span class="linenos">2417</span></a>        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
</span><span id="plot_evaluation_summary-2418"><a href="#plot_evaluation_summary-2418"><span class="linenos">2418</span></a>            <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="plot_evaluation_summary-2419"><a href="#plot_evaluation_summary-2419"><span class="linenos">2419</span></a>                <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(),</span> <span class="p">[</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">])</span>
</span><span id="plot_evaluation_summary-2420"><a href="#plot_evaluation_summary-2420"><span class="linenos">2420</span></a>                <span class="n">df_clipped</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">)</span>
</span><span id="plot_evaluation_summary-2421"><a href="#plot_evaluation_summary-2421"><span class="linenos">2421</span></a>        <span class="k">return</span> <span class="n">df_clipped</span>
</span><span id="plot_evaluation_summary-2422"><a href="#plot_evaluation_summary-2422"><span class="linenos">2422</span></a>    <span class="c1"># ------------------------------------------------------------------</span>
</span><span id="plot_evaluation_summary-2423"><a href="#plot_evaluation_summary-2423"><span class="linenos">2423</span></a>    <span class="c1"># Filter successful runs</span>
</span><span id="plot_evaluation_summary-2424"><a href="#plot_evaluation_summary-2424"><span class="linenos">2424</span></a>    <span class="c1"># ------------------------------------------------------------------</span>
</span><span id="plot_evaluation_summary-2425"><a href="#plot_evaluation_summary-2425"><span class="linenos">2425</span></a>    <span class="k">if</span> <span class="s2">&quot;error&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="plot_evaluation_summary-2426"><a href="#plot_evaluation_summary-2426"><span class="linenos">2426</span></a>        <span class="n">df_plot</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="plot_evaluation_summary-2427"><a href="#plot_evaluation_summary-2427"><span class="linenos">2427</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="plot_evaluation_summary-2428"><a href="#plot_evaluation_summary-2428"><span class="linenos">2428</span></a>        <span class="n">df_plot</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="plot_evaluation_summary-2429"><a href="#plot_evaluation_summary-2429"><span class="linenos">2429</span></a>
</span><span id="plot_evaluation_summary-2430"><a href="#plot_evaluation_summary-2430"><span class="linenos">2430</span></a>    <span class="n">df_plot</span> <span class="o">=</span> <span class="n">df_plot</span><span class="p">[</span><span class="n">df_plot</span><span class="p">[</span><span class="s2">&quot;total_energy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">df_plot</span><span class="p">[</span><span class="s2">&quot;total_energy&quot;</span><span class="p">])]</span>
</span><span id="plot_evaluation_summary-2431"><a href="#plot_evaluation_summary-2431"><span class="linenos">2431</span></a>    <span class="n">df_plot</span> <span class="o">=</span> <span class="n">_robust_clip</span><span class="p">(</span><span class="n">df_plot</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;total_energy&quot;</span><span class="p">,</span> <span class="s2">&quot;fidelity_energy&quot;</span><span class="p">,</span> <span class="s2">&quot;orth_energy&quot;</span><span class="p">])</span>
</span><span id="plot_evaluation_summary-2432"><a href="#plot_evaluation_summary-2432"><span class="linenos">2432</span></a>    <span class="c1"># ------------------------------------------------------------------</span>
</span><span id="plot_evaluation_summary-2433"><a href="#plot_evaluation_summary-2433"><span class="linenos">2433</span></a>    <span class="c1"># Summary table: Top configurations</span>
</span><span id="plot_evaluation_summary-2434"><a href="#plot_evaluation_summary-2434"><span class="linenos">2434</span></a>    <span class="c1"># ------------------------------------------------------------------</span>
</span><span id="plot_evaluation_summary-2435"><a href="#plot_evaluation_summary-2435"><span class="linenos">2435</span></a>    <span class="n">summary</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="plot_evaluation_summary-2436"><a href="#plot_evaluation_summary-2436"><span class="linenos">2436</span></a>        <span class="n">df_plot</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;optimizer&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">])</span>
</span><span id="plot_evaluation_summary-2437"><a href="#plot_evaluation_summary-2437"><span class="linenos">2437</span></a>        <span class="o">.</span><span class="n">agg</span><span class="p">(</span>
</span><span id="plot_evaluation_summary-2438"><a href="#plot_evaluation_summary-2438"><span class="linenos">2438</span></a>            <span class="n">mean_total</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;total_energy&quot;</span><span class="p">,</span> <span class="s2">&quot;mean&quot;</span><span class="p">),</span>
</span><span id="plot_evaluation_summary-2439"><a href="#plot_evaluation_summary-2439"><span class="linenos">2439</span></a>            <span class="n">std_total</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;total_energy&quot;</span><span class="p">,</span> <span class="s2">&quot;std&quot;</span><span class="p">),</span>
</span><span id="plot_evaluation_summary-2440"><a href="#plot_evaluation_summary-2440"><span class="linenos">2440</span></a>            <span class="n">n</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;total_energy&quot;</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span><span class="p">),</span>
</span><span id="plot_evaluation_summary-2441"><a href="#plot_evaluation_summary-2441"><span class="linenos">2441</span></a>        <span class="p">)</span>
</span><span id="plot_evaluation_summary-2442"><a href="#plot_evaluation_summary-2442"><span class="linenos">2442</span></a>        <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
</span><span id="plot_evaluation_summary-2443"><a href="#plot_evaluation_summary-2443"><span class="linenos">2443</span></a>        <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;mean_total&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="plot_evaluation_summary-2444"><a href="#plot_evaluation_summary-2444"><span class="linenos">2444</span></a>    <span class="p">)</span>
</span><span id="plot_evaluation_summary-2445"><a href="#plot_evaluation_summary-2445"><span class="linenos">2445</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Top 10 Configurations by Mean Total Energy:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="plot_evaluation_summary-2446"><a href="#plot_evaluation_summary-2446"><span class="linenos">2446</span></a>    <span class="nb">print</span><span class="p">(</span><span class="n">summary</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">float_format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%.4e</span><span class="s2">&quot;</span><span class="p">))</span>
</span><span id="plot_evaluation_summary-2447"><a href="#plot_evaluation_summary-2447"><span class="linenos">2447</span></a>
</span><span id="plot_evaluation_summary-2448"><a href="#plot_evaluation_summary-2448"><span class="linenos">2448</span></a>    <span class="k">if</span> <span class="n">save_dir</span><span class="p">:</span>
</span><span id="plot_evaluation_summary-2449"><a href="#plot_evaluation_summary-2449"><span class="linenos">2449</span></a>        <span class="n">summary_csv</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">save_dir</span><span class="si">}</span><span class="s2">/summary_ranking_</span><span class="si">{</span><span class="n">timestamp</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">.csv&quot;</span>
</span><span id="plot_evaluation_summary-2450"><a href="#plot_evaluation_summary-2450"><span class="linenos">2450</span></a>        <span class="n">summary</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">summary_csv</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="plot_evaluation_summary-2451"><a href="#plot_evaluation_summary-2451"><span class="linenos">2451</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Saved ranking summary: </span><span class="si">{</span><span class="n">summary_csv</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="plot_evaluation_summary-2452"><a href="#plot_evaluation_summary-2452"><span class="linenos">2452</span></a>
</span><span id="plot_evaluation_summary-2453"><a href="#plot_evaluation_summary-2453"><span class="linenos">2453</span></a>    <span class="c1"># ------------------------------------------------------------------</span>
</span><span id="plot_evaluation_summary-2454"><a href="#plot_evaluation_summary-2454"><span class="linenos">2454</span></a>    <span class="c1"># Heatmap 1: Strategy  Aggression</span>
</span><span id="plot_evaluation_summary-2455"><a href="#plot_evaluation_summary-2455"><span class="linenos">2455</span></a>    <span class="c1"># ------------------------------------------------------------------</span>
</span><span id="plot_evaluation_summary-2456"><a href="#plot_evaluation_summary-2456"><span class="linenos">2456</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
</span><span id="plot_evaluation_summary-2457"><a href="#plot_evaluation_summary-2457"><span class="linenos">2457</span></a>    <span class="n">pivot_strat</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="plot_evaluation_summary-2458"><a href="#plot_evaluation_summary-2458"><span class="linenos">2458</span></a>        <span class="n">df_plot</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;aggression&quot;</span><span class="p">])[</span><span class="s2">&quot;total_energy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span>
</span><span id="plot_evaluation_summary-2459"><a href="#plot_evaluation_summary-2459"><span class="linenos">2459</span></a>    <span class="p">)</span>
</span><span id="plot_evaluation_summary-2460"><a href="#plot_evaluation_summary-2460"><span class="linenos">2460</span></a>    <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">pivot_strat</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;.2e&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span> <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;Mean Total Energy&quot;</span><span class="p">})</span>
</span><span id="plot_evaluation_summary-2461"><a href="#plot_evaluation_summary-2461"><span class="linenos">2461</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;NSA-Flow: Strategy vs Aggression (Mean Total Energy)&quot;</span><span class="p">)</span>
</span><span id="plot_evaluation_summary-2462"><a href="#plot_evaluation_summary-2462"><span class="linenos">2462</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Strategy&quot;</span><span class="p">)</span>
</span><span id="plot_evaluation_summary-2463"><a href="#plot_evaluation_summary-2463"><span class="linenos">2463</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Aggression Level&quot;</span><span class="p">)</span>
</span><span id="plot_evaluation_summary-2464"><a href="#plot_evaluation_summary-2464"><span class="linenos">2464</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="plot_evaluation_summary-2465"><a href="#plot_evaluation_summary-2465"><span class="linenos">2465</span></a>    <span class="k">if</span> <span class="n">save_dir</span><span class="p">:</span>
</span><span id="plot_evaluation_summary-2466"><a href="#plot_evaluation_summary-2466"><span class="linenos">2466</span></a>        <span class="n">fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">save_dir</span><span class="si">}</span><span class="s2">/heatmap_strategy_vs_aggression_</span><span class="si">{</span><span class="n">timestamp</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">.png&quot;</span>
</span><span id="plot_evaluation_summary-2467"><a href="#plot_evaluation_summary-2467"><span class="linenos">2467</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
</span><span id="plot_evaluation_summary-2468"><a href="#plot_evaluation_summary-2468"><span class="linenos">2468</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Saved: </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="plot_evaluation_summary-2469"><a href="#plot_evaluation_summary-2469"><span class="linenos">2469</span></a>    <span class="k">if</span> <span class="n">show_plots</span><span class="p">:</span>
</span><span id="plot_evaluation_summary-2470"><a href="#plot_evaluation_summary-2470"><span class="linenos">2470</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="plot_evaluation_summary-2471"><a href="#plot_evaluation_summary-2471"><span class="linenos">2471</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="plot_evaluation_summary-2472"><a href="#plot_evaluation_summary-2472"><span class="linenos">2472</span></a>
</span><span id="plot_evaluation_summary-2473"><a href="#plot_evaluation_summary-2473"><span class="linenos">2473</span></a>    <span class="c1"># ------------------------------------------------------------------</span>
</span><span id="plot_evaluation_summary-2474"><a href="#plot_evaluation_summary-2474"><span class="linenos">2474</span></a>    <span class="c1"># Heatmap 2: Optimizer  Aggression</span>
</span><span id="plot_evaluation_summary-2475"><a href="#plot_evaluation_summary-2475"><span class="linenos">2475</span></a>    <span class="c1"># ------------------------------------------------------------------</span>
</span><span id="plot_evaluation_summary-2476"><a href="#plot_evaluation_summary-2476"><span class="linenos">2476</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
</span><span id="plot_evaluation_summary-2477"><a href="#plot_evaluation_summary-2477"><span class="linenos">2477</span></a>    <span class="n">pivot_opt</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="plot_evaluation_summary-2478"><a href="#plot_evaluation_summary-2478"><span class="linenos">2478</span></a>        <span class="n">df_plot</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;optimizer&quot;</span><span class="p">,</span> <span class="s2">&quot;aggression&quot;</span><span class="p">])[</span><span class="s2">&quot;total_energy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span>
</span><span id="plot_evaluation_summary-2479"><a href="#plot_evaluation_summary-2479"><span class="linenos">2479</span></a>    <span class="p">)</span>
</span><span id="plot_evaluation_summary-2480"><a href="#plot_evaluation_summary-2480"><span class="linenos">2480</span></a>    <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">pivot_opt</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;.2e&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;magma&quot;</span><span class="p">,</span> <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;Mean Total Energy&quot;</span><span class="p">})</span>
</span><span id="plot_evaluation_summary-2481"><a href="#plot_evaluation_summary-2481"><span class="linenos">2481</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;NSA-Flow: Optimizer vs Aggression (Mean Total Energy)&quot;</span><span class="p">)</span>
</span><span id="plot_evaluation_summary-2482"><a href="#plot_evaluation_summary-2482"><span class="linenos">2482</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Optimizer&quot;</span><span class="p">)</span>
</span><span id="plot_evaluation_summary-2483"><a href="#plot_evaluation_summary-2483"><span class="linenos">2483</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Aggression Level&quot;</span><span class="p">)</span>
</span><span id="plot_evaluation_summary-2484"><a href="#plot_evaluation_summary-2484"><span class="linenos">2484</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="plot_evaluation_summary-2485"><a href="#plot_evaluation_summary-2485"><span class="linenos">2485</span></a>    <span class="k">if</span> <span class="n">save_dir</span><span class="p">:</span>
</span><span id="plot_evaluation_summary-2486"><a href="#plot_evaluation_summary-2486"><span class="linenos">2486</span></a>        <span class="n">fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">save_dir</span><span class="si">}</span><span class="s2">/heatmap_optimizer_vs_aggression_</span><span class="si">{</span><span class="n">timestamp</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">.png&quot;</span>
</span><span id="plot_evaluation_summary-2487"><a href="#plot_evaluation_summary-2487"><span class="linenos">2487</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
</span><span id="plot_evaluation_summary-2488"><a href="#plot_evaluation_summary-2488"><span class="linenos">2488</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Saved: </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="plot_evaluation_summary-2489"><a href="#plot_evaluation_summary-2489"><span class="linenos">2489</span></a>    <span class="k">if</span> <span class="n">show_plots</span><span class="p">:</span>
</span><span id="plot_evaluation_summary-2490"><a href="#plot_evaluation_summary-2490"><span class="linenos">2490</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="plot_evaluation_summary-2491"><a href="#plot_evaluation_summary-2491"><span class="linenos">2491</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="plot_evaluation_summary-2492"><a href="#plot_evaluation_summary-2492"><span class="linenos">2492</span></a>
</span><span id="plot_evaluation_summary-2493"><a href="#plot_evaluation_summary-2493"><span class="linenos">2493</span></a>    <span class="c1"># ------------------------------------------------------------------</span>
</span><span id="plot_evaluation_summary-2494"><a href="#plot_evaluation_summary-2494"><span class="linenos">2494</span></a>    <span class="c1"># Heatmap 3: Strategy  Weight (w)</span>
</span><span id="plot_evaluation_summary-2495"><a href="#plot_evaluation_summary-2495"><span class="linenos">2495</span></a>    <span class="c1"># ------------------------------------------------------------------</span>
</span><span id="plot_evaluation_summary-2496"><a href="#plot_evaluation_summary-2496"><span class="linenos">2496</span></a>    <span class="k">if</span> <span class="s2">&quot;w&quot;</span> <span class="ow">in</span> <span class="n">df_plot</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="plot_evaluation_summary-2497"><a href="#plot_evaluation_summary-2497"><span class="linenos">2497</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
</span><span id="plot_evaluation_summary-2498"><a href="#plot_evaluation_summary-2498"><span class="linenos">2498</span></a>        <span class="n">pivot_w</span> <span class="o">=</span> <span class="n">df_plot</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">])[</span><span class="s2">&quot;total_energy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span>
</span><span id="plot_evaluation_summary-2499"><a href="#plot_evaluation_summary-2499"><span class="linenos">2499</span></a>        <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">pivot_w</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;.2e&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;plasma&quot;</span><span class="p">,</span> <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;Mean Total Energy&quot;</span><span class="p">})</span>
</span><span id="plot_evaluation_summary-2500"><a href="#plot_evaluation_summary-2500"><span class="linenos">2500</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;NSA-Flow: Strategy vs Weight (w)&quot;</span><span class="p">)</span>
</span><span id="plot_evaluation_summary-2501"><a href="#plot_evaluation_summary-2501"><span class="linenos">2501</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Strategy&quot;</span><span class="p">)</span>
</span><span id="plot_evaluation_summary-2502"><a href="#plot_evaluation_summary-2502"><span class="linenos">2502</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Weight (w)&quot;</span><span class="p">)</span>
</span><span id="plot_evaluation_summary-2503"><a href="#plot_evaluation_summary-2503"><span class="linenos">2503</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="plot_evaluation_summary-2504"><a href="#plot_evaluation_summary-2504"><span class="linenos">2504</span></a>        <span class="k">if</span> <span class="n">save_dir</span><span class="p">:</span>
</span><span id="plot_evaluation_summary-2505"><a href="#plot_evaluation_summary-2505"><span class="linenos">2505</span></a>            <span class="n">fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">save_dir</span><span class="si">}</span><span class="s2">/heatmap_strategy_vs_w_</span><span class="si">{</span><span class="n">timestamp</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">.png&quot;</span>
</span><span id="plot_evaluation_summary-2506"><a href="#plot_evaluation_summary-2506"><span class="linenos">2506</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
</span><span id="plot_evaluation_summary-2507"><a href="#plot_evaluation_summary-2507"><span class="linenos">2507</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Saved: </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="plot_evaluation_summary-2508"><a href="#plot_evaluation_summary-2508"><span class="linenos">2508</span></a>        <span class="k">if</span> <span class="n">show_plots</span><span class="p">:</span>
</span><span id="plot_evaluation_summary-2509"><a href="#plot_evaluation_summary-2509"><span class="linenos">2509</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="plot_evaluation_summary-2510"><a href="#plot_evaluation_summary-2510"><span class="linenos">2510</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="plot_evaluation_summary-2511"><a href="#plot_evaluation_summary-2511"><span class="linenos">2511</span></a>
</span><span id="plot_evaluation_summary-2512"><a href="#plot_evaluation_summary-2512"><span class="linenos">2512</span></a>        <span class="c1"># ------------------------------------------------------------------</span>
</span><span id="plot_evaluation_summary-2513"><a href="#plot_evaluation_summary-2513"><span class="linenos">2513</span></a>        <span class="c1"># Faceted plot: Energy vs Aggression (by Optimizer  Strategy)</span>
</span><span id="plot_evaluation_summary-2514"><a href="#plot_evaluation_summary-2514"><span class="linenos">2514</span></a>        <span class="c1"># ------------------------------------------------------------------</span>
</span><span id="plot_evaluation_summary-2515"><a href="#plot_evaluation_summary-2515"><span class="linenos">2515</span></a>        <span class="n">g</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">FacetGrid</span><span class="p">(</span><span class="n">df_plot</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s2">&quot;optimizer&quot;</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="s2">&quot;strategy&quot;</span><span class="p">,</span> <span class="n">margin_titles</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="plot_evaluation_summary-2516"><a href="#plot_evaluation_summary-2516"><span class="linenos">2516</span></a>        <span class="n">g</span><span class="o">.</span><span class="n">map_dataframe</span><span class="p">(</span><span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;aggression&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;total_energy&quot;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">)</span>
</span><span id="plot_evaluation_summary-2517"><a href="#plot_evaluation_summary-2517"><span class="linenos">2517</span></a>        <span class="n">g</span><span class="o">.</span><span class="n">add_legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Weight (w)&quot;</span><span class="p">)</span>
</span><span id="plot_evaluation_summary-2518"><a href="#plot_evaluation_summary-2518"><span class="linenos">2518</span></a>        <span class="n">g</span><span class="o">.</span><span class="n">set_axis_labels</span><span class="p">(</span><span class="s2">&quot;Aggression&quot;</span><span class="p">,</span> <span class="s2">&quot;Total Energy&quot;</span><span class="p">)</span>
</span><span id="plot_evaluation_summary-2519"><a href="#plot_evaluation_summary-2519"><span class="linenos">2519</span></a>        <span class="n">g</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
</span><span id="plot_evaluation_summary-2520"><a href="#plot_evaluation_summary-2520"><span class="linenos">2520</span></a>        <span class="n">g</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;NSA-Flow: Total Energy vs Aggression (Faceted by Optimizer  Strategy)&quot;</span><span class="p">)</span>
</span><span id="plot_evaluation_summary-2521"><a href="#plot_evaluation_summary-2521"><span class="linenos">2521</span></a>
</span><span id="plot_evaluation_summary-2522"><a href="#plot_evaluation_summary-2522"><span class="linenos">2522</span></a>        <span class="c1">#  Highlight best overall config</span>
</span><span id="plot_evaluation_summary-2523"><a href="#plot_evaluation_summary-2523"><span class="linenos">2523</span></a>        <span class="n">best_row</span> <span class="o">=</span> <span class="n">df_plot</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_plot</span><span class="p">[</span><span class="s2">&quot;total_energy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()]</span>
</span><span id="plot_evaluation_summary-2524"><a href="#plot_evaluation_summary-2524"><span class="linenos">2524</span></a>        <span class="n">best_opt</span><span class="p">,</span> <span class="n">best_strat</span> <span class="o">=</span> <span class="n">best_row</span><span class="p">[</span><span class="s2">&quot;optimizer&quot;</span><span class="p">],</span> <span class="n">best_row</span><span class="p">[</span><span class="s2">&quot;strategy&quot;</span><span class="p">]</span>
</span><span id="plot_evaluation_summary-2525"><a href="#plot_evaluation_summary-2525"><span class="linenos">2525</span></a>        <span class="n">best_agg</span><span class="p">,</span> <span class="n">best_w</span><span class="p">,</span> <span class="n">best_E</span> <span class="o">=</span> <span class="n">best_row</span><span class="p">[</span><span class="s2">&quot;aggression&quot;</span><span class="p">],</span> <span class="n">best_row</span><span class="p">[</span><span class="s2">&quot;w&quot;</span><span class="p">],</span> <span class="n">best_row</span><span class="p">[</span><span class="s2">&quot;total_energy&quot;</span><span class="p">]</span>
</span><span id="plot_evaluation_summary-2526"><a href="#plot_evaluation_summary-2526"><span class="linenos">2526</span></a>
</span><span id="plot_evaluation_summary-2527"><a href="#plot_evaluation_summary-2527"><span class="linenos">2527</span></a>        <span class="c1"># Find the right facet</span>
</span><span id="plot_evaluation_summary-2528"><a href="#plot_evaluation_summary-2528"><span class="linenos">2528</span></a>        <span class="k">for</span> <span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">strat</span><span class="p">),</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">axes_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="plot_evaluation_summary-2529"><a href="#plot_evaluation_summary-2529"><span class="linenos">2529</span></a>            <span class="k">if</span> <span class="n">opt</span> <span class="o">==</span> <span class="n">best_opt</span> <span class="ow">and</span> <span class="n">strat</span> <span class="o">==</span> <span class="n">best_strat</span><span class="p">:</span>
</span><span id="plot_evaluation_summary-2530"><a href="#plot_evaluation_summary-2530"><span class="linenos">2530</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">best_agg</span><span class="p">,</span> <span class="n">best_E</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gold&quot;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot; Best&quot;</span><span class="p">)</span>
</span><span id="plot_evaluation_summary-2531"><a href="#plot_evaluation_summary-2531"><span class="linenos">2531</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="plot_evaluation_summary-2532"><a href="#plot_evaluation_summary-2532"><span class="linenos">2532</span></a>
</span><span id="plot_evaluation_summary-2533"><a href="#plot_evaluation_summary-2533"><span class="linenos">2533</span></a>        <span class="c1"># Save and show</span>
</span><span id="plot_evaluation_summary-2534"><a href="#plot_evaluation_summary-2534"><span class="linenos">2534</span></a>        <span class="k">if</span> <span class="n">save_dir</span><span class="p">:</span>
</span><span id="plot_evaluation_summary-2535"><a href="#plot_evaluation_summary-2535"><span class="linenos">2535</span></a>            <span class="n">fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">save_dir</span><span class="si">}</span><span class="s2">/facet_energy_vs_aggression_</span><span class="si">{</span><span class="n">timestamp</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">_highlighted.png&quot;</span>
</span><span id="plot_evaluation_summary-2536"><a href="#plot_evaluation_summary-2536"><span class="linenos">2536</span></a>            <span class="n">g</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
</span><span id="plot_evaluation_summary-2537"><a href="#plot_evaluation_summary-2537"><span class="linenos">2537</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Saved with highlight: </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="plot_evaluation_summary-2538"><a href="#plot_evaluation_summary-2538"><span class="linenos">2538</span></a>
</span><span id="plot_evaluation_summary-2539"><a href="#plot_evaluation_summary-2539"><span class="linenos">2539</span></a>        <span class="k">if</span> <span class="n">show_plots</span><span class="p">:</span>
</span><span id="plot_evaluation_summary-2540"><a href="#plot_evaluation_summary-2540"><span class="linenos">2540</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="plot_evaluation_summary-2541"><a href="#plot_evaluation_summary-2541"><span class="linenos">2541</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="plot_evaluation_summary-2542"><a href="#plot_evaluation_summary-2542"><span class="linenos">2542</span></a>
</span><span id="plot_evaluation_summary-2543"><a href="#plot_evaluation_summary-2543"><span class="linenos">2543</span></a>    <span class="c1"># ------------------------------------------------------------------</span>
</span><span id="plot_evaluation_summary-2544"><a href="#plot_evaluation_summary-2544"><span class="linenos">2544</span></a>    <span class="c1"># Line plot: Energy vs Aggression (Top Strategies)</span>
</span><span id="plot_evaluation_summary-2545"><a href="#plot_evaluation_summary-2545"><span class="linenos">2545</span></a>    <span class="c1"># ------------------------------------------------------------------</span>
</span><span id="plot_evaluation_summary-2546"><a href="#plot_evaluation_summary-2546"><span class="linenos">2546</span></a>    <span class="n">mean_energy</span> <span class="o">=</span> <span class="n">df_plot</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;aggression&quot;</span><span class="p">])[</span><span class="s2">&quot;total_energy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
</span><span id="plot_evaluation_summary-2547"><a href="#plot_evaluation_summary-2547"><span class="linenos">2547</span></a>    <span class="n">top_strats</span> <span class="o">=</span> <span class="n">mean_energy</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;strategy&quot;</span><span class="p">)[</span><span class="s2">&quot;total_energy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">nsmallest</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">index</span>
</span><span id="plot_evaluation_summary-2548"><a href="#plot_evaluation_summary-2548"><span class="linenos">2548</span></a>
</span><span id="plot_evaluation_summary-2549"><a href="#plot_evaluation_summary-2549"><span class="linenos">2549</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
</span><span id="plot_evaluation_summary-2550"><a href="#plot_evaluation_summary-2550"><span class="linenos">2550</span></a>    <span class="k">for</span> <span class="n">strat</span> <span class="ow">in</span> <span class="n">top_strats</span><span class="p">:</span>
</span><span id="plot_evaluation_summary-2551"><a href="#plot_evaluation_summary-2551"><span class="linenos">2551</span></a>        <span class="n">subset</span> <span class="o">=</span> <span class="n">mean_energy</span><span class="p">[</span><span class="n">mean_energy</span><span class="p">[</span><span class="s2">&quot;strategy&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">strat</span><span class="p">]</span>
</span><span id="plot_evaluation_summary-2552"><a href="#plot_evaluation_summary-2552"><span class="linenos">2552</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">subset</span><span class="p">[</span><span class="s2">&quot;aggression&quot;</span><span class="p">],</span> <span class="n">subset</span><span class="p">[</span><span class="s2">&quot;total_energy&quot;</span><span class="p">],</span> <span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">strat</span><span class="p">)</span>
</span><span id="plot_evaluation_summary-2553"><a href="#plot_evaluation_summary-2553"><span class="linenos">2553</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Aggression Level&quot;</span><span class="p">)</span>
</span><span id="plot_evaluation_summary-2554"><a href="#plot_evaluation_summary-2554"><span class="linenos">2554</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Mean Total Energy&quot;</span><span class="p">)</span>
</span><span id="plot_evaluation_summary-2555"><a href="#plot_evaluation_summary-2555"><span class="linenos">2555</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Top Strategies: Energy vs Aggression&quot;</span><span class="p">)</span>
</span><span id="plot_evaluation_summary-2556"><a href="#plot_evaluation_summary-2556"><span class="linenos">2556</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="plot_evaluation_summary-2557"><a href="#plot_evaluation_summary-2557"><span class="linenos">2557</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="plot_evaluation_summary-2558"><a href="#plot_evaluation_summary-2558"><span class="linenos">2558</span></a>    <span class="k">if</span> <span class="n">save_dir</span><span class="p">:</span>
</span><span id="plot_evaluation_summary-2559"><a href="#plot_evaluation_summary-2559"><span class="linenos">2559</span></a>        <span class="n">fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">save_dir</span><span class="si">}</span><span class="s2">/lineplot_top_strategies_</span><span class="si">{</span><span class="n">timestamp</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">.png&quot;</span>
</span><span id="plot_evaluation_summary-2560"><a href="#plot_evaluation_summary-2560"><span class="linenos">2560</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
</span><span id="plot_evaluation_summary-2561"><a href="#plot_evaluation_summary-2561"><span class="linenos">2561</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Saved: </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="plot_evaluation_summary-2562"><a href="#plot_evaluation_summary-2562"><span class="linenos">2562</span></a>    <span class="k">if</span> <span class="n">show_plots</span><span class="p">:</span>
</span><span id="plot_evaluation_summary-2563"><a href="#plot_evaluation_summary-2563"><span class="linenos">2563</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="plot_evaluation_summary-2564"><a href="#plot_evaluation_summary-2564"><span class="linenos">2564</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="plot_evaluation_summary-2565"><a href="#plot_evaluation_summary-2565"><span class="linenos">2565</span></a>
</span><span id="plot_evaluation_summary-2566"><a href="#plot_evaluation_summary-2566"><span class="linenos">2566</span></a>    <span class="c1"># ------------------------------------------------------------------</span>
</span><span id="plot_evaluation_summary-2567"><a href="#plot_evaluation_summary-2567"><span class="linenos">2567</span></a>    <span class="c1"># Line plot: Energy vs Weight (Top Optimizers)</span>
</span><span id="plot_evaluation_summary-2568"><a href="#plot_evaluation_summary-2568"><span class="linenos">2568</span></a>    <span class="c1"># ------------------------------------------------------------------</span>
</span><span id="plot_evaluation_summary-2569"><a href="#plot_evaluation_summary-2569"><span class="linenos">2569</span></a>    <span class="k">if</span> <span class="s2">&quot;w&quot;</span> <span class="ow">in</span> <span class="n">df_plot</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="plot_evaluation_summary-2570"><a href="#plot_evaluation_summary-2570"><span class="linenos">2570</span></a>        <span class="n">mean_w</span> <span class="o">=</span> <span class="n">df_plot</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;optimizer&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">])[</span><span class="s2">&quot;total_energy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
</span><span id="plot_evaluation_summary-2571"><a href="#plot_evaluation_summary-2571"><span class="linenos">2571</span></a>        <span class="n">top_opts</span> <span class="o">=</span> <span class="n">mean_w</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;optimizer&quot;</span><span class="p">)[</span><span class="s2">&quot;total_energy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">nsmallest</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">index</span>
</span><span id="plot_evaluation_summary-2572"><a href="#plot_evaluation_summary-2572"><span class="linenos">2572</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
</span><span id="plot_evaluation_summary-2573"><a href="#plot_evaluation_summary-2573"><span class="linenos">2573</span></a>        <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">top_opts</span><span class="p">:</span>
</span><span id="plot_evaluation_summary-2574"><a href="#plot_evaluation_summary-2574"><span class="linenos">2574</span></a>            <span class="n">subset</span> <span class="o">=</span> <span class="n">mean_w</span><span class="p">[</span><span class="n">mean_w</span><span class="p">[</span><span class="s2">&quot;optimizer&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">opt</span><span class="p">]</span>
</span><span id="plot_evaluation_summary-2575"><a href="#plot_evaluation_summary-2575"><span class="linenos">2575</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">subset</span><span class="p">[</span><span class="s2">&quot;w&quot;</span><span class="p">],</span> <span class="n">subset</span><span class="p">[</span><span class="s2">&quot;total_energy&quot;</span><span class="p">],</span> <span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
</span><span id="plot_evaluation_summary-2576"><a href="#plot_evaluation_summary-2576"><span class="linenos">2576</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Weight (w)&quot;</span><span class="p">)</span>
</span><span id="plot_evaluation_summary-2577"><a href="#plot_evaluation_summary-2577"><span class="linenos">2577</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Mean Total Energy&quot;</span><span class="p">)</span>
</span><span id="plot_evaluation_summary-2578"><a href="#plot_evaluation_summary-2578"><span class="linenos">2578</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Top Optimizers: Energy vs Weight&quot;</span><span class="p">)</span>
</span><span id="plot_evaluation_summary-2579"><a href="#plot_evaluation_summary-2579"><span class="linenos">2579</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="plot_evaluation_summary-2580"><a href="#plot_evaluation_summary-2580"><span class="linenos">2580</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="plot_evaluation_summary-2581"><a href="#plot_evaluation_summary-2581"><span class="linenos">2581</span></a>        <span class="k">if</span> <span class="n">save_dir</span><span class="p">:</span>
</span><span id="plot_evaluation_summary-2582"><a href="#plot_evaluation_summary-2582"><span class="linenos">2582</span></a>            <span class="n">fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">save_dir</span><span class="si">}</span><span class="s2">/lineplot_top_optimizers_vs_w_</span><span class="si">{</span><span class="n">timestamp</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">.png&quot;</span>
</span><span id="plot_evaluation_summary-2583"><a href="#plot_evaluation_summary-2583"><span class="linenos">2583</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
</span><span id="plot_evaluation_summary-2584"><a href="#plot_evaluation_summary-2584"><span class="linenos">2584</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Saved: </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="plot_evaluation_summary-2585"><a href="#plot_evaluation_summary-2585"><span class="linenos">2585</span></a>        <span class="k">if</span> <span class="n">show_plots</span><span class="p">:</span>
</span><span id="plot_evaluation_summary-2586"><a href="#plot_evaluation_summary-2586"><span class="linenos">2586</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="plot_evaluation_summary-2587"><a href="#plot_evaluation_summary-2587"><span class="linenos">2587</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="plot_evaluation_summary-2588"><a href="#plot_evaluation_summary-2588"><span class="linenos">2588</span></a>
</span><span id="plot_evaluation_summary-2589"><a href="#plot_evaluation_summary-2589"><span class="linenos">2589</span></a>    <span class="c1"># ------------------------------------------------------------------</span>
</span><span id="plot_evaluation_summary-2590"><a href="#plot_evaluation_summary-2590"><span class="linenos">2590</span></a>    <span class="c1"># Save cleaned data summary</span>
</span><span id="plot_evaluation_summary-2591"><a href="#plot_evaluation_summary-2591"><span class="linenos">2591</span></a>    <span class="c1"># ------------------------------------------------------------------</span>
</span><span id="plot_evaluation_summary-2592"><a href="#plot_evaluation_summary-2592"><span class="linenos">2592</span></a>    <span class="k">if</span> <span class="n">save_dir</span><span class="p">:</span>
</span><span id="plot_evaluation_summary-2593"><a href="#plot_evaluation_summary-2593"><span class="linenos">2593</span></a>        <span class="n">clean_csv</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">save_dir</span><span class="si">}</span><span class="s2">/cleaned_results_</span><span class="si">{</span><span class="n">timestamp</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">.csv&quot;</span>
</span><span id="plot_evaluation_summary-2594"><a href="#plot_evaluation_summary-2594"><span class="linenos">2594</span></a>        <span class="n">df_plot</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">clean_csv</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="plot_evaluation_summary-2595"><a href="#plot_evaluation_summary-2595"><span class="linenos">2595</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Saved cleaned result data: </span><span class="si">{</span><span class="n">clean_csv</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="plot_evaluation_summary-2596"><a href="#plot_evaluation_summary-2596"><span class="linenos">2596</span></a>
</span><span id="plot_evaluation_summary-2597"><a href="#plot_evaluation_summary-2597"><span class="linenos">2597</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; All summary plots and rankings generated successfully.&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Generate and optionally save detailed summary visualizations for NSA-Flow evaluation results.</p>

<h2 id="parameters">Parameters</h2>

<p>df : pd.DataFrame
    DataFrame output from <code><a href="#evaluate">evaluate()</a></code>, expected to include:
    ['strategy', 'optimizer', 'aggression', 'total_energy', 'w', 'error']
save_dir : str, optional
    Directory where plots and summary CSVs will be saved.
timestamp : str, optional
    Timestamp to append to saved filenames.
show_plots : bool, default=True
    Whether to display plots interactively.</p>
</div>


                </section>
                <section id="NSAFlowLayer">
                            <input id="NSAFlowLayer-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">NSAFlowLayer</span><wbr>(<span class="base">torch.nn.modules.module.Module</span>):

                <label class="view-source-button" for="NSAFlowLayer-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NSAFlowLayer"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NSAFlowLayer-2628"><a href="#NSAFlowLayer-2628"><span class="linenos">2628</span></a><span class="k">class</span><span class="w"> </span><span class="nc">NSAFlowLayer</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="NSAFlowLayer-2629"><a href="#NSAFlowLayer-2629"><span class="linenos">2629</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NSAFlowLayer-2630"><a href="#NSAFlowLayer-2630"><span class="linenos">2630</span></a><span class="sd">    Unified NSA Flow layer:</span>
</span><span id="NSAFlowLayer-2631"><a href="#NSAFlowLayer-2631"><span class="linenos">2631</span></a><span class="sd">      - Optional residual MLP transform</span>
</span><span id="NSAFlowLayer-2632"><a href="#NSAFlowLayer-2632"><span class="linenos">2632</span></a><span class="sd">      - Adaptive retraction blend (learnable w_retract)</span>
</span><span id="NSAFlowLayer-2633"><a href="#NSAFlowLayer-2633"><span class="linenos">2633</span></a><span class="sd">      - Optional nonnegativity enforcement (&#39;none&#39;, &#39;soft&#39;, &#39;hard&#39;)</span>
</span><span id="NSAFlowLayer-2634"><a href="#NSAFlowLayer-2634"><span class="linenos">2634</span></a><span class="sd">      - Can compute fidelity + orthogonality losses if target provided</span>
</span><span id="NSAFlowLayer-2635"><a href="#NSAFlowLayer-2635"><span class="linenos">2635</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="NSAFlowLayer-2636"><a href="#NSAFlowLayer-2636"><span class="linenos">2636</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="NSAFlowLayer-2637"><a href="#NSAFlowLayer-2637"><span class="linenos">2637</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="NSAFlowLayer-2638"><a href="#NSAFlowLayer-2638"><span class="linenos">2638</span></a>        <span class="n">k</span><span class="p">,</span>
</span><span id="NSAFlowLayer-2639"><a href="#NSAFlowLayer-2639"><span class="linenos">2639</span></a>        <span class="n">hidden</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
</span><span id="NSAFlowLayer-2640"><a href="#NSAFlowLayer-2640"><span class="linenos">2640</span></a>        <span class="n">w_retract</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
</span><span id="NSAFlowLayer-2641"><a href="#NSAFlowLayer-2641"><span class="linenos">2641</span></a>        <span class="n">retraction_type</span><span class="o">=</span><span class="s2">&quot;soft_polar&quot;</span><span class="p">,</span>
</span><span id="NSAFlowLayer-2642"><a href="#NSAFlowLayer-2642"><span class="linenos">2642</span></a>        <span class="n">apply_nonneg</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
</span><span id="NSAFlowLayer-2643"><a href="#NSAFlowLayer-2643"><span class="linenos">2643</span></a>        <span class="n">residual</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="NSAFlowLayer-2644"><a href="#NSAFlowLayer-2644"><span class="linenos">2644</span></a>        <span class="n">use_transform</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="NSAFlowLayer-2645"><a href="#NSAFlowLayer-2645"><span class="linenos">2645</span></a>    <span class="p">):</span>
</span><span id="NSAFlowLayer-2646"><a href="#NSAFlowLayer-2646"><span class="linenos">2646</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="NSAFlowLayer-2647"><a href="#NSAFlowLayer-2647"><span class="linenos">2647</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">k</span>
</span><span id="NSAFlowLayer-2648"><a href="#NSAFlowLayer-2648"><span class="linenos">2648</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span> <span class="o">=</span> <span class="n">hidden</span>
</span><span id="NSAFlowLayer-2649"><a href="#NSAFlowLayer-2649"><span class="linenos">2649</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">retraction_type</span> <span class="o">=</span> <span class="n">retraction_type</span>
</span><span id="NSAFlowLayer-2650"><a href="#NSAFlowLayer-2650"><span class="linenos">2650</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">apply_nonneg</span> <span class="o">=</span> <span class="n">apply_nonneg</span>
</span><span id="NSAFlowLayer-2651"><a href="#NSAFlowLayer-2651"><span class="linenos">2651</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">residual</span> <span class="o">=</span> <span class="n">residual</span>
</span><span id="NSAFlowLayer-2652"><a href="#NSAFlowLayer-2652"><span class="linenos">2652</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">use_transform</span> <span class="o">=</span> <span class="n">use_transform</span>
</span><span id="NSAFlowLayer-2653"><a href="#NSAFlowLayer-2653"><span class="linenos">2653</span></a>
</span><span id="NSAFlowLayer-2654"><a href="#NSAFlowLayer-2654"><span class="linenos">2654</span></a>        <span class="c1"># Optional small residual MLP (row-wise)</span>
</span><span id="NSAFlowLayer-2655"><a href="#NSAFlowLayer-2655"><span class="linenos">2655</span></a>        <span class="k">if</span> <span class="n">use_transform</span><span class="p">:</span>
</span><span id="NSAFlowLayer-2656"><a href="#NSAFlowLayer-2656"><span class="linenos">2656</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">transform_net</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
</span><span id="NSAFlowLayer-2657"><a href="#NSAFlowLayer-2657"><span class="linenos">2657</span></a>                <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">hidden</span><span class="p">),</span>
</span><span id="NSAFlowLayer-2658"><a href="#NSAFlowLayer-2658"><span class="linenos">2658</span></a>                <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
</span><span id="NSAFlowLayer-2659"><a href="#NSAFlowLayer-2659"><span class="linenos">2659</span></a>                <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
</span><span id="NSAFlowLayer-2660"><a href="#NSAFlowLayer-2660"><span class="linenos">2660</span></a>            <span class="p">)</span>
</span><span id="NSAFlowLayer-2661"><a href="#NSAFlowLayer-2661"><span class="linenos">2661</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="NSAFlowLayer-2662"><a href="#NSAFlowLayer-2662"><span class="linenos">2662</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">transform_net</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NSAFlowLayer-2663"><a href="#NSAFlowLayer-2663"><span class="linenos">2663</span></a>
</span><span id="NSAFlowLayer-2664"><a href="#NSAFlowLayer-2664"><span class="linenos">2664</span></a>        <span class="c1"># Learnable retraction weight</span>
</span><span id="NSAFlowLayer-2665"><a href="#NSAFlowLayer-2665"><span class="linenos">2665</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">w_retract</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">w_retract</span><span class="p">)))</span>
</span><span id="NSAFlowLayer-2666"><a href="#NSAFlowLayer-2666"><span class="linenos">2666</span></a>        <span class="c1"># Adaptive tradeoff scalar for loss weighting</span>
</span><span id="NSAFlowLayer-2667"><a href="#NSAFlowLayer-2667"><span class="linenos">2667</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">))</span>
</span><span id="NSAFlowLayer-2668"><a href="#NSAFlowLayer-2668"><span class="linenos">2668</span></a>
</span><span id="NSAFlowLayer-2669"><a href="#NSAFlowLayer-2669"><span class="linenos">2669</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_nonneg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
</span><span id="NSAFlowLayer-2670"><a href="#NSAFlowLayer-2670"><span class="linenos">2670</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_nonneg</span> <span class="o">==</span> <span class="s2">&quot;soft&quot;</span><span class="p">:</span>
</span><span id="NSAFlowLayer-2671"><a href="#NSAFlowLayer-2671"><span class="linenos">2671</span></a>            <span class="k">return</span> <span class="n">F</span><span class="o">.</span><span class="n">softplus</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
</span><span id="NSAFlowLayer-2672"><a href="#NSAFlowLayer-2672"><span class="linenos">2672</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_nonneg</span> <span class="o">==</span> <span class="s2">&quot;relu&quot;</span><span class="p">:</span>
</span><span id="NSAFlowLayer-2673"><a href="#NSAFlowLayer-2673"><span class="linenos">2673</span></a>            <span class="k">return</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
</span><span id="NSAFlowLayer-2674"><a href="#NSAFlowLayer-2674"><span class="linenos">2674</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_nonneg</span> <span class="o">==</span> <span class="s2">&quot;hard&quot;</span><span class="p">:</span>
</span><span id="NSAFlowLayer-2675"><a href="#NSAFlowLayer-2675"><span class="linenos">2675</span></a>            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
</span><span id="NSAFlowLayer-2676"><a href="#NSAFlowLayer-2676"><span class="linenos">2676</span></a>        <span class="k">return</span> <span class="n">Y</span>
</span><span id="NSAFlowLayer-2677"><a href="#NSAFlowLayer-2677"><span class="linenos">2677</span></a>
</span><span id="NSAFlowLayer-2678"><a href="#NSAFlowLayer-2678"><span class="linenos">2678</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="NSAFlowLayer-2679"><a href="#NSAFlowLayer-2679"><span class="linenos">2679</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_transform</span><span class="p">:</span>
</span><span id="NSAFlowLayer-2680"><a href="#NSAFlowLayer-2680"><span class="linenos">2680</span></a>            <span class="n">Y_t</span> <span class="o">=</span> <span class="n">Y</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_net</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
</span><span id="NSAFlowLayer-2681"><a href="#NSAFlowLayer-2681"><span class="linenos">2681</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="NSAFlowLayer-2682"><a href="#NSAFlowLayer-2682"><span class="linenos">2682</span></a>            <span class="n">Y_t</span> <span class="o">=</span> <span class="n">Y</span>
</span><span id="NSAFlowLayer-2683"><a href="#NSAFlowLayer-2683"><span class="linenos">2683</span></a>
</span><span id="NSAFlowLayer-2684"><a href="#NSAFlowLayer-2684"><span class="linenos">2684</span></a>        <span class="n">Yw</span> <span class="o">=</span> <span class="n">nsa_flow_retract_auto</span><span class="p">(</span><span class="n">Y_t</span><span class="p">,</span> <span class="n">w_retract</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">w_retract</span><span class="p">,</span> <span class="n">retraction_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">retraction_type</span><span class="p">)</span>
</span><span id="NSAFlowLayer-2685"><a href="#NSAFlowLayer-2685"><span class="linenos">2685</span></a>
</span><span id="NSAFlowLayer-2686"><a href="#NSAFlowLayer-2686"><span class="linenos">2686</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">residual</span><span class="p">:</span>
</span><span id="NSAFlowLayer-2687"><a href="#NSAFlowLayer-2687"><span class="linenos">2687</span></a>            <span class="n">Y_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_nonneg</span><span class="p">(</span><span class="n">Y</span> <span class="o">+</span> <span class="n">Yw</span><span class="p">)</span>
</span><span id="NSAFlowLayer-2688"><a href="#NSAFlowLayer-2688"><span class="linenos">2688</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="NSAFlowLayer-2689"><a href="#NSAFlowLayer-2689"><span class="linenos">2689</span></a>            <span class="n">Y_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_nonneg</span><span class="p">(</span><span class="n">Yw</span><span class="p">)</span>
</span><span id="NSAFlowLayer-2690"><a href="#NSAFlowLayer-2690"><span class="linenos">2690</span></a>
</span><span id="NSAFlowLayer-2691"><a href="#NSAFlowLayer-2691"><span class="linenos">2691</span></a>        <span class="k">if</span> <span class="n">target</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NSAFlowLayer-2692"><a href="#NSAFlowLayer-2692"><span class="linenos">2692</span></a>            <span class="n">fid</span> <span class="o">=</span> <span class="n">fidelity_scaled</span><span class="p">(</span><span class="n">Y_out</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
</span><span id="NSAFlowLayer-2693"><a href="#NSAFlowLayer-2693"><span class="linenos">2693</span></a>            <span class="n">orth</span> <span class="o">=</span> <span class="n">invariant_orthogonality_defect</span><span class="p">(</span><span class="n">Y_out</span><span class="p">)</span>
</span><span id="NSAFlowLayer-2694"><a href="#NSAFlowLayer-2694"><span class="linenos">2694</span></a>            <span class="n">w_dyn</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span>
</span><span id="NSAFlowLayer-2695"><a href="#NSAFlowLayer-2695"><span class="linenos">2695</span></a>            <span class="n">total_loss</span> <span class="o">=</span> <span class="n">fid</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">w_dyn</span><span class="p">)</span> <span class="o">+</span> <span class="n">orth</span> <span class="o">*</span> <span class="n">w_dyn</span>
</span><span id="NSAFlowLayer-2696"><a href="#NSAFlowLayer-2696"><span class="linenos">2696</span></a>            <span class="k">return</span> <span class="n">Y_out</span><span class="p">,</span> <span class="n">total_loss</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="n">orth</span><span class="p">,</span> <span class="n">w_dyn</span>
</span><span id="NSAFlowLayer-2697"><a href="#NSAFlowLayer-2697"><span class="linenos">2697</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="NSAFlowLayer-2698"><a href="#NSAFlowLayer-2698"><span class="linenos">2698</span></a>            <span class="k">return</span> <span class="n">Y_out</span>
</span></pre></div>


            <div class="docstring"><p>Unified NSA Flow layer:</p>

<ul>
<li>Optional residual MLP transform</li>
<li>Adaptive retraction blend (learnable w_retract)</li>
<li>Optional nonnegativity enforcement ('none', 'soft', 'hard')</li>
<li>Can compute fidelity + orthogonality losses if target provided</li>
</ul>
</div>


                            <div id="NSAFlowLayer.__init__" class="classattr">
                                        <input id="NSAFlowLayer.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">NSAFlowLayer</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">k</span>,</span><span class="param">	<span class="n">hidden</span><span class="o">=</span><span class="mi">64</span>,</span><span class="param">	<span class="n">w_retract</span><span class="o">=</span><span class="mf">0.5</span>,</span><span class="param">	<span class="n">retraction_type</span><span class="o">=</span><span class="s1">&#39;soft_polar&#39;</span>,</span><span class="param">	<span class="n">apply_nonneg</span><span class="o">=</span><span class="s1">&#39;none&#39;</span>,</span><span class="param">	<span class="n">residual</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">use_transform</span><span class="o">=</span><span class="kc">True</span></span>)</span>

                <label class="view-source-button" for="NSAFlowLayer.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NSAFlowLayer.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NSAFlowLayer.__init__-2636"><a href="#NSAFlowLayer.__init__-2636"><span class="linenos">2636</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="NSAFlowLayer.__init__-2637"><a href="#NSAFlowLayer.__init__-2637"><span class="linenos">2637</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="NSAFlowLayer.__init__-2638"><a href="#NSAFlowLayer.__init__-2638"><span class="linenos">2638</span></a>        <span class="n">k</span><span class="p">,</span>
</span><span id="NSAFlowLayer.__init__-2639"><a href="#NSAFlowLayer.__init__-2639"><span class="linenos">2639</span></a>        <span class="n">hidden</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
</span><span id="NSAFlowLayer.__init__-2640"><a href="#NSAFlowLayer.__init__-2640"><span class="linenos">2640</span></a>        <span class="n">w_retract</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
</span><span id="NSAFlowLayer.__init__-2641"><a href="#NSAFlowLayer.__init__-2641"><span class="linenos">2641</span></a>        <span class="n">retraction_type</span><span class="o">=</span><span class="s2">&quot;soft_polar&quot;</span><span class="p">,</span>
</span><span id="NSAFlowLayer.__init__-2642"><a href="#NSAFlowLayer.__init__-2642"><span class="linenos">2642</span></a>        <span class="n">apply_nonneg</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
</span><span id="NSAFlowLayer.__init__-2643"><a href="#NSAFlowLayer.__init__-2643"><span class="linenos">2643</span></a>        <span class="n">residual</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="NSAFlowLayer.__init__-2644"><a href="#NSAFlowLayer.__init__-2644"><span class="linenos">2644</span></a>        <span class="n">use_transform</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="NSAFlowLayer.__init__-2645"><a href="#NSAFlowLayer.__init__-2645"><span class="linenos">2645</span></a>    <span class="p">):</span>
</span><span id="NSAFlowLayer.__init__-2646"><a href="#NSAFlowLayer.__init__-2646"><span class="linenos">2646</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="NSAFlowLayer.__init__-2647"><a href="#NSAFlowLayer.__init__-2647"><span class="linenos">2647</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">k</span>
</span><span id="NSAFlowLayer.__init__-2648"><a href="#NSAFlowLayer.__init__-2648"><span class="linenos">2648</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span> <span class="o">=</span> <span class="n">hidden</span>
</span><span id="NSAFlowLayer.__init__-2649"><a href="#NSAFlowLayer.__init__-2649"><span class="linenos">2649</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">retraction_type</span> <span class="o">=</span> <span class="n">retraction_type</span>
</span><span id="NSAFlowLayer.__init__-2650"><a href="#NSAFlowLayer.__init__-2650"><span class="linenos">2650</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">apply_nonneg</span> <span class="o">=</span> <span class="n">apply_nonneg</span>
</span><span id="NSAFlowLayer.__init__-2651"><a href="#NSAFlowLayer.__init__-2651"><span class="linenos">2651</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">residual</span> <span class="o">=</span> <span class="n">residual</span>
</span><span id="NSAFlowLayer.__init__-2652"><a href="#NSAFlowLayer.__init__-2652"><span class="linenos">2652</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">use_transform</span> <span class="o">=</span> <span class="n">use_transform</span>
</span><span id="NSAFlowLayer.__init__-2653"><a href="#NSAFlowLayer.__init__-2653"><span class="linenos">2653</span></a>
</span><span id="NSAFlowLayer.__init__-2654"><a href="#NSAFlowLayer.__init__-2654"><span class="linenos">2654</span></a>        <span class="c1"># Optional small residual MLP (row-wise)</span>
</span><span id="NSAFlowLayer.__init__-2655"><a href="#NSAFlowLayer.__init__-2655"><span class="linenos">2655</span></a>        <span class="k">if</span> <span class="n">use_transform</span><span class="p">:</span>
</span><span id="NSAFlowLayer.__init__-2656"><a href="#NSAFlowLayer.__init__-2656"><span class="linenos">2656</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">transform_net</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
</span><span id="NSAFlowLayer.__init__-2657"><a href="#NSAFlowLayer.__init__-2657"><span class="linenos">2657</span></a>                <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">hidden</span><span class="p">),</span>
</span><span id="NSAFlowLayer.__init__-2658"><a href="#NSAFlowLayer.__init__-2658"><span class="linenos">2658</span></a>                <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
</span><span id="NSAFlowLayer.__init__-2659"><a href="#NSAFlowLayer.__init__-2659"><span class="linenos">2659</span></a>                <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
</span><span id="NSAFlowLayer.__init__-2660"><a href="#NSAFlowLayer.__init__-2660"><span class="linenos">2660</span></a>            <span class="p">)</span>
</span><span id="NSAFlowLayer.__init__-2661"><a href="#NSAFlowLayer.__init__-2661"><span class="linenos">2661</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="NSAFlowLayer.__init__-2662"><a href="#NSAFlowLayer.__init__-2662"><span class="linenos">2662</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">transform_net</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NSAFlowLayer.__init__-2663"><a href="#NSAFlowLayer.__init__-2663"><span class="linenos">2663</span></a>
</span><span id="NSAFlowLayer.__init__-2664"><a href="#NSAFlowLayer.__init__-2664"><span class="linenos">2664</span></a>        <span class="c1"># Learnable retraction weight</span>
</span><span id="NSAFlowLayer.__init__-2665"><a href="#NSAFlowLayer.__init__-2665"><span class="linenos">2665</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">w_retract</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">w_retract</span><span class="p">)))</span>
</span><span id="NSAFlowLayer.__init__-2666"><a href="#NSAFlowLayer.__init__-2666"><span class="linenos">2666</span></a>        <span class="c1"># Adaptive tradeoff scalar for loss weighting</span>
</span><span id="NSAFlowLayer.__init__-2667"><a href="#NSAFlowLayer.__init__-2667"><span class="linenos">2667</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><p>Initialize internal Module state, shared by both nn.Module and ScriptModule.</p>
</div>


                            </div>
                            <div id="NSAFlowLayer.k" class="classattr">
                                <div class="attr variable">
            <span class="name">k</span>

        
    </div>
    <a class="headerlink" href="#NSAFlowLayer.k"></a>
    
    

                            </div>
                            <div id="NSAFlowLayer.hidden" class="classattr">
                                <div class="attr variable">
            <span class="name">hidden</span>

        
    </div>
    <a class="headerlink" href="#NSAFlowLayer.hidden"></a>
    
    

                            </div>
                            <div id="NSAFlowLayer.retraction_type" class="classattr">
                                <div class="attr variable">
            <span class="name">retraction_type</span>

        
    </div>
    <a class="headerlink" href="#NSAFlowLayer.retraction_type"></a>
    
    

                            </div>
                            <div id="NSAFlowLayer.apply_nonneg" class="classattr">
                                <div class="attr variable">
            <span class="name">apply_nonneg</span>

        
    </div>
    <a class="headerlink" href="#NSAFlowLayer.apply_nonneg"></a>
    
    

                            </div>
                            <div id="NSAFlowLayer.residual" class="classattr">
                                <div class="attr variable">
            <span class="name">residual</span>

        
    </div>
    <a class="headerlink" href="#NSAFlowLayer.residual"></a>
    
    

                            </div>
                            <div id="NSAFlowLayer.use_transform" class="classattr">
                                <div class="attr variable">
            <span class="name">use_transform</span>

        
    </div>
    <a class="headerlink" href="#NSAFlowLayer.use_transform"></a>
    
    

                            </div>
                            <div id="NSAFlowLayer.w_retract" class="classattr">
                                <div class="attr variable">
            <span class="name">w_retract</span>

        
    </div>
    <a class="headerlink" href="#NSAFlowLayer.w_retract"></a>
    
    

                            </div>
                            <div id="NSAFlowLayer.alpha" class="classattr">
                                <div class="attr variable">
            <span class="name">alpha</span>

        
    </div>
    <a class="headerlink" href="#NSAFlowLayer.alpha"></a>
    
    

                            </div>
                            <div id="NSAFlowLayer.forward" class="classattr">
                                        <input id="NSAFlowLayer.forward-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">forward</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">Y</span>, </span><span class="param"><span class="n">target</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="NSAFlowLayer.forward-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NSAFlowLayer.forward"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NSAFlowLayer.forward-2678"><a href="#NSAFlowLayer.forward-2678"><span class="linenos">2678</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="NSAFlowLayer.forward-2679"><a href="#NSAFlowLayer.forward-2679"><span class="linenos">2679</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_transform</span><span class="p">:</span>
</span><span id="NSAFlowLayer.forward-2680"><a href="#NSAFlowLayer.forward-2680"><span class="linenos">2680</span></a>            <span class="n">Y_t</span> <span class="o">=</span> <span class="n">Y</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_net</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
</span><span id="NSAFlowLayer.forward-2681"><a href="#NSAFlowLayer.forward-2681"><span class="linenos">2681</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="NSAFlowLayer.forward-2682"><a href="#NSAFlowLayer.forward-2682"><span class="linenos">2682</span></a>            <span class="n">Y_t</span> <span class="o">=</span> <span class="n">Y</span>
</span><span id="NSAFlowLayer.forward-2683"><a href="#NSAFlowLayer.forward-2683"><span class="linenos">2683</span></a>
</span><span id="NSAFlowLayer.forward-2684"><a href="#NSAFlowLayer.forward-2684"><span class="linenos">2684</span></a>        <span class="n">Yw</span> <span class="o">=</span> <span class="n">nsa_flow_retract_auto</span><span class="p">(</span><span class="n">Y_t</span><span class="p">,</span> <span class="n">w_retract</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">w_retract</span><span class="p">,</span> <span class="n">retraction_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">retraction_type</span><span class="p">)</span>
</span><span id="NSAFlowLayer.forward-2685"><a href="#NSAFlowLayer.forward-2685"><span class="linenos">2685</span></a>
</span><span id="NSAFlowLayer.forward-2686"><a href="#NSAFlowLayer.forward-2686"><span class="linenos">2686</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">residual</span><span class="p">:</span>
</span><span id="NSAFlowLayer.forward-2687"><a href="#NSAFlowLayer.forward-2687"><span class="linenos">2687</span></a>            <span class="n">Y_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_nonneg</span><span class="p">(</span><span class="n">Y</span> <span class="o">+</span> <span class="n">Yw</span><span class="p">)</span>
</span><span id="NSAFlowLayer.forward-2688"><a href="#NSAFlowLayer.forward-2688"><span class="linenos">2688</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="NSAFlowLayer.forward-2689"><a href="#NSAFlowLayer.forward-2689"><span class="linenos">2689</span></a>            <span class="n">Y_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_nonneg</span><span class="p">(</span><span class="n">Yw</span><span class="p">)</span>
</span><span id="NSAFlowLayer.forward-2690"><a href="#NSAFlowLayer.forward-2690"><span class="linenos">2690</span></a>
</span><span id="NSAFlowLayer.forward-2691"><a href="#NSAFlowLayer.forward-2691"><span class="linenos">2691</span></a>        <span class="k">if</span> <span class="n">target</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NSAFlowLayer.forward-2692"><a href="#NSAFlowLayer.forward-2692"><span class="linenos">2692</span></a>            <span class="n">fid</span> <span class="o">=</span> <span class="n">fidelity_scaled</span><span class="p">(</span><span class="n">Y_out</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
</span><span id="NSAFlowLayer.forward-2693"><a href="#NSAFlowLayer.forward-2693"><span class="linenos">2693</span></a>            <span class="n">orth</span> <span class="o">=</span> <span class="n">invariant_orthogonality_defect</span><span class="p">(</span><span class="n">Y_out</span><span class="p">)</span>
</span><span id="NSAFlowLayer.forward-2694"><a href="#NSAFlowLayer.forward-2694"><span class="linenos">2694</span></a>            <span class="n">w_dyn</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span>
</span><span id="NSAFlowLayer.forward-2695"><a href="#NSAFlowLayer.forward-2695"><span class="linenos">2695</span></a>            <span class="n">total_loss</span> <span class="o">=</span> <span class="n">fid</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">w_dyn</span><span class="p">)</span> <span class="o">+</span> <span class="n">orth</span> <span class="o">*</span> <span class="n">w_dyn</span>
</span><span id="NSAFlowLayer.forward-2696"><a href="#NSAFlowLayer.forward-2696"><span class="linenos">2696</span></a>            <span class="k">return</span> <span class="n">Y_out</span><span class="p">,</span> <span class="n">total_loss</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="n">orth</span><span class="p">,</span> <span class="n">w_dyn</span>
</span><span id="NSAFlowLayer.forward-2697"><a href="#NSAFlowLayer.forward-2697"><span class="linenos">2697</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="NSAFlowLayer.forward-2698"><a href="#NSAFlowLayer.forward-2698"><span class="linenos">2698</span></a>            <span class="k">return</span> <span class="n">Y_out</span>
</span></pre></div>


            <div class="docstring"><p>Define the computation performed at every call.</p>

<p>Should be overridden by all subclasses.</p>

<div class="alert note">

<p>Although the recipe for forward pass needs to be defined within
this function, one should call the <code>Module</code> instance afterwards
instead of this since the former takes care of running the
registered hooks while the latter silently ignores them.</p>

</div>
</div>


                            </div>
                </section>
                <section id="test_mlp_then_nsa_joint_residual">
                            <input id="test_mlp_then_nsa_joint_residual-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">test_mlp_then_nsa_joint_residual</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">seed</span><span class="o">=</span><span class="mi">0</span>,</span><span class="param">	<span class="n">w</span><span class="o">=</span><span class="mf">0.5</span>,</span><span class="param">	<span class="n">n</span><span class="o">=</span><span class="mi">200</span>,</span><span class="param">	<span class="n">p</span><span class="o">=</span><span class="mi">8</span>,</span><span class="param">	<span class="n">k</span><span class="o">=</span><span class="mi">6</span>,</span><span class="param">	<span class="n">hidden</span><span class="o">=</span><span class="mi">128</span>,</span><span class="param">	<span class="n">noise</span><span class="o">=</span><span class="mf">0.1</span>,</span><span class="param">	<span class="n">mlp_epochs</span><span class="o">=</span><span class="mi">2000</span>,</span><span class="param">	<span class="n">nsa_epochs</span><span class="o">=</span><span class="mi">1500</span>,</span><span class="param">	<span class="n">joint_epochs</span><span class="o">=</span><span class="mi">1500</span>,</span><span class="param">	<span class="n">lr_mlp</span><span class="o">=</span><span class="mf">0.001</span>,</span><span class="param">	<span class="n">lr_nsa</span><span class="o">=</span><span class="mf">0.001</span>,</span><span class="param">	<span class="n">lr_joint</span><span class="o">=</span><span class="mf">0.0005</span>,</span><span class="param">	<span class="n">apply_nonneg</span><span class="o">=</span><span class="s1">&#39;hard&#39;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="test_mlp_then_nsa_joint_residual-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#test_mlp_then_nsa_joint_residual"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="test_mlp_then_nsa_joint_residual-2703"><a href="#test_mlp_then_nsa_joint_residual-2703"><span class="linenos">2703</span></a><span class="k">def</span><span class="w"> </span><span class="nf">test_mlp_then_nsa_joint_residual</span><span class="p">(</span>
</span><span id="test_mlp_then_nsa_joint_residual-2704"><a href="#test_mlp_then_nsa_joint_residual-2704"><span class="linenos">2704</span></a>    <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual-2705"><a href="#test_mlp_then_nsa_joint_residual-2705"><span class="linenos">2705</span></a>    <span class="n">w</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual-2706"><a href="#test_mlp_then_nsa_joint_residual-2706"><span class="linenos">2706</span></a>    <span class="n">n</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual-2707"><a href="#test_mlp_then_nsa_joint_residual-2707"><span class="linenos">2707</span></a>    <span class="n">p</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual-2708"><a href="#test_mlp_then_nsa_joint_residual-2708"><span class="linenos">2708</span></a>    <span class="n">k</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual-2709"><a href="#test_mlp_then_nsa_joint_residual-2709"><span class="linenos">2709</span></a>    <span class="n">hidden</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual-2710"><a href="#test_mlp_then_nsa_joint_residual-2710"><span class="linenos">2710</span></a>    <span class="n">noise</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual-2711"><a href="#test_mlp_then_nsa_joint_residual-2711"><span class="linenos">2711</span></a>    <span class="n">mlp_epochs</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual-2712"><a href="#test_mlp_then_nsa_joint_residual-2712"><span class="linenos">2712</span></a>    <span class="n">nsa_epochs</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual-2713"><a href="#test_mlp_then_nsa_joint_residual-2713"><span class="linenos">2713</span></a>    <span class="n">joint_epochs</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual-2714"><a href="#test_mlp_then_nsa_joint_residual-2714"><span class="linenos">2714</span></a>    <span class="n">lr_mlp</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual-2715"><a href="#test_mlp_then_nsa_joint_residual-2715"><span class="linenos">2715</span></a>    <span class="n">lr_nsa</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual-2716"><a href="#test_mlp_then_nsa_joint_residual-2716"><span class="linenos">2716</span></a>    <span class="n">lr_joint</span><span class="o">=</span><span class="mf">5e-4</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual-2717"><a href="#test_mlp_then_nsa_joint_residual-2717"><span class="linenos">2717</span></a>    <span class="n">apply_nonneg</span><span class="o">=</span><span class="s2">&quot;hard&quot;</span>
</span><span id="test_mlp_then_nsa_joint_residual-2718"><a href="#test_mlp_then_nsa_joint_residual-2718"><span class="linenos">2718</span></a><span class="p">):</span>
</span><span id="test_mlp_then_nsa_joint_residual-2719"><a href="#test_mlp_then_nsa_joint_residual-2719"><span class="linenos">2719</span></a>    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2720"><a href="#test_mlp_then_nsa_joint_residual-2720"><span class="linenos">2720</span></a>    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2721"><a href="#test_mlp_then_nsa_joint_residual-2721"><span class="linenos">2721</span></a>
</span><span id="test_mlp_then_nsa_joint_residual-2722"><a href="#test_mlp_then_nsa_joint_residual-2722"><span class="linenos">2722</span></a>    <span class="c1"># === Synthetic data</span>
</span><span id="test_mlp_then_nsa_joint_residual-2723"><a href="#test_mlp_then_nsa_joint_residual-2723"><span class="linenos">2723</span></a>    <span class="n">W_true</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2724"><a href="#test_mlp_then_nsa_joint_residual-2724"><span class="linenos">2724</span></a>    <span class="n">X</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2725"><a href="#test_mlp_then_nsa_joint_residual-2725"><span class="linenos">2725</span></a>    <span class="n">Y_true</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softplus</span><span class="p">(</span><span class="n">X</span> <span class="o">@</span> <span class="n">W_true</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2726"><a href="#test_mlp_then_nsa_joint_residual-2726"><span class="linenos">2726</span></a>    <span class="n">Y_obs</span> <span class="o">=</span> <span class="n">Y_true</span> <span class="o">+</span> <span class="n">noise</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">Y_true</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2727"><a href="#test_mlp_then_nsa_joint_residual-2727"><span class="linenos">2727</span></a>
</span><span id="test_mlp_then_nsa_joint_residual-2728"><a href="#test_mlp_then_nsa_joint_residual-2728"><span class="linenos">2728</span></a>    <span class="n">n_train</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.8</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2729"><a href="#test_mlp_then_nsa_joint_residual-2729"><span class="linenos">2729</span></a>    <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:</span><span class="n">n_train</span><span class="p">],</span> <span class="n">X</span><span class="p">[</span><span class="n">n_train</span><span class="p">:]</span>
</span><span id="test_mlp_then_nsa_joint_residual-2730"><a href="#test_mlp_then_nsa_joint_residual-2730"><span class="linenos">2730</span></a>    <span class="n">Y_train</span><span class="p">,</span> <span class="n">Y_test</span> <span class="o">=</span> <span class="n">Y_obs</span><span class="p">[:</span><span class="n">n_train</span><span class="p">],</span> <span class="n">Y_obs</span><span class="p">[</span><span class="n">n_train</span><span class="p">:]</span>
</span><span id="test_mlp_then_nsa_joint_residual-2731"><a href="#test_mlp_then_nsa_joint_residual-2731"><span class="linenos">2731</span></a>
</span><span id="test_mlp_then_nsa_joint_residual-2732"><a href="#test_mlp_then_nsa_joint_residual-2732"><span class="linenos">2732</span></a>    <span class="c1"># ========================================================</span>
</span><span id="test_mlp_then_nsa_joint_residual-2733"><a href="#test_mlp_then_nsa_joint_residual-2733"><span class="linenos">2733</span></a>    <span class="c1"># 1 Train baseline MLP</span>
</span><span id="test_mlp_then_nsa_joint_residual-2734"><a href="#test_mlp_then_nsa_joint_residual-2734"><span class="linenos">2734</span></a>    <span class="c1"># ========================================================</span>
</span><span id="test_mlp_then_nsa_joint_residual-2735"><a href="#test_mlp_then_nsa_joint_residual-2735"><span class="linenos">2735</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Training MLP ===&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2736"><a href="#test_mlp_then_nsa_joint_residual-2736"><span class="linenos">2736</span></a>    <span class="n">mlp</span> <span class="o">=</span> <span class="n">SimpleMLP</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">hidden</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2737"><a href="#test_mlp_then_nsa_joint_residual-2737"><span class="linenos">2737</span></a>    <span class="n">opt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="n">mlp</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr_mlp</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2738"><a href="#test_mlp_then_nsa_joint_residual-2738"><span class="linenos">2738</span></a>    <span class="n">mlp_losses</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="test_mlp_then_nsa_joint_residual-2739"><a href="#test_mlp_then_nsa_joint_residual-2739"><span class="linenos">2739</span></a>    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mlp_epochs</span><span class="p">):</span>
</span><span id="test_mlp_then_nsa_joint_residual-2740"><a href="#test_mlp_then_nsa_joint_residual-2740"><span class="linenos">2740</span></a>        <span class="n">opt</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual-2741"><a href="#test_mlp_then_nsa_joint_residual-2741"><span class="linenos">2741</span></a>        <span class="n">Y_pred</span> <span class="o">=</span> <span class="n">mlp</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2742"><a href="#test_mlp_then_nsa_joint_residual-2742"><span class="linenos">2742</span></a>        <span class="n">loss</span> <span class="o">=</span> <span class="n">fidelity_scaled</span><span class="p">(</span><span class="n">Y_pred</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2743"><a href="#test_mlp_then_nsa_joint_residual-2743"><span class="linenos">2743</span></a>        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual-2744"><a href="#test_mlp_then_nsa_joint_residual-2744"><span class="linenos">2744</span></a>        <span class="n">opt</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual-2745"><a href="#test_mlp_then_nsa_joint_residual-2745"><span class="linenos">2745</span></a>        <span class="n">mlp_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
</span><span id="test_mlp_then_nsa_joint_residual-2746"><a href="#test_mlp_then_nsa_joint_residual-2746"><span class="linenos">2746</span></a>        <span class="k">if</span> <span class="n">epoch</span> <span class="o">%</span> <span class="mi">200</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">epoch</span> <span class="o">==</span> <span class="n">mlp_epochs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="test_mlp_then_nsa_joint_residual-2747"><a href="#test_mlp_then_nsa_joint_residual-2747"><span class="linenos">2747</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[MLP </span><span class="si">{</span><span class="n">epoch</span><span class="si">:</span><span class="s2">04d</span><span class="si">}</span><span class="s2">] L=</span><span class="si">{</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2748"><a href="#test_mlp_then_nsa_joint_residual-2748"><span class="linenos">2748</span></a>
</span><span id="test_mlp_then_nsa_joint_residual-2749"><a href="#test_mlp_then_nsa_joint_residual-2749"><span class="linenos">2749</span></a>    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="test_mlp_then_nsa_joint_residual-2750"><a href="#test_mlp_then_nsa_joint_residual-2750"><span class="linenos">2750</span></a>        <span class="n">Y_pred_mlp</span> <span class="o">=</span> <span class="n">mlp</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2751"><a href="#test_mlp_then_nsa_joint_residual-2751"><span class="linenos">2751</span></a>        <span class="n">corr_mlp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">Y_pred_mlp</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">Y_test</span><span class="o">.</span><span class="n">flatten</span><span class="p">()]))[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual-2752"><a href="#test_mlp_then_nsa_joint_residual-2752"><span class="linenos">2752</span></a>        <span class="n">invorth_mlp</span> <span class="o">=</span> <span class="n">invariant_orthogonality_defect</span><span class="p">(</span><span class="n">Y_pred_mlp</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual-2753"><a href="#test_mlp_then_nsa_joint_residual-2753"><span class="linenos">2753</span></a>
</span><span id="test_mlp_then_nsa_joint_residual-2754"><a href="#test_mlp_then_nsa_joint_residual-2754"><span class="linenos">2754</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MLP correlation: </span><span class="si">{</span><span class="n">corr_mlp</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2755"><a href="#test_mlp_then_nsa_joint_residual-2755"><span class="linenos">2755</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MLP orth defect: </span><span class="si">{</span><span class="n">invorth_mlp</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2756"><a href="#test_mlp_then_nsa_joint_residual-2756"><span class="linenos">2756</span></a>
</span><span id="test_mlp_then_nsa_joint_residual-2757"><a href="#test_mlp_then_nsa_joint_residual-2757"><span class="linenos">2757</span></a>    <span class="c1"># ========================================================</span>
</span><span id="test_mlp_then_nsa_joint_residual-2758"><a href="#test_mlp_then_nsa_joint_residual-2758"><span class="linenos">2758</span></a>    <span class="c1"># 2 NSA refinement (residual option)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2759"><a href="#test_mlp_then_nsa_joint_residual-2759"><span class="linenos">2759</span></a>    <span class="c1"># ========================================================</span>
</span><span id="test_mlp_then_nsa_joint_residual-2760"><a href="#test_mlp_then_nsa_joint_residual-2760"><span class="linenos">2760</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Training NSA refinement (apply_nonneg=&#39;</span><span class="si">{</span><span class="n">apply_nonneg</span><span class="si">}</span><span class="s2">&#39;) ===&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2761"><a href="#test_mlp_then_nsa_joint_residual-2761"><span class="linenos">2761</span></a>    <span class="n">nsa</span> <span class="o">=</span> <span class="n">NSAFlowLayer</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">w_retract</span><span class="o">=</span><span class="n">w</span><span class="p">,</span> <span class="n">apply_nonneg</span><span class="o">=</span><span class="n">apply_nonneg</span><span class="p">,</span> <span class="n">residual</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2762"><a href="#test_mlp_then_nsa_joint_residual-2762"><span class="linenos">2762</span></a>    <span class="n">opt_nsa</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="n">nsa</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr_nsa</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2763"><a href="#test_mlp_then_nsa_joint_residual-2763"><span class="linenos">2763</span></a>    <span class="n">nsa_losses</span><span class="p">,</span> <span class="n">nsa_fids</span><span class="p">,</span> <span class="n">nsa_orths</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="test_mlp_then_nsa_joint_residual-2764"><a href="#test_mlp_then_nsa_joint_residual-2764"><span class="linenos">2764</span></a>
</span><span id="test_mlp_then_nsa_joint_residual-2765"><a href="#test_mlp_then_nsa_joint_residual-2765"><span class="linenos">2765</span></a>    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="test_mlp_then_nsa_joint_residual-2766"><a href="#test_mlp_then_nsa_joint_residual-2766"><span class="linenos">2766</span></a>        <span class="n">Y0</span> <span class="o">=</span> <span class="n">mlp</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2767"><a href="#test_mlp_then_nsa_joint_residual-2767"><span class="linenos">2767</span></a>
</span><span id="test_mlp_then_nsa_joint_residual-2768"><a href="#test_mlp_then_nsa_joint_residual-2768"><span class="linenos">2768</span></a>    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsa_epochs</span><span class="p">):</span>
</span><span id="test_mlp_then_nsa_joint_residual-2769"><a href="#test_mlp_then_nsa_joint_residual-2769"><span class="linenos">2769</span></a>        <span class="n">opt_nsa</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual-2770"><a href="#test_mlp_then_nsa_joint_residual-2770"><span class="linenos">2770</span></a>        <span class="n">Y_ref</span> <span class="o">=</span> <span class="n">nsa</span><span class="p">(</span><span class="n">Y0</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2771"><a href="#test_mlp_then_nsa_joint_residual-2771"><span class="linenos">2771</span></a>        <span class="n">fid</span> <span class="o">=</span> <span class="n">fidelity_scaled</span><span class="p">(</span><span class="n">Y_ref</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2772"><a href="#test_mlp_then_nsa_joint_residual-2772"><span class="linenos">2772</span></a>        <span class="n">orth</span> <span class="o">=</span> <span class="n">invariant_orthogonality_defect</span><span class="p">(</span><span class="n">Y_ref</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2773"><a href="#test_mlp_then_nsa_joint_residual-2773"><span class="linenos">2773</span></a>        <span class="n">loss</span> <span class="o">=</span> <span class="n">fid</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">orth</span>
</span><span id="test_mlp_then_nsa_joint_residual-2774"><a href="#test_mlp_then_nsa_joint_residual-2774"><span class="linenos">2774</span></a>        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual-2775"><a href="#test_mlp_then_nsa_joint_residual-2775"><span class="linenos">2775</span></a>        <span class="n">opt_nsa</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual-2776"><a href="#test_mlp_then_nsa_joint_residual-2776"><span class="linenos">2776</span></a>        <span class="n">nsa_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
</span><span id="test_mlp_then_nsa_joint_residual-2777"><a href="#test_mlp_then_nsa_joint_residual-2777"><span class="linenos">2777</span></a>        <span class="n">nsa_fids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fid</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
</span><span id="test_mlp_then_nsa_joint_residual-2778"><a href="#test_mlp_then_nsa_joint_residual-2778"><span class="linenos">2778</span></a>        <span class="n">nsa_orths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orth</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
</span><span id="test_mlp_then_nsa_joint_residual-2779"><a href="#test_mlp_then_nsa_joint_residual-2779"><span class="linenos">2779</span></a>        <span class="k">if</span> <span class="n">epoch</span> <span class="o">%</span> <span class="mi">200</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">epoch</span> <span class="o">==</span> <span class="n">nsa_epochs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="test_mlp_then_nsa_joint_residual-2780"><a href="#test_mlp_then_nsa_joint_residual-2780"><span class="linenos">2780</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[NSA </span><span class="si">{</span><span class="n">epoch</span><span class="si">:</span><span class="s2">04d</span><span class="si">}</span><span class="s2">] loss=</span><span class="si">{</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2"> fid=</span><span class="si">{</span><span class="n">fid</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2"> orth=</span><span class="si">{</span><span class="n">orth</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2781"><a href="#test_mlp_then_nsa_joint_residual-2781"><span class="linenos">2781</span></a>
</span><span id="test_mlp_then_nsa_joint_residual-2782"><a href="#test_mlp_then_nsa_joint_residual-2782"><span class="linenos">2782</span></a>    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="test_mlp_then_nsa_joint_residual-2783"><a href="#test_mlp_then_nsa_joint_residual-2783"><span class="linenos">2783</span></a>        <span class="n">Y_pred_refined</span> <span class="o">=</span> <span class="n">nsa</span><span class="p">(</span><span class="n">mlp</span><span class="p">(</span><span class="n">X_test</span><span class="p">))</span>
</span><span id="test_mlp_then_nsa_joint_residual-2784"><a href="#test_mlp_then_nsa_joint_residual-2784"><span class="linenos">2784</span></a>        <span class="n">corr_nsa</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">Y_pred_refined</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">Y_test</span><span class="o">.</span><span class="n">flatten</span><span class="p">()]))[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual-2785"><a href="#test_mlp_then_nsa_joint_residual-2785"><span class="linenos">2785</span></a>        <span class="n">invorth_nsa</span> <span class="o">=</span> <span class="n">invariant_orthogonality_defect</span><span class="p">(</span><span class="n">Y_pred_refined</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual-2786"><a href="#test_mlp_then_nsa_joint_residual-2786"><span class="linenos">2786</span></a>
</span><span id="test_mlp_then_nsa_joint_residual-2787"><a href="#test_mlp_then_nsa_joint_residual-2787"><span class="linenos">2787</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">NSA refined correlation: </span><span class="si">{</span><span class="n">corr_nsa</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2788"><a href="#test_mlp_then_nsa_joint_residual-2788"><span class="linenos">2788</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NSA refined orth defect: </span><span class="si">{</span><span class="n">invorth_nsa</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2789"><a href="#test_mlp_then_nsa_joint_residual-2789"><span class="linenos">2789</span></a>
</span><span id="test_mlp_then_nsa_joint_residual-2790"><a href="#test_mlp_then_nsa_joint_residual-2790"><span class="linenos">2790</span></a>    <span class="c1"># ========================================================</span>
</span><span id="test_mlp_then_nsa_joint_residual-2791"><a href="#test_mlp_then_nsa_joint_residual-2791"><span class="linenos">2791</span></a>    <span class="c1"># 3 Joint fine-tuning (MLP + Residual NSA)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2792"><a href="#test_mlp_then_nsa_joint_residual-2792"><span class="linenos">2792</span></a>    <span class="c1"># ========================================================</span>
</span><span id="test_mlp_then_nsa_joint_residual-2793"><a href="#test_mlp_then_nsa_joint_residual-2793"><span class="linenos">2793</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Joint fine-tuning MLP + NSA (residual) ===&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2794"><a href="#test_mlp_then_nsa_joint_residual-2794"><span class="linenos">2794</span></a>    <span class="n">joint_model</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">mlp</span><span class="p">,</span> <span class="n">nsa</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2795"><a href="#test_mlp_then_nsa_joint_residual-2795"><span class="linenos">2795</span></a>    <span class="n">opt_joint</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="n">joint_model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr_joint</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2796"><a href="#test_mlp_then_nsa_joint_residual-2796"><span class="linenos">2796</span></a>    <span class="n">joint_losses</span><span class="p">,</span> <span class="n">joint_fids</span><span class="p">,</span> <span class="n">joint_orths</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="test_mlp_then_nsa_joint_residual-2797"><a href="#test_mlp_then_nsa_joint_residual-2797"><span class="linenos">2797</span></a>
</span><span id="test_mlp_then_nsa_joint_residual-2798"><a href="#test_mlp_then_nsa_joint_residual-2798"><span class="linenos">2798</span></a>    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">joint_epochs</span><span class="p">):</span>
</span><span id="test_mlp_then_nsa_joint_residual-2799"><a href="#test_mlp_then_nsa_joint_residual-2799"><span class="linenos">2799</span></a>        <span class="n">opt_joint</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual-2800"><a href="#test_mlp_then_nsa_joint_residual-2800"><span class="linenos">2800</span></a>        <span class="n">Y_joint</span> <span class="o">=</span> <span class="n">joint_model</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2801"><a href="#test_mlp_then_nsa_joint_residual-2801"><span class="linenos">2801</span></a>        <span class="n">fid</span> <span class="o">=</span> <span class="n">fidelity_scaled</span><span class="p">(</span><span class="n">Y_joint</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2802"><a href="#test_mlp_then_nsa_joint_residual-2802"><span class="linenos">2802</span></a>        <span class="n">orth</span> <span class="o">=</span> <span class="n">invariant_orthogonality_defect</span><span class="p">(</span><span class="n">Y_joint</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2803"><a href="#test_mlp_then_nsa_joint_residual-2803"><span class="linenos">2803</span></a>        <span class="n">loss</span> <span class="o">=</span> <span class="n">fid</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">w</span><span class="p">)</span> <span class="o">+</span> <span class="n">orth</span> <span class="o">*</span> <span class="n">w</span>
</span><span id="test_mlp_then_nsa_joint_residual-2804"><a href="#test_mlp_then_nsa_joint_residual-2804"><span class="linenos">2804</span></a>        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual-2805"><a href="#test_mlp_then_nsa_joint_residual-2805"><span class="linenos">2805</span></a>        <span class="n">opt_joint</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual-2806"><a href="#test_mlp_then_nsa_joint_residual-2806"><span class="linenos">2806</span></a>        <span class="n">joint_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
</span><span id="test_mlp_then_nsa_joint_residual-2807"><a href="#test_mlp_then_nsa_joint_residual-2807"><span class="linenos">2807</span></a>        <span class="n">joint_fids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fid</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
</span><span id="test_mlp_then_nsa_joint_residual-2808"><a href="#test_mlp_then_nsa_joint_residual-2808"><span class="linenos">2808</span></a>        <span class="n">joint_orths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orth</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
</span><span id="test_mlp_then_nsa_joint_residual-2809"><a href="#test_mlp_then_nsa_joint_residual-2809"><span class="linenos">2809</span></a>        <span class="k">if</span> <span class="n">epoch</span> <span class="o">%</span> <span class="mi">200</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">epoch</span> <span class="o">==</span> <span class="n">joint_epochs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="test_mlp_then_nsa_joint_residual-2810"><a href="#test_mlp_then_nsa_joint_residual-2810"><span class="linenos">2810</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Joint </span><span class="si">{</span><span class="n">epoch</span><span class="si">:</span><span class="s2">04d</span><span class="si">}</span><span class="s2">] loss=</span><span class="si">{</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2"> fid=</span><span class="si">{</span><span class="n">fid</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2"> orth=</span><span class="si">{</span><span class="n">orth</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2811"><a href="#test_mlp_then_nsa_joint_residual-2811"><span class="linenos">2811</span></a>
</span><span id="test_mlp_then_nsa_joint_residual-2812"><a href="#test_mlp_then_nsa_joint_residual-2812"><span class="linenos">2812</span></a>    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="test_mlp_then_nsa_joint_residual-2813"><a href="#test_mlp_then_nsa_joint_residual-2813"><span class="linenos">2813</span></a>        <span class="n">Y_pred_joint</span> <span class="o">=</span> <span class="n">joint_model</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2814"><a href="#test_mlp_then_nsa_joint_residual-2814"><span class="linenos">2814</span></a>        <span class="n">corr_joint</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">Y_pred_joint</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">Y_test</span><span class="o">.</span><span class="n">flatten</span><span class="p">()]))[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual-2815"><a href="#test_mlp_then_nsa_joint_residual-2815"><span class="linenos">2815</span></a>        <span class="n">invorth_joint</span> <span class="o">=</span> <span class="n">invariant_orthogonality_defect</span><span class="p">(</span><span class="n">Y_pred_joint</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual-2816"><a href="#test_mlp_then_nsa_joint_residual-2816"><span class="linenos">2816</span></a>
</span><span id="test_mlp_then_nsa_joint_residual-2817"><a href="#test_mlp_then_nsa_joint_residual-2817"><span class="linenos">2817</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Final joint correlation: </span><span class="si">{</span><span class="n">corr_joint</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2818"><a href="#test_mlp_then_nsa_joint_residual-2818"><span class="linenos">2818</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final joint orth defect: </span><span class="si">{</span><span class="n">invorth_joint</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2819"><a href="#test_mlp_then_nsa_joint_residual-2819"><span class="linenos">2819</span></a>
</span><span id="test_mlp_then_nsa_joint_residual-2820"><a href="#test_mlp_then_nsa_joint_residual-2820"><span class="linenos">2820</span></a>    <span class="c1"># ========================================================</span>
</span><span id="test_mlp_then_nsa_joint_residual-2821"><a href="#test_mlp_then_nsa_joint_residual-2821"><span class="linenos">2821</span></a>    <span class="c1">#  Diagnostics &amp; Visuals</span>
</span><span id="test_mlp_then_nsa_joint_residual-2822"><a href="#test_mlp_then_nsa_joint_residual-2822"><span class="linenos">2822</span></a>    <span class="c1"># ========================================================</span>
</span><span id="test_mlp_then_nsa_joint_residual-2823"><a href="#test_mlp_then_nsa_joint_residual-2823"><span class="linenos">2823</span></a>    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
</span><span id="test_mlp_then_nsa_joint_residual-2824"><a href="#test_mlp_then_nsa_joint_residual-2824"><span class="linenos">2824</span></a>
</span><span id="test_mlp_then_nsa_joint_residual-2825"><a href="#test_mlp_then_nsa_joint_residual-2825"><span class="linenos">2825</span></a>    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mlp_losses</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2826"><a href="#test_mlp_then_nsa_joint_residual-2826"><span class="linenos">2826</span></a>    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;MLP loss&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2827"><a href="#test_mlp_then_nsa_joint_residual-2827"><span class="linenos">2827</span></a>
</span><span id="test_mlp_then_nsa_joint_residual-2828"><a href="#test_mlp_then_nsa_joint_residual-2828"><span class="linenos">2828</span></a>    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">nsa_losses</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Total&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2829"><a href="#test_mlp_then_nsa_joint_residual-2829"><span class="linenos">2829</span></a>    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">nsa_fids</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Fid&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2830"><a href="#test_mlp_then_nsa_joint_residual-2830"><span class="linenos">2830</span></a>    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">nsa_orths</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Orth&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2831"><a href="#test_mlp_then_nsa_joint_residual-2831"><span class="linenos">2831</span></a>    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual-2832"><a href="#test_mlp_then_nsa_joint_residual-2832"><span class="linenos">2832</span></a>    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NSA refinement (</span><span class="si">{</span><span class="n">apply_nonneg</span><span class="si">}</span><span class="s2">, residual)&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2833"><a href="#test_mlp_then_nsa_joint_residual-2833"><span class="linenos">2833</span></a>
</span><span id="test_mlp_then_nsa_joint_residual-2834"><a href="#test_mlp_then_nsa_joint_residual-2834"><span class="linenos">2834</span></a>    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">joint_losses</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Total&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2835"><a href="#test_mlp_then_nsa_joint_residual-2835"><span class="linenos">2835</span></a>    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">joint_fids</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Fid&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2836"><a href="#test_mlp_then_nsa_joint_residual-2836"><span class="linenos">2836</span></a>    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">joint_orths</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Orth&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2837"><a href="#test_mlp_then_nsa_joint_residual-2837"><span class="linenos">2837</span></a>    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual-2838"><a href="#test_mlp_then_nsa_joint_residual-2838"><span class="linenos">2838</span></a>    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Joint fine-tuning&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2839"><a href="#test_mlp_then_nsa_joint_residual-2839"><span class="linenos">2839</span></a>
</span><span id="test_mlp_then_nsa_joint_residual-2840"><a href="#test_mlp_then_nsa_joint_residual-2840"><span class="linenos">2840</span></a>    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">Y_test</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">Y_pred_mlp</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;MLP r=</span><span class="si">{</span><span class="n">corr_mlp</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2841"><a href="#test_mlp_then_nsa_joint_residual-2841"><span class="linenos">2841</span></a>    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">Y_test</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">Y_pred_refined</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;MLP+NSA r=</span><span class="si">{</span><span class="n">corr_nsa</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2842"><a href="#test_mlp_then_nsa_joint_residual-2842"><span class="linenos">2842</span></a>    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">Y_test</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">Y_pred_joint</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Joint r=</span><span class="si">{</span><span class="n">corr_joint</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2843"><a href="#test_mlp_then_nsa_joint_residual-2843"><span class="linenos">2843</span></a>    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Predicted vs True Y (Test)&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2844"><a href="#test_mlp_then_nsa_joint_residual-2844"><span class="linenos">2844</span></a>    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual-2845"><a href="#test_mlp_then_nsa_joint_residual-2845"><span class="linenos">2845</span></a>
</span><span id="test_mlp_then_nsa_joint_residual-2846"><a href="#test_mlp_then_nsa_joint_residual-2846"><span class="linenos">2846</span></a>    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">Y_pred_joint</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">bins</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2847"><a href="#test_mlp_then_nsa_joint_residual-2847"><span class="linenos">2847</span></a>    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Output distribution (apply_nonneg=</span><span class="si">{</span><span class="n">apply_nonneg</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2848"><a href="#test_mlp_then_nsa_joint_residual-2848"><span class="linenos">2848</span></a>
</span><span id="test_mlp_then_nsa_joint_residual-2849"><a href="#test_mlp_then_nsa_joint_residual-2849"><span class="linenos">2849</span></a>    <span class="n">corrmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">Y_pred_joint</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2850"><a href="#test_mlp_then_nsa_joint_residual-2850"><span class="linenos">2850</span></a>    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">corrmat</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;coolwarm&quot;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2851"><a href="#test_mlp_then_nsa_joint_residual-2851"><span class="linenos">2851</span></a>    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Column correlation heatmap (Joint)&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2852"><a href="#test_mlp_then_nsa_joint_residual-2852"><span class="linenos">2852</span></a>
</span><span id="test_mlp_then_nsa_joint_residual-2853"><a href="#test_mlp_then_nsa_joint_residual-2853"><span class="linenos">2853</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual-2854"><a href="#test_mlp_then_nsa_joint_residual-2854"><span class="linenos">2854</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual-2855"><a href="#test_mlp_then_nsa_joint_residual-2855"><span class="linenos">2855</span></a>    <span class="nb">print</span><span class="p">(</span> <span class="nb">str</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">Y_pred_joint</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span> <span class="p">)</span> <span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual-2856"><a href="#test_mlp_then_nsa_joint_residual-2856"><span class="linenos">2856</span></a>    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
</span><span id="test_mlp_then_nsa_joint_residual-2857"><a href="#test_mlp_then_nsa_joint_residual-2857"><span class="linenos">2857</span></a>        <span class="n">corr_mlp</span><span class="o">=</span><span class="n">corr_mlp</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual-2858"><a href="#test_mlp_then_nsa_joint_residual-2858"><span class="linenos">2858</span></a>        <span class="n">corr_nsa</span><span class="o">=</span><span class="n">corr_nsa</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual-2859"><a href="#test_mlp_then_nsa_joint_residual-2859"><span class="linenos">2859</span></a>        <span class="n">corr_joint</span><span class="o">=</span><span class="n">corr_joint</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual-2860"><a href="#test_mlp_then_nsa_joint_residual-2860"><span class="linenos">2860</span></a>        <span class="n">invorth_mlp</span><span class="o">=</span><span class="n">invorth_mlp</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual-2861"><a href="#test_mlp_then_nsa_joint_residual-2861"><span class="linenos">2861</span></a>        <span class="n">invorth_nsa</span><span class="o">=</span><span class="n">invorth_nsa</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual-2862"><a href="#test_mlp_then_nsa_joint_residual-2862"><span class="linenos">2862</span></a>        <span class="n">invorth_joint</span><span class="o">=</span><span class="n">invorth_joint</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual-2863"><a href="#test_mlp_then_nsa_joint_residual-2863"><span class="linenos">2863</span></a>        <span class="n">apply_nonneg</span><span class="o">=</span><span class="n">apply_nonneg</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual-2864"><a href="#test_mlp_then_nsa_joint_residual-2864"><span class="linenos">2864</span></a>        <span class="n">Y_pred_joint</span><span class="o">=</span><span class="n">Y_pred_joint</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual-2865"><a href="#test_mlp_then_nsa_joint_residual-2865"><span class="linenos">2865</span></a>    <span class="p">)</span>
</span></pre></div>


    

                </section>
                <section id="test_mlp_then_nsa_joint_residual_pca">
                            <input id="test_mlp_then_nsa_joint_residual_pca-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">test_mlp_then_nsa_joint_residual_pca</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">seed</span><span class="o">=</span><span class="mi">0</span>,</span><span class="param">	<span class="n">w</span><span class="o">=</span><span class="mf">0.5</span>,</span><span class="param">	<span class="n">n</span><span class="o">=</span><span class="mi">200</span>,</span><span class="param">	<span class="n">p</span><span class="o">=</span><span class="mi">8</span>,</span><span class="param">	<span class="n">k</span><span class="o">=</span><span class="mi">6</span>,</span><span class="param">	<span class="n">hidden</span><span class="o">=</span><span class="mi">128</span>,</span><span class="param">	<span class="n">noise</span><span class="o">=</span><span class="mf">0.1</span>,</span><span class="param">	<span class="n">mlp_epochs</span><span class="o">=</span><span class="mi">2000</span>,</span><span class="param">	<span class="n">nsa_epochs</span><span class="o">=</span><span class="mi">1500</span>,</span><span class="param">	<span class="n">joint_epochs</span><span class="o">=</span><span class="mi">1500</span>,</span><span class="param">	<span class="n">lr_mlp</span><span class="o">=</span><span class="mf">0.001</span>,</span><span class="param">	<span class="n">lr_nsa</span><span class="o">=</span><span class="mf">0.001</span>,</span><span class="param">	<span class="n">lr_joint</span><span class="o">=</span><span class="mf">0.0005</span>,</span><span class="param">	<span class="n">apply_nonneg</span><span class="o">=</span><span class="s1">&#39;hard&#39;</span>,</span><span class="param">	<span class="n">residual</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">pca_components</span><span class="o">=</span><span class="mi">6</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="test_mlp_then_nsa_joint_residual_pca-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#test_mlp_then_nsa_joint_residual_pca"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="test_mlp_then_nsa_joint_residual_pca-3181"><a href="#test_mlp_then_nsa_joint_residual_pca-3181"><span class="linenos">3181</span></a><span class="k">def</span><span class="w"> </span><span class="nf">test_mlp_then_nsa_joint_residual_pca</span><span class="p">(</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3182"><a href="#test_mlp_then_nsa_joint_residual_pca-3182"><span class="linenos">3182</span></a>    <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3183"><a href="#test_mlp_then_nsa_joint_residual_pca-3183"><span class="linenos">3183</span></a>    <span class="n">w</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3184"><a href="#test_mlp_then_nsa_joint_residual_pca-3184"><span class="linenos">3184</span></a>    <span class="n">n</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3185"><a href="#test_mlp_then_nsa_joint_residual_pca-3185"><span class="linenos">3185</span></a>    <span class="n">p</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3186"><a href="#test_mlp_then_nsa_joint_residual_pca-3186"><span class="linenos">3186</span></a>    <span class="n">k</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3187"><a href="#test_mlp_then_nsa_joint_residual_pca-3187"><span class="linenos">3187</span></a>    <span class="n">hidden</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3188"><a href="#test_mlp_then_nsa_joint_residual_pca-3188"><span class="linenos">3188</span></a>    <span class="n">noise</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3189"><a href="#test_mlp_then_nsa_joint_residual_pca-3189"><span class="linenos">3189</span></a>    <span class="n">mlp_epochs</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3190"><a href="#test_mlp_then_nsa_joint_residual_pca-3190"><span class="linenos">3190</span></a>    <span class="n">nsa_epochs</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3191"><a href="#test_mlp_then_nsa_joint_residual_pca-3191"><span class="linenos">3191</span></a>    <span class="n">joint_epochs</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3192"><a href="#test_mlp_then_nsa_joint_residual_pca-3192"><span class="linenos">3192</span></a>    <span class="n">lr_mlp</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3193"><a href="#test_mlp_then_nsa_joint_residual_pca-3193"><span class="linenos">3193</span></a>    <span class="n">lr_nsa</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3194"><a href="#test_mlp_then_nsa_joint_residual_pca-3194"><span class="linenos">3194</span></a>    <span class="n">lr_joint</span><span class="o">=</span><span class="mf">5e-4</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3195"><a href="#test_mlp_then_nsa_joint_residual_pca-3195"><span class="linenos">3195</span></a>    <span class="n">apply_nonneg</span><span class="o">=</span><span class="s2">&quot;hard&quot;</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3196"><a href="#test_mlp_then_nsa_joint_residual_pca-3196"><span class="linenos">3196</span></a>    <span class="n">residual</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3197"><a href="#test_mlp_then_nsa_joint_residual_pca-3197"><span class="linenos">3197</span></a>    <span class="n">pca_components</span><span class="o">=</span><span class="mi">6</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3198"><a href="#test_mlp_then_nsa_joint_residual_pca-3198"><span class="linenos">3198</span></a><span class="p">):</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3199"><a href="#test_mlp_then_nsa_joint_residual_pca-3199"><span class="linenos">3199</span></a>    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3200"><a href="#test_mlp_then_nsa_joint_residual_pca-3200"><span class="linenos">3200</span></a>    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3201"><a href="#test_mlp_then_nsa_joint_residual_pca-3201"><span class="linenos">3201</span></a>    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3202"><a href="#test_mlp_then_nsa_joint_residual_pca-3202"><span class="linenos">3202</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3203"><a href="#test_mlp_then_nsa_joint_residual_pca-3203"><span class="linenos">3203</span></a>    <span class="c1"># === Synthetic nonlinear data ===</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3204"><a href="#test_mlp_then_nsa_joint_residual_pca-3204"><span class="linenos">3204</span></a>    <span class="n">W_true</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3205"><a href="#test_mlp_then_nsa_joint_residual_pca-3205"><span class="linenos">3205</span></a>    <span class="n">X</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3206"><a href="#test_mlp_then_nsa_joint_residual_pca-3206"><span class="linenos">3206</span></a>    <span class="n">Y_true</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softplus</span><span class="p">(</span><span class="n">X</span> <span class="o">@</span> <span class="n">W_true</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3207"><a href="#test_mlp_then_nsa_joint_residual_pca-3207"><span class="linenos">3207</span></a>    <span class="n">Y_obs</span> <span class="o">=</span> <span class="n">Y_true</span> <span class="o">+</span> <span class="n">noise</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">Y_true</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3208"><a href="#test_mlp_then_nsa_joint_residual_pca-3208"><span class="linenos">3208</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3209"><a href="#test_mlp_then_nsa_joint_residual_pca-3209"><span class="linenos">3209</span></a>    <span class="n">n_train</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.8</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3210"><a href="#test_mlp_then_nsa_joint_residual_pca-3210"><span class="linenos">3210</span></a>    <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:</span><span class="n">n_train</span><span class="p">],</span> <span class="n">X</span><span class="p">[</span><span class="n">n_train</span><span class="p">:]</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3211"><a href="#test_mlp_then_nsa_joint_residual_pca-3211"><span class="linenos">3211</span></a>    <span class="n">Y_train</span><span class="p">,</span> <span class="n">Y_test</span> <span class="o">=</span> <span class="n">Y_obs</span><span class="p">[:</span><span class="n">n_train</span><span class="p">],</span> <span class="n">Y_obs</span><span class="p">[</span><span class="n">n_train</span><span class="p">:]</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3212"><a href="#test_mlp_then_nsa_joint_residual_pca-3212"><span class="linenos">3212</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3213"><a href="#test_mlp_then_nsa_joint_residual_pca-3213"><span class="linenos">3213</span></a>    <span class="c1"># =======================================</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3214"><a href="#test_mlp_then_nsa_joint_residual_pca-3214"><span class="linenos">3214</span></a>    <span class="c1"># 0 PCA Regression Baseline</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3215"><a href="#test_mlp_then_nsa_joint_residual_pca-3215"><span class="linenos">3215</span></a>    <span class="c1"># =======================================</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3216"><a href="#test_mlp_then_nsa_joint_residual_pca-3216"><span class="linenos">3216</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== PCA Regression Baseline ===&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3217"><a href="#test_mlp_then_nsa_joint_residual_pca-3217"><span class="linenos">3217</span></a>    <span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="n">pca_components</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3218"><a href="#test_mlp_then_nsa_joint_residual_pca-3218"><span class="linenos">3218</span></a>    <span class="n">X_train_np</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3219"><a href="#test_mlp_then_nsa_joint_residual_pca-3219"><span class="linenos">3219</span></a>    <span class="n">Y_train_np</span> <span class="o">=</span> <span class="n">Y_train</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3220"><a href="#test_mlp_then_nsa_joint_residual_pca-3220"><span class="linenos">3220</span></a>    <span class="n">X_test_np</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3221"><a href="#test_mlp_then_nsa_joint_residual_pca-3221"><span class="linenos">3221</span></a>    <span class="n">Y_test_np</span> <span class="o">=</span> <span class="n">Y_test</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3222"><a href="#test_mlp_then_nsa_joint_residual_pca-3222"><span class="linenos">3222</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3223"><a href="#test_mlp_then_nsa_joint_residual_pca-3223"><span class="linenos">3223</span></a>    <span class="n">X_train_pca</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train_np</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3224"><a href="#test_mlp_then_nsa_joint_residual_pca-3224"><span class="linenos">3224</span></a>    <span class="n">X_test_pca</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test_np</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3225"><a href="#test_mlp_then_nsa_joint_residual_pca-3225"><span class="linenos">3225</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3226"><a href="#test_mlp_then_nsa_joint_residual_pca-3226"><span class="linenos">3226</span></a>    <span class="n">reg</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3227"><a href="#test_mlp_then_nsa_joint_residual_pca-3227"><span class="linenos">3227</span></a>    <span class="n">reg</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_pca</span><span class="p">,</span> <span class="n">Y_train_np</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3228"><a href="#test_mlp_then_nsa_joint_residual_pca-3228"><span class="linenos">3228</span></a>    <span class="n">Y_pred_pca</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">reg</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_pca</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3229"><a href="#test_mlp_then_nsa_joint_residual_pca-3229"><span class="linenos">3229</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3230"><a href="#test_mlp_then_nsa_joint_residual_pca-3230"><span class="linenos">3230</span></a>    <span class="n">corr_pca</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">Y_pred_pca</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">Y_test</span><span class="o">.</span><span class="n">flatten</span><span class="p">()]))[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3231"><a href="#test_mlp_then_nsa_joint_residual_pca-3231"><span class="linenos">3231</span></a>    <span class="n">invorth_pca</span> <span class="o">=</span> <span class="n">invariant_orthogonality_defect</span><span class="p">(</span><span class="n">Y_pred_pca</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3232"><a href="#test_mlp_then_nsa_joint_residual_pca-3232"><span class="linenos">3232</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3233"><a href="#test_mlp_then_nsa_joint_residual_pca-3233"><span class="linenos">3233</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PCA correlation: </span><span class="si">{</span><span class="n">corr_pca</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3234"><a href="#test_mlp_then_nsa_joint_residual_pca-3234"><span class="linenos">3234</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PCA orth defect: </span><span class="si">{</span><span class="n">invorth_pca</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3235"><a href="#test_mlp_then_nsa_joint_residual_pca-3235"><span class="linenos">3235</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3236"><a href="#test_mlp_then_nsa_joint_residual_pca-3236"><span class="linenos">3236</span></a>    <span class="c1"># =======================================</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3237"><a href="#test_mlp_then_nsa_joint_residual_pca-3237"><span class="linenos">3237</span></a>    <span class="c1"># 1 MLP Baseline</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3238"><a href="#test_mlp_then_nsa_joint_residual_pca-3238"><span class="linenos">3238</span></a>    <span class="c1"># =======================================</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3239"><a href="#test_mlp_then_nsa_joint_residual_pca-3239"><span class="linenos">3239</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Training MLP ===&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3240"><a href="#test_mlp_then_nsa_joint_residual_pca-3240"><span class="linenos">3240</span></a>    <span class="n">mlp</span> <span class="o">=</span> <span class="n">SimpleMLP</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">hidden</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3241"><a href="#test_mlp_then_nsa_joint_residual_pca-3241"><span class="linenos">3241</span></a>    <span class="n">opt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="n">mlp</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr_mlp</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3242"><a href="#test_mlp_then_nsa_joint_residual_pca-3242"><span class="linenos">3242</span></a>    <span class="n">mlp_losses</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3243"><a href="#test_mlp_then_nsa_joint_residual_pca-3243"><span class="linenos">3243</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3244"><a href="#test_mlp_then_nsa_joint_residual_pca-3244"><span class="linenos">3244</span></a>    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mlp_epochs</span><span class="p">):</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3245"><a href="#test_mlp_then_nsa_joint_residual_pca-3245"><span class="linenos">3245</span></a>        <span class="n">opt</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3246"><a href="#test_mlp_then_nsa_joint_residual_pca-3246"><span class="linenos">3246</span></a>        <span class="n">Y_pred</span> <span class="o">=</span> <span class="n">mlp</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3247"><a href="#test_mlp_then_nsa_joint_residual_pca-3247"><span class="linenos">3247</span></a>        <span class="n">loss</span> <span class="o">=</span> <span class="n">fidelity_scaled</span><span class="p">(</span><span class="n">Y_pred</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3248"><a href="#test_mlp_then_nsa_joint_residual_pca-3248"><span class="linenos">3248</span></a>        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3249"><a href="#test_mlp_then_nsa_joint_residual_pca-3249"><span class="linenos">3249</span></a>        <span class="n">opt</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3250"><a href="#test_mlp_then_nsa_joint_residual_pca-3250"><span class="linenos">3250</span></a>        <span class="n">mlp_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3251"><a href="#test_mlp_then_nsa_joint_residual_pca-3251"><span class="linenos">3251</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3252"><a href="#test_mlp_then_nsa_joint_residual_pca-3252"><span class="linenos">3252</span></a>    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3253"><a href="#test_mlp_then_nsa_joint_residual_pca-3253"><span class="linenos">3253</span></a>        <span class="n">Y_pred_mlp</span> <span class="o">=</span> <span class="n">mlp</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3254"><a href="#test_mlp_then_nsa_joint_residual_pca-3254"><span class="linenos">3254</span></a>        <span class="n">corr_mlp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">Y_pred_mlp</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">Y_test</span><span class="o">.</span><span class="n">flatten</span><span class="p">()]))[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3255"><a href="#test_mlp_then_nsa_joint_residual_pca-3255"><span class="linenos">3255</span></a>        <span class="n">invorth_mlp</span> <span class="o">=</span> <span class="n">invariant_orthogonality_defect</span><span class="p">(</span><span class="n">Y_pred_mlp</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3256"><a href="#test_mlp_then_nsa_joint_residual_pca-3256"><span class="linenos">3256</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3257"><a href="#test_mlp_then_nsa_joint_residual_pca-3257"><span class="linenos">3257</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MLP correlation: </span><span class="si">{</span><span class="n">corr_mlp</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3258"><a href="#test_mlp_then_nsa_joint_residual_pca-3258"><span class="linenos">3258</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MLP orth defect: </span><span class="si">{</span><span class="n">invorth_mlp</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3259"><a href="#test_mlp_then_nsa_joint_residual_pca-3259"><span class="linenos">3259</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3260"><a href="#test_mlp_then_nsa_joint_residual_pca-3260"><span class="linenos">3260</span></a>    <span class="c1"># =======================================</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3261"><a href="#test_mlp_then_nsa_joint_residual_pca-3261"><span class="linenos">3261</span></a>    <span class="c1"># 2 NSA refinement</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3262"><a href="#test_mlp_then_nsa_joint_residual_pca-3262"><span class="linenos">3262</span></a>    <span class="c1"># =======================================</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3263"><a href="#test_mlp_then_nsa_joint_residual_pca-3263"><span class="linenos">3263</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== NSA refinement (apply_nonneg=&#39;</span><span class="si">{</span><span class="n">apply_nonneg</span><span class="si">}</span><span class="s2">&#39;) ===&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3264"><a href="#test_mlp_then_nsa_joint_residual_pca-3264"><span class="linenos">3264</span></a>    <span class="n">nsa</span> <span class="o">=</span> <span class="n">NSAFlowLayer</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">w_retract</span><span class="o">=</span><span class="n">w</span><span class="p">,</span> <span class="n">apply_nonneg</span><span class="o">=</span><span class="n">apply_nonneg</span><span class="p">,</span> <span class="n">residual</span><span class="o">=</span><span class="n">residual</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3265"><a href="#test_mlp_then_nsa_joint_residual_pca-3265"><span class="linenos">3265</span></a>    <span class="n">opt_nsa</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="n">nsa</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr_nsa</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3266"><a href="#test_mlp_then_nsa_joint_residual_pca-3266"><span class="linenos">3266</span></a>    <span class="n">nsa_losses</span><span class="p">,</span> <span class="n">nsa_fids</span><span class="p">,</span> <span class="n">nsa_orths</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3267"><a href="#test_mlp_then_nsa_joint_residual_pca-3267"><span class="linenos">3267</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3268"><a href="#test_mlp_then_nsa_joint_residual_pca-3268"><span class="linenos">3268</span></a>    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3269"><a href="#test_mlp_then_nsa_joint_residual_pca-3269"><span class="linenos">3269</span></a>        <span class="n">Y0</span> <span class="o">=</span> <span class="n">mlp</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3270"><a href="#test_mlp_then_nsa_joint_residual_pca-3270"><span class="linenos">3270</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3271"><a href="#test_mlp_then_nsa_joint_residual_pca-3271"><span class="linenos">3271</span></a>    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsa_epochs</span><span class="p">):</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3272"><a href="#test_mlp_then_nsa_joint_residual_pca-3272"><span class="linenos">3272</span></a>        <span class="n">opt_nsa</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3273"><a href="#test_mlp_then_nsa_joint_residual_pca-3273"><span class="linenos">3273</span></a>        <span class="n">Y_ref</span> <span class="o">=</span> <span class="n">nsa</span><span class="p">(</span><span class="n">Y0</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3274"><a href="#test_mlp_then_nsa_joint_residual_pca-3274"><span class="linenos">3274</span></a>        <span class="n">fid</span> <span class="o">=</span> <span class="n">fidelity_scaled</span><span class="p">(</span><span class="n">Y_ref</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3275"><a href="#test_mlp_then_nsa_joint_residual_pca-3275"><span class="linenos">3275</span></a>        <span class="n">orth</span> <span class="o">=</span> <span class="n">invariant_orthogonality_defect</span><span class="p">(</span><span class="n">Y_ref</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3276"><a href="#test_mlp_then_nsa_joint_residual_pca-3276"><span class="linenos">3276</span></a>        <span class="n">loss</span> <span class="o">=</span> <span class="n">fid</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">orth</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3277"><a href="#test_mlp_then_nsa_joint_residual_pca-3277"><span class="linenos">3277</span></a>        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3278"><a href="#test_mlp_then_nsa_joint_residual_pca-3278"><span class="linenos">3278</span></a>        <span class="n">opt_nsa</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3279"><a href="#test_mlp_then_nsa_joint_residual_pca-3279"><span class="linenos">3279</span></a>        <span class="n">nsa_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3280"><a href="#test_mlp_then_nsa_joint_residual_pca-3280"><span class="linenos">3280</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3281"><a href="#test_mlp_then_nsa_joint_residual_pca-3281"><span class="linenos">3281</span></a>    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3282"><a href="#test_mlp_then_nsa_joint_residual_pca-3282"><span class="linenos">3282</span></a>        <span class="n">Y_pred_refined</span> <span class="o">=</span> <span class="n">nsa</span><span class="p">(</span><span class="n">mlp</span><span class="p">(</span><span class="n">X_test</span><span class="p">))</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3283"><a href="#test_mlp_then_nsa_joint_residual_pca-3283"><span class="linenos">3283</span></a>        <span class="n">corr_nsa</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">Y_pred_refined</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">Y_test</span><span class="o">.</span><span class="n">flatten</span><span class="p">()]))[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3284"><a href="#test_mlp_then_nsa_joint_residual_pca-3284"><span class="linenos">3284</span></a>        <span class="n">invorth_nsa</span> <span class="o">=</span> <span class="n">invariant_orthogonality_defect</span><span class="p">(</span><span class="n">Y_pred_refined</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3285"><a href="#test_mlp_then_nsa_joint_residual_pca-3285"><span class="linenos">3285</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3286"><a href="#test_mlp_then_nsa_joint_residual_pca-3286"><span class="linenos">3286</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">NSA refined correlation: </span><span class="si">{</span><span class="n">corr_nsa</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3287"><a href="#test_mlp_then_nsa_joint_residual_pca-3287"><span class="linenos">3287</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NSA refined orth defect: </span><span class="si">{</span><span class="n">invorth_nsa</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3288"><a href="#test_mlp_then_nsa_joint_residual_pca-3288"><span class="linenos">3288</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3289"><a href="#test_mlp_then_nsa_joint_residual_pca-3289"><span class="linenos">3289</span></a>    <span class="c1"># =======================================</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3290"><a href="#test_mlp_then_nsa_joint_residual_pca-3290"><span class="linenos">3290</span></a>    <span class="c1"># 3 Joint Fine-Tuning</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3291"><a href="#test_mlp_then_nsa_joint_residual_pca-3291"><span class="linenos">3291</span></a>    <span class="c1"># =======================================</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3292"><a href="#test_mlp_then_nsa_joint_residual_pca-3292"><span class="linenos">3292</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Joint fine-tuning MLP + NSA ===&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3293"><a href="#test_mlp_then_nsa_joint_residual_pca-3293"><span class="linenos">3293</span></a>    <span class="n">joint_model</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">mlp</span><span class="p">,</span> <span class="n">nsa</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3294"><a href="#test_mlp_then_nsa_joint_residual_pca-3294"><span class="linenos">3294</span></a>    <span class="n">opt_joint</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="n">joint_model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr_joint</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3295"><a href="#test_mlp_then_nsa_joint_residual_pca-3295"><span class="linenos">3295</span></a>    <span class="n">joint_losses</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3296"><a href="#test_mlp_then_nsa_joint_residual_pca-3296"><span class="linenos">3296</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3297"><a href="#test_mlp_then_nsa_joint_residual_pca-3297"><span class="linenos">3297</span></a>    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">joint_epochs</span><span class="p">):</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3298"><a href="#test_mlp_then_nsa_joint_residual_pca-3298"><span class="linenos">3298</span></a>        <span class="n">opt_joint</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3299"><a href="#test_mlp_then_nsa_joint_residual_pca-3299"><span class="linenos">3299</span></a>        <span class="n">Y_joint</span> <span class="o">=</span> <span class="n">joint_model</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3300"><a href="#test_mlp_then_nsa_joint_residual_pca-3300"><span class="linenos">3300</span></a>        <span class="n">fid</span> <span class="o">=</span> <span class="n">fidelity_scaled</span><span class="p">(</span><span class="n">Y_joint</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3301"><a href="#test_mlp_then_nsa_joint_residual_pca-3301"><span class="linenos">3301</span></a>        <span class="n">orth</span> <span class="o">=</span> <span class="n">invariant_orthogonality_defect</span><span class="p">(</span><span class="n">Y_joint</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3302"><a href="#test_mlp_then_nsa_joint_residual_pca-3302"><span class="linenos">3302</span></a>        <span class="n">loss</span> <span class="o">=</span> <span class="n">fid</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">w</span><span class="p">)</span> <span class="o">+</span> <span class="n">orth</span> <span class="o">*</span> <span class="n">w</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3303"><a href="#test_mlp_then_nsa_joint_residual_pca-3303"><span class="linenos">3303</span></a>        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3304"><a href="#test_mlp_then_nsa_joint_residual_pca-3304"><span class="linenos">3304</span></a>        <span class="n">opt_joint</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3305"><a href="#test_mlp_then_nsa_joint_residual_pca-3305"><span class="linenos">3305</span></a>        <span class="n">joint_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3306"><a href="#test_mlp_then_nsa_joint_residual_pca-3306"><span class="linenos">3306</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3307"><a href="#test_mlp_then_nsa_joint_residual_pca-3307"><span class="linenos">3307</span></a>    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3308"><a href="#test_mlp_then_nsa_joint_residual_pca-3308"><span class="linenos">3308</span></a>        <span class="n">Y_pred_joint</span> <span class="o">=</span> <span class="n">joint_model</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3309"><a href="#test_mlp_then_nsa_joint_residual_pca-3309"><span class="linenos">3309</span></a>        <span class="n">corr_joint</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">Y_pred_joint</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">Y_test</span><span class="o">.</span><span class="n">flatten</span><span class="p">()]))[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3310"><a href="#test_mlp_then_nsa_joint_residual_pca-3310"><span class="linenos">3310</span></a>        <span class="n">invorth_joint</span> <span class="o">=</span> <span class="n">invariant_orthogonality_defect</span><span class="p">(</span><span class="n">Y_pred_joint</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3311"><a href="#test_mlp_then_nsa_joint_residual_pca-3311"><span class="linenos">3311</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3312"><a href="#test_mlp_then_nsa_joint_residual_pca-3312"><span class="linenos">3312</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Final joint correlation: </span><span class="si">{</span><span class="n">corr_joint</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3313"><a href="#test_mlp_then_nsa_joint_residual_pca-3313"><span class="linenos">3313</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final joint orth defect: </span><span class="si">{</span><span class="n">invorth_joint</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3314"><a href="#test_mlp_then_nsa_joint_residual_pca-3314"><span class="linenos">3314</span></a>    <span class="c1"># =======================================</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3315"><a href="#test_mlp_then_nsa_joint_residual_pca-3315"><span class="linenos">3315</span></a>    <span class="c1">#  Visualization and comparison</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3316"><a href="#test_mlp_then_nsa_joint_residual_pca-3316"><span class="linenos">3316</span></a>    <span class="c1"># =======================================</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3317"><a href="#test_mlp_then_nsa_joint_residual_pca-3317"><span class="linenos">3317</span></a>    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3318"><a href="#test_mlp_then_nsa_joint_residual_pca-3318"><span class="linenos">3318</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3319"><a href="#test_mlp_then_nsa_joint_residual_pca-3319"><span class="linenos">3319</span></a>    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">([</span><span class="s2">&quot;PCA&quot;</span><span class="p">,</span><span class="s2">&quot;MLP&quot;</span><span class="p">,</span><span class="s2">&quot;MLP+NSA&quot;</span><span class="p">,</span><span class="s2">&quot;Joint&quot;</span><span class="p">],</span> <span class="p">[</span><span class="n">corr_pca</span><span class="p">,</span> <span class="n">corr_mlp</span><span class="p">,</span> <span class="n">corr_nsa</span><span class="p">,</span> <span class="n">corr_joint</span><span class="p">])</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3320"><a href="#test_mlp_then_nsa_joint_residual_pca-3320"><span class="linenos">3320</span></a>    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Test Correlation with True Y&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3321"><a href="#test_mlp_then_nsa_joint_residual_pca-3321"><span class="linenos">3321</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3322"><a href="#test_mlp_then_nsa_joint_residual_pca-3322"><span class="linenos">3322</span></a>    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">([</span><span class="s2">&quot;PCA&quot;</span><span class="p">,</span><span class="s2">&quot;MLP&quot;</span><span class="p">,</span><span class="s2">&quot;MLP+NSA&quot;</span><span class="p">,</span><span class="s2">&quot;Joint&quot;</span><span class="p">],</span> <span class="p">[</span><span class="n">invorth_pca</span><span class="p">,</span> <span class="n">invorth_mlp</span><span class="p">,</span> <span class="n">invorth_nsa</span><span class="p">,</span> <span class="n">invorth_joint</span><span class="p">])</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3323"><a href="#test_mlp_then_nsa_joint_residual_pca-3323"><span class="linenos">3323</span></a>    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Orthogonality Defect (Lower = Better)&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3324"><a href="#test_mlp_then_nsa_joint_residual_pca-3324"><span class="linenos">3324</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3325"><a href="#test_mlp_then_nsa_joint_residual_pca-3325"><span class="linenos">3325</span></a>    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">joint_losses</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3326"><a href="#test_mlp_then_nsa_joint_residual_pca-3326"><span class="linenos">3326</span></a>    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Joint Training Loss&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3327"><a href="#test_mlp_then_nsa_joint_residual_pca-3327"><span class="linenos">3327</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3328"><a href="#test_mlp_then_nsa_joint_residual_pca-3328"><span class="linenos">3328</span></a>    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">Y_test</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">Y_pred_pca</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;PCA r=</span><span class="si">{</span><span class="n">corr_pca</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3329"><a href="#test_mlp_then_nsa_joint_residual_pca-3329"><span class="linenos">3329</span></a>    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">Y_test</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">Y_pred_mlp</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;MLP r=</span><span class="si">{</span><span class="n">corr_mlp</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3330"><a href="#test_mlp_then_nsa_joint_residual_pca-3330"><span class="linenos">3330</span></a>    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">Y_test</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">Y_pred_joint</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Joint r=</span><span class="si">{</span><span class="n">corr_joint</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3331"><a href="#test_mlp_then_nsa_joint_residual_pca-3331"><span class="linenos">3331</span></a>    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3332"><a href="#test_mlp_then_nsa_joint_residual_pca-3332"><span class="linenos">3332</span></a>    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Predicted vs True Y&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3333"><a href="#test_mlp_then_nsa_joint_residual_pca-3333"><span class="linenos">3333</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3334"><a href="#test_mlp_then_nsa_joint_residual_pca-3334"><span class="linenos">3334</span></a>    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">Y_pred_joint</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">bins</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3335"><a href="#test_mlp_then_nsa_joint_residual_pca-3335"><span class="linenos">3335</span></a>    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Output Distribution (apply_nonneg=</span><span class="si">{</span><span class="n">apply_nonneg</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3336"><a href="#test_mlp_then_nsa_joint_residual_pca-3336"><span class="linenos">3336</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3337"><a href="#test_mlp_then_nsa_joint_residual_pca-3337"><span class="linenos">3337</span></a>    <span class="n">corrmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">Y_pred_joint</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3338"><a href="#test_mlp_then_nsa_joint_residual_pca-3338"><span class="linenos">3338</span></a>    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">corrmat</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;coolwarm&quot;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3339"><a href="#test_mlp_then_nsa_joint_residual_pca-3339"><span class="linenos">3339</span></a>    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Column Correlation (Joint)&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3340"><a href="#test_mlp_then_nsa_joint_residual_pca-3340"><span class="linenos">3340</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3341"><a href="#test_mlp_then_nsa_joint_residual_pca-3341"><span class="linenos">3341</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3342"><a href="#test_mlp_then_nsa_joint_residual_pca-3342"><span class="linenos">3342</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3343"><a href="#test_mlp_then_nsa_joint_residual_pca-3343"><span class="linenos">3343</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3344"><a href="#test_mlp_then_nsa_joint_residual_pca-3344"><span class="linenos">3344</span></a>    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3345"><a href="#test_mlp_then_nsa_joint_residual_pca-3345"><span class="linenos">3345</span></a>        <span class="n">corr_pca</span><span class="o">=</span><span class="n">corr_pca</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3346"><a href="#test_mlp_then_nsa_joint_residual_pca-3346"><span class="linenos">3346</span></a>        <span class="n">corr_mlp</span><span class="o">=</span><span class="n">corr_mlp</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3347"><a href="#test_mlp_then_nsa_joint_residual_pca-3347"><span class="linenos">3347</span></a>        <span class="n">corr_nsa</span><span class="o">=</span><span class="n">corr_nsa</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3348"><a href="#test_mlp_then_nsa_joint_residual_pca-3348"><span class="linenos">3348</span></a>        <span class="n">corr_joint</span><span class="o">=</span><span class="n">corr_joint</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3349"><a href="#test_mlp_then_nsa_joint_residual_pca-3349"><span class="linenos">3349</span></a>        <span class="n">invorth_pca</span><span class="o">=</span><span class="n">invorth_pca</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3350"><a href="#test_mlp_then_nsa_joint_residual_pca-3350"><span class="linenos">3350</span></a>        <span class="n">invorth_mlp</span><span class="o">=</span><span class="n">invorth_mlp</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3351"><a href="#test_mlp_then_nsa_joint_residual_pca-3351"><span class="linenos">3351</span></a>        <span class="n">invorth_nsa</span><span class="o">=</span><span class="n">invorth_nsa</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3352"><a href="#test_mlp_then_nsa_joint_residual_pca-3352"><span class="linenos">3352</span></a>        <span class="n">invorth_joint</span><span class="o">=</span><span class="n">invorth_joint</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3353"><a href="#test_mlp_then_nsa_joint_residual_pca-3353"><span class="linenos">3353</span></a>        <span class="n">Y_pred_joint</span><span class="o">=</span><span class="n">Y_pred_joint</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span>
</span><span id="test_mlp_then_nsa_joint_residual_pca-3354"><a href="#test_mlp_then_nsa_joint_residual_pca-3354"><span class="linenos">3354</span></a>    <span class="p">)</span>
</span></pre></div>


    

                </section>
                <section id="test_mlp_then_nsa_joint_residual_diagnostics">
                            <input id="test_mlp_then_nsa_joint_residual_diagnostics-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">test_mlp_then_nsa_joint_residual_diagnostics</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">seed</span><span class="o">=</span><span class="mi">0</span>,</span><span class="param">	<span class="n">w</span><span class="o">=</span><span class="mf">0.5</span>,</span><span class="param">	<span class="n">n</span><span class="o">=</span><span class="mi">200</span>,</span><span class="param">	<span class="n">p</span><span class="o">=</span><span class="mi">8</span>,</span><span class="param">	<span class="n">k</span><span class="o">=</span><span class="mi">6</span>,</span><span class="param">	<span class="n">hidden</span><span class="o">=</span><span class="mi">128</span>,</span><span class="param">	<span class="n">noise</span><span class="o">=</span><span class="mf">0.1</span>,</span><span class="param">	<span class="n">mlp_epochs</span><span class="o">=</span><span class="mi">1000</span>,</span><span class="param">	<span class="n">nsa_epochs</span><span class="o">=</span><span class="mi">800</span>,</span><span class="param">	<span class="n">joint_epochs</span><span class="o">=</span><span class="mi">800</span>,</span><span class="param">	<span class="n">lr_mlp</span><span class="o">=</span><span class="mf">0.001</span>,</span><span class="param">	<span class="n">lr_nsa</span><span class="o">=</span><span class="mf">0.001</span>,</span><span class="param">	<span class="n">lr_joint</span><span class="o">=</span><span class="mf">0.0005</span>,</span><span class="param">	<span class="n">apply_nonneg</span><span class="o">=</span><span class="s1">&#39;hard&#39;</span>,</span><span class="param">	<span class="n">residual</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">use_transform</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">verbose</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="test_mlp_then_nsa_joint_residual_diagnostics-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#test_mlp_then_nsa_joint_residual_diagnostics"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2928"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2928"><span class="linenos">2928</span></a><span class="k">def</span><span class="w"> </span><span class="nf">test_mlp_then_nsa_joint_residual_diagnostics</span><span class="p">(</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2929"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2929"><span class="linenos">2929</span></a>    <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2930"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2930"><span class="linenos">2930</span></a>    <span class="n">w</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2931"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2931"><span class="linenos">2931</span></a>    <span class="n">n</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2932"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2932"><span class="linenos">2932</span></a>    <span class="n">p</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2933"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2933"><span class="linenos">2933</span></a>    <span class="n">k</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2934"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2934"><span class="linenos">2934</span></a>    <span class="n">hidden</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2935"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2935"><span class="linenos">2935</span></a>    <span class="n">noise</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2936"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2936"><span class="linenos">2936</span></a>    <span class="n">mlp_epochs</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2937"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2937"><span class="linenos">2937</span></a>    <span class="n">nsa_epochs</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2938"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2938"><span class="linenos">2938</span></a>    <span class="n">joint_epochs</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2939"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2939"><span class="linenos">2939</span></a>    <span class="n">lr_mlp</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2940"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2940"><span class="linenos">2940</span></a>    <span class="n">lr_nsa</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2941"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2941"><span class="linenos">2941</span></a>    <span class="n">lr_joint</span><span class="o">=</span><span class="mf">5e-4</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2942"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2942"><span class="linenos">2942</span></a>    <span class="n">apply_nonneg</span><span class="o">=</span><span class="s2">&quot;hard&quot;</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2943"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2943"><span class="linenos">2943</span></a>    <span class="n">residual</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2944"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2944"><span class="linenos">2944</span></a>    <span class="n">use_transform</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2945"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2945"><span class="linenos">2945</span></a>    <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2946"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2946"><span class="linenos">2946</span></a><span class="p">):</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2947"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2947"><span class="linenos">2947</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2948"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2948"><span class="linenos">2948</span></a><span class="sd">    Full pipeline:</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2949"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2949"><span class="linenos">2949</span></a><span class="sd">      1) Train MLP for fidelity</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2950"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2950"><span class="linenos">2950</span></a><span class="sd">      2) Train Residual NSA refinement (tracking w_dyn)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2951"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2951"><span class="linenos">2951</span></a><span class="sd">      3) Joint fine-tuning (tracking w_dyn)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2952"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2952"><span class="linenos">2952</span></a><span class="sd">      4) Detailed numeric metrics + visualizations (singular spectra, principal angles, distribution, residuals)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2953"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2953"><span class="linenos">2953</span></a><span class="sd">    Returns a dict of metrics and arrays for further inspection.</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2954"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2954"><span class="linenos">2954</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2955"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2955"><span class="linenos">2955</span></a>    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2956"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2956"><span class="linenos">2956</span></a>    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2957"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2957"><span class="linenos">2957</span></a>    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2958"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2958"><span class="linenos">2958</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2959"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2959"><span class="linenos">2959</span></a>    <span class="c1"># Synthetic nonlinear data (learnable)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2960"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2960"><span class="linenos">2960</span></a>    <span class="n">W_true</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2961"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2961"><span class="linenos">2961</span></a>    <span class="n">X</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2962"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2962"><span class="linenos">2962</span></a>    <span class="n">Y_true</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softplus</span><span class="p">(</span><span class="n">X</span> <span class="o">@</span> <span class="n">W_true</span><span class="p">)</span>                 <span class="c1"># underlying signal</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2963"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2963"><span class="linenos">2963</span></a>    <span class="n">Y_obs</span> <span class="o">=</span> <span class="n">Y_true</span> <span class="o">+</span> <span class="n">noise</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">Y_true</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2964"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2964"><span class="linenos">2964</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2965"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2965"><span class="linenos">2965</span></a>    <span class="n">n_train</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.8</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2966"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2966"><span class="linenos">2966</span></a>    <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:</span><span class="n">n_train</span><span class="p">],</span> <span class="n">X</span><span class="p">[</span><span class="n">n_train</span><span class="p">:]</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2967"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2967"><span class="linenos">2967</span></a>    <span class="n">Y_train</span><span class="p">,</span> <span class="n">Y_test</span> <span class="o">=</span> <span class="n">Y_obs</span><span class="p">[:</span><span class="n">n_train</span><span class="p">],</span> <span class="n">Y_obs</span><span class="p">[</span><span class="n">n_train</span><span class="p">:]</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2968"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2968"><span class="linenos">2968</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2969"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2969"><span class="linenos">2969</span></a>    <span class="c1"># --------------------</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2970"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2970"><span class="linenos">2970</span></a>    <span class="c1"># 1) Train baseline MLP (fidelity only)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2971"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2971"><span class="linenos">2971</span></a>    <span class="c1"># --------------------</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2972"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2972"><span class="linenos">2972</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== TRAIN MLP (fidelity only) ===&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2973"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2973"><span class="linenos">2973</span></a>    <span class="n">mlp</span> <span class="o">=</span> <span class="n">SimpleMLP</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">hidden</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2974"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2974"><span class="linenos">2974</span></a>    <span class="n">opt_mlp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="n">mlp</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr_mlp</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2975"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2975"><span class="linenos">2975</span></a>    <span class="n">mlp_losses</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2976"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2976"><span class="linenos">2976</span></a>    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mlp_epochs</span><span class="p">):</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2977"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2977"><span class="linenos">2977</span></a>        <span class="n">opt_mlp</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2978"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2978"><span class="linenos">2978</span></a>        <span class="n">Y_pred_tr</span> <span class="o">=</span> <span class="n">mlp</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2979"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2979"><span class="linenos">2979</span></a>        <span class="n">loss</span> <span class="o">=</span> <span class="n">fidelity_scaled</span><span class="p">(</span><span class="n">Y_pred_tr</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2980"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2980"><span class="linenos">2980</span></a>        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2981"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2981"><span class="linenos">2981</span></a>        <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clip_grad_norm_</span><span class="p">(</span><span class="n">mlp</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="mf">1.0</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2982"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2982"><span class="linenos">2982</span></a>        <span class="n">opt_mlp</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2983"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2983"><span class="linenos">2983</span></a>        <span class="n">mlp_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2984"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2984"><span class="linenos">2984</span></a>        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">%</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">mlp_epochs</span><span class="o">//</span><span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">epoch</span> <span class="o">==</span> <span class="n">mlp_epochs</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2985"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2985"><span class="linenos">2985</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[MLP </span><span class="si">{</span><span class="n">epoch</span><span class="si">:</span><span class="s2">04d</span><span class="si">}</span><span class="s2">] L=</span><span class="si">{</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2986"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2986"><span class="linenos">2986</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2987"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2987"><span class="linenos">2987</span></a>    <span class="n">mlp</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2988"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2988"><span class="linenos">2988</span></a>    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2989"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2989"><span class="linenos">2989</span></a>        <span class="n">Y_mlp_test</span> <span class="o">=</span> <span class="n">mlp</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2990"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2990"><span class="linenos">2990</span></a>    <span class="c1"># basic metrics</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2991"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2991"><span class="linenos">2991</span></a>    <span class="n">mlp_mse</span> <span class="o">=</span> <span class="n">mse_fn</span><span class="p">(</span><span class="n">Y_mlp_test</span><span class="p">,</span> <span class="n">Y_test</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2992"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2992"><span class="linenos">2992</span></a>    <span class="n">mlp_rmse</span> <span class="o">=</span> <span class="n">rmse_fn</span><span class="p">(</span><span class="n">Y_mlp_test</span><span class="p">,</span> <span class="n">Y_test</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2993"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2993"><span class="linenos">2993</span></a>    <span class="n">mlp_mae</span> <span class="o">=</span> <span class="n">mae_fn</span><span class="p">(</span><span class="n">Y_mlp_test</span><span class="p">,</span> <span class="n">Y_test</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2994"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2994"><span class="linenos">2994</span></a>    <span class="n">mlp_r2</span> <span class="o">=</span> <span class="n">r2_fn</span><span class="p">(</span><span class="n">Y_mlp_test</span><span class="p">,</span> <span class="n">Y_test</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2995"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2995"><span class="linenos">2995</span></a>    <span class="n">mlp_expl_var</span> <span class="o">=</span> <span class="n">explained_var_fn</span><span class="p">(</span><span class="n">Y_mlp_test</span><span class="p">,</span> <span class="n">Y_test</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2996"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2996"><span class="linenos">2996</span></a>    <span class="n">mlp_svals</span> <span class="o">=</span> <span class="n">singular_values</span><span class="p">(</span><span class="n">Y_mlp_test</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2997"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2997"><span class="linenos">2997</span></a>    <span class="n">mlp_invorth</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">invariant_orthogonality_defect</span><span class="p">(</span><span class="n">Y_mlp_test</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2998"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2998"><span class="linenos">2998</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-2999"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-2999"><span class="linenos">2999</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MLP test MSE=</span><span class="si">{</span><span class="n">mlp_mse</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> RMSE=</span><span class="si">{</span><span class="n">mlp_rmse</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> R2=</span><span class="si">{</span><span class="n">mlp_r2</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> invOrth=</span><span class="si">{</span><span class="n">mlp_invorth</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3000"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3000"><span class="linenos">3000</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3001"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3001"><span class="linenos">3001</span></a>    <span class="c1"># --------------------</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3002"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3002"><span class="linenos">3002</span></a>    <span class="c1"># 2) NSA residual refinement (on training MLP outputs)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3003"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3003"><span class="linenos">3003</span></a>    <span class="c1"># --------------------</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3004"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3004"><span class="linenos">3004</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== TRAIN NSA refinement (residual) ===&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3005"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3005"><span class="linenos">3005</span></a>    <span class="n">nsa</span> <span class="o">=</span> <span class="n">NSAFlowLayer</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">hidden</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">w_retract</span><span class="o">=</span><span class="n">w</span><span class="p">,</span> <span class="n">retraction_type</span><span class="o">=</span><span class="s2">&quot;soft_polar&quot;</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3006"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3006"><span class="linenos">3006</span></a>                       <span class="n">apply_nonneg</span><span class="o">=</span><span class="n">apply_nonneg</span><span class="p">,</span> <span class="n">residual</span><span class="o">=</span><span class="n">residual</span><span class="p">,</span> <span class="n">use_transform</span><span class="o">=</span><span class="n">use_transform</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3007"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3007"><span class="linenos">3007</span></a>    <span class="n">opt_nsa</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="n">nsa</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr_nsa</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3008"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3008"><span class="linenos">3008</span></a>    <span class="n">nsa_losses</span><span class="p">,</span> <span class="n">nsa_fids</span><span class="p">,</span> <span class="n">nsa_orths</span><span class="p">,</span> <span class="n">nsa_wdyn</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3009"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3009"><span class="linenos">3009</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3010"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3010"><span class="linenos">3010</span></a>    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3011"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3011"><span class="linenos">3011</span></a>        <span class="n">Y0_train</span> <span class="o">=</span> <span class="n">mlp</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3012"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3012"><span class="linenos">3012</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3013"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3013"><span class="linenos">3013</span></a>    <span class="c1"># If NSA alpha is learnable and used, we&#39;ll record sigmoid(alpha) as w_dyn</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3014"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3014"><span class="linenos">3014</span></a>    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsa_epochs</span><span class="p">):</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3015"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3015"><span class="linenos">3015</span></a>        <span class="n">opt_nsa</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3016"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3016"><span class="linenos">3016</span></a>        <span class="n">Y_ref</span> <span class="o">=</span> <span class="n">nsa</span><span class="p">(</span><span class="n">Y0_train</span><span class="p">)</span> <span class="k">if</span> <span class="n">nsa</span><span class="o">.</span><span class="n">_apply_nonneg</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">nsa</span><span class="p">(</span><span class="n">Y0_train</span><span class="p">)</span>  <span class="c1"># forward returns tensor (targetless)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3017"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3017"><span class="linenos">3017</span></a>        <span class="c1"># compute terms (we will use fidelity and orth as defined)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3018"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3018"><span class="linenos">3018</span></a>        <span class="n">fid</span> <span class="o">=</span> <span class="n">fidelity_scaled</span><span class="p">(</span><span class="n">Y_ref</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3019"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3019"><span class="linenos">3019</span></a>        <span class="n">orth</span> <span class="o">=</span> <span class="n">invariant_orthogonality_defect</span><span class="p">(</span><span class="n">Y_ref</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3020"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3020"><span class="linenos">3020</span></a>        <span class="n">loss</span> <span class="o">=</span> <span class="n">fid</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">orth</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3021"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3021"><span class="linenos">3021</span></a>        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3022"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3022"><span class="linenos">3022</span></a>        <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clip_grad_norm_</span><span class="p">(</span><span class="n">nsa</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="mf">1.0</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3023"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3023"><span class="linenos">3023</span></a>        <span class="n">opt_nsa</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3024"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3024"><span class="linenos">3024</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3025"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3025"><span class="linenos">3025</span></a>        <span class="c1"># record</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3026"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3026"><span class="linenos">3026</span></a>        <span class="n">nsa_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()))</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3027"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3027"><span class="linenos">3027</span></a>        <span class="n">nsa_fids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">fid</span><span class="o">.</span><span class="n">item</span><span class="p">()))</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3028"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3028"><span class="linenos">3028</span></a>        <span class="n">nsa_orths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">orth</span><span class="o">.</span><span class="n">item</span><span class="p">()))</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3029"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3029"><span class="linenos">3029</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3030"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3030"><span class="linenos">3030</span></a>            <span class="n">wdyn</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">nsa</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3031"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3031"><span class="linenos">3031</span></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3032"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3032"><span class="linenos">3032</span></a>            <span class="n">wdyn</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3033"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3033"><span class="linenos">3033</span></a>        <span class="n">nsa_wdyn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wdyn</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3034"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3034"><span class="linenos">3034</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3035"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3035"><span class="linenos">3035</span></a>        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">%</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nsa_epochs</span><span class="o">//</span><span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">epoch</span> <span class="o">==</span> <span class="n">nsa_epochs</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3036"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3036"><span class="linenos">3036</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[NSA </span><span class="si">{</span><span class="n">epoch</span><span class="si">:</span><span class="s2">04d</span><span class="si">}</span><span class="s2">] loss=</span><span class="si">{</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2"> fid=</span><span class="si">{</span><span class="n">fid</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2"> orth=</span><span class="si">{</span><span class="n">orth</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2"> w_dyn=</span><span class="si">{</span><span class="n">wdyn</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3037"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3037"><span class="linenos">3037</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3038"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3038"><span class="linenos">3038</span></a>    <span class="n">nsa</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3039"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3039"><span class="linenos">3039</span></a>    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3040"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3040"><span class="linenos">3040</span></a>        <span class="n">Y_nsa_test</span> <span class="o">=</span> <span class="n">nsa</span><span class="p">(</span><span class="n">mlp</span><span class="p">(</span><span class="n">X_test</span><span class="p">))</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3041"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3041"><span class="linenos">3041</span></a>    <span class="n">nsa_mse</span> <span class="o">=</span> <span class="n">mse_fn</span><span class="p">(</span><span class="n">Y_nsa_test</span><span class="p">,</span> <span class="n">Y_test</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3042"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3042"><span class="linenos">3042</span></a>    <span class="n">nsa_rmse</span> <span class="o">=</span> <span class="n">rmse_fn</span><span class="p">(</span><span class="n">Y_nsa_test</span><span class="p">,</span> <span class="n">Y_test</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3043"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3043"><span class="linenos">3043</span></a>    <span class="n">nsa_mae</span> <span class="o">=</span> <span class="n">mae_fn</span><span class="p">(</span><span class="n">Y_nsa_test</span><span class="p">,</span> <span class="n">Y_test</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3044"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3044"><span class="linenos">3044</span></a>    <span class="n">nsa_r2</span> <span class="o">=</span> <span class="n">r2_fn</span><span class="p">(</span><span class="n">Y_nsa_test</span><span class="p">,</span> <span class="n">Y_test</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3045"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3045"><span class="linenos">3045</span></a>    <span class="n">nsa_expl_var</span> <span class="o">=</span> <span class="n">explained_var_fn</span><span class="p">(</span><span class="n">Y_nsa_test</span><span class="p">,</span> <span class="n">Y_test</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3046"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3046"><span class="linenos">3046</span></a>    <span class="n">nsa_svals</span> <span class="o">=</span> <span class="n">singular_values</span><span class="p">(</span><span class="n">Y_nsa_test</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3047"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3047"><span class="linenos">3047</span></a>    <span class="n">nsa_invorth</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">invariant_orthogonality_defect</span><span class="p">(</span><span class="n">Y_nsa_test</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3048"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3048"><span class="linenos">3048</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3049"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3049"><span class="linenos">3049</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NSA-refined test MSE=</span><span class="si">{</span><span class="n">nsa_mse</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> RMSE=</span><span class="si">{</span><span class="n">nsa_rmse</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> R2=</span><span class="si">{</span><span class="n">nsa_r2</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> invOrth=</span><span class="si">{</span><span class="n">nsa_invorth</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3050"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3050"><span class="linenos">3050</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3051"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3051"><span class="linenos">3051</span></a>    <span class="c1"># --------------------</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3052"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3052"><span class="linenos">3052</span></a>    <span class="c1"># 3) Joint fine-tuning (MLP + NSA)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3053"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3053"><span class="linenos">3053</span></a>    <span class="c1"># --------------------</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3054"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3054"><span class="linenos">3054</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== JOINT FINE-TUNE ===&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3055"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3055"><span class="linenos">3055</span></a>    <span class="n">joint_model</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">mlp</span><span class="p">,</span> <span class="n">nsa</span><span class="p">)</span>  <span class="c1"># reuses trained mlp + trained nsa</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3056"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3056"><span class="linenos">3056</span></a>    <span class="n">opt_joint</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="n">joint_model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr_joint</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3057"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3057"><span class="linenos">3057</span></a>    <span class="n">joint_losses</span><span class="p">,</span> <span class="n">joint_fid_hist</span><span class="p">,</span> <span class="n">joint_orth_hist</span><span class="p">,</span> <span class="n">joint_wdyn</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3058"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3058"><span class="linenos">3058</span></a>    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">joint_epochs</span><span class="p">):</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3059"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3059"><span class="linenos">3059</span></a>        <span class="n">opt_joint</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3060"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3060"><span class="linenos">3060</span></a>        <span class="n">Y_joint_tr</span> <span class="o">=</span> <span class="n">joint_model</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3061"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3061"><span class="linenos">3061</span></a>        <span class="n">fid_j</span> <span class="o">=</span> <span class="n">fidelity_scaled</span><span class="p">(</span><span class="n">Y_joint_tr</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3062"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3062"><span class="linenos">3062</span></a>        <span class="n">orth_j</span> <span class="o">=</span> <span class="n">invariant_orthogonality_defect</span><span class="p">(</span><span class="n">Y_joint_tr</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3063"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3063"><span class="linenos">3063</span></a>        <span class="n">loss_j</span> <span class="o">=</span> <span class="n">fid_j</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">w</span><span class="p">)</span> <span class="o">+</span> <span class="n">orth_j</span> <span class="o">*</span> <span class="n">w</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3064"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3064"><span class="linenos">3064</span></a>        <span class="n">loss_j</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3065"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3065"><span class="linenos">3065</span></a>        <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clip_grad_norm_</span><span class="p">(</span><span class="n">joint_model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="mf">1.0</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3066"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3066"><span class="linenos">3066</span></a>        <span class="n">opt_joint</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3067"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3067"><span class="linenos">3067</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3068"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3068"><span class="linenos">3068</span></a>        <span class="n">joint_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">loss_j</span><span class="o">.</span><span class="n">item</span><span class="p">()))</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3069"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3069"><span class="linenos">3069</span></a>        <span class="n">joint_fid_hist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">fid_j</span><span class="o">.</span><span class="n">item</span><span class="p">()))</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3070"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3070"><span class="linenos">3070</span></a>        <span class="n">joint_orth_hist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">orth_j</span><span class="o">.</span><span class="n">item</span><span class="p">()))</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3071"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3071"><span class="linenos">3071</span></a>        <span class="n">joint_wdyn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">nsa</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">())</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">nsa</span><span class="p">,</span> <span class="s2">&quot;alpha&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">))</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3072"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3072"><span class="linenos">3072</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3073"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3073"><span class="linenos">3073</span></a>        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">%</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">joint_epochs</span><span class="o">//</span><span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">epoch</span> <span class="o">==</span> <span class="n">joint_epochs</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3074"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3074"><span class="linenos">3074</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Joint </span><span class="si">{</span><span class="n">epoch</span><span class="si">:</span><span class="s2">04d</span><span class="si">}</span><span class="s2">] loss=</span><span class="si">{</span><span class="n">loss_j</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2"> fid=</span><span class="si">{</span><span class="n">fid_j</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2"> orth=</span><span class="si">{</span><span class="n">orth_j</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2"> w_dyn=</span><span class="si">{</span><span class="n">joint_wdyn</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3075"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3075"><span class="linenos">3075</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3076"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3076"><span class="linenos">3076</span></a>    <span class="n">joint_model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3077"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3077"><span class="linenos">3077</span></a>    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3078"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3078"><span class="linenos">3078</span></a>        <span class="n">Y_joint_test</span> <span class="o">=</span> <span class="n">joint_model</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3079"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3079"><span class="linenos">3079</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3080"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3080"><span class="linenos">3080</span></a>    <span class="n">joint_mse</span> <span class="o">=</span> <span class="n">mse_fn</span><span class="p">(</span><span class="n">Y_joint_test</span><span class="p">,</span> <span class="n">Y_test</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3081"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3081"><span class="linenos">3081</span></a>    <span class="n">joint_rmse</span> <span class="o">=</span> <span class="n">rmse_fn</span><span class="p">(</span><span class="n">Y_joint_test</span><span class="p">,</span> <span class="n">Y_test</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3082"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3082"><span class="linenos">3082</span></a>    <span class="n">joint_mae</span> <span class="o">=</span> <span class="n">mae_fn</span><span class="p">(</span><span class="n">Y_joint_test</span><span class="p">,</span> <span class="n">Y_test</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3083"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3083"><span class="linenos">3083</span></a>    <span class="n">joint_r2</span> <span class="o">=</span> <span class="n">r2_fn</span><span class="p">(</span><span class="n">Y_joint_test</span><span class="p">,</span> <span class="n">Y_test</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3084"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3084"><span class="linenos">3084</span></a>    <span class="n">joint_expl_var</span> <span class="o">=</span> <span class="n">explained_var_fn</span><span class="p">(</span><span class="n">Y_joint_test</span><span class="p">,</span> <span class="n">Y_test</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3085"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3085"><span class="linenos">3085</span></a>    <span class="n">joint_svals</span> <span class="o">=</span> <span class="n">singular_values</span><span class="p">(</span><span class="n">Y_joint_test</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3086"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3086"><span class="linenos">3086</span></a>    <span class="n">joint_invorth</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">invariant_orthogonality_defect</span><span class="p">(</span><span class="n">Y_joint_test</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3087"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3087"><span class="linenos">3087</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3088"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3088"><span class="linenos">3088</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;JOINT test MSE=</span><span class="si">{</span><span class="n">joint_mse</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> RMSE=</span><span class="si">{</span><span class="n">joint_rmse</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> R2=</span><span class="si">{</span><span class="n">joint_r2</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> invOrth=</span><span class="si">{</span><span class="n">joint_invorth</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3089"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3089"><span class="linenos">3089</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3090"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3090"><span class="linenos">3090</span></a>    <span class="c1"># --------------------</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3091"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3091"><span class="linenos">3091</span></a>    <span class="c1"># Subspace / principal angles between predicted and true column spans</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3092"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3092"><span class="linenos">3092</span></a>    <span class="c1"># --------------------</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3093"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3093"><span class="linenos">3093</span></a>    <span class="c1"># We compute principal angles between column spaces (k columns) of the predicted matrix vs Y_true (test)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3094"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3094"><span class="linenos">3094</span></a>    <span class="n">angles_mlp</span><span class="p">,</span> <span class="n">svals_mlp</span> <span class="o">=</span> <span class="n">principal_angles</span><span class="p">(</span><span class="n">Y_mlp_test</span><span class="p">,</span> <span class="n">Y_test</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">Y_mlp_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">Y_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3095"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3095"><span class="linenos">3095</span></a>    <span class="n">angles_nsa</span><span class="p">,</span> <span class="n">svals_nsa</span> <span class="o">=</span> <span class="n">principal_angles</span><span class="p">(</span><span class="n">Y_nsa_test</span><span class="p">,</span> <span class="n">Y_test</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">Y_nsa_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">Y_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3096"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3096"><span class="linenos">3096</span></a>    <span class="n">angles_joint</span><span class="p">,</span> <span class="n">svals_joint</span> <span class="o">=</span> <span class="n">principal_angles</span><span class="p">(</span><span class="n">Y_joint_test</span><span class="p">,</span> <span class="n">Y_test</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">Y_joint_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">Y_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3097"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3097"><span class="linenos">3097</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3098"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3098"><span class="linenos">3098</span></a>    <span class="c1"># --------------------</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3099"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3099"><span class="linenos">3099</span></a>    <span class="c1"># Visualizations (summary + deep diagnostics)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3100"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3100"><span class="linenos">3100</span></a>    <span class="c1"># --------------------</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3101"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3101"><span class="linenos">3101</span></a>    <span class="c1"># 1) Loss curves and w_dyn tracking</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3102"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3102"><span class="linenos">3102</span></a>    <span class="n">fig1</span><span class="p">,</span> <span class="n">axs1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3103"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3103"><span class="linenos">3103</span></a>    <span class="n">axs1</span> <span class="o">=</span> <span class="n">axs1</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3104"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3104"><span class="linenos">3104</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3105"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3105"><span class="linenos">3105</span></a>    <span class="n">axs1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mlp_losses</span><span class="p">);</span> <span class="n">axs1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;MLP training fidelity loss&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3106"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3106"><span class="linenos">3106</span></a>    <span class="n">axs1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">nsa_losses</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;NSA total&quot;</span><span class="p">);</span> <span class="n">axs1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">nsa_fids</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;NSA fid&quot;</span><span class="p">);</span> <span class="n">axs1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">nsa_orths</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3107"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3107"><span class="linenos">3107</span></a>                                                                                                       <span class="n">label</span><span class="o">=</span><span class="s2">&quot;NSA orth&quot;</span><span class="p">);</span> <span class="n">axs1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span> <span class="n">axs1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;NSA refinement metrics&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3108"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3108"><span class="linenos">3108</span></a>    <span class="n">axs1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">joint_losses</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Joint total&quot;</span><span class="p">);</span> <span class="n">axs1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">joint_fid_hist</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Joint fid&quot;</span><span class="p">);</span> <span class="n">axs1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">joint_orth_hist</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Joint orth&quot;</span><span class="p">);</span> <span class="n">axs1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span> <span class="n">axs1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Joint fine-tuning&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3109"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3109"><span class="linenos">3109</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3110"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3110"><span class="linenos">3110</span></a>    <span class="c1"># w_dyn (alpha sigmoid) traces</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3111"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3111"><span class="linenos">3111</span></a>    <span class="n">axs1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">nsa_wdyn</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;NSA w_dyn (sigmoid alpha)&quot;</span><span class="p">);</span> <span class="n">axs1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;NSA tradeoff (w_dyn)&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3112"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3112"><span class="linenos">3112</span></a>    <span class="n">axs1</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">joint_wdyn</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Joint w_dyn&quot;</span><span class="p">);</span> <span class="n">axs1</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Joint tradeoff (w_dyn)&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3113"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3113"><span class="linenos">3113</span></a>    <span class="n">axs1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">);</span> <span class="n">axs1</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3114"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3114"><span class="linenos">3114</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3115"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3115"><span class="linenos">3115</span></a>    <span class="c1"># Sing. value spectra</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3116"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3116"><span class="linenos">3116</span></a>    <span class="n">axs1</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mlp_svals</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;MLP svals&#39;</span><span class="p">);</span> <span class="n">axs1</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">nsa_svals</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;NSA svals&#39;</span><span class="p">);</span> <span class="n">axs1</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">joint_svals</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;JOINT svals&#39;</span><span class="p">);</span> <span class="n">axs1</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span> <span class="n">axs1</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Singular value spectra (test preds)&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3117"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3117"><span class="linenos">3117</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3118"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3118"><span class="linenos">3118</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3119"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3119"><span class="linenos">3119</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3120"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3120"><span class="linenos">3120</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3121"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3121"><span class="linenos">3121</span></a>    <span class="c1"># 2) Scatter predicted vs true and residual histogram</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3122"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3122"><span class="linenos">3122</span></a>    <span class="n">fig2</span><span class="p">,</span> <span class="n">axs2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3123"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3123"><span class="linenos">3123</span></a>    <span class="n">axs2</span> <span class="o">=</span> <span class="n">axs2</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3124"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3124"><span class="linenos">3124</span></a>    <span class="n">axs2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">Y_test</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">Y_mlp_test</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">);</span> <span class="n">axs2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MLP scatter r=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">mlp_r2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3125"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3125"><span class="linenos">3125</span></a>    <span class="n">axs2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">Y_test</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">Y_nsa_test</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">);</span> <span class="n">axs2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MLP+NSA scatter r=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">nsa_r2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3126"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3126"><span class="linenos">3126</span></a>    <span class="n">axs2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">Y_test</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">Y_joint_test</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">);</span> <span class="n">axs2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;JOINT scatter r=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">joint_r2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3127"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3127"><span class="linenos">3127</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3128"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3128"><span class="linenos">3128</span></a>    <span class="c1"># residuals hist</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3129"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3129"><span class="linenos">3129</span></a>    <span class="n">axs2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">((</span><span class="n">Y_mlp_test</span> <span class="o">-</span> <span class="n">Y_test</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">);</span> <span class="n">axs2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Residuals (MLP)&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3130"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3130"><span class="linenos">3130</span></a>    <span class="n">axs2</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">((</span><span class="n">Y_nsa_test</span> <span class="o">-</span> <span class="n">Y_test</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">);</span> <span class="n">axs2</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Residuals (MLP+NSA)&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3131"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3131"><span class="linenos">3131</span></a>    <span class="n">axs2</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">((</span><span class="n">Y_joint_test</span> <span class="o">-</span> <span class="n">Y_test</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">);</span> <span class="n">axs2</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Residuals (JOINT)&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3132"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3132"><span class="linenos">3132</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3133"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3133"><span class="linenos">3133</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3134"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3134"><span class="linenos">3134</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3135"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3135"><span class="linenos">3135</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3136"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3136"><span class="linenos">3136</span></a>    <span class="c1"># 3) Principal angles bar plots</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3137"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3137"><span class="linenos">3137</span></a>    <span class="n">fig3</span><span class="p">,</span> <span class="n">ax3</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3138"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3138"><span class="linenos">3138</span></a>    <span class="n">ax3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">angles_mlp</span><span class="p">)),</span> <span class="n">angles_mlp</span><span class="p">);</span> <span class="n">ax3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Principal angles MLP -&gt; true&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3139"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3139"><span class="linenos">3139</span></a>    <span class="n">ax3</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">angles_nsa</span><span class="p">)),</span> <span class="n">angles_nsa</span><span class="p">);</span> <span class="n">ax3</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Principal angles MLP+NSA -&gt; true&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3140"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3140"><span class="linenos">3140</span></a>    <span class="n">ax3</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">angles_joint</span><span class="p">)),</span> <span class="n">angles_joint</span><span class="p">);</span> <span class="n">ax3</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Principal angles Joint -&gt; true&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3141"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3141"><span class="linenos">3141</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3142"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3142"><span class="linenos">3142</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3143"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3143"><span class="linenos">3143</span></a>    <span class="c1"># --------------------</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3144"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3144"><span class="linenos">3144</span></a>    <span class="c1"># Pack results</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3145"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3145"><span class="linenos">3145</span></a>    <span class="c1"># --------------------</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3146"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3146"><span class="linenos">3146</span></a>    <span class="n">out</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3147"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3147"><span class="linenos">3147</span></a>        <span class="s2">&quot;mlp&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3148"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3148"><span class="linenos">3148</span></a>            <span class="s2">&quot;Y_pred&quot;</span><span class="p">:</span> <span class="n">Y_mlp_test</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3149"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3149"><span class="linenos">3149</span></a>            <span class="s2">&quot;mse&quot;</span><span class="p">:</span> <span class="n">mlp_mse</span><span class="p">,</span> <span class="s2">&quot;rmse&quot;</span><span class="p">:</span> <span class="n">mlp_rmse</span><span class="p">,</span> <span class="s2">&quot;mae&quot;</span><span class="p">:</span> <span class="n">mlp_mae</span><span class="p">,</span> <span class="s2">&quot;r2&quot;</span><span class="p">:</span> <span class="n">mlp_r2</span><span class="p">,</span> <span class="s2">&quot;explained_var&quot;</span><span class="p">:</span> <span class="n">mlp_expl_var</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3150"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3150"><span class="linenos">3150</span></a>            <span class="s2">&quot;svals&quot;</span><span class="p">:</span> <span class="n">mlp_svals</span><span class="p">,</span> <span class="s2">&quot;invorth&quot;</span><span class="p">:</span> <span class="n">mlp_invorth</span><span class="p">,</span> <span class="s2">&quot;angles&quot;</span><span class="p">:</span> <span class="n">angles_mlp</span><span class="p">,</span> <span class="s2">&quot;svals_cos&quot;</span><span class="p">:</span> <span class="n">svals_mlp</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3151"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3151"><span class="linenos">3151</span></a>        <span class="p">},</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3152"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3152"><span class="linenos">3152</span></a>        <span class="s2">&quot;nsa&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3153"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3153"><span class="linenos">3153</span></a>            <span class="s2">&quot;Y_pred&quot;</span><span class="p">:</span> <span class="n">Y_nsa_test</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3154"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3154"><span class="linenos">3154</span></a>            <span class="s2">&quot;mse&quot;</span><span class="p">:</span> <span class="n">nsa_mse</span><span class="p">,</span> <span class="s2">&quot;rmse&quot;</span><span class="p">:</span> <span class="n">nsa_rmse</span><span class="p">,</span> <span class="s2">&quot;mae&quot;</span><span class="p">:</span> <span class="n">nsa_mae</span><span class="p">,</span> <span class="s2">&quot;r2&quot;</span><span class="p">:</span> <span class="n">nsa_r2</span><span class="p">,</span> <span class="s2">&quot;explained_var&quot;</span><span class="p">:</span> <span class="n">nsa_expl_var</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3155"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3155"><span class="linenos">3155</span></a>            <span class="s2">&quot;svals&quot;</span><span class="p">:</span> <span class="n">nsa_svals</span><span class="p">,</span> <span class="s2">&quot;invorth&quot;</span><span class="p">:</span> <span class="n">nsa_invorth</span><span class="p">,</span> <span class="s2">&quot;angles&quot;</span><span class="p">:</span> <span class="n">angles_nsa</span><span class="p">,</span> <span class="s2">&quot;svals_cos&quot;</span><span class="p">:</span> <span class="n">svals_nsa</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3156"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3156"><span class="linenos">3156</span></a>            <span class="s2">&quot;wdyn&quot;</span><span class="p">:</span> <span class="n">nsa_wdyn</span><span class="p">,</span> <span class="s2">&quot;loss_hist&quot;</span><span class="p">:</span> <span class="n">nsa_losses</span><span class="p">,</span> <span class="s2">&quot;fid_hist&quot;</span><span class="p">:</span> <span class="n">nsa_fids</span><span class="p">,</span> <span class="s2">&quot;orth_hist&quot;</span><span class="p">:</span> <span class="n">nsa_orths</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3157"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3157"><span class="linenos">3157</span></a>        <span class="p">},</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3158"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3158"><span class="linenos">3158</span></a>        <span class="s2">&quot;joint&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3159"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3159"><span class="linenos">3159</span></a>            <span class="s2">&quot;Y_pred&quot;</span><span class="p">:</span> <span class="n">Y_joint_test</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3160"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3160"><span class="linenos">3160</span></a>            <span class="s2">&quot;mse&quot;</span><span class="p">:</span> <span class="n">joint_mse</span><span class="p">,</span> <span class="s2">&quot;rmse&quot;</span><span class="p">:</span> <span class="n">joint_rmse</span><span class="p">,</span> <span class="s2">&quot;mae&quot;</span><span class="p">:</span> <span class="n">joint_mae</span><span class="p">,</span> <span class="s2">&quot;r2&quot;</span><span class="p">:</span> <span class="n">joint_r2</span><span class="p">,</span> <span class="s2">&quot;explained_var&quot;</span><span class="p">:</span> <span class="n">joint_expl_var</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3161"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3161"><span class="linenos">3161</span></a>            <span class="s2">&quot;svals&quot;</span><span class="p">:</span> <span class="n">joint_svals</span><span class="p">,</span> <span class="s2">&quot;invorth&quot;</span><span class="p">:</span> <span class="n">joint_invorth</span><span class="p">,</span> <span class="s2">&quot;angles&quot;</span><span class="p">:</span> <span class="n">angles_joint</span><span class="p">,</span> <span class="s2">&quot;svals_cos&quot;</span><span class="p">:</span> <span class="n">svals_joint</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3162"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3162"><span class="linenos">3162</span></a>            <span class="s2">&quot;wdyn&quot;</span><span class="p">:</span> <span class="n">joint_wdyn</span><span class="p">,</span> <span class="s2">&quot;loss_hist&quot;</span><span class="p">:</span> <span class="n">joint_losses</span><span class="p">,</span> <span class="s2">&quot;fid_hist&quot;</span><span class="p">:</span> <span class="n">joint_fid_hist</span><span class="p">,</span> <span class="s2">&quot;orth_hist&quot;</span><span class="p">:</span> <span class="n">joint_orth_hist</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3163"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3163"><span class="linenos">3163</span></a>        <span class="p">},</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3164"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3164"><span class="linenos">3164</span></a>        <span class="s2">&quot;mlp_losses&quot;</span><span class="p">:</span> <span class="n">mlp_losses</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3165"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3165"><span class="linenos">3165</span></a>        <span class="s2">&quot;nsa_wdyn&quot;</span><span class="p">:</span> <span class="n">nsa_wdyn</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3166"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3166"><span class="linenos">3166</span></a>        <span class="s2">&quot;joint_wdyn&quot;</span><span class="p">:</span> <span class="n">joint_wdyn</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3167"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3167"><span class="linenos">3167</span></a>        <span class="s2">&quot;Y_test&quot;</span><span class="p">:</span> <span class="n">Y_test</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3168"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3168"><span class="linenos">3168</span></a>        <span class="s2">&quot;X_test&quot;</span><span class="p">:</span> <span class="n">X_test</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3169"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3169"><span class="linenos">3169</span></a>    <span class="p">}</span>
</span><span id="test_mlp_then_nsa_joint_residual_diagnostics-3170"><a href="#test_mlp_then_nsa_joint_residual_diagnostics-3170"><span class="linenos">3170</span></a>    <span class="k">return</span> <span class="n">out</span>
</span></pre></div>


            <div class="docstring"><p>Full pipeline:
  1) Train MLP for fidelity
  2) Train Residual NSA refinement (tracking w_dyn)
  3) Joint fine-tuning (tracking w_dyn)
  4) Detailed numeric metrics + visualizations (singular spectra, principal angles, distribution, residuals)
Returns a dict of metrics and arrays for further inspection.</p>
</div>


                </section>
                <section id="test_mlp_then_nsa_joint_residual_v2">
                            <input id="test_mlp_then_nsa_joint_residual_v2-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">test_mlp_then_nsa_joint_residual_v2</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">seed</span><span class="o">=</span><span class="mi">0</span>,</span><span class="param">	<span class="n">w</span><span class="o">=</span><span class="mf">0.5</span>,</span><span class="param">	<span class="n">n</span><span class="o">=</span><span class="mi">200</span>,</span><span class="param">	<span class="n">p</span><span class="o">=</span><span class="mi">8</span>,</span><span class="param">	<span class="n">k</span><span class="o">=</span><span class="mi">6</span>,</span><span class="param">	<span class="n">hidden</span><span class="o">=</span><span class="mi">128</span>,</span><span class="param">	<span class="n">noise</span><span class="o">=</span><span class="mf">0.1</span>,</span><span class="param">	<span class="n">mlp_epochs</span><span class="o">=</span><span class="mi">1000</span>,</span><span class="param">	<span class="n">nsa_epochs</span><span class="o">=</span><span class="mi">800</span>,</span><span class="param">	<span class="n">joint_epochs</span><span class="o">=</span><span class="mi">800</span>,</span><span class="param">	<span class="n">lr_mlp</span><span class="o">=</span><span class="mf">0.001</span>,</span><span class="param">	<span class="n">lr_nsa</span><span class="o">=</span><span class="mf">0.001</span>,</span><span class="param">	<span class="n">lr_joint</span><span class="o">=</span><span class="mf">0.0005</span>,</span><span class="param">	<span class="n">apply_nonneg</span><span class="o">=</span><span class="s1">&#39;hard&#39;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="test_mlp_then_nsa_joint_residual_v2-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#test_mlp_then_nsa_joint_residual_v2"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="test_mlp_then_nsa_joint_residual_v2-3358"><a href="#test_mlp_then_nsa_joint_residual_v2-3358"><span class="linenos">3358</span></a><span class="k">def</span><span class="w"> </span><span class="nf">test_mlp_then_nsa_joint_residual_v2</span><span class="p">(</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3359"><a href="#test_mlp_then_nsa_joint_residual_v2-3359"><span class="linenos">3359</span></a>    <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3360"><a href="#test_mlp_then_nsa_joint_residual_v2-3360"><span class="linenos">3360</span></a>    <span class="n">w</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3361"><a href="#test_mlp_then_nsa_joint_residual_v2-3361"><span class="linenos">3361</span></a>    <span class="n">n</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3362"><a href="#test_mlp_then_nsa_joint_residual_v2-3362"><span class="linenos">3362</span></a>    <span class="n">p</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3363"><a href="#test_mlp_then_nsa_joint_residual_v2-3363"><span class="linenos">3363</span></a>    <span class="n">k</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3364"><a href="#test_mlp_then_nsa_joint_residual_v2-3364"><span class="linenos">3364</span></a>    <span class="n">hidden</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3365"><a href="#test_mlp_then_nsa_joint_residual_v2-3365"><span class="linenos">3365</span></a>    <span class="n">noise</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3366"><a href="#test_mlp_then_nsa_joint_residual_v2-3366"><span class="linenos">3366</span></a>    <span class="n">mlp_epochs</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3367"><a href="#test_mlp_then_nsa_joint_residual_v2-3367"><span class="linenos">3367</span></a>    <span class="n">nsa_epochs</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3368"><a href="#test_mlp_then_nsa_joint_residual_v2-3368"><span class="linenos">3368</span></a>    <span class="n">joint_epochs</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3369"><a href="#test_mlp_then_nsa_joint_residual_v2-3369"><span class="linenos">3369</span></a>    <span class="n">lr_mlp</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3370"><a href="#test_mlp_then_nsa_joint_residual_v2-3370"><span class="linenos">3370</span></a>    <span class="n">lr_nsa</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3371"><a href="#test_mlp_then_nsa_joint_residual_v2-3371"><span class="linenos">3371</span></a>    <span class="n">lr_joint</span><span class="o">=</span><span class="mf">5e-4</span><span class="p">,</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3372"><a href="#test_mlp_then_nsa_joint_residual_v2-3372"><span class="linenos">3372</span></a>    <span class="n">apply_nonneg</span><span class="o">=</span><span class="s2">&quot;hard&quot;</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3373"><a href="#test_mlp_then_nsa_joint_residual_v2-3373"><span class="linenos">3373</span></a><span class="p">):</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3374"><a href="#test_mlp_then_nsa_joint_residual_v2-3374"><span class="linenos">3374</span></a>    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3375"><a href="#test_mlp_then_nsa_joint_residual_v2-3375"><span class="linenos">3375</span></a>    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3376"><a href="#test_mlp_then_nsa_joint_residual_v2-3376"><span class="linenos">3376</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3377"><a href="#test_mlp_then_nsa_joint_residual_v2-3377"><span class="linenos">3377</span></a>    <span class="c1"># === Synthetic nonlinear mapping ===</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3378"><a href="#test_mlp_then_nsa_joint_residual_v2-3378"><span class="linenos">3378</span></a>    <span class="n">W_true</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3379"><a href="#test_mlp_then_nsa_joint_residual_v2-3379"><span class="linenos">3379</span></a>    <span class="n">X</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3380"><a href="#test_mlp_then_nsa_joint_residual_v2-3380"><span class="linenos">3380</span></a>    <span class="n">Y_true</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softplus</span><span class="p">(</span><span class="n">X</span> <span class="o">@</span> <span class="n">W_true</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3381"><a href="#test_mlp_then_nsa_joint_residual_v2-3381"><span class="linenos">3381</span></a>    <span class="n">Y_obs</span> <span class="o">=</span> <span class="n">Y_true</span> <span class="o">+</span> <span class="n">noise</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">Y_true</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3382"><a href="#test_mlp_then_nsa_joint_residual_v2-3382"><span class="linenos">3382</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3383"><a href="#test_mlp_then_nsa_joint_residual_v2-3383"><span class="linenos">3383</span></a>    <span class="n">n_train</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.8</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3384"><a href="#test_mlp_then_nsa_joint_residual_v2-3384"><span class="linenos">3384</span></a>    <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:</span><span class="n">n_train</span><span class="p">],</span> <span class="n">X</span><span class="p">[</span><span class="n">n_train</span><span class="p">:]</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3385"><a href="#test_mlp_then_nsa_joint_residual_v2-3385"><span class="linenos">3385</span></a>    <span class="n">Y_train</span><span class="p">,</span> <span class="n">Y_test</span> <span class="o">=</span> <span class="n">Y_obs</span><span class="p">[:</span><span class="n">n_train</span><span class="p">],</span> <span class="n">Y_obs</span><span class="p">[</span><span class="n">n_train</span><span class="p">:]</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3386"><a href="#test_mlp_then_nsa_joint_residual_v2-3386"><span class="linenos">3386</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3387"><a href="#test_mlp_then_nsa_joint_residual_v2-3387"><span class="linenos">3387</span></a>    <span class="c1"># =====================================================</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3388"><a href="#test_mlp_then_nsa_joint_residual_v2-3388"><span class="linenos">3388</span></a>    <span class="c1"># Baseline MLP</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3389"><a href="#test_mlp_then_nsa_joint_residual_v2-3389"><span class="linenos">3389</span></a>    <span class="c1"># =====================================================</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3390"><a href="#test_mlp_then_nsa_joint_residual_v2-3390"><span class="linenos">3390</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Training MLP ===&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3391"><a href="#test_mlp_then_nsa_joint_residual_v2-3391"><span class="linenos">3391</span></a>    <span class="n">mlp</span> <span class="o">=</span> <span class="n">SimpleMLP</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">hidden</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3392"><a href="#test_mlp_then_nsa_joint_residual_v2-3392"><span class="linenos">3392</span></a>    <span class="n">opt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="n">mlp</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr_mlp</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3393"><a href="#test_mlp_then_nsa_joint_residual_v2-3393"><span class="linenos">3393</span></a>    <span class="n">mlp_losses</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3394"><a href="#test_mlp_then_nsa_joint_residual_v2-3394"><span class="linenos">3394</span></a>    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mlp_epochs</span><span class="p">):</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3395"><a href="#test_mlp_then_nsa_joint_residual_v2-3395"><span class="linenos">3395</span></a>        <span class="n">opt</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3396"><a href="#test_mlp_then_nsa_joint_residual_v2-3396"><span class="linenos">3396</span></a>        <span class="n">Y_pred</span> <span class="o">=</span> <span class="n">mlp</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3397"><a href="#test_mlp_then_nsa_joint_residual_v2-3397"><span class="linenos">3397</span></a>        <span class="n">loss</span> <span class="o">=</span> <span class="n">fidelity_scaled</span><span class="p">(</span><span class="n">Y_pred</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3398"><a href="#test_mlp_then_nsa_joint_residual_v2-3398"><span class="linenos">3398</span></a>        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3399"><a href="#test_mlp_then_nsa_joint_residual_v2-3399"><span class="linenos">3399</span></a>        <span class="n">opt</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3400"><a href="#test_mlp_then_nsa_joint_residual_v2-3400"><span class="linenos">3400</span></a>        <span class="n">mlp_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3401"><a href="#test_mlp_then_nsa_joint_residual_v2-3401"><span class="linenos">3401</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3402"><a href="#test_mlp_then_nsa_joint_residual_v2-3402"><span class="linenos">3402</span></a>    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3403"><a href="#test_mlp_then_nsa_joint_residual_v2-3403"><span class="linenos">3403</span></a>        <span class="n">Y_pred_mlp</span> <span class="o">=</span> <span class="n">mlp</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3404"><a href="#test_mlp_then_nsa_joint_residual_v2-3404"><span class="linenos">3404</span></a>        <span class="n">corr_mlp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">Y_pred_mlp</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">Y_test</span><span class="o">.</span><span class="n">flatten</span><span class="p">()]))[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3405"><a href="#test_mlp_then_nsa_joint_residual_v2-3405"><span class="linenos">3405</span></a>        <span class="n">mse_mlp</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">mse_loss</span><span class="p">(</span><span class="n">Y_pred_mlp</span><span class="p">,</span> <span class="n">Y_test</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3406"><a href="#test_mlp_then_nsa_joint_residual_v2-3406"><span class="linenos">3406</span></a>        <span class="n">var_true</span> <span class="o">=</span> <span class="n">Y_test</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3407"><a href="#test_mlp_then_nsa_joint_residual_v2-3407"><span class="linenos">3407</span></a>        <span class="n">r2_mlp</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">mse_mlp</span> <span class="o">/</span> <span class="n">var_true</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3408"><a href="#test_mlp_then_nsa_joint_residual_v2-3408"><span class="linenos">3408</span></a>        <span class="n">orth_mlp</span> <span class="o">=</span> <span class="n">invariant_orthogonality_defect</span><span class="p">(</span><span class="n">Y_pred_mlp</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3409"><a href="#test_mlp_then_nsa_joint_residual_v2-3409"><span class="linenos">3409</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3410"><a href="#test_mlp_then_nsa_joint_residual_v2-3410"><span class="linenos">3410</span></a>    <span class="c1"># =====================================================</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3411"><a href="#test_mlp_then_nsa_joint_residual_v2-3411"><span class="linenos">3411</span></a>    <span class="c1"># PCA baseline</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3412"><a href="#test_mlp_then_nsa_joint_residual_v2-3412"><span class="linenos">3412</span></a>    <span class="c1"># =====================================================</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3413"><a href="#test_mlp_then_nsa_joint_residual_v2-3413"><span class="linenos">3413</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== PCA regression baseline ===&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3414"><a href="#test_mlp_then_nsa_joint_residual_v2-3414"><span class="linenos">3414</span></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.decomposition</span><span class="w"> </span><span class="kn">import</span> <span class="n">PCA</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3415"><a href="#test_mlp_then_nsa_joint_residual_v2-3415"><span class="linenos">3415</span></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LinearRegression</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3416"><a href="#test_mlp_then_nsa_joint_residual_v2-3416"><span class="linenos">3416</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3417"><a href="#test_mlp_then_nsa_joint_residual_v2-3417"><span class="linenos">3417</span></a>    <span class="n">X_train_np</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3418"><a href="#test_mlp_then_nsa_joint_residual_v2-3418"><span class="linenos">3418</span></a>    <span class="n">Y_train_np</span> <span class="o">=</span> <span class="n">Y_train</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3419"><a href="#test_mlp_then_nsa_joint_residual_v2-3419"><span class="linenos">3419</span></a>    <span class="n">X_test_np</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3420"><a href="#test_mlp_then_nsa_joint_residual_v2-3420"><span class="linenos">3420</span></a>    <span class="n">Y_test_np</span> <span class="o">=</span> <span class="n">Y_test</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3421"><a href="#test_mlp_then_nsa_joint_residual_v2-3421"><span class="linenos">3421</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3422"><a href="#test_mlp_then_nsa_joint_residual_v2-3422"><span class="linenos">3422</span></a>    <span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3423"><a href="#test_mlp_then_nsa_joint_residual_v2-3423"><span class="linenos">3423</span></a>    <span class="n">Z_train</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train_np</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3424"><a href="#test_mlp_then_nsa_joint_residual_v2-3424"><span class="linenos">3424</span></a>    <span class="n">Z_test</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test_np</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3425"><a href="#test_mlp_then_nsa_joint_residual_v2-3425"><span class="linenos">3425</span></a>    <span class="n">reg</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Z_train</span><span class="p">,</span> <span class="n">Y_train_np</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3426"><a href="#test_mlp_then_nsa_joint_residual_v2-3426"><span class="linenos">3426</span></a>    <span class="n">Y_pred_pca</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">reg</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Z_test</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3427"><a href="#test_mlp_then_nsa_joint_residual_v2-3427"><span class="linenos">3427</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3428"><a href="#test_mlp_then_nsa_joint_residual_v2-3428"><span class="linenos">3428</span></a>    <span class="n">corr_pca</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">Y_pred_pca</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">Y_test</span><span class="o">.</span><span class="n">flatten</span><span class="p">()]))[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3429"><a href="#test_mlp_then_nsa_joint_residual_v2-3429"><span class="linenos">3429</span></a>    <span class="n">mse_pca</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">mse_loss</span><span class="p">(</span><span class="n">Y_pred_pca</span><span class="p">,</span> <span class="n">Y_test</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3430"><a href="#test_mlp_then_nsa_joint_residual_v2-3430"><span class="linenos">3430</span></a>    <span class="n">var_true</span> <span class="o">=</span> <span class="n">Y_test</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3431"><a href="#test_mlp_then_nsa_joint_residual_v2-3431"><span class="linenos">3431</span></a>    <span class="n">r2_pca</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">mse_pca</span> <span class="o">/</span> <span class="n">var_true</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3432"><a href="#test_mlp_then_nsa_joint_residual_v2-3432"><span class="linenos">3432</span></a>    <span class="n">orth_pca</span> <span class="o">=</span> <span class="n">invariant_orthogonality_defect</span><span class="p">(</span><span class="n">Y_pred_pca</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3433"><a href="#test_mlp_then_nsa_joint_residual_v2-3433"><span class="linenos">3433</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3434"><a href="#test_mlp_then_nsa_joint_residual_v2-3434"><span class="linenos">3434</span></a>    <span class="c1"># =====================================================</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3435"><a href="#test_mlp_then_nsa_joint_residual_v2-3435"><span class="linenos">3435</span></a>    <span class="c1"># NSA refinement</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3436"><a href="#test_mlp_then_nsa_joint_residual_v2-3436"><span class="linenos">3436</span></a>    <span class="c1"># =====================================================</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3437"><a href="#test_mlp_then_nsa_joint_residual_v2-3437"><span class="linenos">3437</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== NSA refinement ===&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3438"><a href="#test_mlp_then_nsa_joint_residual_v2-3438"><span class="linenos">3438</span></a>    <span class="n">nsa</span> <span class="o">=</span> <span class="n">NSAFlowLayer</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">w_retract</span><span class="o">=</span><span class="n">w</span><span class="p">,</span> <span class="n">apply_nonneg</span><span class="o">=</span><span class="n">apply_nonneg</span><span class="p">,</span> <span class="n">residual</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3439"><a href="#test_mlp_then_nsa_joint_residual_v2-3439"><span class="linenos">3439</span></a>    <span class="n">opt_nsa</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="n">nsa</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr_nsa</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3440"><a href="#test_mlp_then_nsa_joint_residual_v2-3440"><span class="linenos">3440</span></a>    <span class="n">nsa_losses</span><span class="p">,</span> <span class="n">nsa_fids</span><span class="p">,</span> <span class="n">nsa_orths</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3441"><a href="#test_mlp_then_nsa_joint_residual_v2-3441"><span class="linenos">3441</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3442"><a href="#test_mlp_then_nsa_joint_residual_v2-3442"><span class="linenos">3442</span></a>    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3443"><a href="#test_mlp_then_nsa_joint_residual_v2-3443"><span class="linenos">3443</span></a>        <span class="n">Y0</span> <span class="o">=</span> <span class="n">mlp</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3444"><a href="#test_mlp_then_nsa_joint_residual_v2-3444"><span class="linenos">3444</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3445"><a href="#test_mlp_then_nsa_joint_residual_v2-3445"><span class="linenos">3445</span></a>    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsa_epochs</span><span class="p">):</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3446"><a href="#test_mlp_then_nsa_joint_residual_v2-3446"><span class="linenos">3446</span></a>        <span class="n">opt_nsa</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3447"><a href="#test_mlp_then_nsa_joint_residual_v2-3447"><span class="linenos">3447</span></a>        <span class="n">Y_ref</span><span class="p">,</span> <span class="n">total_loss</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="n">orth</span><span class="p">,</span> <span class="n">w_dyn</span> <span class="o">=</span> <span class="n">nsa</span><span class="p">(</span><span class="n">Y0</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">Y_train</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3448"><a href="#test_mlp_then_nsa_joint_residual_v2-3448"><span class="linenos">3448</span></a>        <span class="n">total_loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3449"><a href="#test_mlp_then_nsa_joint_residual_v2-3449"><span class="linenos">3449</span></a>        <span class="n">opt_nsa</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3450"><a href="#test_mlp_then_nsa_joint_residual_v2-3450"><span class="linenos">3450</span></a>        <span class="n">nsa_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">total_loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3451"><a href="#test_mlp_then_nsa_joint_residual_v2-3451"><span class="linenos">3451</span></a>        <span class="n">nsa_fids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fid</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3452"><a href="#test_mlp_then_nsa_joint_residual_v2-3452"><span class="linenos">3452</span></a>        <span class="n">nsa_orths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orth</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3453"><a href="#test_mlp_then_nsa_joint_residual_v2-3453"><span class="linenos">3453</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3454"><a href="#test_mlp_then_nsa_joint_residual_v2-3454"><span class="linenos">3454</span></a>    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3455"><a href="#test_mlp_then_nsa_joint_residual_v2-3455"><span class="linenos">3455</span></a>        <span class="n">Y_pred_refined</span> <span class="o">=</span> <span class="n">nsa</span><span class="p">(</span><span class="n">mlp</span><span class="p">(</span><span class="n">X_test</span><span class="p">))</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3456"><a href="#test_mlp_then_nsa_joint_residual_v2-3456"><span class="linenos">3456</span></a>        <span class="n">corr_nsa</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">Y_pred_refined</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">Y_test</span><span class="o">.</span><span class="n">flatten</span><span class="p">()]))[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3457"><a href="#test_mlp_then_nsa_joint_residual_v2-3457"><span class="linenos">3457</span></a>        <span class="n">mse_nsa</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">mse_loss</span><span class="p">(</span><span class="n">Y_pred_refined</span><span class="p">,</span> <span class="n">Y_test</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3458"><a href="#test_mlp_then_nsa_joint_residual_v2-3458"><span class="linenos">3458</span></a>        <span class="n">var_true</span> <span class="o">=</span> <span class="n">Y_test</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3459"><a href="#test_mlp_then_nsa_joint_residual_v2-3459"><span class="linenos">3459</span></a>        <span class="n">r2_nsa</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">mse_nsa</span> <span class="o">/</span> <span class="n">var_true</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3460"><a href="#test_mlp_then_nsa_joint_residual_v2-3460"><span class="linenos">3460</span></a>        <span class="n">orth_nsa</span> <span class="o">=</span> <span class="n">invariant_orthogonality_defect</span><span class="p">(</span><span class="n">Y_pred_refined</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3461"><a href="#test_mlp_then_nsa_joint_residual_v2-3461"><span class="linenos">3461</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3462"><a href="#test_mlp_then_nsa_joint_residual_v2-3462"><span class="linenos">3462</span></a>    <span class="c1"># =====================================================</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3463"><a href="#test_mlp_then_nsa_joint_residual_v2-3463"><span class="linenos">3463</span></a>    <span class="c1"># Joint fine-tuning (learn   w_dyn evolution)</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3464"><a href="#test_mlp_then_nsa_joint_residual_v2-3464"><span class="linenos">3464</span></a>    <span class="c1"># =====================================================</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3465"><a href="#test_mlp_then_nsa_joint_residual_v2-3465"><span class="linenos">3465</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Joint fine-tuning ===&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3466"><a href="#test_mlp_then_nsa_joint_residual_v2-3466"><span class="linenos">3466</span></a>    <span class="n">joint_model</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">mlp</span><span class="p">,</span> <span class="n">nsa</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3467"><a href="#test_mlp_then_nsa_joint_residual_v2-3467"><span class="linenos">3467</span></a>    <span class="n">opt_joint</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="n">joint_model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr_joint</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3468"><a href="#test_mlp_then_nsa_joint_residual_v2-3468"><span class="linenos">3468</span></a>    <span class="n">joint_losses</span><span class="p">,</span> <span class="n">joint_fids</span><span class="p">,</span> <span class="n">joint_orths</span><span class="p">,</span> <span class="n">wdyn_trace</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3469"><a href="#test_mlp_then_nsa_joint_residual_v2-3469"><span class="linenos">3469</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3470"><a href="#test_mlp_then_nsa_joint_residual_v2-3470"><span class="linenos">3470</span></a>    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">joint_epochs</span><span class="p">):</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3471"><a href="#test_mlp_then_nsa_joint_residual_v2-3471"><span class="linenos">3471</span></a>        <span class="n">opt_joint</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3472"><a href="#test_mlp_then_nsa_joint_residual_v2-3472"><span class="linenos">3472</span></a>        <span class="n">Y_joint</span><span class="p">,</span> <span class="n">total_loss</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="n">orth</span><span class="p">,</span> <span class="n">w_dyn</span> <span class="o">=</span> <span class="n">nsa</span><span class="p">(</span><span class="n">mlp</span><span class="p">(</span><span class="n">X_train</span><span class="p">),</span> <span class="n">target</span><span class="o">=</span><span class="n">Y_train</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3473"><a href="#test_mlp_then_nsa_joint_residual_v2-3473"><span class="linenos">3473</span></a>        <span class="n">total_loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3474"><a href="#test_mlp_then_nsa_joint_residual_v2-3474"><span class="linenos">3474</span></a>        <span class="n">opt_joint</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3475"><a href="#test_mlp_then_nsa_joint_residual_v2-3475"><span class="linenos">3475</span></a>        <span class="n">joint_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">total_loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3476"><a href="#test_mlp_then_nsa_joint_residual_v2-3476"><span class="linenos">3476</span></a>        <span class="n">joint_fids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fid</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3477"><a href="#test_mlp_then_nsa_joint_residual_v2-3477"><span class="linenos">3477</span></a>        <span class="n">joint_orths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orth</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3478"><a href="#test_mlp_then_nsa_joint_residual_v2-3478"><span class="linenos">3478</span></a>        <span class="n">wdyn_trace</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w_dyn</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3479"><a href="#test_mlp_then_nsa_joint_residual_v2-3479"><span class="linenos">3479</span></a>        <span class="k">if</span> <span class="n">epoch</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3480"><a href="#test_mlp_then_nsa_joint_residual_v2-3480"><span class="linenos">3480</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Joint </span><span class="si">{</span><span class="n">epoch</span><span class="si">:</span><span class="s2">04d</span><span class="si">}</span><span class="s2">] loss=</span><span class="si">{</span><span class="n">total_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2"> fid=</span><span class="si">{</span><span class="n">fid</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2"> orth=</span><span class="si">{</span><span class="n">orth</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2"> w_dyn=</span><span class="si">{</span><span class="n">w_dyn</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3481"><a href="#test_mlp_then_nsa_joint_residual_v2-3481"><span class="linenos">3481</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3482"><a href="#test_mlp_then_nsa_joint_residual_v2-3482"><span class="linenos">3482</span></a>    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3483"><a href="#test_mlp_then_nsa_joint_residual_v2-3483"><span class="linenos">3483</span></a>        <span class="n">Y_pred_joint</span> <span class="o">=</span> <span class="n">joint_model</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3484"><a href="#test_mlp_then_nsa_joint_residual_v2-3484"><span class="linenos">3484</span></a>        <span class="n">corr_joint</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">Y_pred_joint</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">Y_test</span><span class="o">.</span><span class="n">flatten</span><span class="p">()]))[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3485"><a href="#test_mlp_then_nsa_joint_residual_v2-3485"><span class="linenos">3485</span></a>        <span class="n">mse_joint</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">mse_loss</span><span class="p">(</span><span class="n">Y_pred_joint</span><span class="p">,</span> <span class="n">Y_test</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3486"><a href="#test_mlp_then_nsa_joint_residual_v2-3486"><span class="linenos">3486</span></a>        <span class="n">var_true</span> <span class="o">=</span> <span class="n">Y_test</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3487"><a href="#test_mlp_then_nsa_joint_residual_v2-3487"><span class="linenos">3487</span></a>        <span class="n">r2_joint</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">mse_joint</span> <span class="o">/</span> <span class="n">var_true</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3488"><a href="#test_mlp_then_nsa_joint_residual_v2-3488"><span class="linenos">3488</span></a>        <span class="n">orth_joint</span> <span class="o">=</span> <span class="n">invariant_orthogonality_defect</span><span class="p">(</span><span class="n">Y_pred_joint</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3489"><a href="#test_mlp_then_nsa_joint_residual_v2-3489"><span class="linenos">3489</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3490"><a href="#test_mlp_then_nsa_joint_residual_v2-3490"><span class="linenos">3490</span></a>    <span class="c1"># =====================================================</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3491"><a href="#test_mlp_then_nsa_joint_residual_v2-3491"><span class="linenos">3491</span></a>    <span class="c1">#  Summary table</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3492"><a href="#test_mlp_then_nsa_joint_residual_v2-3492"><span class="linenos">3492</span></a>    <span class="c1"># =====================================================</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3493"><a href="#test_mlp_then_nsa_joint_residual_v2-3493"><span class="linenos">3493</span></a>    <span class="n">summary</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3494"><a href="#test_mlp_then_nsa_joint_residual_v2-3494"><span class="linenos">3494</span></a>        <span class="p">[</span><span class="s2">&quot;PCA&quot;</span><span class="p">,</span> <span class="n">corr_pca</span><span class="p">,</span> <span class="n">r2_pca</span><span class="p">,</span> <span class="n">mse_pca</span><span class="p">,</span> <span class="n">orth_pca</span><span class="p">],</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3495"><a href="#test_mlp_then_nsa_joint_residual_v2-3495"><span class="linenos">3495</span></a>        <span class="p">[</span><span class="s2">&quot;MLP&quot;</span><span class="p">,</span> <span class="n">corr_mlp</span><span class="p">,</span> <span class="n">r2_mlp</span><span class="p">,</span> <span class="n">mse_mlp</span><span class="p">,</span> <span class="n">orth_mlp</span><span class="p">],</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3496"><a href="#test_mlp_then_nsa_joint_residual_v2-3496"><span class="linenos">3496</span></a>        <span class="p">[</span><span class="s2">&quot;MLP+NSA&quot;</span><span class="p">,</span> <span class="n">corr_nsa</span><span class="p">,</span> <span class="n">r2_nsa</span><span class="p">,</span> <span class="n">mse_nsa</span><span class="p">,</span> <span class="n">orth_nsa</span><span class="p">],</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3497"><a href="#test_mlp_then_nsa_joint_residual_v2-3497"><span class="linenos">3497</span></a>        <span class="p">[</span><span class="s2">&quot;Joint&quot;</span><span class="p">,</span> <span class="n">corr_joint</span><span class="p">,</span> <span class="n">r2_joint</span><span class="p">,</span> <span class="n">mse_joint</span><span class="p">,</span> <span class="n">orth_joint</span><span class="p">],</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3498"><a href="#test_mlp_then_nsa_joint_residual_v2-3498"><span class="linenos">3498</span></a>    <span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Model&quot;</span><span class="p">,</span> <span class="s2">&quot;Corr&quot;</span><span class="p">,</span> <span class="s2">&quot;R2&quot;</span><span class="p">,</span> <span class="s2">&quot;MSE&quot;</span><span class="p">,</span> <span class="s2">&quot;OrthDefect&quot;</span><span class="p">])</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3499"><a href="#test_mlp_then_nsa_joint_residual_v2-3499"><span class="linenos">3499</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Quantitative Summary ===&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3500"><a href="#test_mlp_then_nsa_joint_residual_v2-3500"><span class="linenos">3500</span></a>    <span class="nb">print</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3501"><a href="#test_mlp_then_nsa_joint_residual_v2-3501"><span class="linenos">3501</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3502"><a href="#test_mlp_then_nsa_joint_residual_v2-3502"><span class="linenos">3502</span></a>    <span class="c1"># =====================================================</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3503"><a href="#test_mlp_then_nsa_joint_residual_v2-3503"><span class="linenos">3503</span></a>    <span class="c1">#  Visualization suite</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3504"><a href="#test_mlp_then_nsa_joint_residual_v2-3504"><span class="linenos">3504</span></a>    <span class="c1"># =====================================================</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3505"><a href="#test_mlp_then_nsa_joint_residual_v2-3505"><span class="linenos">3505</span></a>    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3506"><a href="#test_mlp_then_nsa_joint_residual_v2-3506"><span class="linenos">3506</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3507"><a href="#test_mlp_then_nsa_joint_residual_v2-3507"><span class="linenos">3507</span></a>    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mlp_losses</span><span class="p">);</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;MLP Loss&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3508"><a href="#test_mlp_then_nsa_joint_residual_v2-3508"><span class="linenos">3508</span></a>    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">nsa_losses</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Total&quot;</span><span class="p">);</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">nsa_fids</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Fid&quot;</span><span class="p">);</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">nsa_orths</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Orth&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3509"><a href="#test_mlp_then_nsa_joint_residual_v2-3509"><span class="linenos">3509</span></a>    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;NSA Refinement&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3510"><a href="#test_mlp_then_nsa_joint_residual_v2-3510"><span class="linenos">3510</span></a>    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">joint_losses</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Total&quot;</span><span class="p">);</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">joint_fids</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Fid&quot;</span><span class="p">);</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">joint_orths</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Orth&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3511"><a href="#test_mlp_then_nsa_joint_residual_v2-3511"><span class="linenos">3511</span></a>    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Joint Fine-tune&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3512"><a href="#test_mlp_then_nsa_joint_residual_v2-3512"><span class="linenos">3512</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3513"><a href="#test_mlp_then_nsa_joint_residual_v2-3513"><span class="linenos">3513</span></a>    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">Y_test</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">Y_pred_mlp</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;MLP r=</span><span class="si">{</span><span class="n">corr_mlp</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3514"><a href="#test_mlp_then_nsa_joint_residual_v2-3514"><span class="linenos">3514</span></a>    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">Y_test</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">Y_pred_refined</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;MLP+NSA r=</span><span class="si">{</span><span class="n">corr_nsa</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3515"><a href="#test_mlp_then_nsa_joint_residual_v2-3515"><span class="linenos">3515</span></a>    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">Y_test</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">Y_pred_joint</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Joint r=</span><span class="si">{</span><span class="n">corr_joint</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3516"><a href="#test_mlp_then_nsa_joint_residual_v2-3516"><span class="linenos">3516</span></a>    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Pred vs True (Test)&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3517"><a href="#test_mlp_then_nsa_joint_residual_v2-3517"><span class="linenos">3517</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3518"><a href="#test_mlp_then_nsa_joint_residual_v2-3518"><span class="linenos">3518</span></a>    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wdyn_trace</span><span class="p">);</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;w_dyn Evolution (sigmoid())&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3519"><a href="#test_mlp_then_nsa_joint_residual_v2-3519"><span class="linenos">3519</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3520"><a href="#test_mlp_then_nsa_joint_residual_v2-3520"><span class="linenos">3520</span></a>    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">Y_pred_joint</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;coolwarm&quot;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3521"><a href="#test_mlp_then_nsa_joint_residual_v2-3521"><span class="linenos">3521</span></a>    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Column Correlation Heatmap&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3522"><a href="#test_mlp_then_nsa_joint_residual_v2-3522"><span class="linenos">3522</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3523"><a href="#test_mlp_then_nsa_joint_residual_v2-3523"><span class="linenos">3523</span></a>    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">Y_pred_joint</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">bins</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">);</span> <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Output Distribution&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3524"><a href="#test_mlp_then_nsa_joint_residual_v2-3524"><span class="linenos">3524</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3525"><a href="#test_mlp_then_nsa_joint_residual_v2-3525"><span class="linenos">3525</span></a>    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">pca</span><span class="o">.</span><span class="n">components_</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;coolwarm&#39;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3526"><a href="#test_mlp_then_nsa_joint_residual_v2-3526"><span class="linenos">3526</span></a>    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;PCA Components&quot;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3527"><a href="#test_mlp_then_nsa_joint_residual_v2-3527"><span class="linenos">3527</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3528"><a href="#test_mlp_then_nsa_joint_residual_v2-3528"><span class="linenos">3528</span></a>    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3529"><a href="#test_mlp_then_nsa_joint_residual_v2-3529"><span class="linenos">3529</span></a>    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">cellText</span><span class="o">=</span><span class="n">summary</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">colLabels</span><span class="o">=</span><span class="n">summary</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3530"><a href="#test_mlp_then_nsa_joint_residual_v2-3530"><span class="linenos">3530</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3531"><a href="#test_mlp_then_nsa_joint_residual_v2-3531"><span class="linenos">3531</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3532"><a href="#test_mlp_then_nsa_joint_residual_v2-3532"><span class="linenos">3532</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3533"><a href="#test_mlp_then_nsa_joint_residual_v2-3533"><span class="linenos">3533</span></a>
</span><span id="test_mlp_then_nsa_joint_residual_v2-3534"><a href="#test_mlp_then_nsa_joint_residual_v2-3534"><span class="linenos">3534</span></a>    <span class="k">return</span> <span class="n">summary</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">Y_pred_joint</span><span class="o">=</span><span class="n">Y_pred_joint</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">wdyn_trace</span><span class="o">=</span><span class="n">wdyn_trace</span><span class="p">)</span>
</span></pre></div>


    

                </section>
                <section id="fidelity_scaled">
                            <input id="fidelity_scaled-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">fidelity_scaled</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">Y</span>, </span><span class="param"><span class="n">X</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="fidelity_scaled-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#fidelity_scaled"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="fidelity_scaled-106"><a href="#fidelity_scaled-106"><span class="linenos">106</span></a><span class="k">def</span><span class="w"> </span><span class="nf">fidelity_scaled</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
</span><span id="fidelity_scaled-107"><a href="#fidelity_scaled-107"><span class="linenos">107</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;||Y - X|| / ||X||&quot;&quot;&quot;</span>
</span><span id="fidelity_scaled-108"><a href="#fidelity_scaled-108"><span class="linenos">108</span></a>    <span class="n">denom</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">clamp_min</span><span class="p">(</span><span class="mf">1e-12</span><span class="p">)</span>
</span><span id="fidelity_scaled-109"><a href="#fidelity_scaled-109"><span class="linenos">109</span></a>    <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">Y</span> <span class="o">-</span> <span class="n">X</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">denom</span>
</span></pre></div>


            <div class="docstring"><p>||Y - X|| / ||X||</p>
</div>


                </section>
                <section id="fidelity_symmetric">
                            <input id="fidelity_symmetric-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">fidelity_symmetric</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">Y</span>, </span><span class="param"><span class="n">X</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="fidelity_symmetric-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#fidelity_symmetric"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="fidelity_symmetric-111"><a href="#fidelity_symmetric-111"><span class="linenos">111</span></a><span class="k">def</span><span class="w"> </span><span class="nf">fidelity_symmetric</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
</span><span id="fidelity_symmetric-112"><a href="#fidelity_symmetric-112"><span class="linenos">112</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;||Y - X|| / (||X|| + ||Y||)&quot;&quot;&quot;</span>
</span><span id="fidelity_symmetric-113"><a href="#fidelity_symmetric-113"><span class="linenos">113</span></a>    <span class="n">denom</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">clamp_min</span><span class="p">(</span><span class="mf">1e-12</span><span class="p">)</span>
</span><span id="fidelity_symmetric-114"><a href="#fidelity_symmetric-114"><span class="linenos">114</span></a>    <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">Y</span> <span class="o">-</span> <span class="n">X</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">denom</span>
</span></pre></div>


            <div class="docstring"><p>||Y - X|| / (||X|| + ||Y||)</p>
</div>


                </section>
                <section id="nsa_flow_orth">
                            <input id="nsa_flow_orth-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">nsa_flow_orth</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">Y0</span>,</span><span class="param">	<span class="n">X0</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">w</span><span class="o">=</span><span class="mf">0.5</span>,</span><span class="param">	<span class="n">retraction</span><span class="o">=</span><span class="s1">&#39;soft_polar&#39;</span>,</span><span class="param">	<span class="n">max_iter</span><span class="o">=</span><span class="mi">500</span>,</span><span class="param">	<span class="n">tol</span><span class="o">=</span><span class="mf">0.0001</span>,</span><span class="param">	<span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">seed</span><span class="o">=</span><span class="mi">42</span>,</span><span class="param">	<span class="n">apply_nonneg</span><span class="o">=</span><span class="s1">&#39;hard&#39;</span>,</span><span class="param">	<span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;asgd&#39;</span>,</span><span class="param">	<span class="n">initial_learning_rate</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">lr_strategy</span><span class="o">=</span><span class="s1">&#39;bayes&#39;</span>,</span><span class="param">	<span class="n">fidelity_type</span><span class="o">=</span><span class="s1">&#39;scale_invariant&#39;</span>,</span><span class="param">	<span class="n">orth_type</span><span class="o">=</span><span class="s1">&#39;scale_invariant&#39;</span>,</span><span class="param">	<span class="n">aggression</span><span class="o">=</span><span class="mf">0.5</span>,</span><span class="param">	<span class="n">record_every</span><span class="o">=</span><span class="mi">1</span>,</span><span class="param">	<span class="n">window_size</span><span class="o">=</span><span class="mi">10</span>,</span><span class="param">	<span class="n">warmup_iters</span><span class="o">=</span><span class="mi">0</span>,</span><span class="param">	<span class="n">device</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">precision</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="nsa_flow_orth-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#nsa_flow_orth"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="nsa_flow_orth-1376"><a href="#nsa_flow_orth-1376"><span class="linenos">1376</span></a><span class="k">def</span><span class="w"> </span><span class="nf">nsa_flow_orth</span><span class="p">(</span>
</span><span id="nsa_flow_orth-1377"><a href="#nsa_flow_orth-1377"><span class="linenos">1377</span></a>    <span class="n">Y0</span><span class="p">,</span> <span class="n">X0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1378"><a href="#nsa_flow_orth-1378"><span class="linenos">1378</span></a>    <span class="n">retraction</span><span class="o">=</span><span class="s2">&quot;soft_polar&quot;</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1379"><a href="#nsa_flow_orth-1379"><span class="linenos">1379</span></a>    <span class="n">max_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1380"><a href="#nsa_flow_orth-1380"><span class="linenos">1380</span></a>    <span class="n">apply_nonneg</span><span class="o">=</span><span class="s1">&#39;hard&#39;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;asgd&quot;</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1381"><a href="#nsa_flow_orth-1381"><span class="linenos">1381</span></a>    <span class="n">initial_learning_rate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
</span><span id="nsa_flow_orth-1382"><a href="#nsa_flow_orth-1382"><span class="linenos">1382</span></a>    <span class="n">lr_strategy</span><span class="o">=</span><span class="s2">&quot;bayes&quot;</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1383"><a href="#nsa_flow_orth-1383"><span class="linenos">1383</span></a>    <span class="n">fidelity_type</span><span class="o">=</span><span class="s2">&quot;scale_invariant&quot;</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1384"><a href="#nsa_flow_orth-1384"><span class="linenos">1384</span></a>    <span class="n">orth_type</span><span class="o">=</span><span class="s2">&quot;scale_invariant&quot;</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1385"><a href="#nsa_flow_orth-1385"><span class="linenos">1385</span></a>    <span class="n">aggression</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1386"><a href="#nsa_flow_orth-1386"><span class="linenos">1386</span></a>    <span class="n">record_every</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
</span><span id="nsa_flow_orth-1387"><a href="#nsa_flow_orth-1387"><span class="linenos">1387</span></a>    <span class="n">window_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1388"><a href="#nsa_flow_orth-1388"><span class="linenos">1388</span></a>    <span class="n">warmup_iters</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1389"><a href="#nsa_flow_orth-1389"><span class="linenos">1389</span></a>    <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
</span><span id="nsa_flow_orth-1390"><a href="#nsa_flow_orth-1390"><span class="linenos">1390</span></a>    <span class="n">precision</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span>
</span><span id="nsa_flow_orth-1391"><a href="#nsa_flow_orth-1391"><span class="linenos">1391</span></a><span class="p">):</span>
</span><span id="nsa_flow_orth-1392"><a href="#nsa_flow_orth-1392"><span class="linenos">1392</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="nsa_flow_orth-1393"><a href="#nsa_flow_orth-1393"><span class="linenos">1393</span></a><span class="sd">    Autograd-compatible NSA-Flow (modular energy version).</span>
</span><span id="nsa_flow_orth-1394"><a href="#nsa_flow_orth-1394"><span class="linenos">1394</span></a><span class="sd">    Allows user-specified fidelity_type and orth_type.</span>
</span><span id="nsa_flow_orth-1395"><a href="#nsa_flow_orth-1395"><span class="linenos">1395</span></a>
</span><span id="nsa_flow_orth-1396"><a href="#nsa_flow_orth-1396"><span class="linenos">1396</span></a><span class="sd">    fidelity_type  {&quot;basic&quot;, &quot;scale_invariant&quot;, &quot;symmetric&quot;}</span>
</span><span id="nsa_flow_orth-1397"><a href="#nsa_flow_orth-1397"><span class="linenos">1397</span></a><span class="sd">    orth_type  {&quot;basic&quot;, &quot;scale_invariant&quot;}</span>
</span><span id="nsa_flow_orth-1398"><a href="#nsa_flow_orth-1398"><span class="linenos">1398</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="nsa_flow_orth-1399"><a href="#nsa_flow_orth-1399"><span class="linenos">1399</span></a>
</span><span id="nsa_flow_orth-1400"><a href="#nsa_flow_orth-1400"><span class="linenos">1400</span></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">torch</span><span class="o">,</span><span class="w"> </span><span class="nn">time</span>
</span><span id="nsa_flow_orth-1401"><a href="#nsa_flow_orth-1401"><span class="linenos">1401</span></a>
</span><span id="nsa_flow_orth-1402"><a href="#nsa_flow_orth-1402"><span class="linenos">1402</span></a>    <span class="c1"># --- Precision and reproducibility ---</span>
</span><span id="nsa_flow_orth-1403"><a href="#nsa_flow_orth-1403"><span class="linenos">1403</span></a>    <span class="k">if</span> <span class="n">precision</span> <span class="o">==</span> <span class="s2">&quot;float32&quot;</span><span class="p">:</span>
</span><span id="nsa_flow_orth-1404"><a href="#nsa_flow_orth-1404"><span class="linenos">1404</span></a>        <span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float32</span>
</span><span id="nsa_flow_orth-1405"><a href="#nsa_flow_orth-1405"><span class="linenos">1405</span></a>    <span class="k">elif</span> <span class="n">precision</span> <span class="o">==</span> <span class="s2">&quot;float64&quot;</span><span class="p">:</span>
</span><span id="nsa_flow_orth-1406"><a href="#nsa_flow_orth-1406"><span class="linenos">1406</span></a>        <span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float64</span>
</span><span id="nsa_flow_orth-1407"><a href="#nsa_flow_orth-1407"><span class="linenos">1407</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="nsa_flow_orth-1408"><a href="#nsa_flow_orth-1408"><span class="linenos">1408</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;precision must be &#39;float32&#39; or &#39;float64&#39;&quot;</span><span class="p">)</span>
</span><span id="nsa_flow_orth-1409"><a href="#nsa_flow_orth-1409"><span class="linenos">1409</span></a>
</span><span id="nsa_flow_orth-1410"><a href="#nsa_flow_orth-1410"><span class="linenos">1410</span></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span><span class="o">,</span><span class="w"> </span><span class="nn">torch</span><span class="o">,</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
</span><span id="nsa_flow_orth-1411"><a href="#nsa_flow_orth-1411"><span class="linenos">1411</span></a>
</span><span id="nsa_flow_orth-1412"><a href="#nsa_flow_orth-1412"><span class="linenos">1412</span></a>    <span class="n">Y0</span> <span class="o">=</span> <span class="n">safe_to_tensor</span><span class="p">(</span><span class="n">Y0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Y0&quot;</span><span class="p">)</span>
</span><span id="nsa_flow_orth-1413"><a href="#nsa_flow_orth-1413"><span class="linenos">1413</span></a>    <span class="k">if</span> <span class="n">X0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="nsa_flow_orth-1414"><a href="#nsa_flow_orth-1414"><span class="linenos">1414</span></a>        <span class="n">X0</span> <span class="o">=</span> <span class="n">safe_to_tensor</span><span class="p">(</span><span class="n">X0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;X0&quot;</span><span class="p">)</span>
</span><span id="nsa_flow_orth-1415"><a href="#nsa_flow_orth-1415"><span class="linenos">1415</span></a>
</span><span id="nsa_flow_orth-1416"><a href="#nsa_flow_orth-1416"><span class="linenos">1416</span></a>    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
</span><span id="nsa_flow_orth-1417"><a href="#nsa_flow_orth-1417"><span class="linenos">1417</span></a>    <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="nsa_flow_orth-1418"><a href="#nsa_flow_orth-1418"><span class="linenos">1418</span></a>        <span class="n">device</span> <span class="o">=</span> <span class="n">Y0</span><span class="o">.</span><span class="n">device</span>
</span><span id="nsa_flow_orth-1419"><a href="#nsa_flow_orth-1419"><span class="linenos">1419</span></a>
</span><span id="nsa_flow_orth-1420"><a href="#nsa_flow_orth-1420"><span class="linenos">1420</span></a>    <span class="c1"># --- Initialization ---</span>
</span><span id="nsa_flow_orth-1421"><a href="#nsa_flow_orth-1421"><span class="linenos">1421</span></a>    <span class="n">Y</span> <span class="o">=</span> <span class="n">Y0</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="nsa_flow_orth-1422"><a href="#nsa_flow_orth-1422"><span class="linenos">1422</span></a>    <span class="n">p</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span>
</span><span id="nsa_flow_orth-1423"><a href="#nsa_flow_orth-1423"><span class="linenos">1423</span></a>
</span><span id="nsa_flow_orth-1424"><a href="#nsa_flow_orth-1424"><span class="linenos">1424</span></a>    <span class="k">if</span> <span class="n">X0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="nsa_flow_orth-1425"><a href="#nsa_flow_orth-1425"><span class="linenos">1425</span></a>        <span class="n">X0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">apply_nonneg</span> <span class="k">else</span> <span class="n">Y</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="nsa_flow_orth-1426"><a href="#nsa_flow_orth-1426"><span class="linenos">1426</span></a>        <span class="n">perturb_scale</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.05</span>
</span><span id="nsa_flow_orth-1427"><a href="#nsa_flow_orth-1427"><span class="linenos">1427</span></a>        <span class="n">Y</span> <span class="o">=</span> <span class="n">Y</span> <span class="o">+</span> <span class="n">perturb_scale</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
</span><span id="nsa_flow_orth-1428"><a href="#nsa_flow_orth-1428"><span class="linenos">1428</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="nsa_flow_orth-1429"><a href="#nsa_flow_orth-1429"><span class="linenos">1429</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Added perturbation to Y0.&quot;</span><span class="p">)</span>
</span><span id="nsa_flow_orth-1430"><a href="#nsa_flow_orth-1430"><span class="linenos">1430</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="nsa_flow_orth-1431"><a href="#nsa_flow_orth-1431"><span class="linenos">1431</span></a>        <span class="n">X0</span> <span class="o">=</span> <span class="n">X0</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="nsa_flow_orth-1432"><a href="#nsa_flow_orth-1432"><span class="linenos">1432</span></a>        <span class="k">if</span> <span class="n">apply_nonneg</span><span class="p">:</span>
</span><span id="nsa_flow_orth-1433"><a href="#nsa_flow_orth-1433"><span class="linenos">1433</span></a>            <span class="n">X0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">X0</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="nsa_flow_orth-1434"><a href="#nsa_flow_orth-1434"><span class="linenos">1434</span></a>        <span class="k">assert</span> <span class="n">X0</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s2">&quot;X0 must match Y0 shape.&quot;</span>
</span><span id="nsa_flow_orth-1435"><a href="#nsa_flow_orth-1435"><span class="linenos">1435</span></a>
</span><span id="nsa_flow_orth-1436"><a href="#nsa_flow_orth-1436"><span class="linenos">1436</span></a>    <span class="c1"># --- Normalize for scale invariance ---</span>
</span><span id="nsa_flow_orth-1437"><a href="#nsa_flow_orth-1437"><span class="linenos">1437</span></a>    <span class="n">scale_ref</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X0</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">X0</span><span class="o">.</span><span class="n">numel</span><span class="p">())</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">+</span> <span class="mf">1e-12</span>
</span><span id="nsa_flow_orth-1438"><a href="#nsa_flow_orth-1438"><span class="linenos">1438</span></a>    <span class="n">X0</span> <span class="o">=</span> <span class="n">X0</span> <span class="o">/</span> <span class="n">scale_ref</span>
</span><span id="nsa_flow_orth-1439"><a href="#nsa_flow_orth-1439"><span class="linenos">1439</span></a>    <span class="n">Y</span> <span class="o">=</span> <span class="n">Y</span> <span class="o">/</span> <span class="n">scale_ref</span>
</span><span id="nsa_flow_orth-1440"><a href="#nsa_flow_orth-1440"><span class="linenos">1440</span></a>
</span><span id="nsa_flow_orth-1441"><a href="#nsa_flow_orth-1441"><span class="linenos">1441</span></a>    <span class="c1"># --- Default scaling constants ---</span>
</span><span id="nsa_flow_orth-1442"><a href="#nsa_flow_orth-1442"><span class="linenos">1442</span></a>    <span class="n">g0</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">Y</span> <span class="o">-</span> <span class="n">X0</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="n">k</span><span class="p">)</span>
</span><span id="nsa_flow_orth-1443"><a href="#nsa_flow_orth-1443"><span class="linenos">1443</span></a>    <span class="n">g0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">g0</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">)</span>
</span><span id="nsa_flow_orth-1444"><a href="#nsa_flow_orth-1444"><span class="linenos">1444</span></a>    <span class="n">d0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">defect_fast</span><span class="p">(</span><span class="n">Y</span><span class="p">),</span> <span class="nb">min</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">)</span>
</span><span id="nsa_flow_orth-1445"><a href="#nsa_flow_orth-1445"><span class="linenos">1445</span></a>    <span class="n">fid_eta</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">w</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">g0</span> <span class="o">*</span> <span class="n">p</span> <span class="o">*</span> <span class="n">k</span><span class="p">)</span>
</span><span id="nsa_flow_orth-1446"><a href="#nsa_flow_orth-1446"><span class="linenos">1446</span></a>    <span class="n">c_orth</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">w</span> <span class="o">/</span> <span class="n">d0</span>
</span><span id="nsa_flow_orth-1447"><a href="#nsa_flow_orth-1447"><span class="linenos">1447</span></a>
</span><span id="nsa_flow_orth-1448"><a href="#nsa_flow_orth-1448"><span class="linenos">1448</span></a>    <span class="c1"># --- Optimization variable ---</span>
</span><span id="nsa_flow_orth-1449"><a href="#nsa_flow_orth-1449"><span class="linenos">1449</span></a>    <span class="n">Z</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span>
</span><span id="nsa_flow_orth-1450"><a href="#nsa_flow_orth-1450"><span class="linenos">1450</span></a>    <span class="n">lrscl</span><span class="o">=</span><span class="n">lr</span><span class="o">=</span><span class="mf">1.</span>
</span><span id="nsa_flow_orth-1451"><a href="#nsa_flow_orth-1451"><span class="linenos">1451</span></a>    <span class="n">w_use</span> <span class="o">=</span> <span class="n">w</span>
</span><span id="nsa_flow_orth-1452"><a href="#nsa_flow_orth-1452"><span class="linenos">1452</span></a>    <span class="k">if</span> <span class="n">warmup_iters</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="nsa_flow_orth-1453"><a href="#nsa_flow_orth-1453"><span class="linenos">1453</span></a>        <span class="n">w_use</span> <span class="o">=</span> <span class="mf">0.5</span>
</span><span id="nsa_flow_orth-1454"><a href="#nsa_flow_orth-1454"><span class="linenos">1454</span></a>        <span class="n">Z</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span>
</span><span id="nsa_flow_orth-1455"><a href="#nsa_flow_orth-1455"><span class="linenos">1455</span></a>        <span class="n">opt</span> <span class="o">=</span> <span class="n">get_torch_optimizer</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="p">[</span><span class="n">Z</span><span class="p">],</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">)</span>
</span><span id="nsa_flow_orth-1456"><a href="#nsa_flow_orth-1456"><span class="linenos">1456</span></a>        <span class="c1"># ---------------------------------------------------------------------</span>
</span><span id="nsa_flow_orth-1457"><a href="#nsa_flow_orth-1457"><span class="linenos">1457</span></a>        <span class="c1">#  WARMUP PHASE: Estimate relative scaling between fidelity &amp; orth terms</span>
</span><span id="nsa_flow_orth-1458"><a href="#nsa_flow_orth-1458"><span class="linenos">1458</span></a>        <span class="c1"># ---------------------------------------------------------------------</span>
</span><span id="nsa_flow_orth-1459"><a href="#nsa_flow_orth-1459"><span class="linenos">1459</span></a>        <span class="c1"># Use neutral scalars during warmup</span>
</span><span id="nsa_flow_orth-1460"><a href="#nsa_flow_orth-1460"><span class="linenos">1460</span></a>        <span class="n">fid_eta</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="nsa_flow_orth-1461"><a href="#nsa_flow_orth-1461"><span class="linenos">1461</span></a>        <span class="n">c_orth</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="nsa_flow_orth-1462"><a href="#nsa_flow_orth-1462"><span class="linenos">1462</span></a>        <span class="k">for</span> <span class="n">_round</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
</span><span id="nsa_flow_orth-1463"><a href="#nsa_flow_orth-1463"><span class="linenos">1463</span></a>            <span class="n">warmup_fids</span><span class="p">,</span> <span class="n">warmup_orths</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="nsa_flow_orth-1464"><a href="#nsa_flow_orth-1464"><span class="linenos">1464</span></a>            <span class="k">if</span> <span class="n">warmup_iters</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="nsa_flow_orth-1465"><a href="#nsa_flow_orth-1465"><span class="linenos">1465</span></a>                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="nsa_flow_orth-1466"><a href="#nsa_flow_orth-1466"><span class="linenos">1466</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Warmup (</span><span class="si">{</span><span class="n">warmup_iters</span><span class="si">}</span><span class="s2"> iters) to estimate weights ===&quot;</span><span class="p">)</span>
</span><span id="nsa_flow_orth-1467"><a href="#nsa_flow_orth-1467"><span class="linenos">1467</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; init fid_eta=</span><span class="si">{</span><span class="n">fid_eta</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">, c_orth=</span><span class="si">{</span><span class="n">c_orth</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">, lr=</span><span class="si">{</span><span class="n">lr</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="nsa_flow_orth-1468"><a href="#nsa_flow_orth-1468"><span class="linenos">1468</span></a>
</span><span id="nsa_flow_orth-1469"><a href="#nsa_flow_orth-1469"><span class="linenos">1469</span></a>                <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">warmup_iters</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="nsa_flow_orth-1470"><a href="#nsa_flow_orth-1470"><span class="linenos">1470</span></a>                    <span class="n">opt</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
</span><span id="nsa_flow_orth-1471"><a href="#nsa_flow_orth-1471"><span class="linenos">1471</span></a>                    <span class="n">Y_retracted</span> <span class="o">=</span> <span class="n">nsa_flow_retract_auto</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">w_use</span><span class="p">,</span> <span class="n">retraction</span><span class="p">)</span>
</span><span id="nsa_flow_orth-1472"><a href="#nsa_flow_orth-1472"><span class="linenos">1472</span></a>                    <span class="n">Y_retracted</span> <span class="o">=</span> <span class="n">apply_nonnegativity</span><span class="p">(</span><span class="n">Y_retracted</span><span class="p">,</span> <span class="n">apply_nonneg</span><span class="p">)</span>
</span><span id="nsa_flow_orth-1473"><a href="#nsa_flow_orth-1473"><span class="linenos">1473</span></a>                    <span class="n">total_energy</span> <span class="o">=</span> <span class="n">compute_energy</span><span class="p">(</span>
</span><span id="nsa_flow_orth-1474"><a href="#nsa_flow_orth-1474"><span class="linenos">1474</span></a>                        <span class="n">Y_retracted</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1475"><a href="#nsa_flow_orth-1475"><span class="linenos">1475</span></a>                        <span class="n">X0</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1476"><a href="#nsa_flow_orth-1476"><span class="linenos">1476</span></a>                        <span class="n">w</span><span class="o">=</span><span class="n">w</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1477"><a href="#nsa_flow_orth-1477"><span class="linenos">1477</span></a>                        <span class="n">fidelity_type</span><span class="o">=</span><span class="n">fidelity_type</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1478"><a href="#nsa_flow_orth-1478"><span class="linenos">1478</span></a>                        <span class="n">orth_type</span><span class="o">=</span><span class="n">orth_type</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1479"><a href="#nsa_flow_orth-1479"><span class="linenos">1479</span></a>                        <span class="n">fid_eta</span><span class="o">=</span><span class="n">fid_eta</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1480"><a href="#nsa_flow_orth-1480"><span class="linenos">1480</span></a>                        <span class="n">c_orth</span><span class="o">=</span><span class="n">c_orth</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1481"><a href="#nsa_flow_orth-1481"><span class="linenos">1481</span></a>                        <span class="n">track_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1482"><a href="#nsa_flow_orth-1482"><span class="linenos">1482</span></a>                    <span class="p">)</span>
</span><span id="nsa_flow_orth-1483"><a href="#nsa_flow_orth-1483"><span class="linenos">1483</span></a>                    <span class="n">total_energy</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</span><span id="nsa_flow_orth-1484"><a href="#nsa_flow_orth-1484"><span class="linenos">1484</span></a>                    <span class="n">opt</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="nsa_flow_orth-1485"><a href="#nsa_flow_orth-1485"><span class="linenos">1485</span></a>
</span><span id="nsa_flow_orth-1486"><a href="#nsa_flow_orth-1486"><span class="linenos">1486</span></a>                    <span class="c1"># --- Evaluate &amp; store progress ---</span>
</span><span id="nsa_flow_orth-1487"><a href="#nsa_flow_orth-1487"><span class="linenos">1487</span></a>                    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="nsa_flow_orth-1488"><a href="#nsa_flow_orth-1488"><span class="linenos">1488</span></a>                        <span class="n">Y_eval</span> <span class="o">=</span> <span class="n">nsa_flow_retract_auto</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">w_use</span><span class="p">,</span> <span class="n">retraction</span><span class="p">)</span>
</span><span id="nsa_flow_orth-1489"><a href="#nsa_flow_orth-1489"><span class="linenos">1489</span></a>                        <span class="n">Y_eval</span> <span class="o">=</span> <span class="n">apply_nonnegativity</span><span class="p">(</span><span class="n">Y_eval</span><span class="p">,</span> <span class="n">apply_nonneg</span><span class="p">)</span>
</span><span id="nsa_flow_orth-1490"><a href="#nsa_flow_orth-1490"><span class="linenos">1490</span></a>                        <span class="n">E</span> <span class="o">=</span> <span class="n">compute_energy</span><span class="p">(</span>
</span><span id="nsa_flow_orth-1491"><a href="#nsa_flow_orth-1491"><span class="linenos">1491</span></a>                            <span class="n">Y_eval</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1492"><a href="#nsa_flow_orth-1492"><span class="linenos">1492</span></a>                            <span class="n">X0</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1493"><a href="#nsa_flow_orth-1493"><span class="linenos">1493</span></a>                            <span class="n">w</span><span class="o">=</span><span class="n">w</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1494"><a href="#nsa_flow_orth-1494"><span class="linenos">1494</span></a>                            <span class="n">fidelity_type</span><span class="o">=</span><span class="n">fidelity_type</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1495"><a href="#nsa_flow_orth-1495"><span class="linenos">1495</span></a>                            <span class="n">orth_type</span><span class="o">=</span><span class="n">orth_type</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1496"><a href="#nsa_flow_orth-1496"><span class="linenos">1496</span></a>                            <span class="n">fid_eta</span><span class="o">=</span><span class="n">fid_eta</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1497"><a href="#nsa_flow_orth-1497"><span class="linenos">1497</span></a>                            <span class="n">c_orth</span><span class="o">=</span><span class="n">c_orth</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1498"><a href="#nsa_flow_orth-1498"><span class="linenos">1498</span></a>                            <span class="n">track_grad</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1499"><a href="#nsa_flow_orth-1499"><span class="linenos">1499</span></a>                            <span class="n">return_dict</span><span class="o">=</span><span class="kc">True</span>
</span><span id="nsa_flow_orth-1500"><a href="#nsa_flow_orth-1500"><span class="linenos">1500</span></a>                        <span class="p">)</span>
</span><span id="nsa_flow_orth-1501"><a href="#nsa_flow_orth-1501"><span class="linenos">1501</span></a>
</span><span id="nsa_flow_orth-1502"><a href="#nsa_flow_orth-1502"><span class="linenos">1502</span></a>                    <span class="n">warmup_fids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="s2">&quot;fidelity&quot;</span><span class="p">])</span>
</span><span id="nsa_flow_orth-1503"><a href="#nsa_flow_orth-1503"><span class="linenos">1503</span></a>                    <span class="n">warmup_orths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="s2">&quot;orthogonality&quot;</span><span class="p">])</span>
</span><span id="nsa_flow_orth-1504"><a href="#nsa_flow_orth-1504"><span class="linenos">1504</span></a>                    <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="p">(</span><span class="n">it</span> <span class="o">%</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">warmup_iters</span> <span class="o">//</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">it</span> <span class="o">==</span> <span class="n">warmup_iters</span><span class="p">):</span>
</span><span id="nsa_flow_orth-1505"><a href="#nsa_flow_orth-1505"><span class="linenos">1505</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Warmup </span><span class="si">{</span><span class="n">it</span><span class="si">:</span><span class="s2">3d</span><span class="si">}</span><span class="s2">] Fid=</span><span class="si">{</span><span class="n">E</span><span class="p">[</span><span class="s1">&#39;fidelity&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2"> Orth=</span><span class="si">{</span><span class="n">E</span><span class="p">[</span><span class="s1">&#39;orthogonality&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="nsa_flow_orth-1506"><a href="#nsa_flow_orth-1506"><span class="linenos">1506</span></a>
</span><span id="nsa_flow_orth-1507"><a href="#nsa_flow_orth-1507"><span class="linenos">1507</span></a>                <span class="c1"># Compute normalization (make E_fid ~ E_orth after rescaling)</span>
</span><span id="nsa_flow_orth-1508"><a href="#nsa_flow_orth-1508"><span class="linenos">1508</span></a>                <span class="n">mean_fid</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">warmup_fids</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-12</span><span class="p">)</span>
</span><span id="nsa_flow_orth-1509"><a href="#nsa_flow_orth-1509"><span class="linenos">1509</span></a>                <span class="n">mean_orth</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">warmup_orths</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-12</span><span class="p">)</span>
</span><span id="nsa_flow_orth-1510"><a href="#nsa_flow_orth-1510"><span class="linenos">1510</span></a>
</span><span id="nsa_flow_orth-1511"><a href="#nsa_flow_orth-1511"><span class="linenos">1511</span></a>                <span class="c1"># Avoid degenerate values</span>
</span><span id="nsa_flow_orth-1512"><a href="#nsa_flow_orth-1512"><span class="linenos">1512</span></a>                <span class="k">if</span> <span class="n">mean_fid</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">mean_orth</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="nsa_flow_orth-1513"><a href="#nsa_flow_orth-1513"><span class="linenos">1513</span></a>                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="nsa_flow_orth-1514"><a href="#nsa_flow_orth-1514"><span class="linenos">1514</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[Warmup] non-positive mean encountered, skipping reweight round.&quot;</span><span class="p">)</span>
</span><span id="nsa_flow_orth-1515"><a href="#nsa_flow_orth-1515"><span class="linenos">1515</span></a>                    <span class="k">continue</span>
</span><span id="nsa_flow_orth-1516"><a href="#nsa_flow_orth-1516"><span class="linenos">1516</span></a>
</span><span id="nsa_flow_orth-1517"><a href="#nsa_flow_orth-1517"><span class="linenos">1517</span></a>                <span class="c1"># Choose scalar multipliers so that scaled means are roughly equal</span>
</span><span id="nsa_flow_orth-1518"><a href="#nsa_flow_orth-1518"><span class="linenos">1518</span></a>                <span class="c1"># We compute base scalars inversely proportional to means, then scale</span>
</span><span id="nsa_flow_orth-1519"><a href="#nsa_flow_orth-1519"><span class="linenos">1519</span></a>                <span class="c1"># them so that their weighted sum is comparable (keep magnitudes small)</span>
</span><span id="nsa_flow_orth-1520"><a href="#nsa_flow_orth-1520"><span class="linenos">1520</span></a>                <span class="n">fid_eta</span> <span class="o">=</span> <span class="mf">5e-4</span> <span class="o">/</span> <span class="n">mean_fid</span>
</span><span id="nsa_flow_orth-1521"><a href="#nsa_flow_orth-1521"><span class="linenos">1521</span></a>                <span class="n">c_orth</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">mean_orth</span>
</span><span id="nsa_flow_orth-1522"><a href="#nsa_flow_orth-1522"><span class="linenos">1522</span></a>                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="nsa_flow_orth-1523"><a href="#nsa_flow_orth-1523"><span class="linenos">1523</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[Reweighting learned]&quot;</span> <span class="p">)</span>
</span><span id="nsa_flow_orth-1524"><a href="#nsa_flow_orth-1524"><span class="linenos">1524</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; mean_fid=</span><span class="si">{</span><span class="n">mean_fid</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">, mean_orth=</span><span class="si">{</span><span class="n">mean_orth</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="nsa_flow_orth-1525"><a href="#nsa_flow_orth-1525"><span class="linenos">1525</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  new fid_eta=</span><span class="si">{</span><span class="n">fid_eta</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">, c_orth=</span><span class="si">{</span><span class="n">c_orth</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="nsa_flow_orth-1526"><a href="#nsa_flow_orth-1526"><span class="linenos">1526</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;=== Restarting optimization with new weights ===</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="nsa_flow_orth-1527"><a href="#nsa_flow_orth-1527"><span class="linenos">1527</span></a>
</span><span id="nsa_flow_orth-1528"><a href="#nsa_flow_orth-1528"><span class="linenos">1528</span></a>                <span class="c1"># Reset optimization variable and optimizer to start cleanly</span>
</span><span id="nsa_flow_orth-1529"><a href="#nsa_flow_orth-1529"><span class="linenos">1529</span></a>                <span class="n">Z</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span>
</span><span id="nsa_flow_orth-1530"><a href="#nsa_flow_orth-1530"><span class="linenos">1530</span></a>                <span class="n">opt</span> <span class="o">=</span> <span class="n">get_torch_optimizer</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="p">[</span><span class="n">Z</span><span class="p">],</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">)</span>
</span><span id="nsa_flow_orth-1531"><a href="#nsa_flow_orth-1531"><span class="linenos">1531</span></a>
</span><span id="nsa_flow_orth-1532"><a href="#nsa_flow_orth-1532"><span class="linenos">1532</span></a>
</span><span id="nsa_flow_orth-1533"><a href="#nsa_flow_orth-1533"><span class="linenos">1533</span></a>    <span class="c1"># --- Learning rate strategy ---</span>
</span><span id="nsa_flow_orth-1534"><a href="#nsa_flow_orth-1534"><span class="linenos">1534</span></a>    <span class="k">if</span> <span class="n">initial_learning_rate</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lr_strategy</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> \
</span><span id="nsa_flow_orth-1535"><a href="#nsa_flow_orth-1535"><span class="linenos">1535</span></a>       <span class="n">lr_strategy</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">get_lr_estimation_strategies</span><span class="p">():</span>
</span><span id="nsa_flow_orth-1536"><a href="#nsa_flow_orth-1536"><span class="linenos">1536</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="nsa_flow_orth-1537"><a href="#nsa_flow_orth-1537"><span class="linenos">1537</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[NSA-Flow] Estimating learning rate (</span><span class="si">{</span><span class="n">lr_strategy</span><span class="si">}</span><span class="s2">) ...&quot;</span><span class="p">)</span>
</span><span id="nsa_flow_orth-1538"><a href="#nsa_flow_orth-1538"><span class="linenos">1538</span></a>        <span class="n">lr_result</span> <span class="o">=</span> <span class="n">estimate_learning_rate_for_nsa_flow</span><span class="p">(</span>
</span><span id="nsa_flow_orth-1539"><a href="#nsa_flow_orth-1539"><span class="linenos">1539</span></a>            <span class="n">Y0</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">X0</span><span class="p">),</span>
</span><span id="nsa_flow_orth-1540"><a href="#nsa_flow_orth-1540"><span class="linenos">1540</span></a>            <span class="n">X0</span><span class="o">=</span><span class="n">X0</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1541"><a href="#nsa_flow_orth-1541"><span class="linenos">1541</span></a>            <span class="n">w</span><span class="o">=</span><span class="n">w</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1542"><a href="#nsa_flow_orth-1542"><span class="linenos">1542</span></a>            <span class="n">retraction</span><span class="o">=</span><span class="n">retraction</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1543"><a href="#nsa_flow_orth-1543"><span class="linenos">1543</span></a>            <span class="n">fid_eta</span><span class="o">=</span><span class="n">fid_eta</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1544"><a href="#nsa_flow_orth-1544"><span class="linenos">1544</span></a>            <span class="n">c_orth</span><span class="o">=</span><span class="n">c_orth</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1545"><a href="#nsa_flow_orth-1545"><span class="linenos">1545</span></a>            <span class="n">apply_nonneg</span><span class="o">=</span><span class="n">apply_nonneg</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1546"><a href="#nsa_flow_orth-1546"><span class="linenos">1546</span></a>            <span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;bayes&quot;</span> <span class="k">if</span> <span class="n">lr_strategy</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span> <span class="k">else</span> <span class="n">lr_strategy</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1547"><a href="#nsa_flow_orth-1547"><span class="linenos">1547</span></a>            <span class="n">aggression</span><span class="o">=</span><span class="n">aggression</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1548"><a href="#nsa_flow_orth-1548"><span class="linenos">1548</span></a>            <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1549"><a href="#nsa_flow_orth-1549"><span class="linenos">1549</span></a>            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1550"><a href="#nsa_flow_orth-1550"><span class="linenos">1550</span></a>        <span class="p">)</span>
</span><span id="nsa_flow_orth-1551"><a href="#nsa_flow_orth-1551"><span class="linenos">1551</span></a>        <span class="n">lr</span> <span class="o">=</span> <span class="n">lr_result</span><span class="p">[</span><span class="s2">&quot;best_lr&quot;</span><span class="p">]</span>
</span><span id="nsa_flow_orth-1552"><a href="#nsa_flow_orth-1552"><span class="linenos">1552</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="nsa_flow_orth-1553"><a href="#nsa_flow_orth-1553"><span class="linenos">1553</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[NSA-Flow] Selected learning rate: </span><span class="si">{</span><span class="n">lr</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="nsa_flow_orth-1554"><a href="#nsa_flow_orth-1554"><span class="linenos">1554</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="nsa_flow_orth-1555"><a href="#nsa_flow_orth-1555"><span class="linenos">1555</span></a>        <span class="n">lr</span> <span class="o">=</span> <span class="n">initial_learning_rate</span> <span class="ow">or</span> <span class="mf">1e-3</span>
</span><span id="nsa_flow_orth-1556"><a href="#nsa_flow_orth-1556"><span class="linenos">1556</span></a>
</span><span id="nsa_flow_orth-1557"><a href="#nsa_flow_orth-1557"><span class="linenos">1557</span></a>    <span class="n">Z</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span>
</span><span id="nsa_flow_orth-1558"><a href="#nsa_flow_orth-1558"><span class="linenos">1558</span></a>    <span class="n">opt</span> <span class="o">=</span> <span class="n">get_torch_optimizer</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="p">[</span><span class="n">Z</span><span class="p">],</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="o">*</span><span class="n">lrscl</span><span class="p">)</span>
</span><span id="nsa_flow_orth-1559"><a href="#nsa_flow_orth-1559"><span class="linenos">1559</span></a>
</span><span id="nsa_flow_orth-1560"><a href="#nsa_flow_orth-1560"><span class="linenos">1560</span></a>    <span class="c1"># --- Tracking and monitoring ---</span>
</span><span id="nsa_flow_orth-1561"><a href="#nsa_flow_orth-1561"><span class="linenos">1561</span></a>    <span class="n">traces</span><span class="p">,</span> <span class="n">recent_iters</span><span class="p">,</span> <span class="n">recent_totals</span><span class="p">,</span> <span class="n">recent_energies</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="nsa_flow_orth-1562"><a href="#nsa_flow_orth-1562"><span class="linenos">1562</span></a>    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="nsa_flow_orth-1563"><a href="#nsa_flow_orth-1563"><span class="linenos">1563</span></a>    <span class="n">best_Y</span><span class="p">,</span> <span class="n">best_energy</span><span class="p">,</span> <span class="n">best_iter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">),</span> <span class="mi">0</span>
</span><span id="nsa_flow_orth-1564"><a href="#nsa_flow_orth-1564"><span class="linenos">1564</span></a>
</span><span id="nsa_flow_orth-1565"><a href="#nsa_flow_orth-1565"><span class="linenos">1565</span></a>    <span class="c1"># --- Main optimization loop ---</span>
</span><span id="nsa_flow_orth-1566"><a href="#nsa_flow_orth-1566"><span class="linenos">1566</span></a>    <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_iter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="nsa_flow_orth-1567"><a href="#nsa_flow_orth-1567"><span class="linenos">1567</span></a>        <span class="n">opt</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
</span><span id="nsa_flow_orth-1568"><a href="#nsa_flow_orth-1568"><span class="linenos">1568</span></a>
</span><span id="nsa_flow_orth-1569"><a href="#nsa_flow_orth-1569"><span class="linenos">1569</span></a>        <span class="c1"># --- Retraction + optional nonnegativity ---</span>
</span><span id="nsa_flow_orth-1570"><a href="#nsa_flow_orth-1570"><span class="linenos">1570</span></a>        <span class="n">Y_retracted</span> <span class="o">=</span> <span class="n">nsa_flow_retract_auto</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">w_use</span><span class="p">,</span> <span class="n">retraction</span><span class="p">)</span>
</span><span id="nsa_flow_orth-1571"><a href="#nsa_flow_orth-1571"><span class="linenos">1571</span></a>        <span class="n">Y_retracted</span> <span class="o">=</span> <span class="n">apply_nonnegativity</span><span class="p">(</span><span class="n">Y_retracted</span><span class="p">,</span> <span class="n">apply_nonneg</span><span class="p">)</span>
</span><span id="nsa_flow_orth-1572"><a href="#nsa_flow_orth-1572"><span class="linenos">1572</span></a>
</span><span id="nsa_flow_orth-1573"><a href="#nsa_flow_orth-1573"><span class="linenos">1573</span></a>        <span class="c1"># --- Compute energy (autograd-safe) ---</span>
</span><span id="nsa_flow_orth-1574"><a href="#nsa_flow_orth-1574"><span class="linenos">1574</span></a>        <span class="n">total_energy</span> <span class="o">=</span> <span class="n">compute_energy</span><span class="p">(</span>
</span><span id="nsa_flow_orth-1575"><a href="#nsa_flow_orth-1575"><span class="linenos">1575</span></a>            <span class="n">Y_retracted</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1576"><a href="#nsa_flow_orth-1576"><span class="linenos">1576</span></a>            <span class="n">X0</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1577"><a href="#nsa_flow_orth-1577"><span class="linenos">1577</span></a>            <span class="n">w</span><span class="o">=</span><span class="n">w</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1578"><a href="#nsa_flow_orth-1578"><span class="linenos">1578</span></a>            <span class="n">fidelity_type</span><span class="o">=</span><span class="n">fidelity_type</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1579"><a href="#nsa_flow_orth-1579"><span class="linenos">1579</span></a>            <span class="n">orth_type</span><span class="o">=</span><span class="n">orth_type</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1580"><a href="#nsa_flow_orth-1580"><span class="linenos">1580</span></a>            <span class="n">fid_eta</span><span class="o">=</span><span class="n">fid_eta</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1581"><a href="#nsa_flow_orth-1581"><span class="linenos">1581</span></a>            <span class="n">c_orth</span><span class="o">=</span><span class="n">c_orth</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1582"><a href="#nsa_flow_orth-1582"><span class="linenos">1582</span></a>            <span class="n">track_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1583"><a href="#nsa_flow_orth-1583"><span class="linenos">1583</span></a>        <span class="p">)</span>
</span><span id="nsa_flow_orth-1584"><a href="#nsa_flow_orth-1584"><span class="linenos">1584</span></a>        <span class="c1"># --- Compute energy (autograd-safe) ---</span>
</span><span id="nsa_flow_orth-1585"><a href="#nsa_flow_orth-1585"><span class="linenos">1585</span></a>        <span class="n">total_energy</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</span><span id="nsa_flow_orth-1586"><a href="#nsa_flow_orth-1586"><span class="linenos">1586</span></a>        <span class="n">g</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">grad</span>
</span><span id="nsa_flow_orth-1587"><a href="#nsa_flow_orth-1587"><span class="linenos">1587</span></a>        <span class="n">opt</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="nsa_flow_orth-1588"><a href="#nsa_flow_orth-1588"><span class="linenos">1588</span></a>        <span class="c1"># --- Compute energy (autograd-safe) ---</span>
</span><span id="nsa_flow_orth-1589"><a href="#nsa_flow_orth-1589"><span class="linenos">1589</span></a>        <span class="c1"># --- Evaluate &amp; store progress ---</span>
</span><span id="nsa_flow_orth-1590"><a href="#nsa_flow_orth-1590"><span class="linenos">1590</span></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="nsa_flow_orth-1591"><a href="#nsa_flow_orth-1591"><span class="linenos">1591</span></a>            <span class="n">Y_eval</span> <span class="o">=</span> <span class="n">nsa_flow_retract_auto</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">w_use</span><span class="p">,</span> <span class="n">retraction</span><span class="p">)</span>
</span><span id="nsa_flow_orth-1592"><a href="#nsa_flow_orth-1592"><span class="linenos">1592</span></a>            <span class="n">Y_eval</span> <span class="o">=</span> <span class="n">apply_nonnegativity</span><span class="p">(</span><span class="n">Y_eval</span><span class="p">,</span> <span class="n">apply_nonneg</span><span class="p">)</span>
</span><span id="nsa_flow_orth-1593"><a href="#nsa_flow_orth-1593"><span class="linenos">1593</span></a>            <span class="n">E</span> <span class="o">=</span> <span class="n">compute_energy</span><span class="p">(</span>
</span><span id="nsa_flow_orth-1594"><a href="#nsa_flow_orth-1594"><span class="linenos">1594</span></a>                <span class="n">Y_eval</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1595"><a href="#nsa_flow_orth-1595"><span class="linenos">1595</span></a>                <span class="n">X0</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1596"><a href="#nsa_flow_orth-1596"><span class="linenos">1596</span></a>                <span class="n">w</span><span class="o">=</span><span class="n">w</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1597"><a href="#nsa_flow_orth-1597"><span class="linenos">1597</span></a>                <span class="n">fidelity_type</span><span class="o">=</span><span class="n">fidelity_type</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1598"><a href="#nsa_flow_orth-1598"><span class="linenos">1598</span></a>                <span class="n">orth_type</span><span class="o">=</span><span class="n">orth_type</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1599"><a href="#nsa_flow_orth-1599"><span class="linenos">1599</span></a>                <span class="n">fid_eta</span><span class="o">=</span><span class="n">fid_eta</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1600"><a href="#nsa_flow_orth-1600"><span class="linenos">1600</span></a>                <span class="n">c_orth</span><span class="o">=</span><span class="n">c_orth</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1601"><a href="#nsa_flow_orth-1601"><span class="linenos">1601</span></a>                <span class="n">track_grad</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1602"><a href="#nsa_flow_orth-1602"><span class="linenos">1602</span></a>                <span class="n">return_dict</span><span class="o">=</span><span class="kc">True</span>
</span><span id="nsa_flow_orth-1603"><a href="#nsa_flow_orth-1603"><span class="linenos">1603</span></a>            <span class="p">)</span>
</span><span id="nsa_flow_orth-1604"><a href="#nsa_flow_orth-1604"><span class="linenos">1604</span></a>
</span><span id="nsa_flow_orth-1605"><a href="#nsa_flow_orth-1605"><span class="linenos">1605</span></a>            <span class="n">total_val</span> <span class="o">=</span> <span class="n">E</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">]</span>
</span><span id="nsa_flow_orth-1606"><a href="#nsa_flow_orth-1606"><span class="linenos">1606</span></a>            <span class="n">fidelity_val</span> <span class="o">=</span> <span class="n">E</span><span class="p">[</span><span class="s2">&quot;fidelity&quot;</span><span class="p">]</span>
</span><span id="nsa_flow_orth-1607"><a href="#nsa_flow_orth-1607"><span class="linenos">1607</span></a>            <span class="n">orth_val</span> <span class="o">=</span> <span class="n">E</span><span class="p">[</span><span class="s2">&quot;orthogonality&quot;</span><span class="p">]</span>
</span><span id="nsa_flow_orth-1608"><a href="#nsa_flow_orth-1608"><span class="linenos">1608</span></a>
</span><span id="nsa_flow_orth-1609"><a href="#nsa_flow_orth-1609"><span class="linenos">1609</span></a>            <span class="k">if</span> <span class="n">total_val</span> <span class="o">&lt;</span> <span class="n">best_energy</span><span class="p">:</span>
</span><span id="nsa_flow_orth-1610"><a href="#nsa_flow_orth-1610"><span class="linenos">1610</span></a>                <span class="n">best_energy</span> <span class="o">=</span> <span class="n">total_val</span>
</span><span id="nsa_flow_orth-1611"><a href="#nsa_flow_orth-1611"><span class="linenos">1611</span></a>                <span class="n">best_Y</span> <span class="o">=</span> <span class="n">Y_eval</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="nsa_flow_orth-1612"><a href="#nsa_flow_orth-1612"><span class="linenos">1612</span></a>                <span class="n">best_iter</span> <span class="o">=</span> <span class="n">it</span>
</span><span id="nsa_flow_orth-1613"><a href="#nsa_flow_orth-1613"><span class="linenos">1613</span></a>
</span><span id="nsa_flow_orth-1614"><a href="#nsa_flow_orth-1614"><span class="linenos">1614</span></a>            <span class="k">if</span> <span class="n">it</span> <span class="o">%</span> <span class="n">record_every</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="nsa_flow_orth-1615"><a href="#nsa_flow_orth-1615"><span class="linenos">1615</span></a>                <span class="n">traces</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="nsa_flow_orth-1616"><a href="#nsa_flow_orth-1616"><span class="linenos">1616</span></a>                    <span class="s2">&quot;iter&quot;</span><span class="p">:</span> <span class="n">it</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1617"><a href="#nsa_flow_orth-1617"><span class="linenos">1617</span></a>                    <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1618"><a href="#nsa_flow_orth-1618"><span class="linenos">1618</span></a>                    <span class="s2">&quot;fidelity&quot;</span><span class="p">:</span> <span class="n">fidelity_val</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1619"><a href="#nsa_flow_orth-1619"><span class="linenos">1619</span></a>                    <span class="s2">&quot;orthogonality&quot;</span><span class="p">:</span> <span class="n">orth_val</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1620"><a href="#nsa_flow_orth-1620"><span class="linenos">1620</span></a>                    <span class="s2">&quot;total_energy&quot;</span><span class="p">:</span> <span class="n">total_val</span>
</span><span id="nsa_flow_orth-1621"><a href="#nsa_flow_orth-1621"><span class="linenos">1621</span></a>                <span class="p">})</span>
</span><span id="nsa_flow_orth-1622"><a href="#nsa_flow_orth-1622"><span class="linenos">1622</span></a>
</span><span id="nsa_flow_orth-1623"><a href="#nsa_flow_orth-1623"><span class="linenos">1623</span></a>            <span class="n">recent_energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">total_val</span><span class="p">)</span>
</span><span id="nsa_flow_orth-1624"><a href="#nsa_flow_orth-1624"><span class="linenos">1624</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">recent_energies</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">window_size</span><span class="p">:</span>
</span><span id="nsa_flow_orth-1625"><a href="#nsa_flow_orth-1625"><span class="linenos">1625</span></a>                <span class="n">recent_energies</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="nsa_flow_orth-1626"><a href="#nsa_flow_orth-1626"><span class="linenos">1626</span></a>
</span><span id="nsa_flow_orth-1627"><a href="#nsa_flow_orth-1627"><span class="linenos">1627</span></a>            <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="p">(</span><span class="n">it</span> <span class="o">%</span> <span class="n">record_every</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">it</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">):</span>
</span><span id="nsa_flow_orth-1628"><a href="#nsa_flow_orth-1628"><span class="linenos">1628</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Iter </span><span class="si">{</span><span class="n">it</span><span class="si">:</span><span class="s2">3d</span><span class="si">}</span><span class="s2">] Total=</span><span class="si">{</span><span class="n">total_val</span><span class="si">:</span><span class="s2">.6e</span><span class="si">}</span><span class="s2"> | Fid=</span><span class="si">{</span><span class="n">fidelity_val</span><span class="si">:</span><span class="s2">.6e</span><span class="si">}</span><span class="s2"> | Orth=</span><span class="si">{</span><span class="n">orth_val</span><span class="si">:</span><span class="s2">.6e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="nsa_flow_orth-1629"><a href="#nsa_flow_orth-1629"><span class="linenos">1629</span></a>
</span><span id="nsa_flow_orth-1630"><a href="#nsa_flow_orth-1630"><span class="linenos">1630</span></a>            <span class="c1"># --- Convergence criterion ---</span>
</span><span id="nsa_flow_orth-1631"><a href="#nsa_flow_orth-1631"><span class="linenos">1631</span></a>            <span class="c1"># update recent lists for slope-fit</span>
</span><span id="nsa_flow_orth-1632"><a href="#nsa_flow_orth-1632"><span class="linenos">1632</span></a>            <span class="n">recent_iters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
</span><span id="nsa_flow_orth-1633"><a href="#nsa_flow_orth-1633"><span class="linenos">1633</span></a>            <span class="n">recent_totals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">total_val</span><span class="p">)</span>
</span><span id="nsa_flow_orth-1634"><a href="#nsa_flow_orth-1634"><span class="linenos">1634</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">recent_iters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">window_size</span><span class="p">:</span>
</span><span id="nsa_flow_orth-1635"><a href="#nsa_flow_orth-1635"><span class="linenos">1635</span></a>                <span class="n">recent_iters</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="nsa_flow_orth-1636"><a href="#nsa_flow_orth-1636"><span class="linenos">1636</span></a>                <span class="n">recent_totals</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="nsa_flow_orth-1637"><a href="#nsa_flow_orth-1637"><span class="linenos">1637</span></a>
</span><span id="nsa_flow_orth-1638"><a href="#nsa_flow_orth-1638"><span class="linenos">1638</span></a>            <span class="c1"># slope-fit convergence check (need at least 2 points)</span>
</span><span id="nsa_flow_orth-1639"><a href="#nsa_flow_orth-1639"><span class="linenos">1639</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">recent_iters</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">window_size</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
</span><span id="nsa_flow_orth-1640"><a href="#nsa_flow_orth-1640"><span class="linenos">1640</span></a>                <span class="c1"># fit line total = slope * iter + intercept</span>
</span><span id="nsa_flow_orth-1641"><a href="#nsa_flow_orth-1641"><span class="linenos">1641</span></a>                <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">recent_iters</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</span><span id="nsa_flow_orth-1642"><a href="#nsa_flow_orth-1642"><span class="linenos">1642</span></a>                <span class="n">ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">recent_totals</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</span><span id="nsa_flow_orth-1643"><a href="#nsa_flow_orth-1643"><span class="linenos">1643</span></a>                <span class="c1"># subtract mean to improve numerical stability</span>
</span><span id="nsa_flow_orth-1644"><a href="#nsa_flow_orth-1644"><span class="linenos">1644</span></a>                <span class="n">xm</span> <span class="o">=</span> <span class="n">xs</span><span class="o">.</span><span class="n">mean</span><span class="p">();</span> <span class="n">ym</span> <span class="o">=</span> <span class="n">ys</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="nsa_flow_orth-1645"><a href="#nsa_flow_orth-1645"><span class="linenos">1645</span></a>                <span class="c1"># slope = sum((x-xm)*(y-ym))/sum((x-xm)**2)</span>
</span><span id="nsa_flow_orth-1646"><a href="#nsa_flow_orth-1646"><span class="linenos">1646</span></a>                <span class="n">denom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">xs</span> <span class="o">-</span> <span class="n">xm</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="nsa_flow_orth-1647"><a href="#nsa_flow_orth-1647"><span class="linenos">1647</span></a>                <span class="k">if</span> <span class="n">denom</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="nsa_flow_orth-1648"><a href="#nsa_flow_orth-1648"><span class="linenos">1648</span></a>                    <span class="n">slope</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">xs</span> <span class="o">-</span> <span class="n">xm</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">ys</span> <span class="o">-</span> <span class="n">ym</span><span class="p">))</span> <span class="o">/</span> <span class="n">denom</span><span class="p">)</span>
</span><span id="nsa_flow_orth-1649"><a href="#nsa_flow_orth-1649"><span class="linenos">1649</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="nsa_flow_orth-1650"><a href="#nsa_flow_orth-1650"><span class="linenos">1650</span></a>                    <span class="n">slope</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="nsa_flow_orth-1651"><a href="#nsa_flow_orth-1651"><span class="linenos">1651</span></a>
</span><span id="nsa_flow_orth-1652"><a href="#nsa_flow_orth-1652"><span class="linenos">1652</span></a>                <span class="c1"># print debug if requested</span>
</span><span id="nsa_flow_orth-1653"><a href="#nsa_flow_orth-1653"><span class="linenos">1653</span></a>                <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="p">(</span><span class="n">it</span> <span class="o">%</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">record_every</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
</span><span id="nsa_flow_orth-1654"><a href="#nsa_flow_orth-1654"><span class="linenos">1654</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Iter </span><span class="si">{</span><span class="n">it</span><span class="si">:</span><span class="s2">4d</span><span class="si">}</span><span class="s2">] Total=</span><span class="si">{</span><span class="n">total_val</span><span class="si">:</span><span class="s2">.6e</span><span class="si">}</span><span class="s2"> | Fid=</span><span class="si">{</span><span class="n">fidelity_val</span><span class="si">:</span><span class="s2">.6e</span><span class="si">}</span><span class="s2"> | Orth=</span><span class="si">{</span><span class="n">orth_val</span><span class="si">:</span><span class="s2">.6e</span><span class="si">}</span><span class="s2"> | slope=</span><span class="si">{</span><span class="n">slope</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="nsa_flow_orth-1655"><a href="#nsa_flow_orth-1655"><span class="linenos">1655</span></a>
</span><span id="nsa_flow_orth-1656"><a href="#nsa_flow_orth-1656"><span class="linenos">1656</span></a>                <span class="c1"># slope is energy change per iteration. Negative slope =&gt; energy decreasing.</span>
</span><span id="nsa_flow_orth-1657"><a href="#nsa_flow_orth-1657"><span class="linenos">1657</span></a>                <span class="c1"># Stop when improvement is very small: i.e. slope &gt; -tol</span>
</span><span id="nsa_flow_orth-1658"><a href="#nsa_flow_orth-1658"><span class="linenos">1658</span></a>                <span class="k">if</span> <span class="n">slope</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">tol</span><span class="p">:</span>
</span><span id="nsa_flow_orth-1659"><a href="#nsa_flow_orth-1659"><span class="linenos">1659</span></a>                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="nsa_flow_orth-1660"><a href="#nsa_flow_orth-1660"><span class="linenos">1660</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converged at iter </span><span class="si">{</span><span class="n">it</span><span class="si">}</span><span class="s2"> (slope </span><span class="si">{</span><span class="n">slope</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2"> &gt; -</span><span class="si">{</span><span class="n">tol</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>
</span><span id="nsa_flow_orth-1661"><a href="#nsa_flow_orth-1661"><span class="linenos">1661</span></a>                    <span class="k">break</span>
</span><span id="nsa_flow_orth-1662"><a href="#nsa_flow_orth-1662"><span class="linenos">1662</span></a>
</span><span id="nsa_flow_orth-1663"><a href="#nsa_flow_orth-1663"><span class="linenos">1663</span></a>            <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="nsa_flow_orth-1664"><a href="#nsa_flow_orth-1664"><span class="linenos">1664</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">recent_energies</span><span class="p">)</span> <span class="o">==</span> <span class="n">window_size</span><span class="p">:</span>
</span><span id="nsa_flow_orth-1665"><a href="#nsa_flow_orth-1665"><span class="linenos">1665</span></a>                    <span class="n">e_max</span><span class="p">,</span> <span class="n">e_min</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">recent_energies</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">recent_energies</span><span class="p">)</span>
</span><span id="nsa_flow_orth-1666"><a href="#nsa_flow_orth-1666"><span class="linenos">1666</span></a>                    <span class="n">e_avg</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">recent_energies</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">recent_energies</span><span class="p">)</span>
</span><span id="nsa_flow_orth-1667"><a href="#nsa_flow_orth-1667"><span class="linenos">1667</span></a>                    <span class="n">rel_var</span> <span class="o">=</span> <span class="p">(</span><span class="n">e_max</span> <span class="o">-</span> <span class="n">e_min</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">e_avg</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-12</span><span class="p">)</span>
</span><span id="nsa_flow_orth-1668"><a href="#nsa_flow_orth-1668"><span class="linenos">1668</span></a>                    <span class="k">if</span> <span class="n">rel_var</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
</span><span id="nsa_flow_orth-1669"><a href="#nsa_flow_orth-1669"><span class="linenos">1669</span></a>                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="nsa_flow_orth-1670"><a href="#nsa_flow_orth-1670"><span class="linenos">1670</span></a>                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converged at iter </span><span class="si">{</span><span class="n">it</span><span class="si">}</span><span class="s2"> (energy stable &lt; </span><span class="si">{</span><span class="n">tol</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="nsa_flow_orth-1671"><a href="#nsa_flow_orth-1671"><span class="linenos">1671</span></a>                        <span class="k">break</span>
</span><span id="nsa_flow_orth-1672"><a href="#nsa_flow_orth-1672"><span class="linenos">1672</span></a>
</span><span id="nsa_flow_orth-1673"><a href="#nsa_flow_orth-1673"><span class="linenos">1673</span></a>    <span class="n">traces</span> <span class="o">=</span> <span class="n">traces_to_dataframe</span><span class="p">(</span><span class="n">traces</span><span class="p">)</span>
</span><span id="nsa_flow_orth-1674"><a href="#nsa_flow_orth-1674"><span class="linenos">1674</span></a>    <span class="k">return</span> <span class="p">{</span>
</span><span id="nsa_flow_orth-1675"><a href="#nsa_flow_orth-1675"><span class="linenos">1675</span></a>        <span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="n">best_Y</span> <span class="o">*</span> <span class="n">scale_ref</span><span class="p">,</span>  <span class="c1"># rescale to original magnitude</span>
</span><span id="nsa_flow_orth-1676"><a href="#nsa_flow_orth-1676"><span class="linenos">1676</span></a>        <span class="s2">&quot;traces&quot;</span><span class="p">:</span> <span class="n">traces</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1677"><a href="#nsa_flow_orth-1677"><span class="linenos">1677</span></a>        <span class="s2">&quot;final_iter&quot;</span><span class="p">:</span> <span class="n">best_iter</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1678"><a href="#nsa_flow_orth-1678"><span class="linenos">1678</span></a>        <span class="s2">&quot;best_total_energy&quot;</span><span class="p">:</span> <span class="n">best_energy</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1679"><a href="#nsa_flow_orth-1679"><span class="linenos">1679</span></a>        <span class="s2">&quot;best_Y_iteration&quot;</span><span class="p">:</span> <span class="n">best_iter</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1680"><a href="#nsa_flow_orth-1680"><span class="linenos">1680</span></a>        <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="n">X0</span> <span class="o">*</span> <span class="n">scale_ref</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1681"><a href="#nsa_flow_orth-1681"><span class="linenos">1681</span></a>        <span class="s2">&quot;settings&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="nsa_flow_orth-1682"><a href="#nsa_flow_orth-1682"><span class="linenos">1682</span></a>            <span class="s2">&quot;fidelity_type&quot;</span><span class="p">:</span> <span class="n">fidelity_type</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1683"><a href="#nsa_flow_orth-1683"><span class="linenos">1683</span></a>            <span class="s2">&quot;orth_type&quot;</span><span class="p">:</span> <span class="n">orth_type</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1684"><a href="#nsa_flow_orth-1684"><span class="linenos">1684</span></a>            <span class="s2">&quot;retraction&quot;</span><span class="p">:</span> <span class="n">retraction</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1685"><a href="#nsa_flow_orth-1685"><span class="linenos">1685</span></a>            <span class="s2">&quot;optimizer&quot;</span><span class="p">:</span> <span class="n">optimizer</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1686"><a href="#nsa_flow_orth-1686"><span class="linenos">1686</span></a>            <span class="s2">&quot;learning_rate&quot;</span><span class="p">:</span> <span class="n">lr</span><span class="p">,</span>
</span><span id="nsa_flow_orth-1687"><a href="#nsa_flow_orth-1687"><span class="linenos">1687</span></a>        <span class="p">}</span>
</span><span id="nsa_flow_orth-1688"><a href="#nsa_flow_orth-1688"><span class="linenos">1688</span></a>    <span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>Autograd-compatible NSA-Flow (modular energy version).
Allows user-specified fidelity_type and orth_type.</p>

<p>fidelity_type  {"basic", "scale_invariant", "symmetric"}
orth_type  {"basic", "scale_invariant"}</p>
</div>


                </section>
                <section id="demo_nsa_flow_tradeoff">
                            <input id="demo_nsa_flow_tradeoff-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">demo_nsa_flow_tradeoff</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">w_values</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">p</span><span class="o">=</span><span class="mi">40</span>,</span><span class="param">	<span class="n">k</span><span class="o">=</span><span class="mi">6</span>,</span><span class="param">	<span class="n">noise_level</span><span class="o">=</span><span class="mf">0.05</span>,</span><span class="param">	<span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span>,</span><span class="param">	<span class="n">lr_strategy</span><span class="o">=</span><span class="s1">&#39;armijo&#39;</span>,</span><span class="param">	<span class="n">apply_nonneg</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span>,</span><span class="param">	<span class="n">warmup_iters</span><span class="o">=</span><span class="mi">20</span>,</span><span class="param">	<span class="n">tol</span><span class="o">=</span><span class="mf">1e-06</span>,</span><span class="param">	<span class="n">window_size</span><span class="o">=</span><span class="mi">8</span>,</span><span class="param">	<span class="n">seed</span><span class="o">=</span><span class="mi">0</span>,</span><span class="param">	<span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">save_path</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">fig_dpi</span><span class="o">=</span><span class="mi">250</span>,</span><span class="param">	<span class="n">legend_y</span><span class="o">=</span><span class="mf">0.5</span>,</span><span class="param">	<span class="n">font_scale</span><span class="o">=</span><span class="mf">1.2</span>,</span><span class="param">	<span class="n">fig_scale</span><span class="o">=</span><span class="mf">1.0</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="demo_nsa_flow_tradeoff-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#demo_nsa_flow_tradeoff"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="demo_nsa_flow_tradeoff-3543"><a href="#demo_nsa_flow_tradeoff-3543"><span class="linenos">3543</span></a><span class="k">def</span><span class="w"> </span><span class="nf">demo_nsa_flow_tradeoff</span><span class="p">(</span>
</span><span id="demo_nsa_flow_tradeoff-3544"><a href="#demo_nsa_flow_tradeoff-3544"><span class="linenos">3544</span></a>    <span class="n">w_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="demo_nsa_flow_tradeoff-3545"><a href="#demo_nsa_flow_tradeoff-3545"><span class="linenos">3545</span></a>    <span class="n">p</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
</span><span id="demo_nsa_flow_tradeoff-3546"><a href="#demo_nsa_flow_tradeoff-3546"><span class="linenos">3546</span></a>    <span class="n">k</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
</span><span id="demo_nsa_flow_tradeoff-3547"><a href="#demo_nsa_flow_tradeoff-3547"><span class="linenos">3547</span></a>    <span class="n">noise_level</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
</span><span id="demo_nsa_flow_tradeoff-3548"><a href="#demo_nsa_flow_tradeoff-3548"><span class="linenos">3548</span></a>    <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
</span><span id="demo_nsa_flow_tradeoff-3549"><a href="#demo_nsa_flow_tradeoff-3549"><span class="linenos">3549</span></a>    <span class="n">lr_strategy</span><span class="o">=</span><span class="s2">&quot;armijo&quot;</span><span class="p">,</span>
</span><span id="demo_nsa_flow_tradeoff-3550"><a href="#demo_nsa_flow_tradeoff-3550"><span class="linenos">3550</span></a>    <span class="n">apply_nonneg</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">,</span>
</span><span id="demo_nsa_flow_tradeoff-3551"><a href="#demo_nsa_flow_tradeoff-3551"><span class="linenos">3551</span></a>    <span class="n">warmup_iters</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
</span><span id="demo_nsa_flow_tradeoff-3552"><a href="#demo_nsa_flow_tradeoff-3552"><span class="linenos">3552</span></a>    <span class="n">tol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span>
</span><span id="demo_nsa_flow_tradeoff-3553"><a href="#demo_nsa_flow_tradeoff-3553"><span class="linenos">3553</span></a>    <span class="n">window_size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
</span><span id="demo_nsa_flow_tradeoff-3554"><a href="#demo_nsa_flow_tradeoff-3554"><span class="linenos">3554</span></a>    <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="demo_nsa_flow_tradeoff-3555"><a href="#demo_nsa_flow_tradeoff-3555"><span class="linenos">3555</span></a>    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="demo_nsa_flow_tradeoff-3556"><a href="#demo_nsa_flow_tradeoff-3556"><span class="linenos">3556</span></a>    <span class="n">save_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="demo_nsa_flow_tradeoff-3557"><a href="#demo_nsa_flow_tradeoff-3557"><span class="linenos">3557</span></a>    <span class="n">fig_dpi</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span>
</span><span id="demo_nsa_flow_tradeoff-3558"><a href="#demo_nsa_flow_tradeoff-3558"><span class="linenos">3558</span></a>    <span class="n">legend_y</span><span class="o">=</span><span class="mf">0.50</span><span class="p">,</span>         <span class="c1">#  knob 1: vertical position of legend</span>
</span><span id="demo_nsa_flow_tradeoff-3559"><a href="#demo_nsa_flow_tradeoff-3559"><span class="linenos">3559</span></a>    <span class="n">font_scale</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span>        <span class="c1">#  knob 2: controls all font sizes</span>
</span><span id="demo_nsa_flow_tradeoff-3560"><a href="#demo_nsa_flow_tradeoff-3560"><span class="linenos">3560</span></a>    <span class="n">fig_scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>         <span class="c1">#  knob 3: controls overall figure size</span>
</span><span id="demo_nsa_flow_tradeoff-3561"><a href="#demo_nsa_flow_tradeoff-3561"><span class="linenos">3561</span></a><span class="p">):</span>
</span><span id="demo_nsa_flow_tradeoff-3562"><a href="#demo_nsa_flow_tradeoff-3562"><span class="linenos">3562</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="demo_nsa_flow_tradeoff-3563"><a href="#demo_nsa_flow_tradeoff-3563"><span class="linenos">3563</span></a><span class="sd">    Educational demo: visualize how NSA-Flow trades off fidelity vs orthogonality</span>
</span><span id="demo_nsa_flow_tradeoff-3564"><a href="#demo_nsa_flow_tradeoff-3564"><span class="linenos">3564</span></a><span class="sd">    across a range of w values, with optional figure saving and adjustable layout.</span>
</span><span id="demo_nsa_flow_tradeoff-3565"><a href="#demo_nsa_flow_tradeoff-3565"><span class="linenos">3565</span></a>
</span><span id="demo_nsa_flow_tradeoff-3566"><a href="#demo_nsa_flow_tradeoff-3566"><span class="linenos">3566</span></a><span class="sd">    Layout knobs:</span>
</span><span id="demo_nsa_flow_tradeoff-3567"><a href="#demo_nsa_flow_tradeoff-3567"><span class="linenos">3567</span></a><span class="sd">        legend_y   moves the legend vertically in the first subplot</span>
</span><span id="demo_nsa_flow_tradeoff-3568"><a href="#demo_nsa_flow_tradeoff-3568"><span class="linenos">3568</span></a><span class="sd">        font_scale  single scalar controlling all font sizes</span>
</span><span id="demo_nsa_flow_tradeoff-3569"><a href="#demo_nsa_flow_tradeoff-3569"><span class="linenos">3569</span></a><span class="sd">        fig_scale   overall scaling of figure dimensions</span>
</span><span id="demo_nsa_flow_tradeoff-3570"><a href="#demo_nsa_flow_tradeoff-3570"><span class="linenos">3570</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="demo_nsa_flow_tradeoff-3571"><a href="#demo_nsa_flow_tradeoff-3571"><span class="linenos">3571</span></a>
</span><span id="demo_nsa_flow_tradeoff-3572"><a href="#demo_nsa_flow_tradeoff-3572"><span class="linenos">3572</span></a>    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
</span><span id="demo_nsa_flow_tradeoff-3573"><a href="#demo_nsa_flow_tradeoff-3573"><span class="linenos">3573</span></a>    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
</span><span id="demo_nsa_flow_tradeoff-3574"><a href="#demo_nsa_flow_tradeoff-3574"><span class="linenos">3574</span></a>
</span><span id="demo_nsa_flow_tradeoff-3575"><a href="#demo_nsa_flow_tradeoff-3575"><span class="linenos">3575</span></a>    <span class="c1"># --- Synthetic setup ---</span>
</span><span id="demo_nsa_flow_tradeoff-3576"><a href="#demo_nsa_flow_tradeoff-3576"><span class="linenos">3576</span></a>    <span class="n">X_true</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
</span><span id="demo_nsa_flow_tradeoff-3577"><a href="#demo_nsa_flow_tradeoff-3577"><span class="linenos">3577</span></a>    <span class="n">X_true</span> <span class="o">=</span> <span class="n">nsa_flow_retract_auto</span><span class="p">(</span><span class="n">X_true</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
</span><span id="demo_nsa_flow_tradeoff-3578"><a href="#demo_nsa_flow_tradeoff-3578"><span class="linenos">3578</span></a>    <span class="n">X0</span> <span class="o">=</span> <span class="n">X_true</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="demo_nsa_flow_tradeoff-3579"><a href="#demo_nsa_flow_tradeoff-3579"><span class="linenos">3579</span></a>    <span class="n">Y0</span> <span class="o">=</span> <span class="n">X_true</span> <span class="o">+</span> <span class="n">noise_level</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">X_true</span><span class="p">)</span>
</span><span id="demo_nsa_flow_tradeoff-3580"><a href="#demo_nsa_flow_tradeoff-3580"><span class="linenos">3580</span></a>
</span><span id="demo_nsa_flow_tradeoff-3581"><a href="#demo_nsa_flow_tradeoff-3581"><span class="linenos">3581</span></a>    <span class="k">if</span> <span class="n">w_values</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="demo_nsa_flow_tradeoff-3582"><a href="#demo_nsa_flow_tradeoff-3582"><span class="linenos">3582</span></a>        <span class="n">w_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="demo_nsa_flow_tradeoff-3583"><a href="#demo_nsa_flow_tradeoff-3583"><span class="linenos">3583</span></a>        <span class="n">w_values</span> <span class="o">=</span> <span class="p">[</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.99</span> <span class="p">]</span>
</span><span id="demo_nsa_flow_tradeoff-3584"><a href="#demo_nsa_flow_tradeoff-3584"><span class="linenos">3584</span></a>
</span><span id="demo_nsa_flow_tradeoff-3585"><a href="#demo_nsa_flow_tradeoff-3585"><span class="linenos">3585</span></a>    <span class="c1"># --- Figure setup ---</span>
</span><span id="demo_nsa_flow_tradeoff-3586"><a href="#demo_nsa_flow_tradeoff-3586"><span class="linenos">3586</span></a>    <span class="n">ncols</span> <span class="o">=</span> <span class="mi">4</span>
</span><span id="demo_nsa_flow_tradeoff-3587"><a href="#demo_nsa_flow_tradeoff-3587"><span class="linenos">3587</span></a>    <span class="n">nrows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">w_values</span><span class="p">)</span> <span class="o">/</span> <span class="n">ncols</span><span class="p">))</span>
</span><span id="demo_nsa_flow_tradeoff-3588"><a href="#demo_nsa_flow_tradeoff-3588"><span class="linenos">3588</span></a>    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
</span><span id="demo_nsa_flow_tradeoff-3589"><a href="#demo_nsa_flow_tradeoff-3589"><span class="linenos">3589</span></a>        <span class="n">nrows</span><span class="p">,</span>
</span><span id="demo_nsa_flow_tradeoff-3590"><a href="#demo_nsa_flow_tradeoff-3590"><span class="linenos">3590</span></a>        <span class="n">ncols</span><span class="p">,</span>
</span><span id="demo_nsa_flow_tradeoff-3591"><a href="#demo_nsa_flow_tradeoff-3591"><span class="linenos">3591</span></a>        <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">fig_scale</span> <span class="o">*</span> <span class="mi">16</span><span class="p">,</span> <span class="n">fig_scale</span> <span class="o">*</span> <span class="mf">3.5</span> <span class="o">*</span> <span class="n">nrows</span><span class="p">)</span>
</span><span id="demo_nsa_flow_tradeoff-3592"><a href="#demo_nsa_flow_tradeoff-3592"><span class="linenos">3592</span></a>    <span class="p">)</span>
</span><span id="demo_nsa_flow_tradeoff-3593"><a href="#demo_nsa_flow_tradeoff-3593"><span class="linenos">3593</span></a>    <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="demo_nsa_flow_tradeoff-3594"><a href="#demo_nsa_flow_tradeoff-3594"><span class="linenos">3594</span></a>
</span><span id="demo_nsa_flow_tradeoff-3595"><a href="#demo_nsa_flow_tradeoff-3595"><span class="linenos">3595</span></a>    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="demo_nsa_flow_tradeoff-3596"><a href="#demo_nsa_flow_tradeoff-3596"><span class="linenos">3596</span></a>
</span><span id="demo_nsa_flow_tradeoff-3597"><a href="#demo_nsa_flow_tradeoff-3597"><span class="linenos">3597</span></a>    <span class="c1"># --- Font sizes (scaled globally) ---</span>
</span><span id="demo_nsa_flow_tradeoff-3598"><a href="#demo_nsa_flow_tradeoff-3598"><span class="linenos">3598</span></a>    <span class="n">title_fs</span> <span class="o">=</span> <span class="mi">12</span> <span class="o">*</span> <span class="n">font_scale</span>
</span><span id="demo_nsa_flow_tradeoff-3599"><a href="#demo_nsa_flow_tradeoff-3599"><span class="linenos">3599</span></a>    <span class="n">label_fs</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">font_scale</span>
</span><span id="demo_nsa_flow_tradeoff-3600"><a href="#demo_nsa_flow_tradeoff-3600"><span class="linenos">3600</span></a>    <span class="n">annot_fs</span> <span class="o">=</span> <span class="mf">8.5</span> <span class="o">*</span> <span class="n">font_scale</span>
</span><span id="demo_nsa_flow_tradeoff-3601"><a href="#demo_nsa_flow_tradeoff-3601"><span class="linenos">3601</span></a>    <span class="n">legend_fs</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">font_scale</span>
</span><span id="demo_nsa_flow_tradeoff-3602"><a href="#demo_nsa_flow_tradeoff-3602"><span class="linenos">3602</span></a>    <span class="n">suptitle_fs</span> <span class="o">=</span> <span class="mi">14</span> <span class="o">*</span> <span class="n">font_scale</span>
</span><span id="demo_nsa_flow_tradeoff-3603"><a href="#demo_nsa_flow_tradeoff-3603"><span class="linenos">3603</span></a>
</span><span id="demo_nsa_flow_tradeoff-3604"><a href="#demo_nsa_flow_tradeoff-3604"><span class="linenos">3604</span></a>    <span class="c1"># --- Main sweep ---</span>
</span><span id="demo_nsa_flow_tradeoff-3605"><a href="#demo_nsa_flow_tradeoff-3605"><span class="linenos">3605</span></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">w_values</span><span class="p">):</span>
</span><span id="demo_nsa_flow_tradeoff-3606"><a href="#demo_nsa_flow_tradeoff-3606"><span class="linenos">3606</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">nsa_flow_orth</span><span class="p">(</span>
</span><span id="demo_nsa_flow_tradeoff-3607"><a href="#demo_nsa_flow_tradeoff-3607"><span class="linenos">3607</span></a>            <span class="n">Y0</span><span class="p">,</span>
</span><span id="demo_nsa_flow_tradeoff-3608"><a href="#demo_nsa_flow_tradeoff-3608"><span class="linenos">3608</span></a>            <span class="n">w</span><span class="o">=</span><span class="n">w</span><span class="p">,</span>
</span><span id="demo_nsa_flow_tradeoff-3609"><a href="#demo_nsa_flow_tradeoff-3609"><span class="linenos">3609</span></a>            <span class="n">max_iter</span><span class="o">=</span><span class="n">max_iter</span><span class="p">,</span>
</span><span id="demo_nsa_flow_tradeoff-3610"><a href="#demo_nsa_flow_tradeoff-3610"><span class="linenos">3610</span></a>            <span class="n">initial_learning_rate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="demo_nsa_flow_tradeoff-3611"><a href="#demo_nsa_flow_tradeoff-3611"><span class="linenos">3611</span></a>            <span class="n">lr_strategy</span><span class="o">=</span><span class="n">lr_strategy</span><span class="p">,</span>
</span><span id="demo_nsa_flow_tradeoff-3612"><a href="#demo_nsa_flow_tradeoff-3612"><span class="linenos">3612</span></a>            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
</span><span id="demo_nsa_flow_tradeoff-3613"><a href="#demo_nsa_flow_tradeoff-3613"><span class="linenos">3613</span></a>            <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span>
</span><span id="demo_nsa_flow_tradeoff-3614"><a href="#demo_nsa_flow_tradeoff-3614"><span class="linenos">3614</span></a>            <span class="n">window_size</span><span class="o">=</span><span class="n">window_size</span><span class="p">,</span>
</span><span id="demo_nsa_flow_tradeoff-3615"><a href="#demo_nsa_flow_tradeoff-3615"><span class="linenos">3615</span></a>            <span class="n">warmup_iters</span><span class="o">=</span><span class="n">warmup_iters</span><span class="p">,</span>
</span><span id="demo_nsa_flow_tradeoff-3616"><a href="#demo_nsa_flow_tradeoff-3616"><span class="linenos">3616</span></a>            <span class="n">apply_nonneg</span><span class="o">=</span><span class="n">apply_nonneg</span><span class="p">,</span>
</span><span id="demo_nsa_flow_tradeoff-3617"><a href="#demo_nsa_flow_tradeoff-3617"><span class="linenos">3617</span></a>        <span class="p">)</span>
</span><span id="demo_nsa_flow_tradeoff-3618"><a href="#demo_nsa_flow_tradeoff-3618"><span class="linenos">3618</span></a>
</span><span id="demo_nsa_flow_tradeoff-3619"><a href="#demo_nsa_flow_tradeoff-3619"><span class="linenos">3619</span></a>        <span class="n">X_target</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]</span>
</span><span id="demo_nsa_flow_tradeoff-3620"><a href="#demo_nsa_flow_tradeoff-3620"><span class="linenos">3620</span></a>        <span class="n">Y_final</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;Y&quot;</span><span class="p">]</span>
</span><span id="demo_nsa_flow_tradeoff-3621"><a href="#demo_nsa_flow_tradeoff-3621"><span class="linenos">3621</span></a>
</span><span id="demo_nsa_flow_tradeoff-3622"><a href="#demo_nsa_flow_tradeoff-3622"><span class="linenos">3622</span></a>        <span class="n">fid_start</span> <span class="o">=</span> <span class="n">fidelity_scaled</span><span class="p">(</span><span class="n">X_target</span><span class="p">,</span> <span class="n">Y0</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="demo_nsa_flow_tradeoff-3623"><a href="#demo_nsa_flow_tradeoff-3623"><span class="linenos">3623</span></a>        <span class="n">fid_end</span> <span class="o">=</span> <span class="n">fidelity_scaled</span><span class="p">(</span><span class="n">X_target</span><span class="p">,</span> <span class="n">Y_final</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="demo_nsa_flow_tradeoff-3624"><a href="#demo_nsa_flow_tradeoff-3624"><span class="linenos">3624</span></a>
</span><span id="demo_nsa_flow_tradeoff-3625"><a href="#demo_nsa_flow_tradeoff-3625"><span class="linenos">3625</span></a>        <span class="n">orth_start</span> <span class="o">=</span> <span class="n">invariant_orthogonality_defect</span><span class="p">(</span><span class="n">Y0</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="demo_nsa_flow_tradeoff-3626"><a href="#demo_nsa_flow_tradeoff-3626"><span class="linenos">3626</span></a>        <span class="n">orth_end</span> <span class="o">=</span> <span class="n">invariant_orthogonality_defect</span><span class="p">(</span><span class="n">Y_final</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="demo_nsa_flow_tradeoff-3627"><a href="#demo_nsa_flow_tradeoff-3627"><span class="linenos">3627</span></a>
</span><span id="demo_nsa_flow_tradeoff-3628"><a href="#demo_nsa_flow_tradeoff-3628"><span class="linenos">3628</span></a>        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="demo_nsa_flow_tradeoff-3629"><a href="#demo_nsa_flow_tradeoff-3629"><span class="linenos">3629</span></a>            <span class="s2">&quot;w&quot;</span><span class="p">:</span> <span class="n">w</span><span class="p">,</span>
</span><span id="demo_nsa_flow_tradeoff-3630"><a href="#demo_nsa_flow_tradeoff-3630"><span class="linenos">3630</span></a>            <span class="s2">&quot;fid_start&quot;</span><span class="p">:</span> <span class="n">fid_start</span><span class="p">,</span>
</span><span id="demo_nsa_flow_tradeoff-3631"><a href="#demo_nsa_flow_tradeoff-3631"><span class="linenos">3631</span></a>            <span class="s2">&quot;fid_end&quot;</span><span class="p">:</span> <span class="n">fid_end</span><span class="p">,</span>
</span><span id="demo_nsa_flow_tradeoff-3632"><a href="#demo_nsa_flow_tradeoff-3632"><span class="linenos">3632</span></a>            <span class="s2">&quot;orth_start&quot;</span><span class="p">:</span> <span class="n">orth_start</span><span class="p">,</span>
</span><span id="demo_nsa_flow_tradeoff-3633"><a href="#demo_nsa_flow_tradeoff-3633"><span class="linenos">3633</span></a>            <span class="s2">&quot;orth_end&quot;</span><span class="p">:</span> <span class="n">orth_end</span><span class="p">,</span>
</span><span id="demo_nsa_flow_tradeoff-3634"><a href="#demo_nsa_flow_tradeoff-3634"><span class="linenos">3634</span></a>            <span class="s2">&quot;best_total_energy&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;best_total_energy&quot;</span><span class="p">],</span>
</span><span id="demo_nsa_flow_tradeoff-3635"><a href="#demo_nsa_flow_tradeoff-3635"><span class="linenos">3635</span></a>        <span class="p">})</span>
</span><span id="demo_nsa_flow_tradeoff-3636"><a href="#demo_nsa_flow_tradeoff-3636"><span class="linenos">3636</span></a>
</span><span id="demo_nsa_flow_tradeoff-3637"><a href="#demo_nsa_flow_tradeoff-3637"><span class="linenos">3637</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="demo_nsa_flow_tradeoff-3638"><a href="#demo_nsa_flow_tradeoff-3638"><span class="linenos">3638</span></a>        <span class="n">trace</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;traces&quot;</span><span class="p">]</span>
</span><span id="demo_nsa_flow_tradeoff-3639"><a href="#demo_nsa_flow_tradeoff-3639"><span class="linenos">3639</span></a>
</span><span id="demo_nsa_flow_tradeoff-3640"><a href="#demo_nsa_flow_tradeoff-3640"><span class="linenos">3640</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
</span><span id="demo_nsa_flow_tradeoff-3641"><a href="#demo_nsa_flow_tradeoff-3641"><span class="linenos">3641</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">trace</span><span class="p">[</span><span class="s2">&quot;iter&quot;</span><span class="p">],</span> <span class="n">trace</span><span class="p">[</span><span class="s2">&quot;total_energy&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Total&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="demo_nsa_flow_tradeoff-3642"><a href="#demo_nsa_flow_tradeoff-3642"><span class="linenos">3642</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">trace</span><span class="p">[</span><span class="s2">&quot;iter&quot;</span><span class="p">],</span> <span class="n">trace</span><span class="p">[</span><span class="s2">&quot;fidelity&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Fidelity&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
</span><span id="demo_nsa_flow_tradeoff-3643"><a href="#demo_nsa_flow_tradeoff-3643"><span class="linenos">3643</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">trace</span><span class="p">[</span><span class="s2">&quot;iter&quot;</span><span class="p">],</span> <span class="n">trace</span><span class="p">[</span><span class="s2">&quot;orthogonality&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Orthogonality&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
</span><span id="demo_nsa_flow_tradeoff-3644"><a href="#demo_nsa_flow_tradeoff-3644"><span class="linenos">3644</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;w = </span><span class="si">{</span><span class="n">w</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">title_fs</span><span class="p">)</span>
</span><span id="demo_nsa_flow_tradeoff-3645"><a href="#demo_nsa_flow_tradeoff-3645"><span class="linenos">3645</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Iteration&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">label_fs</span><span class="p">)</span>
</span><span id="demo_nsa_flow_tradeoff-3646"><a href="#demo_nsa_flow_tradeoff-3646"><span class="linenos">3646</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Energy&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">label_fs</span><span class="p">)</span>
</span><span id="demo_nsa_flow_tradeoff-3647"><a href="#demo_nsa_flow_tradeoff-3647"><span class="linenos">3647</span></a>
</span><span id="demo_nsa_flow_tradeoff-3648"><a href="#demo_nsa_flow_tradeoff-3648"><span class="linenos">3648</span></a>            <span class="c1"># Annotate with metrics</span>
</span><span id="demo_nsa_flow_tradeoff-3649"><a href="#demo_nsa_flow_tradeoff-3649"><span class="linenos">3649</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
</span><span id="demo_nsa_flow_tradeoff-3650"><a href="#demo_nsa_flow_tradeoff-3650"><span class="linenos">3650</span></a>                <span class="mf">0.98</span><span class="p">,</span> <span class="mf">0.97</span><span class="p">,</span>
</span><span id="demo_nsa_flow_tradeoff-3651"><a href="#demo_nsa_flow_tradeoff-3651"><span class="linenos">3651</span></a>                <span class="sa">f</span><span class="s2">&quot;Fid: </span><span class="si">{</span><span class="n">fid_end</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="se">\n</span><span class="s2">Orth: </span><span class="si">{</span><span class="n">orth_end</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="demo_nsa_flow_tradeoff-3652"><a href="#demo_nsa_flow_tradeoff-3652"><span class="linenos">3652</span></a>                <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
</span><span id="demo_nsa_flow_tradeoff-3653"><a href="#demo_nsa_flow_tradeoff-3653"><span class="linenos">3653</span></a>                <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">annot_fs</span><span class="p">,</span>
</span><span id="demo_nsa_flow_tradeoff-3654"><a href="#demo_nsa_flow_tradeoff-3654"><span class="linenos">3654</span></a>                <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s2">&quot;round,pad=0.25&quot;</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.85</span><span class="p">)</span>
</span><span id="demo_nsa_flow_tradeoff-3655"><a href="#demo_nsa_flow_tradeoff-3655"><span class="linenos">3655</span></a>            <span class="p">)</span>
</span><span id="demo_nsa_flow_tradeoff-3656"><a href="#demo_nsa_flow_tradeoff-3656"><span class="linenos">3656</span></a>
</span><span id="demo_nsa_flow_tradeoff-3657"><a href="#demo_nsa_flow_tradeoff-3657"><span class="linenos">3657</span></a>        <span class="c1"># Legend only on the first panel</span>
</span><span id="demo_nsa_flow_tradeoff-3658"><a href="#demo_nsa_flow_tradeoff-3658"><span class="linenos">3658</span></a>        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="demo_nsa_flow_tradeoff-3659"><a href="#demo_nsa_flow_tradeoff-3659"><span class="linenos">3659</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="n">legend_fs</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">legend_y</span><span class="p">),</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="demo_nsa_flow_tradeoff-3660"><a href="#demo_nsa_flow_tradeoff-3660"><span class="linenos">3660</span></a>
</span><span id="demo_nsa_flow_tradeoff-3661"><a href="#demo_nsa_flow_tradeoff-3661"><span class="linenos">3661</span></a>    <span class="c1"># Hide unused axes</span>
</span><span id="demo_nsa_flow_tradeoff-3662"><a href="#demo_nsa_flow_tradeoff-3662"><span class="linenos">3662</span></a>    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)):</span>
</span><span id="demo_nsa_flow_tradeoff-3663"><a href="#demo_nsa_flow_tradeoff-3663"><span class="linenos">3663</span></a>        <span class="n">axes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</span><span id="demo_nsa_flow_tradeoff-3664"><a href="#demo_nsa_flow_tradeoff-3664"><span class="linenos">3664</span></a>
</span><span id="demo_nsa_flow_tradeoff-3665"><a href="#demo_nsa_flow_tradeoff-3665"><span class="linenos">3665</span></a>    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;NSA-Flow Tradeoff: Fidelity vs Orthogonality&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">suptitle_fs</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.995</span><span class="p">)</span>
</span><span id="demo_nsa_flow_tradeoff-3666"><a href="#demo_nsa_flow_tradeoff-3666"><span class="linenos">3666</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.97</span><span class="p">])</span>
</span><span id="demo_nsa_flow_tradeoff-3667"><a href="#demo_nsa_flow_tradeoff-3667"><span class="linenos">3667</span></a>
</span><span id="demo_nsa_flow_tradeoff-3668"><a href="#demo_nsa_flow_tradeoff-3668"><span class="linenos">3668</span></a>    <span class="c1"># --- Save or show ---</span>
</span><span id="demo_nsa_flow_tradeoff-3669"><a href="#demo_nsa_flow_tradeoff-3669"><span class="linenos">3669</span></a>    <span class="k">if</span> <span class="n">save_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="demo_nsa_flow_tradeoff-3670"><a href="#demo_nsa_flow_tradeoff-3670"><span class="linenos">3670</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="demo_nsa_flow_tradeoff-3671"><a href="#demo_nsa_flow_tradeoff-3671"><span class="linenos">3671</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">fig_dpi</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
</span><span id="demo_nsa_flow_tradeoff-3672"><a href="#demo_nsa_flow_tradeoff-3672"><span class="linenos">3672</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Figure saved to: </span><span class="si">{</span><span class="n">save_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="demo_nsa_flow_tradeoff-3673"><a href="#demo_nsa_flow_tradeoff-3673"><span class="linenos">3673</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="demo_nsa_flow_tradeoff-3674"><a href="#demo_nsa_flow_tradeoff-3674"><span class="linenos">3674</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="demo_nsa_flow_tradeoff-3675"><a href="#demo_nsa_flow_tradeoff-3675"><span class="linenos">3675</span></a>
</span><span id="demo_nsa_flow_tradeoff-3676"><a href="#demo_nsa_flow_tradeoff-3676"><span class="linenos">3676</span></a>    <span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</span><span id="demo_nsa_flow_tradeoff-3677"><a href="#demo_nsa_flow_tradeoff-3677"><span class="linenos">3677</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Summary of NSA-Flow tradeoff results:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="demo_nsa_flow_tradeoff-3678"><a href="#demo_nsa_flow_tradeoff-3678"><span class="linenos">3678</span></a>    <span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
</span><span id="demo_nsa_flow_tradeoff-3679"><a href="#demo_nsa_flow_tradeoff-3679"><span class="linenos">3679</span></a>
</span><span id="demo_nsa_flow_tradeoff-3680"><a href="#demo_nsa_flow_tradeoff-3680"><span class="linenos">3680</span></a>    <span class="k">return</span> <span class="n">results_df</span><span class="p">,</span> <span class="n">save_path</span>
</span></pre></div>


            <div class="docstring"><p>Educational demo: visualize how NSA-Flow trades off fidelity vs orthogonality
across a range of w values, with optional figure saving and adjustable layout.</p>

<p>Layout knobs:
    legend_y   moves the legend vertically in the first subplot
    font_scale  single scalar controlling all font sizes
    fig_scale   overall scaling of figure dimensions</p>
</div>


                </section>
                <section id="safe_to_tensor">
                            <input id="safe_to_tensor-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">safe_to_tensor</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">X</span>, </span><span class="param"><span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span>, </span><span class="param"><span class="n">device</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">name</span><span class="o">=</span><span class="s1">&#39;input&#39;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="safe_to_tensor-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#safe_to_tensor"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="safe_to_tensor-35"><a href="#safe_to_tensor-35"><span class="linenos">35</span></a><span class="k">def</span><span class="w"> </span><span class="nf">safe_to_tensor</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;input&quot;</span><span class="p">):</span>
</span><span id="safe_to_tensor-36"><a href="#safe_to_tensor-36"><span class="linenos">36</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="safe_to_tensor-37"><a href="#safe_to_tensor-37"><span class="linenos">37</span></a><span class="sd">    Safely convert an input (NumPy, pandas, or torch) into a clean torch.Tensor.</span>
</span><span id="safe_to_tensor-38"><a href="#safe_to_tensor-38"><span class="linenos">38</span></a>
</span><span id="safe_to_tensor-39"><a href="#safe_to_tensor-39"><span class="linenos">39</span></a><span class="sd">    Handles:</span>
</span><span id="safe_to_tensor-40"><a href="#safe_to_tensor-40"><span class="linenos">40</span></a><span class="sd">      - pd.DataFrame with mixed or non-numeric columns</span>
</span><span id="safe_to_tensor-41"><a href="#safe_to_tensor-41"><span class="linenos">41</span></a><span class="sd">      - np.ndarray with dtype=object or NaNs</span>
</span><span id="safe_to_tensor-42"><a href="#safe_to_tensor-42"><span class="linenos">42</span></a><span class="sd">      - torch.Tensor (passed through)</span>
</span><span id="safe_to_tensor-43"><a href="#safe_to_tensor-43"><span class="linenos">43</span></a><span class="sd">    </span>
</span><span id="safe_to_tensor-44"><a href="#safe_to_tensor-44"><span class="linenos">44</span></a><span class="sd">    Parameters</span>
</span><span id="safe_to_tensor-45"><a href="#safe_to_tensor-45"><span class="linenos">45</span></a><span class="sd">    ----------</span>
</span><span id="safe_to_tensor-46"><a href="#safe_to_tensor-46"><span class="linenos">46</span></a><span class="sd">    X : array-like</span>
</span><span id="safe_to_tensor-47"><a href="#safe_to_tensor-47"><span class="linenos">47</span></a><span class="sd">        Input array, DataFrame, or tensor.</span>
</span><span id="safe_to_tensor-48"><a href="#safe_to_tensor-48"><span class="linenos">48</span></a><span class="sd">    dtype : torch.dtype, optional</span>
</span><span id="safe_to_tensor-49"><a href="#safe_to_tensor-49"><span class="linenos">49</span></a><span class="sd">        Target tensor precision (default: torch.float64).</span>
</span><span id="safe_to_tensor-50"><a href="#safe_to_tensor-50"><span class="linenos">50</span></a><span class="sd">    device : torch.device or str, optional</span>
</span><span id="safe_to_tensor-51"><a href="#safe_to_tensor-51"><span class="linenos">51</span></a><span class="sd">        Target device (default: None  keep on CPU).</span>
</span><span id="safe_to_tensor-52"><a href="#safe_to_tensor-52"><span class="linenos">52</span></a><span class="sd">    name : str, optional</span>
</span><span id="safe_to_tensor-53"><a href="#safe_to_tensor-53"><span class="linenos">53</span></a><span class="sd">        Used in error messages for debugging context.</span>
</span><span id="safe_to_tensor-54"><a href="#safe_to_tensor-54"><span class="linenos">54</span></a><span class="sd">    </span>
</span><span id="safe_to_tensor-55"><a href="#safe_to_tensor-55"><span class="linenos">55</span></a><span class="sd">    Returns</span>
</span><span id="safe_to_tensor-56"><a href="#safe_to_tensor-56"><span class="linenos">56</span></a><span class="sd">    -------</span>
</span><span id="safe_to_tensor-57"><a href="#safe_to_tensor-57"><span class="linenos">57</span></a><span class="sd">    torch.Tensor</span>
</span><span id="safe_to_tensor-58"><a href="#safe_to_tensor-58"><span class="linenos">58</span></a><span class="sd">        Cleaned tensor with numeric dtype and NaNs replaced by 0.</span>
</span><span id="safe_to_tensor-59"><a href="#safe_to_tensor-59"><span class="linenos">59</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="safe_to_tensor-60"><a href="#safe_to_tensor-60"><span class="linenos">60</span></a>    <span class="c1"># --- Handle torch tensor early ---</span>
</span><span id="safe_to_tensor-61"><a href="#safe_to_tensor-61"><span class="linenos">61</span></a>    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
</span><span id="safe_to_tensor-62"><a href="#safe_to_tensor-62"><span class="linenos">62</span></a>        <span class="k">return</span> <span class="n">X</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="safe_to_tensor-63"><a href="#safe_to_tensor-63"><span class="linenos">63</span></a>
</span><span id="safe_to_tensor-64"><a href="#safe_to_tensor-64"><span class="linenos">64</span></a>    <span class="c1"># --- Handle pandas DataFrame ---</span>
</span><span id="safe_to_tensor-65"><a href="#safe_to_tensor-65"><span class="linenos">65</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
</span><span id="safe_to_tensor-66"><a href="#safe_to_tensor-66"><span class="linenos">66</span></a>        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
</span><span id="safe_to_tensor-67"><a href="#safe_to_tensor-67"><span class="linenos">67</span></a>
</span><span id="safe_to_tensor-68"><a href="#safe_to_tensor-68"><span class="linenos">68</span></a>    <span class="c1"># --- Handle numpy array ---</span>
</span><span id="safe_to_tensor-69"><a href="#safe_to_tensor-69"><span class="linenos">69</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
</span><span id="safe_to_tensor-70"><a href="#safe_to_tensor-70"><span class="linenos">70</span></a>        <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="nb">object</span><span class="p">:</span>
</span><span id="safe_to_tensor-71"><a href="#safe_to_tensor-71"><span class="linenos">71</span></a>            <span class="c1"># Convert elementwise, fallback to 0.0 on failure</span>
</span><span id="safe_to_tensor-72"><a href="#safe_to_tensor-72"><span class="linenos">72</span></a>            <span class="k">def</span><span class="w"> </span><span class="nf">_safe_float</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
</span><span id="safe_to_tensor-73"><a href="#safe_to_tensor-73"><span class="linenos">73</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="safe_to_tensor-74"><a href="#safe_to_tensor-74"><span class="linenos">74</span></a>                    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</span><span id="safe_to_tensor-75"><a href="#safe_to_tensor-75"><span class="linenos">75</span></a>                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="safe_to_tensor-76"><a href="#safe_to_tensor-76"><span class="linenos">76</span></a>                    <span class="k">return</span> <span class="mf">0.0</span>
</span><span id="safe_to_tensor-77"><a href="#safe_to_tensor-77"><span class="linenos">77</span></a>            <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">_safe_float</span><span class="p">)(</span><span class="n">X</span><span class="p">)</span>
</span><span id="safe_to_tensor-78"><a href="#safe_to_tensor-78"><span class="linenos">78</span></a>        <span class="c1"># Replace any remaining NaNs or infs</span>
</span><span id="safe_to_tensor-79"><a href="#safe_to_tensor-79"><span class="linenos">79</span></a>        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">posinf</span><span class="o">=</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">neginf</span><span class="o">=-</span><span class="mf">1e6</span><span class="p">)</span>
</span><span id="safe_to_tensor-80"><a href="#safe_to_tensor-80"><span class="linenos">80</span></a>        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
</span><span id="safe_to_tensor-81"><a href="#safe_to_tensor-81"><span class="linenos">81</span></a>        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="safe_to_tensor-82"><a href="#safe_to_tensor-82"><span class="linenos">82</span></a>
</span><span id="safe_to_tensor-83"><a href="#safe_to_tensor-83"><span class="linenos">83</span></a>    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported type for </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Safely convert an input (NumPy, pandas, or torch) into a clean torch.Tensor.</p>

<p>Handles:</p>

<ul>
<li>pd.DataFrame with mixed or non-numeric columns</li>
<li>np.ndarray with dtype=object or NaNs</li>
<li>torch.Tensor (passed through)</li>
</ul>

<h2 id="parameters">Parameters</h2>

<p>X : array-like
    Input array, DataFrame, or tensor.
dtype : torch.dtype, optional
    Target tensor precision (default: torch.float64).
device : torch.device or str, optional
    Target device (default: None  keep on CPU).
name : str, optional
    Used in error messages for debugging context.</p>

<h2 id="returns">Returns</h2>

<p>torch.Tensor
    Cleaned tensor with numeric dtype and NaNs replaced by 0.</p>
</div>


                </section>
                <section id="demo_nsa_flow_optimizer_tradeoff">
                            <input id="demo_nsa_flow_optimizer_tradeoff-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">demo_nsa_flow_optimizer_tradeoff</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">optimizers</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">w_values</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">p</span><span class="o">=</span><span class="mi">40</span>,</span><span class="param">	<span class="n">k</span><span class="o">=</span><span class="mi">6</span>,</span><span class="param">	<span class="n">noise_level</span><span class="o">=</span><span class="mf">0.05</span>,</span><span class="param">	<span class="n">max_iter</span><span class="o">=</span><span class="mi">600</span>,</span><span class="param">	<span class="n">lr_strategy</span><span class="o">=</span><span class="s1">&#39;armijo&#39;</span>,</span><span class="param">	<span class="n">apply_nonneg</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span>,</span><span class="param">	<span class="n">warmup_iters</span><span class="o">=</span><span class="mi">20</span>,</span><span class="param">	<span class="n">tol</span><span class="o">=</span><span class="mf">1e-06</span>,</span><span class="param">	<span class="n">window_size</span><span class="o">=</span><span class="mi">8</span>,</span><span class="param">	<span class="n">seed</span><span class="o">=</span><span class="mi">0</span>,</span><span class="param">	<span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">nrows</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">ncols</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">save_path</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">fig_dpi</span><span class="o">=</span><span class="mi">250</span>,</span><span class="param">	<span class="n">legend_y</span><span class="o">=</span><span class="mf">0.4</span>,</span><span class="param">	<span class="n">font_scale</span><span class="o">=</span><span class="mf">1.1</span>,</span><span class="param">	<span class="n">fig_scale</span><span class="o">=</span><span class="mf">1.0</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="demo_nsa_flow_optimizer_tradeoff-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#demo_nsa_flow_optimizer_tradeoff"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="demo_nsa_flow_optimizer_tradeoff-3684"><a href="#demo_nsa_flow_optimizer_tradeoff-3684"><span class="linenos">3684</span></a><span class="k">def</span><span class="w"> </span><span class="nf">demo_nsa_flow_optimizer_tradeoff</span><span class="p">(</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3685"><a href="#demo_nsa_flow_optimizer_tradeoff-3685"><span class="linenos">3685</span></a>    <span class="n">optimizers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3686"><a href="#demo_nsa_flow_optimizer_tradeoff-3686"><span class="linenos">3686</span></a>    <span class="n">w_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3687"><a href="#demo_nsa_flow_optimizer_tradeoff-3687"><span class="linenos">3687</span></a>    <span class="n">p</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3688"><a href="#demo_nsa_flow_optimizer_tradeoff-3688"><span class="linenos">3688</span></a>    <span class="n">k</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3689"><a href="#demo_nsa_flow_optimizer_tradeoff-3689"><span class="linenos">3689</span></a>    <span class="n">noise_level</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3690"><a href="#demo_nsa_flow_optimizer_tradeoff-3690"><span class="linenos">3690</span></a>    <span class="n">max_iter</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3691"><a href="#demo_nsa_flow_optimizer_tradeoff-3691"><span class="linenos">3691</span></a>    <span class="n">lr_strategy</span><span class="o">=</span><span class="s2">&quot;armijo&quot;</span><span class="p">,</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3692"><a href="#demo_nsa_flow_optimizer_tradeoff-3692"><span class="linenos">3692</span></a>    <span class="n">apply_nonneg</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">,</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3693"><a href="#demo_nsa_flow_optimizer_tradeoff-3693"><span class="linenos">3693</span></a>    <span class="n">warmup_iters</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3694"><a href="#demo_nsa_flow_optimizer_tradeoff-3694"><span class="linenos">3694</span></a>    <span class="n">tol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3695"><a href="#demo_nsa_flow_optimizer_tradeoff-3695"><span class="linenos">3695</span></a>    <span class="n">window_size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3696"><a href="#demo_nsa_flow_optimizer_tradeoff-3696"><span class="linenos">3696</span></a>    <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3697"><a href="#demo_nsa_flow_optimizer_tradeoff-3697"><span class="linenos">3697</span></a>    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3698"><a href="#demo_nsa_flow_optimizer_tradeoff-3698"><span class="linenos">3698</span></a>    <span class="n">nrows</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3699"><a href="#demo_nsa_flow_optimizer_tradeoff-3699"><span class="linenos">3699</span></a>    <span class="n">ncols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3700"><a href="#demo_nsa_flow_optimizer_tradeoff-3700"><span class="linenos">3700</span></a>    <span class="n">save_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3701"><a href="#demo_nsa_flow_optimizer_tradeoff-3701"><span class="linenos">3701</span></a>    <span class="n">fig_dpi</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3702"><a href="#demo_nsa_flow_optimizer_tradeoff-3702"><span class="linenos">3702</span></a>    <span class="n">legend_y</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3703"><a href="#demo_nsa_flow_optimizer_tradeoff-3703"><span class="linenos">3703</span></a>    <span class="n">font_scale</span><span class="o">=</span><span class="mf">1.1</span><span class="p">,</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3704"><a href="#demo_nsa_flow_optimizer_tradeoff-3704"><span class="linenos">3704</span></a>    <span class="n">fig_scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3705"><a href="#demo_nsa_flow_optimizer_tradeoff-3705"><span class="linenos">3705</span></a><span class="p">):</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3706"><a href="#demo_nsa_flow_optimizer_tradeoff-3706"><span class="linenos">3706</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3707"><a href="#demo_nsa_flow_optimizer_tradeoff-3707"><span class="linenos">3707</span></a><span class="sd">    Compare optimizer performance across w-values.</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3708"><a href="#demo_nsa_flow_optimizer_tradeoff-3708"><span class="linenos">3708</span></a><span class="sd">    Plots Fidelity (blue) and Orthogonality (red) together on each optimizer&#39;s subplot.</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3709"><a href="#demo_nsa_flow_optimizer_tradeoff-3709"><span class="linenos">3709</span></a><span class="sd">    Allows user to choose subplot grid dimensions (nrows, ncols).</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3710"><a href="#demo_nsa_flow_optimizer_tradeoff-3710"><span class="linenos">3710</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3711"><a href="#demo_nsa_flow_optimizer_tradeoff-3711"><span class="linenos">3711</span></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3712"><a href="#demo_nsa_flow_optimizer_tradeoff-3712"><span class="linenos">3712</span></a>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3713"><a href="#demo_nsa_flow_optimizer_tradeoff-3713"><span class="linenos">3713</span></a>    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3714"><a href="#demo_nsa_flow_optimizer_tradeoff-3714"><span class="linenos">3714</span></a>    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3715"><a href="#demo_nsa_flow_optimizer_tradeoff-3715"><span class="linenos">3715</span></a>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3716"><a href="#demo_nsa_flow_optimizer_tradeoff-3716"><span class="linenos">3716</span></a>    <span class="c1"># --- Synthetic setup ---</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3717"><a href="#demo_nsa_flow_optimizer_tradeoff-3717"><span class="linenos">3717</span></a>    <span class="n">X_true</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3718"><a href="#demo_nsa_flow_optimizer_tradeoff-3718"><span class="linenos">3718</span></a>    <span class="n">X_true</span> <span class="o">=</span> <span class="n">nsa_flow_retract_auto</span><span class="p">(</span><span class="n">X_true</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3719"><a href="#demo_nsa_flow_optimizer_tradeoff-3719"><span class="linenos">3719</span></a>    <span class="n">Y0</span> <span class="o">=</span> <span class="n">X_true</span> <span class="o">+</span> <span class="n">noise_level</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">X_true</span><span class="p">)</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3720"><a href="#demo_nsa_flow_optimizer_tradeoff-3720"><span class="linenos">3720</span></a>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3721"><a href="#demo_nsa_flow_optimizer_tradeoff-3721"><span class="linenos">3721</span></a>    <span class="c1"># --- Weight values ---</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3722"><a href="#demo_nsa_flow_optimizer_tradeoff-3722"><span class="linenos">3722</span></a>    <span class="k">if</span> <span class="n">w_values</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3723"><a href="#demo_nsa_flow_optimizer_tradeoff-3723"><span class="linenos">3723</span></a>        <span class="n">w_values</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">]</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3724"><a href="#demo_nsa_flow_optimizer_tradeoff-3724"><span class="linenos">3724</span></a>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3725"><a href="#demo_nsa_flow_optimizer_tradeoff-3725"><span class="linenos">3725</span></a>    <span class="c1"># --- Optimizers ---</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3726"><a href="#demo_nsa_flow_optimizer_tradeoff-3726"><span class="linenos">3726</span></a>    <span class="k">if</span> <span class="n">optimizers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3727"><a href="#demo_nsa_flow_optimizer_tradeoff-3727"><span class="linenos">3727</span></a>        <span class="n">optimizers</span> <span class="o">=</span> <span class="n">get_torch_optimizer</span><span class="p">(</span><span class="n">return_list</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3728"><a href="#demo_nsa_flow_optimizer_tradeoff-3728"><span class="linenos">3728</span></a>        <span class="n">optimizers</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">optimizers</span> <span class="k">if</span> <span class="n">o</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;pid&quot;</span><span class="p">,</span> <span class="s2">&quot;qhm&quot;</span><span class="p">,</span> <span class="s2">&quot;qhadam&quot;</span><span class="p">]]</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3729"><a href="#demo_nsa_flow_optimizer_tradeoff-3729"><span class="linenos">3729</span></a>        <span class="n">optimizers</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;adabound&quot;</span><span class="p">,</span><span class="s2">&quot;adam&quot;</span><span class="p">,</span><span class="s2">&quot;asgd&quot;</span><span class="p">,</span><span class="s2">&quot;lars&quot;</span><span class="p">,</span><span class="s2">&quot;radam&quot;</span><span class="p">,</span><span class="s2">&quot;sgd&quot;</span><span class="p">,</span><span class="s2">&quot;sgdp&quot;</span><span class="p">,</span><span class="s2">&quot;yogi&quot;</span><span class="p">]</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3730"><a href="#demo_nsa_flow_optimizer_tradeoff-3730"><span class="linenos">3730</span></a>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3731"><a href="#demo_nsa_flow_optimizer_tradeoff-3731"><span class="linenos">3731</span></a>    <span class="n">n_opt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">optimizers</span><span class="p">)</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3732"><a href="#demo_nsa_flow_optimizer_tradeoff-3732"><span class="linenos">3732</span></a>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3733"><a href="#demo_nsa_flow_optimizer_tradeoff-3733"><span class="linenos">3733</span></a>    <span class="c1"># --- Determine layout ---</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3734"><a href="#demo_nsa_flow_optimizer_tradeoff-3734"><span class="linenos">3734</span></a>    <span class="k">if</span> <span class="n">nrows</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">ncols</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3735"><a href="#demo_nsa_flow_optimizer_tradeoff-3735"><span class="linenos">3735</span></a>        <span class="n">ncols</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n_opt</span><span class="p">))</span> <span class="k">if</span> <span class="n">ncols</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ncols</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3736"><a href="#demo_nsa_flow_optimizer_tradeoff-3736"><span class="linenos">3736</span></a>        <span class="n">nrows</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_opt</span> <span class="o">/</span> <span class="n">ncols</span><span class="p">)</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3737"><a href="#demo_nsa_flow_optimizer_tradeoff-3737"><span class="linenos">3737</span></a>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3738"><a href="#demo_nsa_flow_optimizer_tradeoff-3738"><span class="linenos">3738</span></a>    <span class="c1"># --- Font and figure parameters ---</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3739"><a href="#demo_nsa_flow_optimizer_tradeoff-3739"><span class="linenos">3739</span></a>    <span class="n">title_fs</span> <span class="o">=</span> <span class="mi">12</span> <span class="o">*</span> <span class="n">font_scale</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3740"><a href="#demo_nsa_flow_optimizer_tradeoff-3740"><span class="linenos">3740</span></a>    <span class="n">label_fs</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">font_scale</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3741"><a href="#demo_nsa_flow_optimizer_tradeoff-3741"><span class="linenos">3741</span></a>    <span class="n">legend_fs</span> <span class="o">=</span> <span class="mf">8.5</span> <span class="o">*</span> <span class="n">font_scale</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3742"><a href="#demo_nsa_flow_optimizer_tradeoff-3742"><span class="linenos">3742</span></a>    <span class="n">suptitle_fs</span> <span class="o">=</span> <span class="mi">15</span> <span class="o">*</span> <span class="n">font_scale</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3743"><a href="#demo_nsa_flow_optimizer_tradeoff-3743"><span class="linenos">3743</span></a>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3744"><a href="#demo_nsa_flow_optimizer_tradeoff-3744"><span class="linenos">3744</span></a>    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3745"><a href="#demo_nsa_flow_optimizer_tradeoff-3745"><span class="linenos">3745</span></a>        <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3746"><a href="#demo_nsa_flow_optimizer_tradeoff-3746"><span class="linenos">3746</span></a>        <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">fig_scale</span> <span class="o">*</span> <span class="mf">4.8</span> <span class="o">*</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">fig_scale</span> <span class="o">*</span> <span class="mf">3.6</span> <span class="o">*</span> <span class="n">nrows</span><span class="p">),</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3747"><a href="#demo_nsa_flow_optimizer_tradeoff-3747"><span class="linenos">3747</span></a>        <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3748"><a href="#demo_nsa_flow_optimizer_tradeoff-3748"><span class="linenos">3748</span></a>    <span class="p">)</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3749"><a href="#demo_nsa_flow_optimizer_tradeoff-3749"><span class="linenos">3749</span></a>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3750"><a href="#demo_nsa_flow_optimizer_tradeoff-3750"><span class="linenos">3750</span></a>    <span class="n">axes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># flatten grid</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3751"><a href="#demo_nsa_flow_optimizer_tradeoff-3751"><span class="linenos">3751</span></a>    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3752"><a href="#demo_nsa_flow_optimizer_tradeoff-3752"><span class="linenos">3752</span></a>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3753"><a href="#demo_nsa_flow_optimizer_tradeoff-3753"><span class="linenos">3753</span></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">opt_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">optimizers</span><span class="p">):</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3754"><a href="#demo_nsa_flow_optimizer_tradeoff-3754"><span class="linenos">3754</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3755"><a href="#demo_nsa_flow_optimizer_tradeoff-3755"><span class="linenos">3755</span></a>        <span class="n">fid_vals</span><span class="p">,</span> <span class="n">orth_vals</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3756"><a href="#demo_nsa_flow_optimizer_tradeoff-3756"><span class="linenos">3756</span></a>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3757"><a href="#demo_nsa_flow_optimizer_tradeoff-3757"><span class="linenos">3757</span></a>        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">w_values</span><span class="p">:</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3758"><a href="#demo_nsa_flow_optimizer_tradeoff-3758"><span class="linenos">3758</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3759"><a href="#demo_nsa_flow_optimizer_tradeoff-3759"><span class="linenos">3759</span></a>                <span class="n">result</span> <span class="o">=</span> <span class="n">nsa_flow_orth</span><span class="p">(</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3760"><a href="#demo_nsa_flow_optimizer_tradeoff-3760"><span class="linenos">3760</span></a>                    <span class="n">Y0</span><span class="p">,</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3761"><a href="#demo_nsa_flow_optimizer_tradeoff-3761"><span class="linenos">3761</span></a>                    <span class="n">w</span><span class="o">=</span><span class="n">w</span><span class="p">,</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3762"><a href="#demo_nsa_flow_optimizer_tradeoff-3762"><span class="linenos">3762</span></a>                    <span class="n">max_iter</span><span class="o">=</span><span class="n">max_iter</span><span class="p">,</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3763"><a href="#demo_nsa_flow_optimizer_tradeoff-3763"><span class="linenos">3763</span></a>                    <span class="n">lr_strategy</span><span class="o">=</span><span class="n">lr_strategy</span><span class="p">,</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3764"><a href="#demo_nsa_flow_optimizer_tradeoff-3764"><span class="linenos">3764</span></a>                    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3765"><a href="#demo_nsa_flow_optimizer_tradeoff-3765"><span class="linenos">3765</span></a>                    <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3766"><a href="#demo_nsa_flow_optimizer_tradeoff-3766"><span class="linenos">3766</span></a>                    <span class="n">window_size</span><span class="o">=</span><span class="n">window_size</span><span class="p">,</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3767"><a href="#demo_nsa_flow_optimizer_tradeoff-3767"><span class="linenos">3767</span></a>                    <span class="n">warmup_iters</span><span class="o">=</span><span class="n">warmup_iters</span><span class="p">,</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3768"><a href="#demo_nsa_flow_optimizer_tradeoff-3768"><span class="linenos">3768</span></a>                    <span class="n">apply_nonneg</span><span class="o">=</span><span class="n">apply_nonneg</span><span class="p">,</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3769"><a href="#demo_nsa_flow_optimizer_tradeoff-3769"><span class="linenos">3769</span></a>                    <span class="n">optimizer</span><span class="o">=</span><span class="n">opt_name</span><span class="p">,</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3770"><a href="#demo_nsa_flow_optimizer_tradeoff-3770"><span class="linenos">3770</span></a>                <span class="p">)</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3771"><a href="#demo_nsa_flow_optimizer_tradeoff-3771"><span class="linenos">3771</span></a>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3772"><a href="#demo_nsa_flow_optimizer_tradeoff-3772"><span class="linenos">3772</span></a>                <span class="n">X_target</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3773"><a href="#demo_nsa_flow_optimizer_tradeoff-3773"><span class="linenos">3773</span></a>                <span class="n">Y_final</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;Y&quot;</span><span class="p">]</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3774"><a href="#demo_nsa_flow_optimizer_tradeoff-3774"><span class="linenos">3774</span></a>                <span class="n">fid_end</span> <span class="o">=</span> <span class="n">fidelity_scaled</span><span class="p">(</span><span class="n">X_target</span><span class="p">,</span> <span class="n">Y_final</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3775"><a href="#demo_nsa_flow_optimizer_tradeoff-3775"><span class="linenos">3775</span></a>                <span class="n">orth_end</span> <span class="o">=</span> <span class="n">invariant_orthogonality_defect</span><span class="p">(</span><span class="n">Y_final</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3776"><a href="#demo_nsa_flow_optimizer_tradeoff-3776"><span class="linenos">3776</span></a>                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3777"><a href="#demo_nsa_flow_optimizer_tradeoff-3777"><span class="linenos">3777</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">opt_name</span><span class="si">}</span><span class="s2"> | w=</span><span class="si">{</span><span class="n">w</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">] FID=</span><span class="si">{</span><span class="n">fid_end</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, ORTH=</span><span class="si">{</span><span class="n">orth_end</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3778"><a href="#demo_nsa_flow_optimizer_tradeoff-3778"><span class="linenos">3778</span></a>                <span class="n">fid_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fid_end</span><span class="p">)</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3779"><a href="#demo_nsa_flow_optimizer_tradeoff-3779"><span class="linenos">3779</span></a>                <span class="n">orth_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orth_end</span><span class="p">)</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3780"><a href="#demo_nsa_flow_optimizer_tradeoff-3780"><span class="linenos">3780</span></a>                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3781"><a href="#demo_nsa_flow_optimizer_tradeoff-3781"><span class="linenos">3781</span></a>                    <span class="s2">&quot;optimizer&quot;</span><span class="p">:</span> <span class="n">opt_name</span><span class="p">,</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3782"><a href="#demo_nsa_flow_optimizer_tradeoff-3782"><span class="linenos">3782</span></a>                    <span class="s2">&quot;w&quot;</span><span class="p">:</span> <span class="n">w</span><span class="p">,</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3783"><a href="#demo_nsa_flow_optimizer_tradeoff-3783"><span class="linenos">3783</span></a>                    <span class="s2">&quot;fid_end&quot;</span><span class="p">:</span> <span class="n">fid_end</span><span class="p">,</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3784"><a href="#demo_nsa_flow_optimizer_tradeoff-3784"><span class="linenos">3784</span></a>                    <span class="s2">&quot;orth_end&quot;</span><span class="p">:</span> <span class="n">orth_end</span><span class="p">,</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3785"><a href="#demo_nsa_flow_optimizer_tradeoff-3785"><span class="linenos">3785</span></a>                <span class="p">})</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3786"><a href="#demo_nsa_flow_optimizer_tradeoff-3786"><span class="linenos">3786</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3787"><a href="#demo_nsa_flow_optimizer_tradeoff-3787"><span class="linenos">3787</span></a>                <span class="n">fid_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3788"><a href="#demo_nsa_flow_optimizer_tradeoff-3788"><span class="linenos">3788</span></a>                <span class="n">orth_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3789"><a href="#demo_nsa_flow_optimizer_tradeoff-3789"><span class="linenos">3789</span></a>                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3790"><a href="#demo_nsa_flow_optimizer_tradeoff-3790"><span class="linenos">3790</span></a>                    <span class="s2">&quot;optimizer&quot;</span><span class="p">:</span> <span class="n">opt_name</span><span class="p">,</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3791"><a href="#demo_nsa_flow_optimizer_tradeoff-3791"><span class="linenos">3791</span></a>                    <span class="s2">&quot;w&quot;</span><span class="p">:</span> <span class="n">w</span><span class="p">,</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3792"><a href="#demo_nsa_flow_optimizer_tradeoff-3792"><span class="linenos">3792</span></a>                    <span class="s2">&quot;fid_end&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3793"><a href="#demo_nsa_flow_optimizer_tradeoff-3793"><span class="linenos">3793</span></a>                    <span class="s2">&quot;orth_end&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3794"><a href="#demo_nsa_flow_optimizer_tradeoff-3794"><span class="linenos">3794</span></a>                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3795"><a href="#demo_nsa_flow_optimizer_tradeoff-3795"><span class="linenos">3795</span></a>                <span class="p">})</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3796"><a href="#demo_nsa_flow_optimizer_tradeoff-3796"><span class="linenos">3796</span></a>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3797"><a href="#demo_nsa_flow_optimizer_tradeoff-3797"><span class="linenos">3797</span></a>        <span class="c1"># --- Plot both metrics on same axes ---</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3798"><a href="#demo_nsa_flow_optimizer_tradeoff-3798"><span class="linenos">3798</span></a>        <span class="n">ax2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3799"><a href="#demo_nsa_flow_optimizer_tradeoff-3799"><span class="linenos">3799</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">w_values</span><span class="p">,</span> <span class="n">fid_vals</span><span class="p">,</span> <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Fidelity&quot;</span><span class="p">)</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3800"><a href="#demo_nsa_flow_optimizer_tradeoff-3800"><span class="linenos">3800</span></a>        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">w_values</span><span class="p">,</span> <span class="n">orth_vals</span><span class="p">,</span> <span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Orthogonality&quot;</span><span class="p">)</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3801"><a href="#demo_nsa_flow_optimizer_tradeoff-3801"><span class="linenos">3801</span></a>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3802"><a href="#demo_nsa_flow_optimizer_tradeoff-3802"><span class="linenos">3802</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">opt_name</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">title_fs</span><span class="p">)</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3803"><a href="#demo_nsa_flow_optimizer_tradeoff-3803"><span class="linenos">3803</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">label_fs</span><span class="p">)</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3804"><a href="#demo_nsa_flow_optimizer_tradeoff-3804"><span class="linenos">3804</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Fidelity&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">label_fs</span><span class="p">)</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3805"><a href="#demo_nsa_flow_optimizer_tradeoff-3805"><span class="linenos">3805</span></a>        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Orthogonality&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">label_fs</span><span class="p">)</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3806"><a href="#demo_nsa_flow_optimizer_tradeoff-3806"><span class="linenos">3806</span></a>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3807"><a href="#demo_nsa_flow_optimizer_tradeoff-3807"><span class="linenos">3807</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3808"><a href="#demo_nsa_flow_optimizer_tradeoff-3808"><span class="linenos">3808</span></a>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3809"><a href="#demo_nsa_flow_optimizer_tradeoff-3809"><span class="linenos">3809</span></a>        <span class="c1"># Combine legends</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3810"><a href="#demo_nsa_flow_optimizer_tradeoff-3810"><span class="linenos">3810</span></a>        <span class="n">lines</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3811"><a href="#demo_nsa_flow_optimizer_tradeoff-3811"><span class="linenos">3811</span></a>        <span class="n">lines2</span><span class="p">,</span> <span class="n">labels2</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3812"><a href="#demo_nsa_flow_optimizer_tradeoff-3812"><span class="linenos">3812</span></a>        <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">lines</span> <span class="o">+</span> <span class="n">lines2</span><span class="p">,</span> <span class="n">labels</span> <span class="o">+</span> <span class="n">labels2</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">legend_fs</span><span class="p">,</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3813"><a href="#demo_nsa_flow_optimizer_tradeoff-3813"><span class="linenos">3813</span></a>                   <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">legend_y</span><span class="p">),</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3814"><a href="#demo_nsa_flow_optimizer_tradeoff-3814"><span class="linenos">3814</span></a>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3815"><a href="#demo_nsa_flow_optimizer_tradeoff-3815"><span class="linenos">3815</span></a>    <span class="c1"># --- Turn off unused subplots ---</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3816"><a href="#demo_nsa_flow_optimizer_tradeoff-3816"><span class="linenos">3816</span></a>    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">optimizers</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)):</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3817"><a href="#demo_nsa_flow_optimizer_tradeoff-3817"><span class="linenos">3817</span></a>        <span class="n">axes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3818"><a href="#demo_nsa_flow_optimizer_tradeoff-3818"><span class="linenos">3818</span></a>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3819"><a href="#demo_nsa_flow_optimizer_tradeoff-3819"><span class="linenos">3819</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.97</span><span class="p">])</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3820"><a href="#demo_nsa_flow_optimizer_tradeoff-3820"><span class="linenos">3820</span></a>    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;NSA-Flow Optimizer Comparison: Fidelity &amp; Orthogonality vs w&quot;</span><span class="p">,</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3821"><a href="#demo_nsa_flow_optimizer_tradeoff-3821"><span class="linenos">3821</span></a>                 <span class="n">fontsize</span><span class="o">=</span><span class="n">suptitle_fs</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.995</span><span class="p">)</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3822"><a href="#demo_nsa_flow_optimizer_tradeoff-3822"><span class="linenos">3822</span></a>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3823"><a href="#demo_nsa_flow_optimizer_tradeoff-3823"><span class="linenos">3823</span></a>    <span class="k">if</span> <span class="n">save_path</span><span class="p">:</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3824"><a href="#demo_nsa_flow_optimizer_tradeoff-3824"><span class="linenos">3824</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3825"><a href="#demo_nsa_flow_optimizer_tradeoff-3825"><span class="linenos">3825</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">fig_dpi</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3826"><a href="#demo_nsa_flow_optimizer_tradeoff-3826"><span class="linenos">3826</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Saved figure to </span><span class="si">{</span><span class="n">save_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3827"><a href="#demo_nsa_flow_optimizer_tradeoff-3827"><span class="linenos">3827</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3828"><a href="#demo_nsa_flow_optimizer_tradeoff-3828"><span class="linenos">3828</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3829"><a href="#demo_nsa_flow_optimizer_tradeoff-3829"><span class="linenos">3829</span></a>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3830"><a href="#demo_nsa_flow_optimizer_tradeoff-3830"><span class="linenos">3830</span></a>    <span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3831"><a href="#demo_nsa_flow_optimizer_tradeoff-3831"><span class="linenos">3831</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Summary of results (per optimizer  w):&quot;</span><span class="p">)</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3832"><a href="#demo_nsa_flow_optimizer_tradeoff-3832"><span class="linenos">3832</span></a>    <span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;optimizer&quot;</span><span class="p">)[[</span><span class="s2">&quot;fid_end&quot;</span><span class="p">,</span> <span class="s2">&quot;orth_end&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
</span><span id="demo_nsa_flow_optimizer_tradeoff-3833"><a href="#demo_nsa_flow_optimizer_tradeoff-3833"><span class="linenos">3833</span></a>    <span class="k">return</span> <span class="n">results_df</span>
</span></pre></div>


            <div class="docstring"><p>Compare optimizer performance across w-values.
Plots Fidelity (blue) and Orthogonality (red) together on each optimizer's subplot.
Allows user to choose subplot grid dimensions (nrows, ncols).</p>
</div>


                </section>
    </main>
</body>
</html>